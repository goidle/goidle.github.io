{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_1/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"d17b9cc9-e61f-5fbf-964b-4888a557d77f","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM 재조정 작업을 진행한다. 완성된 VDOM을 Commit phase를 통해 DOM…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<h3 id=\"포스트별-주제\"><a href=\"#%ED%8F%AC%EC%8A%A4%ED%8A%B8%EB%B3%84-%EC%A3%BC%EC%A0%9C\" aria-label=\"포스트별 주제 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>포스트별 주제</h3>\n<ol>\n<li>훅을 통해 컴포넌트 상태를 업데이트한다.</li>\n<li>업데이트를 반영할 <strong>Work</strong>를 <strong>scheduler</strong>에게 전달하고 <strong>scheduler</strong>는 스케줄링된 <strong>Task</strong>를 적절한 시기에 실행한다.</li>\n<li>\n<h3 id=\"uwork을-통해-vdom-재조정-작업을-진행한다u\"><a href=\"#uwork%EC%9D%84-%ED%86%B5%ED%95%B4-vdom-%EC%9E%AC%EC%A1%B0%EC%A0%95-%EC%9E%91%EC%97%85%EC%9D%84-%EC%A7%84%ED%96%89%ED%95%9C%EB%8B%A4u\" aria-label=\"uwork을 통해 vdom 재조정 작업을 진행한다u permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><u><strong>Work</strong>을 통해 VDOM 재조정 작업을 진행한다.</u></h3>\n</li>\n<li>완성된 VDOM을 Commit phase를 통해 DOM에 적용한다.</li>\n<li>사용자의 상호작용으로 이벤트가 발생하고 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>\n</ol>\n<hr>\n<p>아마 이번 포스트에서 리액트에 대해 막연하게 생각하셨던 대부분을 다루게 될 것입니다. 그만큼 중추적인 역할을 하는 패키지가 <strong>reconciler</strong>입니다.  </p>\n<p>우리는 먼저 <u>JSX로 작성한 컴포넌트들이 어떻게 React element로 변환되고, VDOM에 올리기 위해 어떤 방식으로 fiber로 확장하는지 알아볼 것입니다.</u> 그 후에 컴포넌트로부터 발생한 변경점들을 VDOM에 적용하는 Render phase와 완성된 VDOM을 DOM에 적용하는 Commit phase를 순서대로 확인해보며 마무리할 것입니다.</p>\n<h1 id=\"1-react-element\"><a href=\"#1-react-element\" aria-label=\"1 react element permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. React element</h1>\n<h2 id=\"1---1-종류\"><a href=\"#1---1-%EC%A2%85%EB%A5%98\" aria-label=\"1   1 종류 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1 - 1 종류</h2>\n<p>리액트 컴포넌트는 크게 호스트 컴포넌트, 사용자 정의 컴포넌트<up>커스텀 컴포넌트</up>, 리액트에서 제공하는 컴포넌트<up>스태틱 컴포넌트</up>로 나눌 수 있습니다.  </p>\n<ul>\n<li>호스트 컴포넌트는 div, input, button 등 html element에 대응하는 컴포넌트입니다.  </li>\n<li>커스텀 컴포넌트는 일반적으로 개발자들이 만들게 되는 클래스, 함수형 컴포넌트입니다.  </li>\n<li>스태틱 컴포넌트는 하나의 특수한 목적을 가진 컴포넌트로 Fragment, lazy, Context(Provider, Consumer), memo 등이 있습니다.</li>\n</ul>\n<h2 id=\"1---2-createelement\"><a href=\"#1---2-createelement\" aria-label=\"1   2 createelement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1 - 2 createElement()</h2>\n<p>JSX 문법으로 작성된 컴포넌트는 바벨을 통해 React.createElement()로 치환됩니다. 이러한 이유로 개발자는 React 모듈을 사용하지  않아도 JSX를 작성할 때는 항상 React를 import 해야합니다.   </p>\n<p>createElement()가 어떤 인자를 받는지부터 확인하겠습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactElement.js#L312\" target=\"_blank\">react > ReactElement.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">type</code>: 컴포넌트의 종류에 따라 다음의 값이 사용됩니다.  </p>\n<ul>\n<li>호스트 컴포넌트: 태그 이름</li>\n<li>커스텀 컴포넌트: 작성한 함수</li>\n<li>스태틱 컴포넌트: <a target=\"_black\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactSymbols.js#L12\">미리 정의된 Symbol</a> 또는 memo, lazy와 같이 함수 호출을 통해 만들어진 React element</li>\n</ul>\n<p><code class=\"language-text\">config</code>: props를 담고 있는 객체입니다.<br>\n<code class=\"language-text\">children</code>: 코드에서는 자식을 하나의 인자가 받도록 되어 있지만 실제로는 여러 자식이 올 경우 3 ~ n번째의 인자에 자식들이 들어옵니다. <code class=\"language-text\">function createElement(type, config, children1, children2, ..childrenN)</code>의 형태가 됩니다.</p>\n<p>다음의 예제로 해당 내용을 확인해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">CustomComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>CustomComponent <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"host_component\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<blockquote>\n<p>&#x3C;>…&#x3C;/>는 &#x3C;React.Fragment>…&#x3C;/React.Fragment>의 단축 형태입니다.</p>\n</blockquote>\n<p>바벨을 통해 치환된 코드는 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n    React<span class=\"token punctuation\">.</span>Fragment<span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: Symbol.for('react.fragment')</span>\n    <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// config</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 첫번째 자식</span>\n      CustomComponent<span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: function</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// config</span>\n      <span class=\"token comment\">// 자식은 없음</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 두번째 자식</span>\n      <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: tag name</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"host_component\"</span> <span class=\"token punctuation\">}</span> <span class=\"token comment\">// config</span>\n      <span class=\"token comment\">// 자식은 없음</span>\n    <span class=\"token punctuation\">)</span> \n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>React element를 만드는 과정은 다음과 같습니다.</p>\n<ol>\n<li>React element에는 key와 ref라는 예약된 속성들이 존재합니다. config에 예약 속성을 제외한 나머지를 props 객체에 저장합니다. </li>\n<li>복수의 자식이 넘어온다면 하나의 배열에 저장합니다.</li>\n<li>default props가 존재할 경우 props 객체에 적용합니다.</li>\n<li>1 ~ 3에서 작성한 정보를 가지고 React element 객체를 만듭니다.</li>\n</ol>\n<anchor id=\"createElement\" />\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactElement.js#L312\" target=\"_blank\">react > ReactElement.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">const</span> <span class=\"token constant\">RESERVED_PROPS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  ref<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token comment\">// 1</span>\n  <span class=\"token keyword\">let</span> propName<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> key <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> ref <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasValidRef</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// config.ref !== undefined;</span>\n      ref <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>ref<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasValidKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// config.key !== undefined;</span>\n      key <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> config<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 예약된 속성을 제외한 나머지를 props 객체에 저장</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propName <span class=\"token keyword\">in</span> config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> propName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token operator\">!</span><span class=\"token constant\">RESERVED_PROPS</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propName<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 2</span>\n  <span class=\"token keyword\">const</span> childrenLength <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childrenLength <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> children<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childrenLength <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> childArray <span class=\"token operator\">=</span> <span class=\"token function\">Array</span><span class=\"token punctuation\">(</span>childrenLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> childrenLength<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      childArray<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> childArray<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 3</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">&amp;&amp;</span> type<span class=\"token punctuation\">.</span>defaultProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> defaultProps <span class=\"token operator\">=</span> type<span class=\"token punctuation\">.</span>defaultProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propName <span class=\"token keyword\">in</span> defaultProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> defaultProps<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 4</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">ReactElement</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">,</span>\n    ref<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만드는 과정은 확인했으니 <code class=\"language-text\">ReactElement()</code>가 무엇을 반환하는지 확인해봅시다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactElement.js#L111\" target=\"_blank\">react > ReactElement.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ReactElement</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This tag allows us to uniquely identify this as a React Element</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Built-in properties that belong on the element</span>\n    type<span class=\"token punctuation\">:</span> type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">,</span>\n    ref<span class=\"token punctuation\">:</span> ref<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">:</span> props<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> element<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>특이하게 생긴 <code class=\"language-text\">$$typeof</code>가 있습니다. 이 속성은 fiber를 만들 때 element의 종류를 확인하는 데 쓰입니다. 기본적으로는 <code class=\"language-text\">REACT_ELEMENT_TYPE</code>이지만 스태틱 컴포넌트의 경우 심볼을 사용합니다.   </p>\n<p>스태틱 컴포넌트 중 간단하게 memo와 lazy만 확인해보겠습니다.</p>\n<anchor id=\"memo\">\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react/src/memo.js\" target=\"_blank\">react > memo.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span><span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> memo<span class=\"token operator\">&lt;</span>Props<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  type<span class=\"token punctuation\">:</span> React$ElementType<span class=\"token punctuation\">,</span>\n  compare<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">oldProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">:</span> Props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    compare<span class=\"token punctuation\">:</span> compare <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> compare<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactLazy.js#L13\" target=\"_blank\">react > ReactLazy.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span><span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> lazy<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">ctor</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> LazyComponent<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> lazyType <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">,</span>\n    _ctor<span class=\"token punctuation\">:</span> ctor<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// React uses these fields to store the result.</span>\n    _status<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    _result<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> lazyType<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>리액트 코어 패키지가 하는 일은 대게 이런 리액트용 element를 만드는 거라고 생각하시면 됩니다.</p>\n<blockquote>\n<p>Text는 React element로 변환하지 않습니다.</p>\n</blockquote>\n<h1 id=\"2-fiber\"><a href=\"#2-fiber\" aria-label=\"2 fiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Fiber</h1>\n<p>React element의 종류를 type 심볼을 통해 판단했다면 fiber는 <a target=\"_black\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactWorkTags.js#L10\">tag</a>를 통해 판단합니다. 이 tag의 명칭은 Work tag로 각 fiber 종류에 따라 재조정 작업의 처리가 달라야 하기 때문에 붙은 명칭입니다. </p>\n<h2 id=\"2---1-createfiber\"><a href=\"#2---1-createfiber\" aria-label=\"2   1 createfiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 - 1 createFiber()</h2>\n<p>몇몇 종류의 fiber들은 <strong><em>props</em></strong>를 조금 다른 의미로 다루고 있습니다. 그래서 fiber 생성을 위한 사전 준비가 살짝 일반 fiber와는 다릅니다. 이 부분을 처리하기 위해 createFiberFrom***()의 형식으로 함수가 파생되어 있기는 하지만 결국 fiber를 만드는 최종 함수로 createFiber()를 사용하므로 이 함수부터 확인하겠습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L354\" target=\"_blank\">reconciler > ReactFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createFiber</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">tag<span class=\"token punctuation\">:</span> WorkTag<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> mixed<span class=\"token punctuation\">,</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FiberNode</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">FiberNode</code>의 설명은 <a target=\"_blank\" href=\"/react/in-depth-react-intro#FiberNode\">Intro</a>에서 언급한 내용으로 대체합니다.</li>\n</ul>\n<p>props를 특별하게 다루는 fiber는 Fragment와 Text입니다. 이들을 먼저 확인해보고 난 후에 일반적인 fiber를 생성하는 createFiberFromElement()를 확인하겠습니다.</p>\n<h2 id=\"2---2-createfiberfromfragment-createfiberfromtext\"><a href=\"#2---2-createfiberfromfragment-createfiberfromtext\" aria-label=\"2   2 createfiberfromfragment createfiberfromtext permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 - 2 createFiberFromFragment(), createFiberFromText()</h2>\n<p>Fragment는 컴포넌트들을 하나로 묶어주는 포장지라고 생각하시면 됩니다. 그래서 props에는 다른 값을 다루지 않고 오로지 children만을 저장합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// fragment fiber를 만드는 코드 중..</span>\n<span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromFragment</span><span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">  element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span></span>  returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">,</span>\n  element<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncreated<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> created<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>createFiberFromFragment()를 호출할 때 props에서 children을 꺼내<up>6</up> 넘겨줍니다.  </li>\n</ul>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L758\" target=\"_blank\">reconciler > ReactFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Fragment <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactWorkTags'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromFragment</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">elements<span class=\"token punctuation\">,</span>  \n  mode<span class=\"token punctuation\">,</span>  \n  expirationTime<span class=\"token punctuation\">,</span>  \n  key</span>  \n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>Fragment<span class=\"token punctuation\">,</span> elements<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>children으로 넘어온 <code class=\"language-text\">elements</code>를 <code class=\"language-text\">createFiber()</code>의 두 번째 인자<up>pendingProps</up>로 넘겨주면서 fiber의 props에 자식만 저장합니다. 즉 Fragment는 props를 자식의 저장소로 사용합니다.   </li>\n</ul>\n<p>그렇다면 Text fiber의 props에는 무엇이 저장될까요?<br>\nText는 그 자체가 데이터입니다. 다른 추가적이 요소가 필요 없습니다. 심지어 key도요. 그래서 props에는 Text 그 자체가 들어갑니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// text fiber를 만드는 코드 중..</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token string\">''</span> <span class=\"token operator\">+</span> newChild<span class=\"token punctuation\">,</span></span>    returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>React element가 string, number일 경우 그 자체를 props 인자로 넘겨줍니다.  </li>\n</ul>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L860\" target=\"_blank\">reconciler > ReactFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HostText <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactWorkTags'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">content<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>HostText<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Fragment와 다른 점은 Work tag 말고도 key가 없다는 점입니다.</li>\n</ul>\n<blockquote>\n<p>이 이외에도 props를 특별하게 다루는 fiber로 Portal이 있습니다.</p>\n</blockquote>\n<p>다음은 일반적으로 Props를 사용하는 fiber 생성 함수 createFiberFromElement()입니다.</p>\n<h2 id=\"2---3-createfiberfromelement\"><a href=\"#2---3-createfiberfromelement\" aria-label=\"2   3 createfiberfromelement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 - 3 createFiberFromElement()</h2>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L731\" target=\"_blank\">reconciler > ReactFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">element<span class=\"token punctuation\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pendingProps <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromTypeAndProps</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">,</span>\n    mode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>먼저 element에서 필요한 정보들을 꺼냅니다<up>7 ~ 9</up>. <code class=\"language-text\">createFiberFromTypeAndProps()</code>는 이 정보들을 이용하여 element의 <strong><em>type</em></strong>에 맞는 fiber로 확장합니다.  </li>\n</ul>\n<p><code class=\"language-text\">createFiberFromTypeAndProps()</code>가 가장 먼저 해야 할 일은 여러 형태의 React element를 잘 분간하여 거기에 맞는 fiber tag를 찾아내는 것입니다. </p>\n<anchor id=\"createFiberFromTypeAndProps\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L593\" target=\"_blank\">reconciler > ReactFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  IndeterminateComponent<span class=\"token punctuation\">,</span>\n  ClassComponent<span class=\"token punctuation\">,</span>\n  MemoComponent<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactWorkTags'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// fiber tag</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">REACT_FRAGMENT_TYPE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 스태틱 컴포넌트</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromTypeAndProps</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">type<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> fiber<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> fiberTag <span class=\"token operator\">=</span> IndeterminateComponent<span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">let</span> resolvedType <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// class component</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldConstruct</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// type.prototype &amp;&amp; type.prototype.isReactComponent;</span>\n<span class=\"gatsby-highlight-code-line\">      fiberTag <span class=\"token operator\">=</span> ClassComponent<span class=\"token punctuation\">;</span></span>    <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//else?? 여기서는 함수형 컴포넌트라고 단정지을 수 없습니다.</span>\n    \n  <span class=\"token comment\">// type이 string이면 호스트 컴포넌트 입니다. ex) 'div', 'input'..</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    fiberTag <span class=\"token operator\">=</span> HostComponent<span class=\"token punctuation\">;</span></span>\n  <span class=\"token comment\">// 이하 스태틱 컴포넌트</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    getTag<span class=\"token punctuation\">:</span> <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">createFiberFromFragment</span><span class=\"token punctuation\">(</span>\n          pendingProps<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span>\n          mode<span class=\"token punctuation\">,</span>\n          expirationTime<span class=\"token punctuation\">,</span>\n          key<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_CONCURRENT_MODE_TYPE</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">        fiberTag <span class=\"token operator\">=</span> Mode<span class=\"token punctuation\">;</span></span>        mode <span class=\"token operator\">|=</span> ConcurrentMode <span class=\"token operator\">|</span> BlockingMode <span class=\"token operator\">|</span> StrictMode<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">/*...*/</span>\n      <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> type <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">              fiberTag <span class=\"token operator\">=</span> MemoComponent<span class=\"token punctuation\">;</span></span>              <span class=\"token keyword\">break</span> getTag<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">              fiberTag <span class=\"token operator\">=</span> LazyComponent<span class=\"token punctuation\">;</span></span>              resolvedType <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">break</span> getTag<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">/*...*/</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> info <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n          <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'Element type is invalid: expected a string (for built-in '</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">'components) or a class/function (for composite components) '</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">'but got: %s.%s'</span><span class=\"token punctuation\">,</span>\n          type <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> type <span class=\"token punctuation\">:</span> <span class=\"token keyword\">typeof</span> type<span class=\"token punctuation\">,</span>\n          info<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">  fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>fiberTag<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  fiber<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> resolvedType<span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>22: <code class=\"language-text\">IndeterminateComponent</code> tag는 현재 이 fiber가 클래스 컴포넌트인지 함수형 컴포넌트인지 확실히 알 수 없는 상태를 뜻합니다.  </li>\n</ul>\n<anchor id=\"IndeterminateComponent\" />\n<ul>\n<li>\n<p>30: type이 함수라면 클래스, 함수형 컴포넌트 중 하나입니다. 근데 이상한 점은 클래스 컴포넌트가 아님을 확인<up>27</up> 했는데도 함수형 컴포넌트 tag를 설정하는 부분이 보이지 않습니다. 왜 함수형 컴포넌트라고 단정 짓지 않는 것일까요?  </p>\n<p>이유는 개발자의 실수로 다음과 같이 작성될 수 있기 때문입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"I'm Foo\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Foo</code>는 render 메소드를 품고 있는 객체 리터럴을 반환하는 함수형 컴포넌트입니다. 하지만 이 반환되는 객체는 리액트 컴포넌트를 상속하지 않았기 때문에 내부에서 문제를 일으킬 소지가 있습니다.  </p>\n<p>리액트는 이와 같은 케이스를 <strong><em>클래스 컴포넌트를 작성하려다 발생한 휴먼 에러</em></strong>라고 판단하고 내부에서 올바르게 동작하도록 Foo를 <u>클래스 컴포넌트로 변환</u>시킵니다. Component를 Foo에 상속시킴과 동시에 반환했던 객체 리터럴까지 Foo의 instance로 갈아 끼워 주면서 말이죠.  </p>\n<p>문제는 이러한 케이스는 함수를 실행해 보기 전까지는 알 수 없다는 것입니다. createFiberFromTypeAndProps()는 fiber로 확장하는 책임만 가지고 있기 때문에 여기서는 이를 알 수 있는 방법이 없습니다. 그래서 컴포넌트를 호출할 수 있는 시점에 함수를 호출하여 다시 판단하도록 <code class=\"language-text\">IndeterminateComponent</code> tag를 달아주는 것입니다. </p>\n</li>\n<li>\n<p>54: switch case문<up>39 ~ 49 </up>은 쉽게 이해할 수 있지만 아마 default<up>51</up>는 그렇지 않을 것입니다. 지금까지 확인했던 React element의 type은 심볼, 텍스트, 함수가 전부 였습니다. 그렇다면 언제 type에 객체가 오는 것일까요?</p>\n<p>이를 이해하기 위해 리액트 코어 패키지의 <a href=\"#memo\">memo 함수</a>를 다시 한번 확인해 보고 오세요. 반환값이 <u>React element</u>입니다. 그리고 아래의 memo 사용 코드를 보시면 default의 내용이 이제는 이해가 가실 겁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">FC</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">'memo component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">FC</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이해 가시나요? 우리는 첫 줄에서 이미 memo element를 만들었습니다. 그리고 이 element를 다시 JSX로 컴포넌트 선언을 하였기   때문에 type에는 memo element 객체가 들어가게 되는 것입니다.</p>\n</li>\n</ul>\n<p>React element와 fiber를 어떻게 생성하는지는 이 정도면 충분할 것 같습니다. React element가 언제 fiber로 확장되는지는 분석을 계속해서 진행하다 보면 자연스레 아시게 됩니다.</p>\n<p>다음 주제는 이전 scheduler 포스트에서 스케줄링했던 Work 함수를 진행할 차례이지만, 아직까진 VDOM에 친숙하지 않습니다. Render phase에서는 VDOM 탐색 로직이 많기 때문에 분석할 때 헷갈리지 않도록 VDOM과 좀 더 친숙해지는 시간을 가지도록 하겠습니다.</p>\n<h1 id=\"3-fiber-root-node\"><a href=\"#3-fiber-root-node\" aria-label=\"3 fiber root node permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Fiber Root Node</h1>\n<p>Intro에서 사용했던 이미지를 재활용하여 부족했던 설명을 보충하도록 하겠습니다.</p>\n<figure>\n <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 634px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 143.69085173501577%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEOElEQVRIx31VaVMbRxDl/1cZCXOksKGAKrv4EmOBDSGxY9kcTkglgSRCEgh0sTr2vne150vPiBUSEnRV1+xcb1/PdL+Zw5ilacpbx3VhOw58f4AoipAkCR8zTQuO40LTDXi+P9qT7WM2Nw6W3E9UqjUcfiriy9cTHBx+xq/FY/zx5zl2Cvu8/2b7R5Qr13wt+9k46NwshsyCIOTs/MGAswvDiPdD8iiOZ+6ZYsjMNE1IkgRRFKEoCndd16Gqw9axbSg0L/V6MKj/OOwpQJ/OxjAM2LSRuWVZvC8IAmzPg0NgSqkEg1qPmM8EzDqP6Y+bS2DMom4XqarOCPkR4HN+cnyMt9vbEGo1pLKMmN082Fx2IckDw6dYZePs3FZXVzE/P4+fDw/xnLE9nKETWhA9AYrfR5zGCOOQPCAWCfpSH4XdAlZfraJyVeEb7cBAz2lDsBvou3foum1Ygf4Qco8GWnaNT+oDGU5igpIF10IVl80SZK+LlnYDLZSh+QrUQIQa99H37yA4DbTtW94mRIYDGoE6Qb3VbOGqegWZUmc4T4wINDPHclD65xK+OxiN2aGBIB4MAfWBwjvMms0mFhYWsJCbx28XJVzrKb7U+9i/buGi5+LvjoN3799jZXkJu3u77GqQkQqT4AGQnRmzer2OxcUl/LCyjOO//kONAE/bIj7V2yhLPm4UD+92drC0soJCoTBiaATaJGCUhKPJi/Nz/Ht6OuprvoaO02GVy/syVc/Rx4+wKOGzFDQfA8Yp5VacQFE1nipUf4hM2hClMEMdktfh4bmuB5nWuO02HaaD+L5azGmGEc+jMAx5/ULTkFICM1IWAcp+lycwUxeLlWSrNVQbtmY24DDkmJTkw4c9HOztkeIML6prK3SWdyOVKVcqeLOxgUaj8XTI2aWUy2Xk8nl+y/vffsdZN8HB9R12SCNPWg6+3hhY39hELpfD1tbWqKKMacAhw77Yx8bmJjbW11BrCdDpPyWqlrNuE307gBumKBaLWHz5EkdHR7MZalQdCWKIsgJR6MAlqXLu1SU7H9F7uGX2BFQq1YlimAJkv5EUFQ4pCqns1GKJKiXhqgIMSMU1ujSm4FliTwDasY6+LKJE+RcrD2UoSiKajRa/5QyQGcuEIAi4z2R4pzTwev0V8vkFfP9+DHhU+MItXq+tIT+fx7ezIsxE4RnwlMxNANZ7NSwuL5Lm5fD5F9K8xELr9hJLy8vIvcjhpyJVRaoSYIRZgjwjZAPlapnf2ngY1WqV1PoUqitRYvdGIY8/GTMBzVDDIPThe/79WxuP3gjXduHEJkS3MwH4mOFEHmq+TC+cRZs9KqVkxNCjuvVsnxjKkPzus/JvkmKPAFVf4sltByaXdyekltyibzbG5lnITObZc2Hfz2fO1qu+iJj0gAOyOnYjG17kcGff7tg3+zNbnI2Pe7YmE+j/AYmfmLxmz5QpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"vDOM\" title=\"vDOM\" src=\"/static/258b43ce623e7b6340fc6aed969199ed/153fa/vDOM.png\" srcset=\"/static/258b43ce623e7b6340fc6aed969199ed/0780f/vDOM.png 198w,\n/static/258b43ce623e7b6340fc6aed969199ed/47b26/vDOM.png 395w,\n/static/258b43ce623e7b6340fc6aed969199ed/153fa/vDOM.png 634w\" sizes=\"(max-width: 634px) 100vw, 634px\" loading=\"lazy\">\n    </span>\n  <figcaption>Virtual DOM</figcaption>\n</figure>\n<p><code class=\"language-text\">Root Node</code><up>root</up>는 VDOM을 대표하는 노드로서 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberRoot.js#L104\" target=\"_blank\">FiberRootNode</a>를 통해 생성됩니다.<br>\nroot가 관리하는 정보를 몇 개만 추려보자면 현재 <u>DOM에 적용된 </u>VDOM 최상단 node<up>host root</up>인 <code class=\"language-text\">current</code>, container element를 참조하는 <code class=\"language-text\">containerInfo</code>, <strong>scheduler</strong>에서 이미 다루었던 스케줄 정보 등이 있습니다.</p>\n<p>root가 참조하는 current를 최상단 node라고 해서 <code class=\"language-text\">&lt;App /&gt;</code>이라 생각할 수도 있는데 그렇지는 않고 일반적인 fiber와 같이 createFiber()로 생성되고 root를 참조하도록 만들어진 fiber<up>host root</up>가 최상단 node입니다. </p>\n<figure>\n <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 521px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 85.41266794625719%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACf0lEQVQ4y41U23baMBDkV+ILvkm2ZPkGDgYbFwK5tC9N+9L//4zprhKRhqY5fdizWiFGo9lZL7I4w64YcVeeMOoJYz/hNJ4wj0ckSYogCBCG4SVfr69jEQYhermxgAd9h0Y2kJFG6MfwPP8doIvPQBdxFFuGszpgq7bomi1ub7dotISQkljGnzL6CzBJEsz6C0a1x7Sb8P35B6ZxwtAP2Gy20KpE4PPh4B3Lj8L3fSy8wEOTtXiqvuG+fsRczTDEdOh+Ylz/ovyMUm3g+TeIoghxHNvsWC+Xy0tmcgs/9NHmHfZqRqdXqE2NVbdGv+bnD2jqDlprlGWJYRjQdW/1er1GXdcoigJt22K1Wr0wNGmFQ3nEoLfo1S36skeRG2IT2eDb0zRFlmWWHYermRUH17y/8HwPVVrjVN5jIi1zoQkgtHq8RXBV/zteNBQtHs1X3JtHbKodpNT2NvZhHCVWN2bJe8zK1ZyZGTPktdWQAVvR4VidScseIhHI84JABWmjILLcrvkwgxlj6Pfc1pJsxXpyLYSwWl4AJ7OHySvESXzRJ00zZKm0NTPgPQZwWjIgg3DmM5xfAGWLoz6RjmesFHWuqWwXldLEUFowHgBmxUycdVwz3LP5IgvYEcOZulyRlvxkmUv7R8eExf7TvNdmdnu2KTdkWAY8Vw/U5T3ZpUBEVvG8G2tmn1wQBP7/jx7bps4a7M1M80sfhli+dpYaEZP4VEdRakE/Yngdr8Y2eDBPGM2EtuhQZKUdt1qPNIY78mZjvel0Y8s4G3GEbCHKS2bo082VqHE0Z1SyRipSq5+UGdkhgxTOEjk1SdEHY2Otw90tKSvaT4qSRpZIiAS/AbLjBPBM7nRJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"FiberRootNode\" title=\"FiberRootNode\" src=\"/static/1d082036557ede9ed154c0ce38e680a1/2ff8c/FiberRootNode.png\" srcset=\"/static/1d082036557ede9ed154c0ce38e680a1/0780f/FiberRootNode.png 198w,\n/static/1d082036557ede9ed154c0ce38e680a1/47b26/FiberRootNode.png 395w,\n/static/1d082036557ede9ed154c0ce38e680a1/2ff8c/FiberRootNode.png 521w\" sizes=\"(max-width: 521px) 100vw, 521px\" loading=\"lazy\">\n    </span>\n  <figcaption>root&#xC758; &#xC18D;&#xC131;</figcaption>\n</figure>\n<p>current의 <code class=\"language-text\">return</code>을 보면 null임을 확인할 수 있습니다. VDOM의 최상단이기 때문이며 root는 stateNode를 통해 가리키고 있습니다.</p>\n<blockquote>\n<h3 id=\"statenode\"><a href=\"#statenode\" aria-label=\"statenode permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>stateNode</h3>\n<p>호스트 컴포넌트의 stateNode는 DOM에 삽입된 html element를 가리키는 반면에 개발자가 작성한 커스텀 컴포넌트의 stateNode는 null입니다. DOM에 마운트되는게 아니기 때문이며 특별히 host root만 DOM에 마운트 되지 않아도 root를 가리키도록 되어있습니다.</p>\n</blockquote>\n<p>이제 본격적으로 다음의 간단한 Todo list 예제를 VDOM에 대입해보며 VDOM과 익숙해져 보겠습니다.</p>\n<anchor id=\"todo\">\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> submit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>input value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>button\n        onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">></span>\n        submit\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">OrderList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> list <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ol<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ol<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Todo <span class=\"token operator\">/</span><span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1 id=\"4-트리-구조\"><a href=\"#4-%ED%8A%B8%EB%A6%AC-%EA%B5%AC%EC%A1%B0\" aria-label=\"4 트리 구조 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 트리 구조</h1>\n<blockquote>\n<p>트리에서 root 부분은 생략하고 바로 App부터 작성하도록 하겠습니다.</p>\n</blockquote>\n<p>먼저 React element tree의 구조를 보고 VDOM으로 어떻게 변경되는지 확인해 봅시다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.91695501730104%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACi0lEQVQoz22S7UtTYRjG/RdsIvNt8+xszk0zo7f/JyKM0lTsm34JP4UUSWLgl0CKVSCBaKayzTm3qbgdT3NrOJ2uqXufTtvL2cvVfc4JS+iBi+fhfp7nx3W/1FSrVfxv5fN58DwPn88Hp9MJu90OjuOwarPh9Ozs8l0umUAyfIj06SlyuRxqxODc7DxeTUzgzdQUXr+dxMvxcbwYG8Pz0VEEgkHkSwIy2TPkikVckBJHEfjNywh7tlAVBJxnMkimUshmszLwwcPHqGtl0KLXQalR41pzExSk2sYGLK9YJSfFShnlSgViPumTY7i/zCBgW0GFYv8uCdg30A9Gr0f3vbsw3uxGe/cNdNy+BR3tZsea9LBALgvlEsTv6UQc/sUF7NOdUCpJ9yJYLJ8EfNo3CJVKjc4OI/RaDVhWAw3LopVhYFm1Sa5+CUWU6YNA2t/aBD83i52FecT2ghJQhF0CnwwMoq2rkxzeQXvXdegNelI7WHLtcLnkJpETsYa5i3PEgruIbHtw5OWRpnoWqYFXgI96e8Gom2A0GqAmZ0xbGxidDiotC6vLeVmfaDyG9U8m8DOf4f74Aa7pd9h4P40dh10qxV+HBGxUqcASSKPVyiJgK2lpzS6PB7mLH4QQpnQPSOlolOon4MT7HcnQvuyQ6igB+weeEYRFFzVEZzBAR6lqSSLYapeBRdLejhfeFQv85CiTTKJMsdDmOmKBH1e7fL+nB4qWJjTT2CgalKhTKqEg1dbXY9FiQYQcBF0ORHhOmr29jXWk43EpzUPOgyjnxoFzDSkaJwloMpkwNDSEkZERDA8Py/ufc2B3FyGPGxx11b/0DdvUWW7xK44jP1GgFH1WM4LmJXgpnqDYbwd4pYiJCeSlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"react element tree\" title=\"react element tree\" src=\"/static/2e4121db1459e29f83f309f0fa55b5e4/c94d1/react_element_tree.png\" srcset=\"/static/2e4121db1459e29f83f309f0fa55b5e4/0780f/react_element_tree.png 198w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/47b26/react_element_tree.png 395w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/c94d1/react_element_tree.png 790w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/9e288/react_element_tree.png 1185w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/35b34/react_element_tree.png 1445w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>특별한 부분은 없으므로 바로 VDOM으로 넘어가겠습니다.</p>\n<anchor id=\"VDOM\" />\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.08575380359613%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz21SDY+aQBDl//+KJqa9xLRJ07R6UQ/16tcpoOIpwikKCigItoeod368DqumXnsvmexmMvve7Jvh1gsPi4mJYLnEer3GNcrlMkRRRKVSQSaTAc/z7I7j3xovfIbpuTjs9yzNHV9fsSKyxWKBiAhDOtViHoZQRxiG2Gw2TCiKInbuqN6iJtJiA43BE6LtBrppYDwaIQgCIsRbhJ6H5rev6Bd4pvoeHN9HqlFFXVOoZofo2SeyJVarkAiPR8RxOBxY8erXEkrmFk/3RWy2W5a71MQRYxb4SBRyyLWl/8S468IYptxGJ/Ud3dsUHE09EZ7F1iRQVVXk5CbG9gSCqoBv1VDqKxjPZ28J97sdXsgjTx9i2pJgd9rwyZsX8vAiuI5C5FsCCrIE33WgGgbSwgOyYg2aNT0RXr66pMHUPyfR/pKElLxBNfEBjU8JyLGXxFfudfHxZ5511ifRm2IWkq6jPzHQIC9jxFyMMI6AFEyanCEKCGybdTxTenAHGvuy4c4hU8dzErZocD3Lgj6zMZmNYdpDojsNkLt4NyUfFP4O2n0Bv89+mERud+R3J72k/TMcA64/h+PZGFsjNizOUvuw6aH7KMMm78a0fwvHZo+s3iPcdhOTeg3edMJyu/MqifoAJbJBol0sUl1J6UKgHKfVH9BJ/4B2l2GTje/OSGeP+rQ6Qz7L8rNzLrbneiv+xR+O4i8sOl/+vQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"fiber tree\" title=\"fiber tree\" src=\"/static/9b78c3f6f60939e0dc886845b74cb49c/c94d1/fiber_tree.png\" srcset=\"/static/9b78c3f6f60939e0dc886845b74cb49c/0780f/fiber_tree.png 198w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/47b26/fiber_tree.png 395w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/c94d1/fiber_tree.png 790w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/9e288/fiber_tree.png 1185w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/c4e1e/fiber_tree.png 1446w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>마찬가지로 <code class=\"language-text\">Fragment</code>가 사라진 부분을 제외하고는 특별한 부분은 없습니다.  </p>\n<p>Fragment는 포장지 역할만 하기 때문에 Fiber로 변환될 때 Fragment를 벗겨내고 자식들을 얻어와 fiber로 확장합니다. 하지만 Fragment도 React element이므로 key를 설정할 수 있습니다. 이 key가 설정된 Fragment는 단순한 포장지 역할을 넘어서 개발자가 의도적으로 컴포넌트를 판별하기 위한 장치로 사용되므로 제거하지 않고 Fragment fiber로 만듭니다. key가 설정되어 있는 Fragment만 <a href=\"#createFiberFromTypeAndProps\">createFiberFromTypeAndProps()</a>의 39라인에 도달할 수 있습니다. 이 부분은 나중에 코드로 확인합니다.</p>\n<blockquote>\n<p>만약 Fragment를 다음과 같이 정의했다면 Todo 컴포넌트 자식으로 Fragment가 살아있었을 것입니다.<br>\n&#x3C;Fragment key=“foo”></p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.08575380359613%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABwklEQVQoz42S2W7aYBSE/f6XfYGoN71qVTVSUFMRWpXVFMIW2xBcNoPBDjaLwTaL+WoMRCSlSkcaHV/MmX+OxkLTGDGbz9kFAbvdjteQJIlUKoUoisiyzCWcdvcUJs6E/kBjqA/ZbjaUfqt8Ld/TNoxI7HoeXkQ3mvs3u0qSZvELj4VrptbwhangLRxs22JsWaxWPuVWi5tfaTrmKFTxV+q1v0RrZFDLt6jVOFOzE2mCo1bYi4LQ/YRcXeL9jzhqmPocupqnEn+HVk8y1uvIqSvalRjuck4jfYUm30U64WQ2GI9J1KpklCp90yBREkk+lBGbjziuy3JmYvQeWMzHOLMnRj0Ja9RivfJ40iSmhkqw3RwS7tEZdIkVRCpNhbk1Jh0W8K2Q5Xu1hB2W9i8o2Q/0GllatTsa+Y9hKaH4cy7DTbg8nU5I3Of5lEvSNU1+1kIzx4kWt9vtizaD6Dtg5S+ilGvfDaeL4PoektZDHvSxZzMa4VR0nc5Qo95RsCfG8d/g2eycryFcOqNn6Fi2gfF0mK1+m9Vme/C9YHpO4RT/VI6/XnNdyFPvdbktlyiqTWKl4vPpwf8YvnXGMdqb6fb8A3EjQgw3LaplAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"dom tree\" title=\"dom tree\" src=\"/static/914819c7e9cfda3169682706ca97475a/c94d1/dom_tree.png\" srcset=\"/static/914819c7e9cfda3169682706ca97475a/0780f/dom_tree.png 198w,\n/static/914819c7e9cfda3169682706ca97475a/47b26/dom_tree.png 395w,\n/static/914819c7e9cfda3169682706ca97475a/c94d1/dom_tree.png 790w,\n/static/914819c7e9cfda3169682706ca97475a/9e288/dom_tree.png 1185w,\n/static/914819c7e9cfda3169682706ca97475a/c4e1e/dom_tree.png 1446w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>VDOM을 DOM에 적용할 때는 html element에 대응하는 호스트 컴포넌트만 마운트됩니다.<br>\n개발자가 작성한 커스텀 컴포넌트는 React element를 반환하는 <strong><u>상태를 가진 콜백 함수</u></strong> 그 이상 그 이하도 아닙니다.  </p>\n<p>자 이제 사전준비는 모두 끝났습니다. 본격적으로 재조정 작업을 시작해 봅시다.</p>\n<h1 id=\"5-sync-work-async-work\"><a href=\"#5-sync-work-async-work\" aria-label=\"5 sync work async work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Sync <strong>Work</strong>, Async <strong>Work</strong></h1>\n<p><strong>Work</strong> 콜백을 스케줄링시켰던 <a href=\"/react/in-depth-react-scheduler_1/#ensureRootIsScheduled\" target=\"_blank\">ensureRootIsScheduled()</a> 기억하시나요? 이때 여러 상황을 고려하여 재조정 작업을 비동기로 처리해야 할지 동기적으로 처리해야 할지 결정했습니다. 이 결정에 따라서 사용된 콜백이 각각 performConcurrentWorkOnRoot()와 performSyncWorkOnRoot()입니다.</p>\n<blockquote>\n<p>비동기 작업에 대한 분석은 performConcurrentWorkOnRoot()의 초입부분 까지만 진행하고 이 이후로는 동기 작업에 대해서만 분석하도록 하겠습니다.</p>\n</blockquote>\n<h2 id=\"5---1-async-work\"><a href=\"#5---1-async-work\" aria-label=\"5   1 async work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5 - 1 Async <strong>Work</strong></h2>\n<p>비동기 작업에 대해 지난 포스트에서 언급만 하고 아직 코드로 확인하지 못했던 부분이 있었습니다. 바로 <strong>scheduler</strong>에게 잔여작업이 있는지 알려주는 <a href=\"/react/in-depth-react-scheduler_2#work_loop\" target=\"_blank\">부분<up>22번 라인</up></a>입니다.  </p>\n<p>performConcurrentWorkOnRoot()를 통해 확인해볼 텐데 이 부분을 제외하고는 performSyncWorkOnRoot()와 로직이 같으므로 중복되는 것은 동기 작업을 분석할 때 설명하도록 하겠습니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L631\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> didTimeout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 처리해야 될 expirationTime을 가지고 온다.</span>\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> <span class=\"token function\">getNextRootExpirationTimeToWorkOn</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">!==</span> NoWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> originalCallbackNode <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>callbackNode<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/*...*/</span>\n\n    <span class=\"token comment\">/* Render phase 진입.. */</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* 작업 중단에 따른 처리.. */</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* Commit phase 진입.. */</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 각 phase 진행 과정에서 추가적인 업데이트가 발생할 경우를 대비한 스케줄링 요청</span>\n    <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token operator\">===</span> originalCallbackNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 해당 root에는 잔여 작업이 남아 있으므로 root를 잡아논 Work 콜백을 반환한다.</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">root.callbackNode</code><up>18</up>는 Commit phase<up>14</up>를 지나면 null로 초기화됩니다. null이 아니라는 건 아래의 코드에서 <strong>Work</strong>를 진행하다 중지된 겁니다. </p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1462\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Perform work until Scheduler asks us to yield</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>while 문이 중지되었다면 <code class=\"language-text\">workInProgress</code>는 비어있지 않을 것<up>11</up>이므로 Commit phase<up>14</up>에 도달하지 못해 callbackNode<up>18</up>는 초기화되지 않습니다.  </p>\n<p>그리고 한 가지 더 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L552\" target=\"_blank\">ensureRootIsScheduled()</a><up>17</up>를 실행했는데도 root가 가지고 있는 callbackNode<up>Task</up>가 현재 <strong>Work</strong>를 진행한 originalCallbackNode<up>6</up>와 같다는 건<up>18</up> 현재 originalCallbackNode가 가장 우선순위가 높음을 나타내므로 계속해서 작업을 이어서 진행할 수 있다는 뜻입니다.  </p>\n<p>이 모든 근거를 바탕으로 <code class=\"language-text\">performConcurrentWorkOnRoot()</code><up>20</up>를 반환해 scheduler에게 해당 root에 잔여 작업이 남아 있음을 알려줍니다. 이렇게 반환한 <strong>Work</strong> 콜백은 <strong>scheduler</strong>가 다음 프레임에 실행시켜 줄 것입니다.</p>\n<blockquote>\n<p>concurrent mode에 대해서는 자세히 다루지는 않았지만 기반이 되는 몇몇 부분들을 확인해보았습니다. 이번 시리즈에서는 이 이상으로 분석하지는 않지만, 추후에 보편적으로 사용하게 되는 날이 오면 그때 가서 다루어 보도록 하겠습니다.</p>\n</blockquote>\n<h2 id=\"5---2-sync-work\"><a href=\"#5---2-sync-work\" aria-label=\"5   2 sync work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5 - 2 Sync <strong>Work</strong></h2>\n<blockquote>\n<p>async <strong>Work</strong>와는 다르게 해당 <strong>Work</strong>는 한번 실행되면 모든 작업이 끝날때 까지 동기적으로 처리합니다.</p>\n</blockquote>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L977\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Check if there's expired work on this root. Otherwise, render at Sync.</span>\n  <span class=\"token keyword\">const</span> lastExpiredTime <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>lastExpiredTime<span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> lastExpiredTime <span class=\"token operator\">!==</span> NoWork <span class=\"token operator\">?</span> lastExpiredTime <span class=\"token punctuation\">:</span> Sync<span class=\"token punctuation\">;</span></span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">lastExpiredTime</code>는 이전 <strong>Work</strong>가 만료되었을 때 할당되는 시간입니다. 이 부분은 위에서 performConcurrentWorkOnRoot()를 다룰 때 여러분의 이해를 위해 생략했던 부분으로 아래에서 확인해 볼 수 있습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L636\" target=\"_blank\" class=\"code_link_2\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> didTimeout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>didTimeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">requestCurrentTimeForUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">markRootExpiredAtTime</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> currentTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>concurrent mode에서 비동기로 <strong>Work</strong>를 진행하다 만료가 될 경우(<down><a href=\"/react/in-depth-react-scheduler_2/#work_loop\" target=\"_blank\">workLoop()의 20 ~ 22</a></down>) root에 lastExpiredTime이 새겨지고<up>4</up> 다음 프레임에 동기로 처리하기 위해 performSyncWorkOnRoot()를 root에 스케줄링<up>5</up> 시킵니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L554\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">:</span> FiberRoot</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lastExpiredTime <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>lastExpiredTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastExpiredTime <span class=\"token operator\">!==</span> NoWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Special case: Expired work should flush synchronously.</span>\n    root<span class=\"token punctuation\">.</span>callbackExpirationTime <span class=\"token operator\">=</span> Sync<span class=\"token punctuation\">;</span>\n    root<span class=\"token punctuation\">.</span>callbackPriority <span class=\"token operator\">=</span> ImmediatePriority<span class=\"token punctuation\">;</span>\n    root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token operator\">=</span> <span class=\"token function\">scheduleSyncCallback</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>정리하자면 sync work가 실행되는 경우는 두 가지입니다. concurrent -> sync와 처음부터 sync인 경우이며 이때 expirationTime을 구하는 방식이 다르기 때문에 아래 4번 라인이 필요한 것입니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L977\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// const expirationTime = lastExpiredTime !== NoWork ? lastExpiredTime : Sync;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>root <span class=\"token operator\">!==</span> workInProgressRoot <span class=\"token operator\">||</span> expirationTime <span class=\"token operator\">!==</span> renderExpirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">prepareFreshStack</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>if 문<up>6</up>의 의미를 알아보겠습니다.  </p>\n<p>이 부분도 concurrent mode와 연관이 있는데 자바스크립트는 멀티 스레드 환경에서 실행되는 게 아니므로 리액트는 하나의 VDOM에 대한 <strong>Work</strong>만 진행할 수 있습니다. 그래서 <strong>reconciler</strong>가 작업 중인 root를 전역변수 <code class=\"language-text\">workInProgressRoot</code>로 잡아둘 수 있는 것입니다.</p>\n<p>하지만 현재 가장 우선순위가 높은 Task의 <code class=\"language-text\">root</code>가 작업 중이던 workInProgressRoot와 다르다면<up>6</up> <strong>reconciler</strong>의 컨텍스트는 새로운 작업을 진행하기 위해 초기화<up>7</up> 해야 합니다.   </p>\n<p><code class=\"language-text\">expirationTime !== renderExpirationTime</code>도 root와 비슷한 의미로 다른 작업이 더 우선순위가 높아 이전 작업을 초기화 해야 함을 나타냅니다.</p>\n<blockquote>\n<p>VDOM에는 하나의 root만 존재합니다. 이 말인즉슨 root가 다르다는 의미는 ReactDOM.render()를 통해 만들어진 다른 VDOM에서 발생한 작업이 더 우선순위가 높다는 말입니다. 그래서 새로운 VDOM root에 재조정 작업을 진행하기 위한 작업용 트리를 만드는 함수가 <code class=\"language-text\">prepareFreshStack()</code>입니다.</p>\n</blockquote>\n<blockquote>\n<p>renderExpirationTime는 초기에는 noWork<up>0</up>입니다. 만약 맨 처음으로 performSyncWorkOnRoot()가 호출되는 경우 if문<up>6</up>은 true일 것이고(<down>expirationTime  !== noWork</down>) 재조정 작업 전에 항상 초기화될 것입니다.  </p>\n</blockquote>\n<p><code class=\"language-text\">prepareFreshStack()</code>은 current의 최상단 노드인 host root를 복제하여 workInProgress tree의 host root를 만듦과 동시에 <strong>reconciler</strong>의 컨텍스트 변수들을 초기화합니다.</p>\n<anchor id=\"prepareFreshStack\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1236\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareFreshStack</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> expirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  root<span class=\"token punctuation\">.</span>finishedWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> \n  root<span class=\"token punctuation\">.</span>finishedExpirationTime <span class=\"token operator\">=</span> NoWork<span class=\"token punctuation\">;</span>\n\n  workInProgressRoot <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span>\n  workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  renderExpirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n  workInProgressRootExitStatus <span class=\"token operator\">=</span> RootIncomplete<span class=\"token punctuation\">;</span>\n  workInProgressRootFatalError <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  workInProgressRootLatestProcessedExpirationTime <span class=\"token operator\">=</span> Sync<span class=\"token punctuation\">;</span>\n  workInProgressRootLatestSuspenseTimeout <span class=\"token operator\">=</span> Sync<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<anchor id=\"createWorkInProgress\" />\n<p>workInProgress를 만들 때 매번 새로운 객체로 만들어내지 않습니다. 재조정 작업은 매우 반복적으로 발생하는 작업입니다. 그래서 매번 객체를 만들어 리소스를 낭비하지 않고 기존에 만들어진 객체를 재활용하고 속성만 초기화합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> workInProgress <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 새로 생성</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>\n      current<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">,</span>\n      pendingProps<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>elementType<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n\n    workInProgress<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span>\n    current<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 재활용</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 기존 객체에서 재활용 하지 못하는 속성들은 초기화 해준다.</span>\n    workInProgress<span class=\"token punctuation\">.</span>pendingProps <span class=\"token operator\">=</span> pendingProps<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> NoEffect<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// current와 workInProgress가 공유하는 속성들</span>\n  workInProgress<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>childExpirationTime<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">;</span>\n\n  workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n\n  workInProgress<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>ref <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>ref<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이쯤에서 한 가지 여러분에게 상기시켜 드릴 부분이 있습니다.  </p>\n<p>현재 위치는 재조정 작업을 진행하기 전 시작 위치이며 최상단 current을 복제한 workInProgress<up>host root</up>를 만들었습니다. 여기까지만 놓고 봤을 때 컴포넌트의 상태가 변하면 항상 host root부터 시작한다는 걸 어림짐작할 수 있습니다. 깊이가 깊은 자식의 상태 값이 바뀌어도 항상 host root부터 시작하여 자식까지 workInProgress 트리를 만들어 가게 됩니다.</p>\n<blockquote>\n<p>❗ workInProgress 트리만 만든다는 것이지 host root부터 자식까지 컴포넌트을 호출하는게 아님을 유의하세요.</p>\n</blockquote>\n<p>prepareFreshStack()이 실행된 후 VDOM의 상태는 다음과 같습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 586px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.116040955631405%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB0klEQVQoz5WSy27TQBSG846wYFMkHqCvwYbuWSAVIVVs6AKQskACpAoEaoqKmkSkSk3u8SV17GCPPfZc/HM8tgshlVDH+jUjz+g7/7m0iqJAKZQ7AEWSpPLc3O2ovm/W33etBlaCnPMOuq+O0D9+CW84MI91oUiyljb/guEQ69EIYRQhTdMtaKs5aIoZzgJYn3qwz0eI/LgKrxq7tXVa7uwJ7Nlz+OsMnmuDc34DrRwSLhXA2DlEp/cQP5f7mIdf4fgbTC8PMOjew9XgPoJ5u3yKmHnYbDx43gq2vYTv+/+kXAIpumsfovv9AcaXewQ7QbDJMBk+w2lnD72LR1gv3hnHUgpElO50OsViucBkMkGWZcblTQ1zVcByIpz0RzizHNgES3MBzihyVqdb7lohkhJhwnC9Whl3SZLs1jCXBT70L/D0fRsvvnzEqWVREG3cVxVWKOre8jACC3/BcV24pDiOIYTYdphRKhFLcDW2YDtzcqegqtnZGRmIHCrPwMgZY8wApZR/gOUnyOHbb2d4/PoYB+03+PxjUHdO3zqHt62tOeQE5FQzx3cRhCuwXELoYtfhf1R3mVKWGoKOUcIRk3jZTV3d3RnYSGpt6mak7wZq9BuhCZjgovPNLwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"prepare fresh stack\" title=\"prepare fresh stack\" src=\"/static/ebe6186ba40a6583c9e3d095d10dcec5/77b8d/prepare_fresh_stack.png\" srcset=\"/static/ebe6186ba40a6583c9e3d095d10dcec5/0780f/prepare_fresh_stack.png 198w,\n/static/ebe6186ba40a6583c9e3d095d10dcec5/47b26/prepare_fresh_stack.png 395w,\n/static/ebe6186ba40a6583c9e3d095d10dcec5/77b8d/prepare_fresh_stack.png 586w\" sizes=\"(max-width: 586px) 100vw, 586px\" loading=\"lazy\">\n    </span>\n<blockquote>\n<p>root node fiber === host root</p>\n</blockquote>\n<p>이렇게 작업용 VDOM의 entry를 만들었습니다.   </p>\n<p>다음 포스트에서는 본격적으로 Render phase에 진입하여 <strong>Work</strong>를 진행합니다. 이 과정에서 VDOM 탐색은 어떤 방식으로 구현되어있는지, 업데이트 컴포넌트를 어떻게 찾아내는지, 재조정 작업은 무엇인지 등을 확인하게 됩니다.</p>","frontmatter":{"title":"React 톺아보기 - 05. Reconciler_1","date":"2020-10-11","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-reconciler_1/","previous":{"fields":{"slug":"/react/in-depth-react-scheduler_2/"},"frontmatter":{"title":"React 톺아보기 - 04. Scheduler_2","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_2/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_2","category":"react"}}}}}