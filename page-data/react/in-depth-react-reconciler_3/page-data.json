{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_3/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"ba850fdd-61e2-5e5c-bd9b-1e6233fb55eb","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 6 - 6 reconcileChildren 1) ChildReconciler fiber 확장과 관련된 일련의(추가, 삭제..) 함수들이 존재합니다. 이 함수들은 fiber의 상태에 따라서 로직의 경로가 조금씩 다른데 이때의 상태란 fiber…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.22036168787676%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQoz4VS2W6DQBDj//8oH4AapEb5hR5qI+UAws0e43qGbkvVpH2wdgDb65khExEIsEBr0QooqwqbzQYP2y0edzvkeY79fo+iKFBfr8a5pc2sCGFBMowRbp5RlSXqukZTV6jLC7q25VnCDQOgfPLE+0WrdTKMTbPAOUQaxa6FtA3gHYUeGPoF0wjeAjkfEXhGGsfzidorjZ0lzSwujYRGXgkUaW3PfYdZDdxsF40Ue6aUaSK3RxgH+yaq0ZRmuJoD0jwSSIoUY/XNkr0+Q05HHdxP/tcM/4Bn+zoCa6vrEDhLd3iDu5wR+h7CroRp0w7uG663N46LiIiamu8j3wemDC9PiId3G8N3y7fA+eiiNJWlGD+hC9MF6WW62bThf1tO5HswHn79hx/bZsBJOgJy5wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"render phase flow\" title=\"render phase flow\" src=\"/static/ea0101d7212866b4c6776ee262f8160e/c94d1/render_phase_flow.png\" srcset=\"/static/ea0101d7212866b4c6776ee262f8160e/0780f/render_phase_flow.png 198w,\n/static/ea0101d7212866b4c6776ee262f8160e/47b26/render_phase_flow.png 395w,\n/static/ea0101d7212866b4c6776ee262f8160e/c94d1/render_phase_flow.png 790w,\n/static/ea0101d7212866b4c6776ee262f8160e/9e288/render_phase_flow.png 1185w,\n/static/ea0101d7212866b4c6776ee262f8160e/624a3/render_phase_flow.png 1493w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<h2 id=\"6---6-reconcilechildren\"><a href=\"#6---6-reconcilechildren\" aria-label=\"6   6 reconcilechildren permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 - 6 reconcileChildren</h2>\n<h3 id=\"1-childreconciler\"><a href=\"#1-childreconciler\" aria-label=\"1 childreconciler permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) ChildReconciler</h3>\n<p>fiber 확장과 관련된 일련의(<down>추가, 삭제..</down>) 함수들이 존재합니다. 이 함수들은 fiber의 상태에 따라서 로직의 경로가 조금씩 다른데 이때의 상태란 <em>fiber가 새로 생성되어 마운트되어야 하는지</em>  혹은 <em>업데이트된 것인지</em>를 나타냅니다. 이 함수들은 매우 빈번하게 호출되므로 리액트는 컴파일러의 최적화에 도움을 주기 위해 경로가 다른 함수들을 다음과 같이 미리 분리하여 사용되도록 하였습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L258\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">shouldTrackSideEffects</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 삭제</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 마운트</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 추가, 위치 이동</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 마운트</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// React element를 fiber로 확장</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> reconcileChildFibers<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// flag를 통해 마운트, 업데이트용 함수를 미리 나눠둠.</span>\n<span class=\"token keyword\">const</span> reconcileChildFibers <span class=\"token operator\">=</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> mountChildFibers <span class=\"token operator\">=</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>마운트의 경우 <code class=\"language-text\">shouldTrackSideEffects</code>는 false이며 업데이트는 true입니다. 위 함수들은 reconcileChildren()에서 아래와 같이 사용됩니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberBeginWork.js#L210\" target=\"_blank\">reconciler > ReactFiberBeginWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"> \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  nextChildren<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  renderExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">mountChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ChildReconciler()<up>mountChildFibers, reconcileChildFibers</up>를 분석하기에 앞서 <em>재조정</em>에 대해 잠깐만 언급한 후 넘어가도록 하겠습니다.</p>\n<p>재조정 작업의 목적은 VDOM 트리에서 변경이 발생한 부분을 효과적으로 비교하여 새로운 트리를 만들어내는 것입니다. 이때 효과적이란 최소한의 연산을 뜻하는데 리액트는 어떻게 이 부분을 처리하였는지 <a href=\"https://ko.reactjs.org/docs/reconciliation.html\" target=\"_blank\">공식홈페이지</a>에서 자세히 설명하고 있으므로 한번 읽고 오시면 진행하는 데 많은 도움이 될 것 같습니다.<br>\n아래는 그 일부분을 발췌한 내용입니다.</p>\n<blockquote>\n<p>두 가지 가정에 기반을 두어 O(n) 복잡도의 휴리스틱 알고리즘을 구현했습니다.</p>\n<ol>\n<li>서로 다른 type의 두 엘리먼트는 서로 다른 트리를 만들어낸다.</li>\n<li>개발자가 key prop을 통해, 여러 렌더링 사이에서 어떤 자식 엘리먼트가 변경되지 않아야 할지 표시해 줄 수 있다.</li>\n</ol>\n</blockquote>\n<p>핵심은 React element를 fiber로 확장할 때 <em>current를 재사용할 수 있는지</em> 또는 <em>새로운 fiber를 만들어 내어야 하는지</em>  이 두 가지의 선택지에서 어떠한 근거를 가지고 선택하느냐입니다.</p>\n<p>앞으로의 내용은 이것을 어떻게 코드로 작성하였는지 분석하는 내용이 될 것입니다.</p>\n<h3 id=\"2-reconcilechildfibers\"><a href=\"#2-reconcilechildfibers\" aria-label=\"2 reconcilechildfibers permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) reconcileChildFibers</h3>\n<p>ChildReconciler()는 reconcileChildFibers()를 반환합니다. 이 함수는 컴포넌트를 실행하여 반환받은 newChild의 타입에 맞게 재조정 함수로 라우팅하는 역할을 합니다.<br>\nnewChild에는 React element, text, 복수의 자식을 가진 배열이 올 수 있습니다.</p>\n<anchor id=\"reconcileChildFibers\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L1246\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">,</span> newChild<span class=\"token punctuation\">,</span> expirationTime</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// key가 없는 Fragment</span>\n  <span class=\"token keyword\">const</span> isUnkeyedTopLevelFragment <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isUnkeyedTopLevelFragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newChild <span class=\"token operator\">=</span> newChild<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> isObject <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// React element</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span>\n          <span class=\"token function\">reconcileSingleElement</span><span class=\"token punctuation\">(</span>\n            returnFiber<span class=\"token punctuation\">,</span>\n            currentFirstChild<span class=\"token punctuation\">,</span>\n            newChild<span class=\"token punctuation\">,</span>\n            expirationTime<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">/*...*/</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// text</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">reconcileSingleTextNode</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        currentFirstChild<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">''</span> <span class=\"token operator\">+</span> newChild<span class=\"token punctuation\">,</span>\n        expirationTime<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 복수개의 자식을 담고 있는 배열</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n      returnFiber<span class=\"token punctuation\">,</span>\n      currentFirstChild<span class=\"token punctuation\">,</span>\n      newChild<span class=\"token punctuation\">,</span>\n      expirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Remaining cases are all treated as empty.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>복수의 자식들은 배열에 담기므로 newChild가 배열이 아니라면 단일 자식임을 알 수 있습니다. </p>\n</blockquote>\n<ul>\n<li>4 ~ 11: key 설정이 되지 않은 fragment를 처리하고 있습니다.<br>\n이전에 Todo를 VDOM과 매칭시켰던 <a href=\"/react/in-depth-react-reconciler_1/#VDOM\" target=\"_blank\">이미지</a> 기억하시나요? 이때 VDOM에는 fragment가 존재하지 않았습니다. 그 이유는 key가 없는 fragment는 하위 컴포넌트를 묶어주는 용도로만 사용되므로 굳이 fiber로 만들 필요가 없기 때문입니다.<br>\n자식을 props에서 꺼내<up>10</up> 재조정을 진행하므로 fragment는 VDOM에는 존재하지 않게 됩니다.</li>\n<li>27: text는 호스트 컴포넌트 하위에 있는 text와는 다르게 fiber로 만들어 주는 걸 확인할 수 있습니다.</li>\n<li>20, 27: 재조정 작업을 통해 반환된 fiber를 <code class=\"language-text\">placeSingleChild()</code>가 받아 placement side-effect tag를 달아 주어야 하는지 판단합니다.</li>\n</ul>\n<h4 id=\"placesinglechild\"><a href=\"#placesinglechild\" aria-label=\"placesinglechild permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>placeSingleChild</h4>\n<blockquote>\n<h3 id=\"side-effect\"><a href=\"#side-effect\" aria-label=\"side effect permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>side-effect</h3>\n<p>VDOM 입장에서는 트리에 변경 점을 불러오는 모든 행위가 side effect입니다. 그러므로 재조정 작업은 side-effect를 낳는다고 생각할 수 있습니다.\n커스텀 컴포넌트 호출 또한 side-effect에 해당하므로 다음과 같이 tag를 설정해주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> nextChildren <span class=\"token operator\">=</span> <span class=\"token function\">renderWithHooks</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nworkInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> PerformedWork<span class=\"token punctuation\">;</span></code></pre></div>\n<p>fiber에 새겨진 tag는 Commit phase에서 실제 DOM을 조작할 때 사용됩니다.</p>\n</blockquote>\n<anchor id=\"placeSingleChild\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L361\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">newFiber<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      shouldTrackSideEffects <span class=\"token operator\">&amp;&amp;</span> \n      newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> newFiber\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>current가 존재하는 상황<up>4</up>에서 newFiber의 alternate가 null<up>5</up>이라는 것은 반환된 컴포넌트가 이전 컴포넌트와 type 또는 key가 달라 fiber를 새로 생성하였음을 뜻합니다. 그러므로 새로 만들어진 newFiber로 갈아 끼우기 위해 Placement tag를 달아줍니다.  </p>\n<p>다음은 React element, text, array가 어떻게 재조정을 거치는지 확인하겠습니다.</p>\n<h3 id=\"3-reconcilesingleelement\"><a href=\"#3-reconcilesingleelement\" aria-label=\"3 reconcilesingleelement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3) reconcileSingleElement</h3>\n<p>fiber를 만들어낼 때 가장 먼저 해야 할 일은 기존 fiber를 재사용할 수 있느냐를 판단하는 겁니다. 이는 매우 중요합니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L1132\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileSingleElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  currentFirstChild<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  element<span class=\"token punctuation\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>key\n  <span class=\"token keyword\">let</span> child <span class=\"token operator\">=</span> currentFirstChild\n\n  <span class=\"token comment\">// newChild와 매칭되는 current를 찾는다.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        child<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> Fragment\n          <span class=\"token operator\">?</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span>\n          <span class=\"token punctuation\">:</span> child<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// current 재사용</span>\n        <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>\n          child<span class=\"token punctuation\">,</span>\n          element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span>\n            <span class=\"token operator\">?</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n            <span class=\"token punctuation\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n          expirationTime\n        <span class=\"token punctuation\">)</span>\n        existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n        <span class=\"token keyword\">return</span> existing\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    child <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 새 fiber 생성..</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>12, 37: current를 재사용하기 위해서는 현재 처리하고 있는 React element에 매칭되는 current가 필요합니다. 하지만 같은 depth에 여러 형제가 존재할 수도 있습니다. while 문은 이 복수의 자식 중 현재 element와 매칭되는 current가 있는지 찾고 있는 것입니다. 재사용하기 위해서요.<br>\n만약 매칭되는 current가 없다면 fiber를 새로 만들 것이고 이렇게 되면 하위 트리들은 모두 current가 존재하지 않게 됩니다. 즉 자연스럽게 하위 트리를 새롭게 재구축하게 될 것입니다.</li>\n<li>\n<p>13, 35: key가 다르다면 우리가 찾는 fiber가 아니며 해당 자식은 삭제되어야 함을 나타내므로 제거해줍니다.</p>\n<blockquote>\n<p>다시 말씀드리지만 reconcileSingleElement()는 해당 depth에 단일 자식만 위치할 것임을 나타냅니다. 그러므로 지금 처리되고 있는 element와 매칭되지 않는 fiber들은 삭제되어야 한다는 걸 알 수 있습니다.</p>\n</blockquote>\n</li>\n<li>16 ~ 17, 31: key가 같아도 type이 다르다면 current를 버리고 다시 만들어야 합니다. 이때 해당 current만 제거하면 안 되고 형제들도 다 같이 제거해야 합니다. 해당 depth에는 단일 fiber만 위치할 것이고 재사용하지는 못하지만 이미 매칭되는 current를 찾았기 때문에 더 이상 while 문을 진행할 필요가 없습니다.</li>\n<li>\n<p>19: 우리가 원하던 current를 찾았다면 라인 31 처럼 current ‘이외’의 모든 fiber를 지워줍니다.</p>\n<blockquote>\n<p>deleteRemainingChildren()<up>19</up>의 두번 째 인자로 current의 형제를 넘겨주고 라인 30의 경우 current를 넘겨주는 걸 인지하시길 바랍니다.</p>\n</blockquote>\n</li>\n<li>21 ~ 27: key, type이 모두 같다면 해당 current를 재사용하여 연산을 최소화할 수 있습니다. 이때 딱 한 가지 current의 데이터가 아닌 반환된 element의 데이터를 사용해서 workInProgress를 만들어야 하는 것이 있습니다. 바로 부모에게 받은 props입니다. 자식이 재조정 작업 중이라는 건 부모가 업데이트되어 재호출되었다는 뜻으로 부모가 넘겨주는 props 또한 변경될 수도 있음을 나타냅니다.</li>\n<li>28: current를 재사용 했기 때문에 현재 return은 current의 부모를 가리키고 있습니다. workInProgress tree의 부모를 가리키도록 수정해줍니다.</li>\n</ul>\n<p>삭제 부분을 먼저 보도록 하겠습니다.</p>\n<h4 id=\"deleteremainingchildren-deletechild\"><a href=\"#deleteremainingchildren-deletechild\" aria-label=\"deleteremainingchildren deletechild permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deleteRemainingChildren(), deleteChild()</h4>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L280\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> currentFirstChild</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 마운트 환경이라면 current가 없음을 뜻하며</span>\n    <span class=\"token comment\">// 없다면 애초에 지울 것도 없으므로 빠져나간다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> childToDelete <span class=\"token operator\">=</span> currentFirstChild\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>childToDelete <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> childToDelete<span class=\"token punctuation\">)</span>\n    childToDelete <span class=\"token operator\">=</span> childToDelete<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>넘겨받은 currentFirstChild 부터 시작하여 모든 형제를 삭제<up>deleteChild()</up> 해줍니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L259\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> childToDelete</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// deleteRemainingChildren()와 동일</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">.</span>lastEffect\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    last<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> childToDelete\n    returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> childToDelete\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> childToDelete\n  <span class=\"token punctuation\">}</span>\n  childToDelete<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  childToDelete<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Deletion\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>이제 fiber가 가지고 있는 여러 <a target=\"_blank\" href=\"/react/in-depth-react-intro#FiberNode\">정보</a>들에 대한 지식이 생겼으므로 fiber를 좀 더 넓은 개념으로서 생각해볼 수 있습니다. 이를 위해서 <a href=\"https://ko.wikipedia.org/wiki/%EB%8D%95_%ED%83%80%EC%9D%B4%ED%95%91\" target=\"_blank\">Duck typing</a>에 대한 기억을 끄집어낼 필요가 있습니다.</p>\n<p>fiber를 Duck typing에 빗대어 설명하자면 fiber는 VDOM 노드이면서 effect입니다. 왜냐면 VDOM 노드가 가지고 있어야 할 속성(<down>return, sibling, child, index..</down>)과 side effect 처리에 필요한 속성(<down>tag, stateNode<up>html element</up>, updateQueue<up>effect life cycle</up></down>)들을 모두 가지고 있기 때문입니다. 또한, effect collection(<down>nextEffect, firstEffect, lastEffect</down>)입니다.</p>\n</blockquote>\n<p>이 effect<up>fiber</up>는 추후에 completeUnitOfWork()에서 부모로 전달되는데 이 부분에 대해서는 completeUnitOfWork()를 분석할 때 더욱 자세히 알아보기 위해 생략하겠습니다.</p>\n<p>삭제는 예외적으로 effect를 위로 올리는 시기가 조금 다릅니다. 부모로 전달하기 위해서는 completeUnitOfWork()까지 fiber<up>effect</up>가 살아 있어야 하는데 문제는 삭제되는 fiber는 새롭게 만들어지는 fiber로 대체되기 때문에 지금 말고는 접근할 수 있는 시점이 없습니다. 그래서 지금 여기서 바로 부모<up>returnFiber</up>로 Deletion tag를 가지고 있는 fiber를 연결하는 겁니다.</p>\n<p>만약 deleteRemainingChildren()를 통해 복수의 자식이 제거되었다면 부모에는 연결 리스트로 삭제된 모든 자식들(<down>deletion tag가 새겨진 effect</down>)이 저장될 것입니다.</p>\n<h4 id=\"usefiber\"><a href=\"#usefiber\" aria-label=\"usefiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>useFiber()</h4>\n<p>current를 재사용하는 useFiber()의 코드는 간단합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L320\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"> \n<span class=\"token keyword\">function</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">fiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> mixed<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> clone <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n  clone<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  clone<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">return</span> clone\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>createWorkInProgress()는 <a href=\"/react/in-depth-react-reconciler_1#createWorkInProgress\" target=\"_blank\">reconciler_1</a> 이미 에서 확인했습니다.<br>\n현재 depth에 존재하는 노드는 자신 하나이므로 위치를 나타내는 index는 0, 형제는 null입니다. index 속성은 복수의 자식이 담겨있는 배열을 재조정할 때 이용됩니다.</p>\n<h3 id=\"4-reconcilesingletextnode\"><a href=\"#4-reconcilesingletextnode\" aria-label=\"4 reconcilesingletextnode permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4) reconcileSingleTextNode</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">reconcileSingleTextNode</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  currentFirstChild<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  textContent<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentFirstChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> currentFirstChild<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>currentFirstChild<span class=\"token punctuation\">,</span> textContent<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n    existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> existing\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n    textContent<span class=\"token punctuation\">,</span>\n    returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    expirationTime\n  <span class=\"token punctuation\">)</span>\n  created<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n  <span class=\"token keyword\">return</span> created\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>text는 key를 가지고 있지 않습니다. 그러므로 첫 번째 current 자식이 text fiber라면<up>8</up> 재사용하고 그렇지 않다면 모두 지워준 후 fiber를 새롭게 만들어 반환합니다.</p>\n<h3 id=\"5-reconcilechildrenarray\"><a href=\"#5-reconcilechildrenarray\" aria-label=\"5 reconcilechildrenarray permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5) reconcileChildrenArray</h3>\n<p>배열에서 발생할 수 있는 변경에는 원소의 추가, 이동, 삭제가 있습니다. reconcileChildrenArray()에서는 변경 점을 최소한의 연산으로 탐색하기 위한 노력이 있으며 코드에서 이 의도와 의미를 알아내는 게 이번 섹션의 목적입니다.</p>\n<p>reconcileChildrenArray()는 두 개의 자료구조를 넘겨받습니다.<br>\ncurrent의 연결 리스트<up>currentFirstChild</up>, 컴포넌트가 반환한 React element를 담고 있는 배열<up>newChildren</up>.  </p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n    returnFiber<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    currentFirstChild<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    newChild<span class=\"token punctuation\">,</span></span>    expirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 두 자료구조를 비교하여 원소들의 추가, 이동, 삭제를 판별하는 로직을 짠다고 합시다.\n어떻게 짜면 효율적일까요? 가장 간단하게는 2 중첩 형태의 완전 탐색을 이용할 수도 있을 것이고 또는 맵으로 변경하여 key와 index로 판별할 수도 있습니다.</p>\n<blockquote>\n<p>이번 섹션에서는 current와 React element를 타겟으로 통칭하여 지칭하도록 하겠습니다.</p>\n</blockquote>\n<p>리액트는 O(n)의 시간복잡도로 판별을 완수합니다. 연결리스트든 배열이든 타겟을 가리키는 커서는 해당 위치를 딱 한 번만 지나가게 된다는 뜻이며 이때 사용되는 비교 알고리즘의 핵심은 fiber의 key와 원소의 이동입니다.</p>\n<p>양쪽의 타겟들을 비교할 때 최적의 케이스는 current들이 움직이지 않고 element 배열에서 그 자리에 계속 자리 잡고 있는 것입니다. 이 케이스에서 발생하는 원소의 추가, 삭제는 시간 복잡도에 별다른 영향을 주지 않습니다.<br>\ncurrent가 이동하지 않았다고 가정만 할 수 있다면 커서의 전진만으로 타겟의 key와 type를 이용하여 추가, 삭제를 손쉽게 판단할 수 있기 때문입니다.  </p>\n<p>하지만 current가 원래 위치에 없을 때는 이야기가 다릅니다. element 배열을 모두 탐색하지 않는 한 해당 타겟의 이동, 삭제를 판단할 수 없습니다. 이때는 완전 탐색을 이용할 수도 있지만 그렇게 하지는 않고 공간 복잡도를 올리고 시간 복잡도를 내리는 선택을 합니다. current 연결 리스트를 맵으로 변환하여 key 또는 index를 이용하여 current를 찾아내는 방식으로 말이죠.</p>\n<p>여기서 언급되는 fiber의 key는 타겟의 identity를 판별하는데 사용되므로 매우 중요합니다.<br>\n예를 들어 누가 봐도 고양이 컴포넌트이지만 리액트는 개발자가 사자라고 주장한다면 군말 없이 사자라고 판단합니다. 문제는 key를 설정하지 않아 값이 null일 때 발생합니다. 이 부분은 추후에 코드를 보면서 알아보겠습니다.</p>\n<p>비교 알고리즘의 대략적인 내용은 위와 같고 이제부터 좀 더 세부적인 내용을 확인해 봅시다.</p>\n<anchor id=\"reconcileChildrenArray\" />\n<h4 id=\"1-current가-이동하지-않았을-경우로-가정\"><a href=\"#1-current%EA%B0%80-%EC%9D%B4%EB%8F%99%ED%95%98%EC%A7%80-%EC%95%8A%EC%95%98%EC%9D%84-%EA%B2%BD%EC%9A%B0%EB%A1%9C-%EA%B0%80%EC%A0%95\" aria-label=\"1 current가 이동하지 않았을 경우로 가정 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. current가 이동하지 않았을 경우로 가정</h4>\n<p>먼저 주석과 함께 다음의 코드를 한번 쭉 훑어보세요. current가 이동하지 않았을 경우에 대한 로직이며 블록별 의미를 본인 나름대로 해석해 보시길 바랍니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  currentFirstChild<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  newChildren<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> resultingFirstChild<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">let</span> previousNewFiber<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">let</span> oldFiber <span class=\"token operator\">=</span> currentFirstChild <span class=\"token comment\">// current 커서</span>\n  <span class=\"token keyword\">let</span> lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> newIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">// new child 커서</span>\n  <span class=\"token keyword\">let</span> nextOldFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> oldFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber<span class=\"token punctuation\">.</span>index <span class=\"token operator\">></span> newIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      nextOldFiber <span class=\"token operator\">=</span> oldFiber</span><span class=\"gatsby-highlight-code-line\">      oldFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      nextOldFiber <span class=\"token operator\">=</span> oldFiber<span class=\"token punctuation\">.</span>sibling</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    <span class=\"token comment\">// key가 다르다면 null을 같다면 type을 비교하여 생성 혹은 current를 재사용하여 fiber를 반환</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">updateSlot</span><span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">      returnFiber<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      oldFiber<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      expirationTime</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        oldFiber <span class=\"token operator\">=</span> nextOldFiber</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">break</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">&amp;&amp;</span> newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    <span class=\"token comment\">// fiber에 위치 index를 새기며 이동, 추가의 경우 placement effect tag도 달아줌.</span>\n<span class=\"gatsby-highlight-code-line\">    lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      resultingFirstChild <span class=\"token operator\">=</span> newFiber</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    previousNewFiber <span class=\"token operator\">=</span> newFiber\n    oldFiber <span class=\"token operator\">=</span> nextOldFiber\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>잘 이해 안 된다고 바로 밑으로 내리지 않으셨길 기대하면서 분석을 시작해 봅니다.</p>\n<ul>\n<li>\n<p>16 ~ 21: 위 코드에서는 안 나와 있지만, element가 null일 경우 fiber로 만들지 않고 생략합니다. 그래서 아래 코드의 경우 oldFiber의 index가 newIdx보다 보다 클 수 있습니다.  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> a<span class=\"token punctuation\">{</span> index<span class=\"token punctuation\">:</span><span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>b<span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> b<span class=\"token punctuation\">{</span> index<span class=\"token punctuation\">:</span><span class=\"token number\">0</span> <span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>해당 위치가 null이었다는 걸 VDOM에서는 확인할 수 없으므로 추가로 판별하고 처리<up>18</up>하고 있는 것입니다.</p>\n</li>\n<li>\n<p>23 ~ 39: current의 이동을 판별하고 그에 대한 처리를 합니다.<br>\n<code class=\"language-text\">updateSlot()</code>은 current를 재사용할 수 있으면 재사용을 하고 type이 다르면 fiber을 새로 만들어 줍니다.<br>\nfiber를 반환하는 것 말고도 null을 반환할 수 있는데 key가 다르거나 newChild가 null이면 null을 반환합니다. 29 ~ 34 라인은 null이면 더이상 로직을 진행할 이유가 없어서 입니다.</p>\n<p>null일 경우 최적의 케이스에 대한 로직을 중단하는데 아래의 경우에는 어떨까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>이 경우 current는 이동하지 않았습니다. 하지만 newChild가 null이기 때문에 위 로직은 중단될 것입니다. null이라면 아무런 기준이 되는 정보를 가지고 있지 않으므로 이는 어쩔 수 없는 부분입니다.   </p>\n<p>다음의 경우에 대해서  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>이 때 개발자는 1번을 지우기 위해 null를 반환했습니다. 하지만 리액트 입장에서는 newChild가 null이라고 1번이 삭제되었다는 판단을 할 수 있을까요? 이것은 배열을 모두 탐색해보기 전까지는 알 수 없습니다. key가 변경 되었든 newChild 자체가 null이든 updateSlot()이 null를 반환하면 로직을 중단시킬 수 밖에 없게 되는 것이 이 이유 때문입니다.</p>\n<p>35 ~ 39에서는 <code class=\"language-text\">newFiber.alternate === null</code>를 통해 type이 변경되어 새롭게 fiber가 만들어졌다는 걸 알 수 있습니다. 그래서 더 이상 필요 없는 current를 삭제해줍니다.</p>\n</li>\n<li>41 ~ 46: 마무리 단계입니다.<br>\n<code class=\"language-text\">placeChild()</code>는 fiber에 index를 새기고 필요에 따라 tag도 달아줍니다. 그리고 연결 리스트로 형제들과 엮어줍니다.</li>\n</ul>\n<p>current가 움직이지 않았다면 newChildren을 기준으로 추가<up>23</up>, 삭제<up>37</up>가 한번의 탐색으로 동시에 처리할 수 있습니다. 더불어 current 리스트가 더 길거나 그 반대로 newChildren이 긴 경우에 쉽게 처리할 수 있습니다.  </p>\n<ol>\n<li>current 리스트가 더 길다는 건 나머지들은 모두 삭제되었다는 뜻으로 삭제만 하면 끝입니다.  </li>\n<li>반대로 newChildren이 길 경우는 추가되었다는 뜻이겠죠. 코드의 의미는 명확합니다.</li>\n</ol>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// for (; oldFiber !== null &amp;&amp; newIdx &lt; newChildren.length; newIdx++) { ... }</span>\n\n  <span class=\"token comment\">// current 리스트가 더 긴 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newIdx <span class=\"token operator\">===</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// if (newIdx === newChildren.length) {...}</span>\n\n  <span class=\"token comment\">// newChildren 배열이 더 긴 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">createChild</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        expirationTime<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        resultingFirstChild <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      previousNewFiber <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 이외의 케이스에서는 더 이상 커서의 전진만으로 변경점을 판별할 수 없으므로 current 리스트를 맵으로 변환하여 진행합니다. 잠시 이 부분으로 넘어가기 전에 아직 확인하지 않았던  <code class=\"language-text\">updateSlot()</code>과 <code class=\"language-text\">placeChild()</code>를 마저 보고 넘어가도록하겠습니다.</p>\n<blockquote>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L480\" target=\"_blank\">createChild()</a>는 이제까지 많이 봐왔던 형식으로 React element type에 맞는 fiber로 확장하는 코드만 존재하므로 생략합니다.</p>\n</blockquote>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L544\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">updateSlot</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  oldFiber<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  newChild<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> oldFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> oldFiber<span class=\"token punctuation\">.</span>key <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">updateTextNode</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> newChild<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">updateFragment</span><span class=\"token punctuation\">(</span>\n              returnFiber<span class=\"token punctuation\">,</span>\n              oldFiber<span class=\"token punctuation\">,</span>\n              newChild<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span>\n              expirationTime<span class=\"token punctuation\">,</span>\n              key\n            <span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">,</span> newChild<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">/*...*/</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token function\">updateFragment</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        oldFiber<span class=\"token punctuation\">,</span>\n        newChild<span class=\"token punctuation\">,</span>\n        expirationTime<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>element의 종류에 맞춰서 적절히 라우팅 해주고 있습니다. 여기서 사용되는 <code class=\"language-text\">update***()</code>는 SQL의 UPSERT와 같이 <em>‘current가 재사용 할 수 있으면 하고 없으면 새롭게 만들어 반환한다.’</em> 의 의미를 담고 있는 함수입니다.</p>\n<p>null을 반환하는 경우는 key가 다르거나 newChild가 fiber로 확장될 수 없을 때 입니다.<br>\n일반적으로 React element에는 key를 설정할 수 있지만 text, 배열에는 key를 설정할 수 없습니다.<br>\nkey를 설정할 수 없는 newChild<up>10, 38</up>이지만 current의 key가 존재<up>11, 39</up>한다면 이는 current가 이동, 삭제되었다고 볼 수 있으므로 null을 반환하고 있습니다.</p>\n<p>update***()는 로직의 구조가 비슷하므로 일반적인 updateElement() 하나만 확인하고 넘어가겠습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L393\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  element<span class=\"token punctuation\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> current<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n    existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> existing\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>\n      element<span class=\"token punctuation\">,</span>\n      returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n      expirationTime\n    <span class=\"token punctuation\">)</span>\n    created<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> created\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>current를 재사용하기 위해서는 key와 type이 같아야 하며 이때 props만은 재사용하지 않는다고 일전에 설명드렸습니다. 여기서 이 내용과 <code class=\"language-text\">updateElement()</code>의 로직을 근거로 <strong><em>key를 설정하지 않으면 발생하는 문제점</em></strong>에 대해 유추해 볼 수 있습니다.  </p>\n<p><em>“key와 type이 같으면 props만 변경된다.”</em> 그리고 key를 설정하지 않으면 key는 null이다.<br>\n문제는 배열에서 key를 설정하지 않은 같은 type의 fiber가 이동되었을 때 발생합니다.<br>\n다음의 Counter 예제를 통해 어떠한 문제가 발생하는지 눈으로 확인해봅시다.</p>\n<iframe src=\"https://stackblitz.com/edit/ex-counter?ctl=1&embed=1&file=index.js&hideNavigation=1\" style=\"width:100%;height: 500px\"></iframe>\n<p>reverse 버튼을 통해 두개의 Counter 컴포넌트를 반전시키길 원합니다. 하지만 바람과 달리 버튼만 반전이 되고 숫자는 그대로입니다.  </p>\n<p>props만 변경되기 때문에 hook 객체에 담겨있는 숫자는 이동하지 않는 것입니다. 이처럼 복수개의 같은 type의 컴포넌트를 사용할 때는 필수적으로 key를 설정해주어야 합니다.</p>\n<blockquote>\n<p>위 내용을 기억하고 공식홈페이지의 <a href=\"https://ko.reactjs.org/docs/lists-and-keys.html\" target=\"_blank\">리스트와 key</a>를 다시 한번 읽어 보세요. 아마 내용을 받아들이는 깊이가 이전과는 다름을 느끼실겁니다. 암기가 아닌 이해가 중요합니다.</p>\n</blockquote>\n<p>updateSlot()은 여기서 끝이고 다음은 placeChild()를 확인 하겠습니다.</p>\n<p>updateSlot(), createChild()를 통해 fiber를 반환받으면 이제 이 fiber의 위치를 나타내는 index와 이동, 추가를 나타내는 placement tag를 달아주어야 합니다. 이동 + 추가는 한 묶음으로 html 내장 함수인 <a href=\"https://developer.mozilla.org/ko/docs/Web/API/Node/appendChild\" target=\"_blank\">appendChild()</a>를 이용하여 한번에 처리할 수 있습니다.</p>\n<p>우리는 실질적으로 이동시킬 element 선택에도 조금의 생각이 필요합니다.<br>\n다음의 경우에 어떤 element에 placement tag를 달아주어야 할까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>1이 맨뒤로 이동하면서 2와 3의 위치가 한칸씩 앞으로 이동하게 되었습니다.<br>\n이때 placement tag를 모든 컴포넌트에 달아 주어 각각 DOM 조작을 해야 할까요?  </p>\n<p>일반적으로 배열에서의 이동이란 ‘현재 위치’를 기준으로 앞과 뒤로 움직이는걸 뜻하지만 리액트는 이동을 상대적인 것으로 ‘인접한 원소’를 기준으로 그보다 앞 혹은 뒤로 움직이는걸 이동이라고 정의했습니다.   </p>\n<p>이렇게 정의한 덕분에 위 배열 예제에서 한가지에 대한 처리로 문제를 해결 할 수 있게 되었습니다. </p>\n<ol>\n<li>1이 뒤로 이동했다고 판단할 경우 2, 3을 그대로 두고 1만 조작하던지</li>\n<li>1은 가만히 있었는데 2, 3이 앞으로 이동했다고 판단하여 2, 3을 조작하던지  </li>\n</ol>\n<p>이동의 정의를 인접한 원소를 기준으로 뒤로 이동한 경우 1, 앞으로 이동한 경우를 나타낸 것이 2입니다. 그리고 전자로 로직을 작성한 함수가 placeChild()입니다.</p>\n<anchor id=\"placeChild\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L333\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">newFiber<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  lastPlacedIndex<span class=\"token punctuation\">:</span> number<span class=\"token punctuation\">,</span>\n  newIndex<span class=\"token punctuation\">:</span> number</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> number <span class=\"token punctuation\">{</span>\n  newFiber<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> newIndex\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 마운트의 경우 index 설정만 필요함.</span>\n    <span class=\"token keyword\">return</span> lastPlacedIndex\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">.</span>alternate\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> oldIndex <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>index\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldIndex <span class=\"token operator\">&lt;</span> lastPlacedIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 이동</span>\n      newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n      <span class=\"token keyword\">return</span> lastPlacedIndex\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 이동하지 않음</span>\n      <span class=\"token keyword\">return</span> oldIndex\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 추가</span>\n    newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n    <span class=\"token keyword\">return</span> lastPlacedIndex\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>첫 <code class=\"language-text\">lastPlacedIndex</code>는 0입니다. 그리고 cucrnet가 없다면<up>13</up> 이는 새롭게 만들어진 fiber임으로 DOM에 삽입하기 위해 tag를 달아<up>25</up>줍니다.<br>\n이제 원소의 이동을 판단할 차례인데 이동의 기준은 현재 삽입할 위치의 이전 원소가 되겠습니다. 이전 원소의 index보다 current의 index가 작다는 것은 current가 오른쪽으로 이동했음을 뜻합니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 773px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 31.69469598965071%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/0lEQVQY041R207CQBTs//+JUfHyQvTJEBBNDPCAiQmIFsxaSLc32i1tz+54SukaCQ+eZHZ2zmWSPesYY6C1hjmCripGuWdDBE2VzRlNTQ/Rb3/N7OXgVHDhv6EZcZpa7RRlCW+1xG7tIWNWvo+Sc2L0Au/pEe5wAMUD/vsc33xf9XvwuS+NIgjWoveAxfMQ3mbTGO6KAu5shsT9RMhDWzbOlcL0rovx5Tne7rvYJgncyRijizO83l5h/bFAyAaT6w6mNx3MB318CdEYts8zB7RBjChTf3JRlkHludUFI4xj6Naj3mF9nILd40ETf0ggJSSvRDIT0b6csGEQSPspPx7zzAhHlo0cAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"placeChild  \" title=\"placeChild  \" src=\"/static/21a832466a953523abcf49974706ba80/73dad/placeChild().png\" srcset=\"/static/21a832466a953523abcf49974706ba80/0780f/placeChild().png 198w,\n/static/21a832466a953523abcf49974706ba80/47b26/placeChild().png 395w,\n/static/21a832466a953523abcf49974706ba80/73dad/placeChild().png 773w\" sizes=\"(max-width: 773px) 100vw, 773px\" loading=\"lazy\">\n    </span>\n<p>위 내용을 토대로 가장 최악의 시나리오는 무엇일까요? 바로 맨 뒤 원소가 맨 앞으로 이동했을 경우 입니다. 이때는 첫 번째 원소를 제외한 나머지 fiber들에 placement tag가 달릴 것 입니다.</p>\n<p>이 부분을 확인하기 위해 Todo 예제를 다음과 같이 수정하겠습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>todos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>pull<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span></span>      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">OrderList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> list <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ol<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">&lt;</span>li key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></span>      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ol<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// placement tag를 처리하는 Commit phase 함수.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">key: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>finishedWork<span class=\"token punctuation\">.</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> tag: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>finishedWork<span class=\"token punctuation\">.</span>effectTag<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>맨 뒤에 있는 todo item을 앞으로 당겨오는 pull 버튼을 추가했습니다. item의 key는 입력 값 그대로 사용합니다.</p>\n<img src=\"/path/to/dir/d6d8a683c537f6028c749aa45b13b5fa/placement_when_pull_tail.gif\" height=\"300px\" width=\"100%\">\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 568px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.03521126760564%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABE0lEQVQoz32R6XKCQBCEff8nyw/LiAaTIIcKFqEwLPdyLHR6SRkNZTLFFHsw30zTi67rkCQCUjbo+x56f029r2XN+wRplqLIMhR5hrauURcFqrKEUgoYRz7fuWikhB+c/wSWLDr5J4QHF9ZmDWP5BN+y4JgvCF0XI24xAfWi71pU7PhfqDKH57nYOzbiOMY5DJHzzWJUeY6PKJq+m4BCS0rTny7z1CFFgi0nXD0vceBku52JOAh0BcZhwMDEdUIhxPSP7oH3MnTEGmissTFWcPcW3l9N2McjFO+blgqr6jZhywPVq1+AOTBKBd4I2hLkEWTZNhzKlqqH0JK5noCPpnl01tCkCx3+ZLGgURc6ntHtefMvZXwcHV4/GcYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"placement when pull tail\" title=\"placement when pull tail\" src=\"/static/687c4ac201b8dcac0bbcae3e30c166e1/870c3/placement_when_pull_tail.png\" srcset=\"/static/687c4ac201b8dcac0bbcae3e30c166e1/0780f/placement_when_pull_tail.png 198w,\n/static/687c4ac201b8dcac0bbcae3e30c166e1/47b26/placement_when_pull_tail.png 395w,\n/static/687c4ac201b8dcac0bbcae3e30c166e1/870c3/placement_when_pull_tail.png 568w\" sizes=\"(max-width: 568px) 100vw, 568px\" loading=\"lazy\">\n    </span>\n<p>tag: 2는 placement tag를 나타냅니다.</p>\n<p>다음은 current가 이동한 경우에 어떻게 맵을 이용하여 구현하였는지 확인해보겠습니다.</p>\n<h4 id=\"2-current가-이동한-경우\"><a href=\"#2-current%EA%B0%80-%EC%9D%B4%EB%8F%99%ED%95%9C-%EA%B2%BD%EC%9A%B0\" aria-label=\"2 current가 이동한 경우 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. current가 이동한 경우</h4>\n<p>로직의 흐름은 먼저 current 리스트를 맵으로 변환하고 아직 커서가 지나가지 않은 newChildren 배열의 원소들을 마저 지나가며 맵에서 current를 찾아옵니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// if (oldFiber === null) {...}</span>\n\n  <span class=\"token keyword\">const</span> existingChildren <span class=\"token operator\">=</span> <span class=\"token function\">mapRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">updateFromMap</span><span class=\"token punctuation\">(</span>\n      existingChildren<span class=\"token punctuation\">,</span>\n      returnFiber<span class=\"token punctuation\">,</span>\n      newIdx<span class=\"token punctuation\">,</span>\n      newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      expirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 재활용된 fiber의 경우 맵에서 제거해준다</span>\n          existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>\n            newFiber<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> newIdx <span class=\"token punctuation\">:</span> newFiber<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n\n      lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        resultingFirstChild <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      previousNewFiber <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>6: current 연결 리스트를 맵으로 변환합니다.</li>\n<li>9: updateSlot()과 동일합니다. 다만 current를 참조하는 방식이 map을 통한 참조라는 것만 다릅니다.</li>\n<li>39: newChildren을 모두 탐색한 후에도 currrent가 맵에 남아 있다면 모두 제거된 것이므로 삭제해주면 됩니다.</li>\n<li>42: 부모는 child 속성으로 첫 번째 자식만 참조하므로 resultingFirstChild만 반환합니다.</li>\n</ul>\n<p>mapRemainingChildren()에서는 맵의 key를 설정하는 부분 정도만 주의깊게 보시면 될 것 같습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L299\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">mapRemainingChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> currentFirstChild</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> existingChildren <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> existingChild <span class=\"token operator\">=</span> currentFirstChild\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>existingChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span> existingChild<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">,</span> existingChild<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span>\n    existingChild <span class=\"token operator\">=</span> existingChild<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> existingChildren\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>updateFromMap()의 로직은 updateSlot()과 비교했을 때 맵을 이용하여 current를 참조한다는 점만 다르므로 생략합니다.  </p>\n</blockquote>\n<p>여기까지가 Render phase flow에서 재조정 작업을 진행하는 6.reconcileChildren 입니다.  </p>\n<p>이전에 Todo 예제에서 Input컴포넌트의 상태가 업데이트 된 후의 VDOM 형태를 표현한 <a href=\"/react/in-depth-react-reconciler_2/#input_update\" target=\"_blank\">이미지</a>를 기억하시나요?\nInput 컴포넌트는 상태가 업데이트 되었으니 5.update***에서 컴포넌트가 호출될 것입니다. 그리고 반환하는 자식 React element는 6.reconcileChildren에서 재조정 작업을 거친 후 fiber로 확장되어 VDOM에 반영됩니다.<br>\n이 과정을 모두 거친 후의 VDOM 형태는 다음과 같습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.58697972251868%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz22Sa1PaQBiF/f9f+hP6pZ2OIxbq2Km1zFQorcpFMJMQ7gIptxAEEUIgl6dvAlqlfWfe7CbZPXvOnnMQBAH7ba8dFqsVzmbD/ypwHDzTxPM8fN9/tffg5Ys8ogWfrn7x5jTOebGAO51iW2NWliU9xpne86hp1D7GUI4PGejl7SE74FeAvvwIAZv9Plm1SM8c4QrT9XLJxpaW0RV2jmGgn5yQPzth0uttAYN9QAFivZV4oSm8zaRIqQo8zvGlvfmczWyGK/NFt0vj6xeqZ6eMm/V/GUbMFkuy35IkRO73UpbZoE+9XkUrK+i1Kp27Fg/DIQ8Ti3tdR0skKH6OY6hqBOjLfT4DPpVutEgqJdRmRe7LxByN0Bs1aq06XaOL2W4zbXewhgO6tzna6TSWWvhrVggYTm5bTd79uCCt3uDYK87zlxxfZ1BE2svyfve4ix1RjMeoppJMSsL+8D2Fow9UM2k8kR0BNkVe8iZPVhzry/xnWSOZz6G2GvgSnY3EKBBJoSGjUP7VJcNKhdlkQk/WGoUcVqeNvy85KteN4kNokm2zmk1xxIxoFENC158l7uc0ApSNIVVXGIRjeIoroGF7O+f8XT73O3j6HgZ8F/I/II3wk+Y0GSAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"reconcile children\" title=\"reconcile children\" src=\"/static/8add8101dc88320afdd3537f1f4d6b98/c94d1/reconcile_children.png\" srcset=\"/static/8add8101dc88320afdd3537f1f4d6b98/0780f/reconcile_children.png 198w,\n/static/8add8101dc88320afdd3537f1f4d6b98/47b26/reconcile_children.png 395w,\n/static/8add8101dc88320afdd3537f1f4d6b98/c94d1/reconcile_children.png 790w,\n/static/8add8101dc88320afdd3537f1f4d6b98/d6df5/reconcile_children.png 937w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>다음 포스트에서는 지금까지 진행했던 <strong>Work</strong>의 작업물을 마무리하는 방법을 알아 볼 것입니다.</p>","frontmatter":{"title":"React 톺아보기 - 05. Reconciler_3","date":"2020-10-11","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-reconciler_3/","previous":{"fields":{"slug":"/react/in-depth-react-reconciler_2/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_2","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_4/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_4","category":"react"}}}}}