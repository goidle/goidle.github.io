{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_1/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"d17b9cc9-e61f-5fbf-964b-4888a557d77f","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 아마 이번 포스터에서 리액트에 대해 궁금증을 가지고 있었던 거의 대부분을 다루지 않을까 생각해봅니다. 그만큼 중추적인 역할을 하는 패키지가 reconciler입니다.   우리는 먼저 JSX로 작성한 컴포넌트들이 어떤 형식으로 react element로 변환되고 이것을 VDOM에 올리기 위해 어떻게 fiber…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<p>아마 이번 포스터에서 리액트에 대해 궁금증을 가지고 있었던 거의 대부분을 다루지 않을까 생각해봅니다. 그만큼 중추적인 역할을 하는 패키지가 reconciler입니다.  </p>\n<p>우리는 먼저 JSX로 작성한 컴포넌트들이 어떤 형식으로 react element로 변환되고 이것을 VDOM에 올리기 위해 어떻게 fiber로 확장하는지 알아볼 것입니다. 그 후에 변경점들을 VDOM에 적용하는 render phase와 완성된 VDOM을 DOM에 적용하는 commit phase를 순서대로 확인해보며 마무리할 것입니다.  </p>\n<h1 id=\"1-react-element\"><a href=\"#1-react-element\" aria-label=\"1 react element permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. React element</h1>\n<h2 id=\"종류\"><a href=\"#%EC%A2%85%EB%A5%98\" aria-label=\"종류 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>종류</h2>\n<p>리액트 컴포넌트는 크게 호스트 컴포넌트, 사용자 정의 컴포넌트<up>커스텀 컴포넌트</up>, 리액트에서 제공하는 컴포넌트<up>스태틱 컴포넌트</up>로 나눌 수 있습니다.<br>\n호스트 컴포넌트는 div, input, button 등 html element에 대응하는 컴포넌트이며<br>\n커스텀 컴포넌트는 일반적으로 개발자들이 만들게 되는 class, functional component입니다.<br>\n리액트에서 제공하는 컴포넌트는 하나의 특수한 목적을 가진 컴포넌트로 fragment, lazy, context(Provider, Consumer), memo 등이 있습니다.</p>\n<h2 id=\"createelement\"><a href=\"#createelement\" aria-label=\"createelement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createElement()</h2>\n<p>JSX 문법으로 작성된 코드는 바벨을 통해 React.createElement로 치환됩니다. 이 이유 때문에 개발자가 React를 명시적으로 사용하지 않아도 JSX를 작성할 때는 항상 React를 import 해야합니다. 이 함수가 어떤 인자를 받는지 부터 확인하고 가겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react > ReactElement.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">type</code>에는 JSX로 컴포넌트를 선언할 때 사용한 값이 들어갑니다.</p>\n<ul>\n<li>호스트 컴포넌트: 태그 이름</li>\n<li>커스텀 컴포넌트: class, function 그 자체</li>\n<li>스태틱 컴포넌트: <a target=\"_black\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactSymbols.js\">미리 정의된 Symbol</a> 또는 memo, lazy와 같이 함수 호출을 통해 만들어진 react element</li>\n</ul>\n<p><code class=\"language-text\">config</code>는 컴포넌트를 사용할 때 넘겨준 모든 attribute를 담고 있는 객체입니다.<br>\n<code class=\"language-text\">children</code>은 조금 부연 설명이 필요한데 함수 선언 형태는 3개의 인자만 있지만 실제로는 여러 자식이 올 경우 3 ~ n번째의 인자에 자식들이 들어옵니다. type, config, children1, children2, … childrenN의 형태가 됩니다.</p>\n<p>다음의 예제로 위 내용을 확인해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">CustomComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>CustomComponent <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"host_component\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<blockquote>\n<p>&#x3C;>…&#x3C;/>는 &#x3C;React.Fragment>…&#x3C;/React.Fragment>의 단축 형태입니다.</p>\n</blockquote>\n<p>치환된 코드는 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n    React<span class=\"token punctuation\">.</span>Fragment<span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: Symbol.for('react.fragment')</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// config</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 첫번째 자식</span>\n      CustomComponent<span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: function</span>\n      <span class=\"token keyword\">null</span> <span class=\"token comment\">// config</span>\n      <span class=\"token comment\">// 자식은 없음</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 두번째 자식</span>\n      <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// type: tag name</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"host_component\"</span> <span class=\"token punctuation\">}</span> <span class=\"token comment\">// config</span>\n    <span class=\"token punctuation\">)</span> \n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>이 인자들을 받아서 react element를 만드는 과정은 다음과 같습니다.</p>\n<ol>\n<li>react element에는 key와 ref라는 예약된 속성들이 존재합니다. config에 해당 속성을 제외한 나머지를 props 객체에 저장합니다. </li>\n<li>인자로 넘어온 자식이 복수개이면 하나의 배열에 저장합니다.</li>\n<li>default props가 존재할경우 props 객체에 적용합니다.</li>\n<li>위 내용을 이용하여 react element 객체를 만듭니다.</li>\n</ol>\n<anchor id=\"createElement\" />\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react > ReactElement.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">RESERVED_PROPS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  ref<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token comment\">// 1. react element에는 key와 ref라는 예약된 속성들이 존재합니다. config에 해당 속성을 제외한 나머지를 props 객체에 저장합니다. </span>\n  <span class=\"token keyword\">let</span> propName<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> key <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> ref <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasValidRef</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// config.ref !== undefined;</span>\n      ref <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>ref<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasValidKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// config.key !== undefined;</span>\n      key <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> config<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 예약된 속성을 제외한 나머지를 props 객체에 저장</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propName <span class=\"token keyword\">in</span> config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> propName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token operator\">!</span><span class=\"token constant\">RESERVED_PROPS</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propName<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 2. 인자로 넘어온 자식이 복수개이면 하나의 배열에 저장합니다.</span>\n  <span class=\"token keyword\">const</span> childrenLength <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childrenLength <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> children<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childrenLength <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> childArray <span class=\"token operator\">=</span> <span class=\"token function\">Array</span><span class=\"token punctuation\">(</span>childrenLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> childrenLength<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      childArray<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> childArray<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 3. default props가 존재할경우 props 객체에 기본값으로 저장합니다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">&amp;&amp;</span> type<span class=\"token punctuation\">.</span>defaultProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> defaultProps <span class=\"token operator\">=</span> type<span class=\"token punctuation\">.</span>defaultProps<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propName <span class=\"token keyword\">in</span> defaultProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> defaultProps<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 4. 위 내용을 이용하여 react element 객체를 만듭니다.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">ReactElement</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">,</span>\n    ref<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만드는 과정은 확인했으니 react element의 생김새를 한번 확인해볼까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ReactElement</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This tag allows us to uniquely identify this as a React Element</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Built-in properties that belong on the element</span>\n    type<span class=\"token punctuation\">:</span> type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">,</span>\n    ref<span class=\"token punctuation\">:</span> ref<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">:</span> props<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> element<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>특이하게 생긴 <code class=\"language-text\">$$typeof</code>가 있습니다. 이 속성은 fiber를 만들때 element의 종류를 확인하는데 쓰입니다. 기본적으로는 <code class=\"language-text\">REACT_ELEMENT_TYPE</code>이지만 스태틱 컴포넌트의 경우는 심볼이 들어갑니다. 스태틱 컴포넌트는 간단하게 memo와 lazy만 확인해보겠습니다.</p>\n<anchor id=\"memo\">\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react > memo.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span><span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> memo<span class=\"token operator\">&lt;</span>Props<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  type<span class=\"token punctuation\">:</span> React$ElementType<span class=\"token punctuation\">,</span>\n  compare<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">oldProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">:</span> Props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    compare<span class=\"token punctuation\">:</span> compare <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> compare<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// react > lazy.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span><span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> lazy<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">ctor</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> LazyComponent<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> lazyType <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    $$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">,</span>\n    _ctor<span class=\"token punctuation\">:</span> ctor<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// React uses these fields to store the result.</span>\n    _status<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    _result<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> lazyType<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>react element에 대해서 알아야 할 부분은 이정도면 충분할 것 같습니다. react core 패키지가 하는 일은 대게 이런 리액트용 element를 만드는 거라고 생각하시면 됩니다.</p>\n<h1 id=\"2-fiber\"><a href=\"#2-fiber\" aria-label=\"2 fiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Fiber</h1>\n<blockquote>\n<p>react element를 VDOM에 올리기 위해서는 fiber로 확장해야 합니다. 확장할 때의 코드에는 주로 element가 어떤 종류인지 판단하는 코드가 많습니다. 코드를 간략화하기 위해서 분석 대상을  커스텀 컴포넌트, 호스트 컴포넌트, fragment, memo로 압축하도록 하겠습니다.</p>\n</blockquote>\n<p>react element의 종류를 type 심볼을 통해 판단했다면 fiber는 <a target=\"_black\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactWorkTags.js\">tag</a>를 통해 판단합니다. 그리고 이 tag의 명칭은 work tag 입니다. 각 fiber의 종류에 따라 재조정 작업의 처리가 달라야 하기 때문에 붙은 명칭입니다. </p>\n<h2 id=\"createfiber\"><a href=\"#createfiber\" aria-label=\"createfiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createFiber()</h2>\n<p>react element를 만들 때 와 같이 fiber도 종류에 따라 만드는 형식이 약간 다릅니다. fiber를 생성하는 함수는 createFiberFrom***()의 형태로 나뉘어 있지만 결국에는 createFiber()로 끝납니다. 먼저 이 함수를 확인해보자면</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiber.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createFiber</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">tag<span class=\"token punctuation\">:</span> WorkTag<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> mixed<span class=\"token punctuation\">,</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FiberNode</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">FiberNode</code>의 설명은 <a target=\"_blank\" href=\"/react/in-depth-react-intro#FiberNode\">Intro</a>에서 언급한 내용으로 대체하도록 하겠습니다.</p>\n<p>일반적으로 createFiberFromElement()를 통해 fiber를 만드는데 몇몇 종류의 fiber들은 props를 조금 다른 의미로 다루고 있습니다. 이에 해당하는 fiber 중 fragment와 text 만 다루고 넘어가겠습니다.</p>\n<blockquote>\n<p>이들을 처리하기 위해 파생된 함수가 createFiberFrom***입니다.</p>\n</blockquote>\n<h2 id=\"createfiberfromfragment-createfiberfromtext\"><a href=\"#createfiberfromfragment-createfiberfromtext\" aria-label=\"createfiberfromfragment createfiberfromtext permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createFiberFromFragment(), createFiberFromText()</h2>\n<p>fragment는 단순히 컴포넌트들을 하나로 묶어주는 포장지라고 생각하면 됩니다. 그래서 props에는 다른 값을 다루지 않고 오로지 children만을 저장합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// fragment fiber를 만드는 코드 중..</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSymbols'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromFragment</span><span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span></span>    returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n    element<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  created<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> created<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> \n\n<span class=\"token comment\">// reconciler > ReactFiber.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Fragment <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactWorkTags'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromFragment</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">elements<span class=\"token punctuation\">:</span> ReactFragment<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>Fragment<span class=\"token punctuation\">,</span> elements<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>fragment를 만들 때 애초에 children을 꺼내 props에 넘겨줍니다.<br>\n그렇다면 text fiber의 props에는 무엇이 저장될까요?<br>\ntext는 그 자체가 데이터 입니다. 다른 추가적이 요소가 필요 없습니다 심지어 key도요. 그래서 props에는 text 그 자체가 들어갑니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// text fiber를 만드는 코드 중..</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n    textContent<span class=\"token punctuation\">,</span>\n    returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// reconciler > ReactFiber.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HostText <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactWorkTags'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">content<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>HostText<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>이 이외에도 props를 특별하게 다루는 fiber는 portal이 있습니다.</p>\n</blockquote>\n<h2 id=\"createfiberfromelement\"><a href=\"#createfiberfromelement\" aria-label=\"createfiberfromelement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createFiberFromElement()</h2>\n<p>이제 일반적인 react element에서 fiber로 확장하는 코드를 보도록 하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">element<span class=\"token punctuation\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pendingProps <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromTypeAndProps</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    key<span class=\"token punctuation\">,</span>\n    pendingProps<span class=\"token punctuation\">,</span>\n    mode<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>먼저 element에서 필요한 정보들을 꺼냅니다. 이제 이 정보들을 이용하여 <code class=\"language-text\">createFiberFromTypeAndProps()</code>를 통해 해당 type에 맞는 fiber을 찾아 확장하기만 하면 됩니다.  </p>\n<p>이 함수의 첫 번째 목적은 fiber의 tag를 추출하는 겁니다. 그리고 해당 tag를 가진 fiber를 만들어 반환합니다.</p>\n<anchor id=\"createFiberFromTypeAndProps\" />\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberBeginWork.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createFiberFromTypeAndProps</span><span class=\"token punctuation\">(</span>\n  type<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span> <span class=\"token comment\">// React$ElementType</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  mode<span class=\"token punctuation\">:</span> TypeOfMode<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> fiber<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> fiberTag <span class=\"token operator\">=</span> IndeterminateComponent<span class=\"token punctuation\">;</span> <span class=\"token comment\">// class인지 functional component인지 아직 알 수 없음을 뜻함.</span>\n  <span class=\"token keyword\">let</span> resolvedType <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// class component</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldConstruct</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// type.prototype &amp;&amp; type.prototype.isReactComponent;</span>\n      fiberTag <span class=\"token operator\">=</span> ClassComponent<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// else?? 여기서는 함수형 컴포넌트라고 단정지을 수 없습니다.</span>\n    \n  <span class=\"token comment\">// type이 string이면 호스트 컴포넌트 입니다. 'div', 'input'..</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiberTag <span class=\"token operator\">=</span> HostComponent<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 이하 스태틱 컴포넌트</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    getTag<span class=\"token punctuation\">:</span> <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_STRICT_MODE_TYPE</span><span class=\"token punctuation\">:</span>\n        fiberTag <span class=\"token operator\">=</span> Mode<span class=\"token punctuation\">;</span>\n        mode <span class=\"token operator\">|=</span> StrictMode<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_SUSPENSE_TYPE</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">createFiberFromSuspense</span><span class=\"token punctuation\">(</span>pendingProps<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// 생략..</span>\n      <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> type <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_MEMO_TYPE</span><span class=\"token punctuation\">:</span>\n              fiberTag <span class=\"token operator\">=</span> MemoComponent<span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">break</span> getTag<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_LAZY_TYPE</span><span class=\"token punctuation\">:</span>\n              fiberTag <span class=\"token operator\">=</span> LazyComponent<span class=\"token punctuation\">;</span>\n              resolvedType <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">break</span> getTag<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 생략..</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> info <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n          <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'Element type is invalid: expected a string (for built-in '</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">'components) or a class/function (for composite components) '</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">'but got: %s.%s'</span><span class=\"token punctuation\">,</span>\n          type <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> type <span class=\"token punctuation\">:</span> <span class=\"token keyword\">typeof</span> type<span class=\"token punctuation\">,</span>\n          info<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  fiber <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>fiberTag<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> resolvedType<span class=\"token punctuation\">;</span>\n  fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>코드를 묶어 보자면 13 ~ 59 라인이 tag를 추출하는 코드, 61 ~ 64 라인이 fiber를 만들어 내는 코드입니다.<br>\n짚고 넘어갈만한 부분은 11, 19, 35번 라인 입니다.  </p>\n<ul>\n<li>11: <code class=\"language-text\">IndeterminateComponent</code> tag는 현재 이 fiber가 클래스 컴포넌트인지 함수형 컴포넌트인지 확실히 알 수 없는 상태라는 걸 나타냅니다.  </li>\n</ul>\n<anchor id=\"IndeterminateComponent\" />\n<ul>\n<li>\n<p>19: 16라인에서 <code class=\"language-text\">type</code>이 React.Componenet를 상속받은 클래스인지 확인하여 <code class=\"language-text\">ClassComponent</code> tag를 설정합니다.<br>\n그런데 왜 else문을 사용하여 함수형 컴포넌트라고 단정짓지 않은것일까요?<br>\n이유는 일반 함수를 이용하여 클래스 컴포넌트를 사용할 수도 있기 때문입니다. 대게 개발자의 실수에 의해 다음과 같이 작성될 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token constant\">CC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"I'm CC\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">CC</code>는 클래스 컴포넌트의 인스턴스를 반환합니다. 리액트는 위와 같은 케이스에서 에러를 던지지 않고 경고 로그와 함께 CC를 클래스 컴포넌트로 만듭니다. 당연히 반환하는 인스턴스는 CC의 instance로 갈아끼웁니다.<br>\n문제는 이 함수를 실행해 보기 전까지는 모릅니다. 그래서 fiber로 확장만 하는 createFiberFromTypeAndProps()에서는 이를 알 수 있는 방법이 없기 때문에 호출할 수 있는 시점에 다시 판단할 수 있도록 tag를 IndeterminateComponent로 설정하는 겁니다.</p>\n</li>\n<li>\n<p>35: 26라인의 switch문에서 스태틱 컴포넌트들을 이미 분기처리했는데 <code class=\"language-text\">default</code>에서 <code class=\"language-text\">type</code>이 <code class=\"language-text\">object</code>인지는 왜 확인하는 걸까요?<br>\n이를 이해하기 위해서 리액트 코어 패키지의 <a href=\"#memo\">memo 함수</a>를 다시 확인해 보면 반환값이 react element입니다. 이제 memo를 사용하는 일반적인 코드를 생각해보시면 이해가 가실겁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">FC</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">'memo component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">FC</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이해가 가시나요? 우리는 첫줄에서 이미 memo element를 만들었습니다. 그리고 이 element를 다시 React.createElement()에 넘겨주었기 때문에 type에는 memo element 오브젝트가 들어가게 되는겁니다.</p>\n</li>\n</ul>\n<p>react element와 fiber를 어떻게 생성하는지는 이정도면 충분할 것 같습니다.<br>\n다음 주제는 render phase이지만 VDOM을 순회할 때 헷갈리지 않도록 미리 좀더 VDOM에 익숙해지는 시간을 가지도록 하겠습니다. </p>\n<h1 id=\"3-fiber-root-node\"><a href=\"#3-fiber-root-node\" aria-label=\"3 fiber root node permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Fiber Root Node</h1>\n<p>Intro에서 사용했던 VDOM 이미지를 가지고 와서 어떻게 서로 참조하고 있었는지 다시 한번 확인하도록 하겠습니다.</p>\n<figure>\n <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 634px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 143.69085173501577%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEOElEQVRIx31VaVMbRxDl/1cZCXOksKGAKrv4EmOBDSGxY9kcTkglgSRCEgh0sTr2vne150vPiBUSEnRV1+xcb1/PdL+Zw5ilacpbx3VhOw58f4AoipAkCR8zTQuO40LTDXi+P9qT7WM2Nw6W3E9UqjUcfiriy9cTHBx+xq/FY/zx5zl2Cvu8/2b7R5Qr13wt+9k46NwshsyCIOTs/MGAswvDiPdD8iiOZ+6ZYsjMNE1IkgRRFKEoCndd16Gqw9axbSg0L/V6MKj/OOwpQJ/OxjAM2LSRuWVZvC8IAmzPg0NgSqkEg1qPmM8EzDqP6Y+bS2DMom4XqarOCPkR4HN+cnyMt9vbEGo1pLKMmN082Fx2IckDw6dYZePs3FZXVzE/P4+fDw/xnLE9nKETWhA9AYrfR5zGCOOQPCAWCfpSH4XdAlZfraJyVeEb7cBAz2lDsBvou3foum1Ygf4Qco8GWnaNT+oDGU5igpIF10IVl80SZK+LlnYDLZSh+QrUQIQa99H37yA4DbTtW94mRIYDGoE6Qb3VbOGqegWZUmc4T4wINDPHclD65xK+OxiN2aGBIB4MAfWBwjvMms0mFhYWsJCbx28XJVzrKb7U+9i/buGi5+LvjoN3799jZXkJu3u77GqQkQqT4AGQnRmzer2OxcUl/LCyjOO//kONAE/bIj7V2yhLPm4UD+92drC0soJCoTBiaATaJGCUhKPJi/Nz/Ht6OuprvoaO02GVy/syVc/Rx4+wKOGzFDQfA8Yp5VacQFE1nipUf4hM2hClMEMdktfh4bmuB5nWuO02HaaD+L5azGmGEc+jMAx5/ULTkFICM1IWAcp+lycwUxeLlWSrNVQbtmY24DDkmJTkw4c9HOztkeIML6prK3SWdyOVKVcqeLOxgUaj8XTI2aWUy2Xk8nl+y/vffsdZN8HB9R12SCNPWg6+3hhY39hELpfD1tbWqKKMacAhw77Yx8bmJjbW11BrCdDpPyWqlrNuE307gBumKBaLWHz5EkdHR7MZalQdCWKIsgJR6MAlqXLu1SU7H9F7uGX2BFQq1YlimAJkv5EUFQ4pCqns1GKJKiXhqgIMSMU1ujSm4FliTwDasY6+LKJE+RcrD2UoSiKajRa/5QyQGcuEIAi4z2R4pzTwev0V8vkFfP9+DHhU+MItXq+tIT+fx7ezIsxE4RnwlMxNANZ7NSwuL5Lm5fD5F9K8xELr9hJLy8vIvcjhpyJVRaoSYIRZgjwjZAPlapnf2ngY1WqV1PoUqitRYvdGIY8/GTMBzVDDIPThe/79WxuP3gjXduHEJkS3MwH4mOFEHmq+TC+cRZs9KqVkxNCjuvVsnxjKkPzus/JvkmKPAFVf4sltByaXdyekltyibzbG5lnITObZc2Hfz2fO1qu+iJj0gAOyOnYjG17kcGff7tg3+zNbnI2Pe7YmE+j/AYmfmLxmz5QpAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"vDOM\" title=\"vDOM\" src=\"/static/258b43ce623e7b6340fc6aed969199ed/153fa/vDOM.png\" srcset=\"/static/258b43ce623e7b6340fc6aed969199ed/0780f/vDOM.png 198w,\n/static/258b43ce623e7b6340fc6aed969199ed/47b26/vDOM.png 395w,\n/static/258b43ce623e7b6340fc6aed969199ed/153fa/vDOM.png 634w\" sizes=\"(max-width: 634px) 100vw, 634px\" loading=\"lazy\">\n    </span>\n  <figcaption>Virtual DOM</figcaption>\n</figure>\n<p><code class=\"language-text\">Root Node</code><up>root</up>는 VDOM을 대표하는 FiberRootNode 객체입니다. root가 관리하는 정보를 몇개만 추려보자면 현재 DOM에 적용된 VDOM 최상단 node<up>host root</up>인 <code class=\"language-text\">current</code>, container element를 참조하는 <code class=\"language-text\">containerInfo</code>, scheduler에서 이미 다루었던 스케줄링 정보를 저장하는 callback***등이 있습니다.</p>\n<p>root가 참조하는 current를 최상단 node라고해서 <code class=\"language-text\">&lt;App /&gt;</code>이라 생각할 수도 있는데 그렇지는 않고 이 node는 root 컴포넌트의 fiber<up>host root</up>라고 생각하시면 될 것 같습니다. </p>\n<figure>\n <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 521px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 85.41266794625719%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACf0lEQVQ4y41U23baMBDkV+ILvkm2ZPkGDgYbFwK5tC9N+9L//4zprhKRhqY5fdizWiFGo9lZL7I4w64YcVeeMOoJYz/hNJ4wj0ckSYogCBCG4SVfr69jEQYhermxgAd9h0Y2kJFG6MfwPP8doIvPQBdxFFuGszpgq7bomi1ub7dotISQkljGnzL6CzBJEsz6C0a1x7Sb8P35B6ZxwtAP2Gy20KpE4PPh4B3Lj8L3fSy8wEOTtXiqvuG+fsRczTDEdOh+Ylz/ovyMUm3g+TeIoghxHNvsWC+Xy0tmcgs/9NHmHfZqRqdXqE2NVbdGv+bnD2jqDlprlGWJYRjQdW/1er1GXdcoigJt22K1Wr0wNGmFQ3nEoLfo1S36skeRG2IT2eDb0zRFlmWWHYermRUH17y/8HwPVVrjVN5jIi1zoQkgtHq8RXBV/zteNBQtHs1X3JtHbKodpNT2NvZhHCVWN2bJe8zK1ZyZGTPktdWQAVvR4VidScseIhHI84JABWmjILLcrvkwgxlj6Pfc1pJsxXpyLYSwWl4AJ7OHySvESXzRJ00zZKm0NTPgPQZwWjIgg3DmM5xfAGWLoz6RjmesFHWuqWwXldLEUFowHgBmxUycdVwz3LP5IgvYEcOZulyRlvxkmUv7R8eExf7TvNdmdnu2KTdkWAY8Vw/U5T3ZpUBEVvG8G2tmn1wQBP7/jx7bps4a7M1M80sfhli+dpYaEZP4VEdRakE/Yngdr8Y2eDBPGM2EtuhQZKUdt1qPNIY78mZjvel0Y8s4G3GEbCHKS2bo082VqHE0Z1SyRipSq5+UGdkhgxTOEjk1SdEHY2Otw90tKSvaT4qSRpZIiAS/AbLjBPBM7nRJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"FiberRootNode\" title=\"FiberRootNode\" src=\"/static/1d082036557ede9ed154c0ce38e680a1/2ff8c/FiberRootNode.png\" srcset=\"/static/1d082036557ede9ed154c0ce38e680a1/0780f/FiberRootNode.png 198w,\n/static/1d082036557ede9ed154c0ce38e680a1/47b26/FiberRootNode.png 395w,\n/static/1d082036557ede9ed154c0ce38e680a1/2ff8c/FiberRootNode.png 521w\" sizes=\"(max-width: 521px) 100vw, 521px\" loading=\"lazy\">\n    </span>\n  <figcaption>root&#xC758; &#xC18D;&#xC131;</figcaption>\n</figure>\n<p><code class=\"language-text\">return</code>을 보면 null입니다. VDOM의 최상단이기 때문이며 stateNode로 root를 가리키고 있습니다.</p>\n<blockquote>\n<p>호스트 컴포넌트의 stateNode는 DOM에 마운트된 html element를 가리키는 반면에 개발자가 작성한 커스텀 컴포넌트의 stateNode는 null입니다. DOM에 마운트되는게 아니기 때문이고 특별히 host root만 DOM에 마운트 되지 않아도 root를 가리키도록 되어있습니다.</p>\n</blockquote>\n<p>이제 본격적으로 다음의 간단한 todo list 예제를 VDOM에 대입해보며 VDOM 구조에대해 익숙해져봅시다.</p>\n<anchor id=\"todo\">\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> submit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>input value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>button\n        onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">></span>\n        submit\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">OrderList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> list <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ol<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ol<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Todo <span class=\"token operator\">/</span><span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1 id=\"4-트리-구조\"><a href=\"#4-%ED%8A%B8%EB%A6%AC-%EA%B5%AC%EC%A1%B0\" aria-label=\"4 트리 구조 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 트리 구조</h1>\n<p>이제 todo list를 VDOM과 매칭시켜 볼 텐데 root node는 위의 설명으로 대체하고 바로 App부터 시작하도록 하겠습니다.\n먼저 react element tree의 구조를 보고 VDOM으로 어떻게 변경되는지 확인하겠습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.91695501730104%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACi0lEQVQoz22S7UtTYRjG/RdsIvNt8+xszk0zo7f/JyKM0lTsm34JP4UUSWLgl0CKVSCBaKayzTm3qbgdT3NrOJ2uqXufTtvL2cvVfc4JS+iBi+fhfp7nx3W/1FSrVfxv5fN58DwPn88Hp9MJu90OjuOwarPh9Ozs8l0umUAyfIj06SlyuRxqxODc7DxeTUzgzdQUXr+dxMvxcbwYG8Pz0VEEgkHkSwIy2TPkikVckBJHEfjNywh7tlAVBJxnMkimUshmszLwwcPHqGtl0KLXQalR41pzExSk2sYGLK9YJSfFShnlSgViPumTY7i/zCBgW0GFYv8uCdg30A9Gr0f3vbsw3uxGe/cNdNy+BR3tZsea9LBALgvlEsTv6UQc/sUF7NOdUCpJ9yJYLJ8EfNo3CJVKjc4OI/RaDVhWAw3LopVhYFm1Sa5+CUWU6YNA2t/aBD83i52FecT2ghJQhF0CnwwMoq2rkxzeQXvXdegNelI7WHLtcLnkJpETsYa5i3PEgruIbHtw5OWRpnoWqYFXgI96e8Gom2A0GqAmZ0xbGxidDiotC6vLeVmfaDyG9U8m8DOf4f74Aa7pd9h4P40dh10qxV+HBGxUqcASSKPVyiJgK2lpzS6PB7mLH4QQpnQPSOlolOon4MT7HcnQvuyQ6igB+weeEYRFFzVEZzBAR6lqSSLYapeBRdLejhfeFQv85CiTTKJMsdDmOmKBH1e7fL+nB4qWJjTT2CgalKhTKqEg1dbXY9FiQYQcBF0ORHhOmr29jXWk43EpzUPOgyjnxoFzDSkaJwloMpkwNDSEkZERDA8Py/ufc2B3FyGPGxx11b/0DdvUWW7xK44jP1GgFH1WM4LmJXgpnqDYbwd4pYiJCeSlAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"react element tree\" title=\"react element tree\" src=\"/static/2e4121db1459e29f83f309f0fa55b5e4/c94d1/react_element_tree.png\" srcset=\"/static/2e4121db1459e29f83f309f0fa55b5e4/0780f/react_element_tree.png 198w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/47b26/react_element_tree.png 395w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/c94d1/react_element_tree.png 790w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/9e288/react_element_tree.png 1185w,\n/static/2e4121db1459e29f83f309f0fa55b5e4/35b34/react_element_tree.png 1445w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>react element의 경우 모든 자식을 children 속성으로 참조합니다.<br>\n특별한 부분은 없으므로 바로 VDOM으로 넘어가겠습니다.</p>\n<anchor id=\"VDOM\" />\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.08575380359613%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz21SDY+aQBDl//+KJqa9xLRJ07R6UQ/16tcpoOIpwikKCigItoeod368DqumXnsvmexmMvve7Jvh1gsPi4mJYLnEer3GNcrlMkRRRKVSQSaTAc/z7I7j3xovfIbpuTjs9yzNHV9fsSKyxWKBiAhDOtViHoZQRxiG2Gw2TCiKInbuqN6iJtJiA43BE6LtBrppYDwaIQgCIsRbhJ6H5rev6Bd4pvoeHN9HqlFFXVOoZofo2SeyJVarkAiPR8RxOBxY8erXEkrmFk/3RWy2W5a71MQRYxb4SBRyyLWl/8S468IYptxGJ/Ud3dsUHE09EZ7F1iRQVVXk5CbG9gSCqoBv1VDqKxjPZ28J97sdXsgjTx9i2pJgd9rwyZsX8vAiuI5C5FsCCrIE33WgGgbSwgOyYg2aNT0RXr66pMHUPyfR/pKElLxBNfEBjU8JyLGXxFfudfHxZ5511ifRm2IWkq6jPzHQIC9jxFyMMI6AFEyanCEKCGybdTxTenAHGvuy4c4hU8dzErZocD3Lgj6zMZmNYdpDojsNkLt4NyUfFP4O2n0Bv89+mERud+R3J72k/TMcA64/h+PZGFsjNizOUvuw6aH7KMMm78a0fwvHZo+s3iPcdhOTeg3edMJyu/MqifoAJbJBol0sUl1J6UKgHKfVH9BJ/4B2l2GTje/OSGeP+rQ6Qz7L8rNzLrbneiv+xR+O4i8sOl/+vQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"fiber tree\" title=\"fiber tree\" src=\"/static/9b78c3f6f60939e0dc886845b74cb49c/c94d1/fiber_tree.png\" srcset=\"/static/9b78c3f6f60939e0dc886845b74cb49c/0780f/fiber_tree.png 198w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/47b26/fiber_tree.png 395w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/c94d1/fiber_tree.png 790w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/9e288/fiber_tree.png 1185w,\n/static/9b78c3f6f60939e0dc886845b74cb49c/c4e1e/fiber_tree.png 1446w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>여기에서는 <code class=\"language-text\">Fragment</code>가 사라진 부분을 제외하고는 이미 언급한 부분들입니다.<br>\nFragment는 포장지 역할만 하기 때문에 Fiber로 변환될 때 reconciler가 Fragment를 바로 벗기고 자식들만 취합니다. 하지만 Fragment도 react element이므로 key를 설정할 수 있습니다. 이 key가 설정된 Fragment는 단순한 포장지 역할을 넘어서 개발자가 의도적으로 Fragment를 판별하기 위한 장치이므로 벗겨내지 않고 fiber로 만듦과 동시에 재사용 가능하도록 합니다. 이 부분은 추후에 코드를 통해 확인하게 될 것입니다.</p>\n<blockquote>\n<p>만약 Fragment를 다음과 같이 정의 했다면 Todo 컴포넌트 자식으로 Fragment가 살아있었을 것입니다.<br>\n&#x3C;React.Fragment key=“foo”></p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.08575380359613%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABwklEQVQoz42S2W7aYBSE/f6XfYGoN71qVTVSUFMRWpXVFMIW2xBcNoPBDjaLwTaL+WoMRCSlSkcaHV/MmX+OxkLTGDGbz9kFAbvdjteQJIlUKoUoisiyzCWcdvcUJs6E/kBjqA/ZbjaUfqt8Ld/TNoxI7HoeXkQ3mvs3u0qSZvELj4VrptbwhangLRxs22JsWaxWPuVWi5tfaTrmKFTxV+q1v0RrZFDLt6jVOFOzE2mCo1bYi4LQ/YRcXeL9jzhqmPocupqnEn+HVk8y1uvIqSvalRjuck4jfYUm30U64WQ2GI9J1KpklCp90yBREkk+lBGbjziuy3JmYvQeWMzHOLMnRj0Ja9RivfJ40iSmhkqw3RwS7tEZdIkVRCpNhbk1Jh0W8K2Q5Xu1hB2W9i8o2Q/0GllatTsa+Y9hKaH4cy7DTbg8nU5I3Of5lEvSNU1+1kIzx4kWt9vtizaD6Dtg5S+ilGvfDaeL4PoektZDHvSxZzMa4VR0nc5Qo95RsCfG8d/g2eycryFcOqNn6Fi2gfF0mK1+m9Vme/C9YHpO4RT/VI6/XnNdyFPvdbktlyiqTWKl4vPpwf8YvnXGMdqb6fb8A3EjQgw3LaplAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"dom tree\" title=\"dom tree\" src=\"/static/914819c7e9cfda3169682706ca97475a/c94d1/dom_tree.png\" srcset=\"/static/914819c7e9cfda3169682706ca97475a/0780f/dom_tree.png 198w,\n/static/914819c7e9cfda3169682706ca97475a/47b26/dom_tree.png 395w,\n/static/914819c7e9cfda3169682706ca97475a/c94d1/dom_tree.png 790w,\n/static/914819c7e9cfda3169682706ca97475a/9e288/dom_tree.png 1185w,\n/static/914819c7e9cfda3169682706ca97475a/c4e1e/dom_tree.png 1446w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>VDOM을 DOM에 적용할 때 당연히 호스트 컴포넌트만 마운트합니다. 개발자가 작성한 컴포넌트는 상태를 가지고 호스트 컴포넌트를 반환하는 콜백 함수 그 이상 그 이하도 아닙니다.  </p>\n<p>사전준비는 모두 끝났습니다. 이제 본격적으로 재조정 작업을 시작해 봅시다.</p>\n<h1 id=\"5-sync-work-async-work\"><a href=\"#5-sync-work-async-work\" aria-label=\"5 sync work async work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Sync Work, Async Work</h1>\n<p>훅을 이용하여 Work 콜백을 스케줄링 시켰던 것 기억하시나요? 이때 여러 상황을 고려하여 재조정 작업을 비동기로 처리해야 할 지 동기적으로 처리해야 할 지 정했습니다. 그리고 이 결정에 따라서 Work 콜백을 달리 선택했는데 이 콜백은 각각 performConcurrentWorkOnRoot(), performSyncWorkOnRoot()이었습니다.  </p>\n<p>여기서 비동기 작업을 마지막으로 언급하고 이 이후로는 동기작업에 대해서만 진행하도록 하겠습니다.</p>\n<h2 id=\"async-work\"><a href=\"#async-work\" aria-label=\"async work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Async Work</h2>\n<p>비동기 작업에 대해 지난 포스터에서 언급만 하고 아직 코드로 확인하지 못했던 부분이 있었습니다. 바로 scheduler에게 잔여작업이 있는지 알려주는 부분<up><a href=\"/react/in-depth-react-scheduler_2#work_loop\" target=\"_blank\">19번 라인</a></up>입니다.  </p>\n<p>performConcurrentWorkOnRoot()를 통해 확인해볼 텐데 현재 확인 하는 부분을 제외하고는 로직이 performSyncWorkOnRoot()와 똑같습니다. 그러므로 나머지 부분은 동기작업을 분석할 때 설명하기 위해 여기서는 생략하도록 하겠습니다.  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> didTimeout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> <span class=\"token function\">getNextRootExpirationTimeToWorkOn</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">!==</span> NoWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> originalCallbackNode <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>callbackNode<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 생략..</span>\n\n    <span class=\"token comment\">// render phase 진입 생략..</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 생략..</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// commit phase 진입 생략..</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token operator\">===</span> originalCallbackNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// The task node scheduled for this root is the same one that's</span>\n      <span class=\"token comment\">// currently executed. Need to return a continuation.</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>생략된 부분은 render phase와 commit phase에 진입하는 코드입니다.</p>\n</blockquote>\n<p>9라인의 <code class=\"language-text\">callbackNode</code><up>Task</up>는 13라인의 commit phase를 지나면 null로 초기화 됩니다. null이 아니라는건 다음의 코드에서 Work를 진행하다 중지된겁니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Perform work until Scheduler asks us to yield</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>중지 되었다면 당연히 <code class=\"language-text\">workInProgress</code>는 비어있지 않기 때문에 13라인에 도달하지 못하므로 root의 callbackNode는 초기화 되지 않습니다. 그리고 한 가지 더 16라인의 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L552\" target=\"_blank\">ensureRootIsScheduled()</a>를 실행했는데도 callbackNode가 현재 Work를 진행한 Task와 같다는건 현재 Task가 가장 우선순위가 높기 때문에 계속해서 작업을 진행할 수 있다는 뜻입니다. 이 모든 근거를 바탕으로 20라인에서 performConcurrentWorkOnRoot()을 반환해 재조정 작업을 계속해서 이어서 진행할 수 있도록 합니다.</p>\n<blockquote>\n<p>concurrent mode에 대해서는 자세히 다루지는 않았지만 기반이 되는 몇몇 부분들을 확인해보았습니다. 이번 시리즈에서는 이 이상으로 해당 모드에 대해서 분석하지는 않지만 추후에 보편적으로 사용하게되는 날이 오면 그때가서 본격적으로 다루어 보도록 하겠습니다.</p>\n</blockquote>\n<h2 id=\"sync-work\"><a href=\"#sync-work\" aria-label=\"sync work permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sync Work</h2>\n<blockquote>\n<p>async work와는 다르게 해당 Work는 한번 실행되면 모든 작업이 끝날 때 까지 동기적으로 처리합니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Check if there's expired work on this root. Otherwise, render at Sync.</span>\n  <span class=\"token keyword\">const</span> lastExpiredTime <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>lastExpiredTime<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> lastExpiredTime <span class=\"token operator\">!==</span> NoWork <span class=\"token operator\">?</span> lastExpiredTime <span class=\"token punctuation\">:</span> Sync<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">lastExpiredTime</code>는 이전 Work가 만료되었을 때 할당되는 시간입니다. 이 부분은 위에서 performConcurrentWorkOnRoot()를 다룰 때 독자들의 이해를 위해 생략했던 부분으로 따로 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L636\" target=\"_blank\">여기서</a> 확인해 볼 수 있습니다. concurrent mode에서 비동기로 Work를 진행하다 만료가 될 경우 root에 lastExpiredTime가 새겨지고 다음 작업부터 동기로 처리하기 위해 performSyncWorkOnRoot()를 실행하도록 한다고만 생각해주세요.  </p>\n<p>어쨋든 sync work가 실행되는 경우는 두가지, 위 경우와 처음부터 sync인 경우입니다. 스니펫 코드가 바로 두 가지 경우에 대한 <code class=\"language-text\">expirationTime</code>을 구하는 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// const expirationTime = lastExpiredTime !== NoWork ? lastExpiredTime : Sync;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    root <span class=\"token operator\">!==</span> workInProgressRoot <span class=\"token operator\">||</span>\n    expirationTime <span class=\"token operator\">!==</span> renderExpirationTime\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">prepareFreshStack</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>if문의 의미를 알아보겠습니다.<br>\n이 부분도 concurrent mode와 연관이 있는데 자바스크립트는 멀티 스레드 환경에서 실행되는게 아니기 때문에 리액트는 하나의 재조정 작업만 할 수 있습니다. 그리고 현재 재조정 작업중인 root를 <code class=\"language-text\">workInProgressRoot</code>로 잡아두고 있죠. 하지만 현재 가장 우선순위가 높은 Task의 root가 작업중이던 root와 다르다면 기존에 작업중이던 VDOM 트리를 초기화 해주어야 합니다. 그 역할을 <code class=\"language-text\">prepareFreshStack()</code>가 합니다.<br>\n<code class=\"language-text\">expirationTime !== renderExpirationTime</code>도 root와 같은 의미입니다. </p>\n<blockquote>\n<p>VDOM에는 하나의 root만 존재합니다. 이 말인 즉슨 root가 다르다는 의미는 ReactDOM.render()를 통해 만들어진 다른 VDOM root의 작업이 더 우선순위가 높다라는 말입니다. 그래서 진행중이던 트리를 초기화해야 되는 겁니다.</p>\n</blockquote>\n<blockquote>\n<p>renderExpirationTime는 초기에는 noWork<up>0</up>입니다. 만약 맨 처음으로 호출되는 경우 위 if문은 항상 true일 것이고 재조정 작업전에 초기화될 것입니다.  </p>\n</blockquote>\n<p>prepareFreshStack()는 workInProgress 트리의 host root를 만듦과 동시에 작업에 필요한 전역 변수들을 초기화 시킵니다.</p>\n<anchor id=\"prepareFreshStack\" />\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareFreshStack</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> expirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  root<span class=\"token punctuation\">.</span>finishedWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> \n  root<span class=\"token punctuation\">.</span>finishedExpirationTime <span class=\"token operator\">=</span> NoWork<span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\">  workInProgressRoot <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span></span>  workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  renderExpirationTime <span class=\"token operator\">=</span> expirationTime<span class=\"token punctuation\">;</span></span>  workInProgressRootExitStatus <span class=\"token operator\">=</span> RootIncomplete<span class=\"token punctuation\">;</span>\n  workInProgressRootFatalError <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  workInProgressRootLatestProcessedExpirationTime <span class=\"token operator\">=</span> Sync<span class=\"token punctuation\">;</span>\n  workInProgressRootLatestSuspenseTimeout <span class=\"token operator\">=</span> Sync<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<anchor id=\"createWorkInProgress\" />\n<p>하이라이트 부분에서 바로 이전에 보았던 변수들을 확인할 수 있습니다.<br>\n작업용 tree의 host root인 <code class=\"language-text\">workInProgress</code>를 만들어야 합니다. <a href=\"/react/in-depth-react-intro#prepare_fresh_stack\" target=\"_blank\">Intro</a>에서 해당 트리에 대한 설명을 기억하시나요? 작업용 fiber를 만들때는 current을 자가복제 해서 만든다고 언급했습니다.<br>\n그리고 매번 새로운 객체를 만들어내지 않습니다. 재조정 작업은 매우 반복적으로 발생하는 작업입니다. 그래서 매번 객체를 만들어 리소스를 낭비하지 않고 기존에 만들어진 객체를 재활용하여 속성만 초기화 해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  pendingProps<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> workInProgress <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 새로 생성</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span>\n      current<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">,</span>\n      pendingProps<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>elementType<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n\n    workInProgress<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span>\n    current<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 재활용</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 기존 객체를 재활용하기 위한 초기화</span>\n    workInProgress<span class=\"token punctuation\">.</span>pendingProps <span class=\"token operator\">=</span> pendingProps<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> NoEffect<span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    workInProgress<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// current와 workInProgress가 공유하는 속성들</span>\n  workInProgress<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>childExpirationTime<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">;</span>\n\n  workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n\n  workInProgress<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">;</span>\n  workInProgress<span class=\"token punctuation\">.</span>ref <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>ref<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>한 가지만 생각하고 넘어가겠습니다.<br>\n현재 위치는 재조정 작업을 들어가기 전 시작 위치 입니다. 그리고 최 상단 current을 복제한 workInProgress을 만들었죠. 여기까지만 놓고 봤을 때 컴포넌트의 상태가 변하면 항상 host root 부터 시작한다는 걸 알 수 있습니다. 깊이가 깊은 자식의 상태값이 바뀌어도 host root부터 자식까지 workInProgress 트리를 만들어 갈 것입니다.</p>\n<blockquote>\n<p>트리만 만든다는 것이지 host root부터 자식까지 컴포넌트들을 실행한다는 건 아닙니다.</p>\n</blockquote>\n<p>prepareFreshStack()이 실행된 후의 VDOM은 다음과 같습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 586px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.116040955631405%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB0klEQVQoz5WSy27TQBSG846wYFMkHqCvwYbuWSAVIVVs6AKQskACpAoEaoqKmkSkSk3u8SV17GCPPfZc/HM8tgshlVDH+jUjz+g7/7m0iqJAKZQ7AEWSpPLc3O2ovm/W33etBlaCnPMOuq+O0D9+CW84MI91oUiyljb/guEQ69EIYRQhTdMtaKs5aIoZzgJYn3qwz0eI/LgKrxq7tXVa7uwJ7Nlz+OsMnmuDc34DrRwSLhXA2DlEp/cQP5f7mIdf4fgbTC8PMOjew9XgPoJ5u3yKmHnYbDx43gq2vYTv+/+kXAIpumsfovv9AcaXewQ7QbDJMBk+w2lnD72LR1gv3hnHUgpElO50OsViucBkMkGWZcblTQ1zVcByIpz0RzizHNgES3MBzihyVqdb7lohkhJhwnC9Whl3SZLs1jCXBT70L/D0fRsvvnzEqWVREG3cVxVWKOre8jACC3/BcV24pDiOIYTYdphRKhFLcDW2YDtzcqegqtnZGRmIHCrPwMgZY8wApZR/gOUnyOHbb2d4/PoYB+03+PxjUHdO3zqHt62tOeQE5FQzx3cRhCuwXELoYtfhf1R3mVKWGoKOUcIRk3jZTV3d3RnYSGpt6mak7wZq9BuhCZjgovPNLwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"prepare fresh stack\" title=\"prepare fresh stack\" src=\"/static/ebe6186ba40a6583c9e3d095d10dcec5/77b8d/prepare_fresh_stack.png\" srcset=\"/static/ebe6186ba40a6583c9e3d095d10dcec5/0780f/prepare_fresh_stack.png 198w,\n/static/ebe6186ba40a6583c9e3d095d10dcec5/47b26/prepare_fresh_stack.png 395w,\n/static/ebe6186ba40a6583c9e3d095d10dcec5/77b8d/prepare_fresh_stack.png 586w\" sizes=\"(max-width: 586px) 100vw, 586px\" loading=\"lazy\">\n    </span>\n<p>이렇게 작업용 VDOM의 entry를 만들었습니다. 이제 본격적으로 render phase에 진입하여 VDOM을 순회할 차레입니다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">목록</th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-scheduler_2/\">React 톺아보기- 05. Seconciler_2</a></td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-reconciler_2/\">React 톺아보기- 05. Reconciler_2</a></td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"React 톺아보기- 05. Reconciler_1","date":"2020-07-01","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-reconciler_1/","previous":{"fields":{"slug":"/react/in-depth-react-scheduler_2/"},"frontmatter":{"title":"React 톺아보기- 04. Scheduler_2","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_2/"},"frontmatter":{"title":"React 톺아보기- 05. Reconciler_2","category":"react"}}}}}