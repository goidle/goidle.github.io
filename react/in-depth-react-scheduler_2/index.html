<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, minimum-scale=1, maximum-scale=2"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:Catamaran;font-weight:800;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:56px;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:20px;color:inherit;font-family:Catamaran;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:6px;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:2px;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#0687f0;text-decoration:none;box-shadow:none;}a:hover,a:active{text-decoration:underline;}a.gatsby-resp-image-link{box-shadow:none;text-decoration:none;}a:hover{text-decoration:none;}</style><style data-href="/styles.5ef2db19258f1289f869.css" id="gatsby-global-css">@import url(https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css);@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:100;src:local("Noto Sans KR Thin "),local("Noto Sans KR-Thin"),url(/static/noto-sans-kr-latin-100-2de137ca3e12ea146ee47485a97f1e78.woff2) format("woff2"),url(/static/noto-sans-kr-latin-100-b965647685dd9fc531d1f8a1cc25e024.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:300;src:local("Noto Sans KR Light "),local("Noto Sans KR-Light"),url(/static/noto-sans-kr-latin-300-4f773a0fce88aa857d70b56c5b0a1d26.woff2) format("woff2"),url(/static/noto-sans-kr-latin-300-ee87751dac814562bac316d848e35748.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:400;src:local("Noto Sans KR Regular "),local("Noto Sans KR-Regular"),url(/static/noto-sans-kr-latin-400-be09f2ced7ff9fa6eda5f0416e2fc840.woff2) format("woff2"),url(/static/noto-sans-kr-latin-400-4c50be0fe5b21a153b8e40a392c2d3fe.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:500;src:local("Noto Sans KR Medium "),local("Noto Sans KR-Medium"),url(/static/noto-sans-kr-latin-500-416698c2fc4b3951f8d63d3d2ae23900.woff2) format("woff2"),url(/static/noto-sans-kr-latin-500-28601458e118110e494903a1fcd6dcf5.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:700;src:local("Noto Sans KR Bold "),local("Noto Sans KR-Bold"),url(/static/noto-sans-kr-latin-700-04e782e08729f3725ae5a9c95da0c8ba.woff2) format("woff2"),url(/static/noto-sans-kr-latin-700-b9e989a96027f839a9569d2d011e0b71.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:900;src:local("Noto Sans KR Black "),local("Noto Sans KR-Black"),url(/static/noto-sans-kr-latin-900-c41f1395489a117ca36d550142a1695f.woff2) format("woff2"),url(/static/noto-sans-kr-latin-900-589f5fbf84d9dc9984a969bae969fd60.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:100;src:local("Catamaran Thin "),local("Catamaran-Thin"),url(/static/catamaran-latin-100-3570195a7b5f619dd9b2419d8fa3f089.woff2) format("woff2"),url(/static/catamaran-latin-100-e82908f57f6d2f23eb9876b2d6868195.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:200;src:local("Catamaran Extra Light "),local("Catamaran-Extra Light"),url(/static/catamaran-latin-200-987ea210308405ac77ba2f36430a70c9.woff2) format("woff2"),url(/static/catamaran-latin-200-bb5993d2f001b739bb9ab7c3ed9725c3.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:300;src:local("Catamaran Light "),local("Catamaran-Light"),url(/static/catamaran-latin-300-2b8a4bd13e9d5ba755f010f8732b0bb6.woff2) format("woff2"),url(/static/catamaran-latin-300-c2696c65c33dcf37871b72bad51ee1ce.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:400;src:local("Catamaran Regular "),local("Catamaran-Regular"),url(/static/catamaran-latin-400-640947b787a38ec35d097129637d9130.woff2) format("woff2"),url(/static/catamaran-latin-400-97e5bc807a3e915e3fbf40ce5fcb1128.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:500;src:local("Catamaran Medium "),local("Catamaran-Medium"),url(/static/catamaran-latin-500-884483dd213f37ae3b5c98f73dd190a5.woff2) format("woff2"),url(/static/catamaran-latin-500-412cf386e31213e3601cb2132b9c4c2d.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:600;src:local("Catamaran SemiBold "),local("Catamaran-SemiBold"),url(/static/catamaran-latin-600-eb6ebda25331e50d3f42c45a41f613bb.woff2) format("woff2"),url(/static/catamaran-latin-600-215c58c6114e0556cb1c332c0fda463a.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:700;src:local("Catamaran Bold "),local("Catamaran-Bold"),url(/static/catamaran-latin-700-3196f49881b324fa5a5f937875cc380f.woff2) format("woff2"),url(/static/catamaran-latin-700-05f6e51c518dd3b521b258e5c05d0e72.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:800;src:local("Catamaran ExtraBold "),local("Catamaran-ExtraBold"),url(/static/catamaran-latin-800-601b1d0f1b78fd65c3205b2c004bbe60.woff2) format("woff2"),url(/static/catamaran-latin-800-3b1675e4ede7e86ec79fa84c1203908e.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:900;src:local("Catamaran Black "),local("Catamaran-Black"),url(/static/catamaran-latin-900-6bb5f96614acb7754020b922e1a63d24.woff2) format("woff2"),url(/static/catamaran-latin-900-79292dba48851cc3a212863c860d8f09.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.custom-hr{margin:64px 0;background:linear-gradient(72deg,#291e95,#cc007a);border:none;height:2px}.home-header{margin-top:0;border-bottom:none;font-weight:900;font-size:48px;letter-spacing:-2px}.link{box-shadow:none;text-decoration:none;color:inherit}.switch-container{text-align:right}.switch-container .icon{text-align:center;color:#222;font-size:14px;font-weight:900}.footer{padding-top:52px;text-align:center;font-size:12px}.footer a{text-decoration:none!important}.home{position:absolute;margin-top:-1.5px}body.light{background-color:#fff;color:#615f5f}body.light .home-header{color:#5a5a5a}body.light .bio .author-name-content{background-color:#ecf0f2}body.light .bio .author-introduction{color:#7d7d7d}body.light .bio a{color:navy}body.light .bio .bio_fontaswesome{fill:navy;vertical-align:-.125em}body.light .category-container{border-color:#ecf0f2;border-style:solid;border-width:1px 6px;background-color:#f4f7f8}body.light .category-container .item{border:1px solid #ecf0f2;background-color:#fff;box-shadow:0 1px 1px rgba(0,0,0,.1)}body.light .category-container .item a{color:#666}body.light .category-container .item[aria-selected=true]{border:2px solid #909da1;font-weight:bolder}body.light .category-container .item[aria-selected=true] a{color:#636c6e}body.light .category-container .item .badge{background-color:#f5222d;color:#fff}body.light .thumbnail{background-color:#fff;box-shadow:0 0 12px rgba(122,124,136,.212)}body.light .thumbnail h3{color:#5173b3}body.light .thumbnail p{color:#7d7d7d}body.light .thumbnail:hover{text-shadow:.1px .1px .1px rgba(68,67,67,.925);box-shadow:1px 3px 15px rgba(122,124,136,.432)}body.light .footer,body.light .thumbnail .thumbnail-subinfo{color:#615f5f}body.light .footer a{color:#5a5a5a}body.light .navigator a{background-color:#fceff7;color:#cc007a}body.light :not(pre)>code[class*=language-]{color:#fff;border:1.2px solid hsla(0,0%,100%,.6392156862745098);background:#7d7d7d}body.dark{background-color:#282c35;color:#dbd8d8}body.dark .home-header{color:#eee}body.dark .bio .author-name-content{background-color:#383636}body.dark .bio .author-introduction{color:#dbd8d8}body.dark .bio a{color:#bb72ec}body.dark .bio .bio_fontaswesome{fill:#bb72ec;vertical-align:-.125em}body.dark .category-container{border-color:#383636;border-style:solid;border-width:1px 6px;background-color:#24272c}body.dark .category-container .item{border:1px solid #383636;background-color:#282c35;box-shadow:0 1px 1px hsla(0,0%,100%,.1)}body.dark .category-container .item a{color:#d8d7d7}body.dark .category-container .item[aria-selected=true]{border:2px solid #666;font-weight:bolder}body.dark .category-container .item[aria-selected=true] a{color:#fff}body.dark .category-container .item .badge{background-color:#d695ab;color:#eee}body.dark .thumbnail{background-color:#282c35;box-shadow:0 0 12px rgba(197,166,201,.2)}body.dark .thumbnail h3{color:#d695ab}body.dark .thumbnail p{color:#dbd8d8}body.dark .thumbnail:hover{box-shadow:1px 1px 13px rgba(195,153,201,.26);text-shadow:.1px .1px .1px #fff}body.dark .footer,body.dark .thumbnail .thumbnail-subinfo{color:#dbd8d8}body.dark .footer a{color:#fff}body.dark blockquote{border-left:4px solid hsla(0,0%,100%,.822)}body.dark h1,body.dark h2{border-bottom-color:hsla(0,0%,100%,.3)}body.dark .navigator a{background-color:#fceff7;color:#cc007a}body.dark td,body.dark th{border-bottom:1px solid hsla(0,0%,100%,.15)}body.dark :not(pre)>code[class*=language-]{color:#c85656;border:1.2px solid rgba(0,0,0,.6392156862745098);background:#e1e1e1}body.dark hr{background:hsla(0,0%,100%,.3)}body{font-family:Noto Sans KR,sans-serif;background-color:#fff;-webkit-text-size-adjust:antialiased;-moz-osx-font-smoothing:grayscale;transition:background-color .3s,color .3s}h1{margin-top:2em;font-size:2.15em}h1,h2{letter-spacing:-1px;border-bottom:transparent!important}h2{margin-top:1.5em;margin-bottom:0;font-size:1.5em}h3{font-weight:700;margin-bottom:.1rem;margin-top:0;letter-spacing:-1px}@media (max-width:500px){.home-header{font-size:40px}}.post-date{text-align:right;font-size:12px;font-style:italic}.bio{margin-bottom:15px}.bio .author-description{display:flex}.bio .author-image{margin-top:0;margin-right:12px;margin-bottom:0;min-width:95px}.bio .author-name{display:flex;flex-direction:column;justify-content:center}.bio .author-name-prefix{font-size:90%;margin-right:4px}.bio .author-name-content{display:inline-block;font-size:95%;padding:2px 6px;font-weight:bolder;border-radius:8px;transform-origin:center;cursor:default}.bio .author-introduction{margin-top:4px;font-size:80%;line-height:1.4}.bio .author-socials{margin-top:4px}.bio a{margin-right:8px;font-size:80%;cursor:pointer}.bio a.visited{text-decoration:none}@keyframes flutter{0%{transform:rotate(0deg)}35%{transform:rotate(0deg)}40%{transform:rotate(-5deg)}60%{transform:rotate(5deg)}65%{transform:rotate(0deg)}to{transform:rotate(0deg)}}.item{position:relative}.item .badge{display:inline-block;position:absolute;top:1px;right:3px;transform:translate(50%,-50%);border-radius:10px;box-shadow:0 0 0 1px;padding:8px 7px;z-index:999;font-weight:700}.category-container{position:sticky;position:-webkit-sticky;top:0;line-height:0;white-space:nowrap;overflow-x:scroll;-ms-overflow-style:none;overflow:-moz-scrollbars-none;z-index:1;padding:6px 20px;margin:0 -5px!important}.category-container .item{display:inline-block;margin:.25rem 7px .25rem 0;border-radius:15px;white-space:normal;box-sizing:border-box;cursor:pointer}.category-container .item div{display:block;padding:14px 16px 16px;font-size:13px;box-sizing:border-box}.category-container .item:last-child{margin-right:0}.category-container::-webkit-scrollbar{display:none}.thumbnail-container{min-height:calc(100vh - 3.5rem)}.thumbnail{display:block;margin-top:12px;padding:15px 15px 12px;transition:box-shadow .3s,text-shadow .3s,opacity .4s;opacity:0;border-radius:10px}.thumbnail p{font-size:90%;line-height:1.4}.thumbnail .thumbnail-subinfo{font-size:.75rem;margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid #e8e8e8}.thumbnail.visible{opacity:1}.navigator{margin:40px 0;list-style:none;padding:0;overflow:hidden}.navigator li{margin-bottom:12px}.navigator a{padding:7px 16px 8px;border-radius:6px;font-size:12px;opacity:.8}ul.navigator li.right_navi{float:right}ul.navigator li.left_navi{float:left}.post h1{font-size:2.5rem;line-height:1.1}.post h2{margin-top:3.5rem;font-size:1.73286rem}.post h2,.post p{margin-bottom:1.75rem}.post li{margin-bottom:.875rem}.post .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1.2em;margin-left:-1.2em;padding-right:1em;padding-left:.75em;border-left:.35em solid #0687f0}.post blockquote{color:#999}.post code[class*=language-],.post pre[class*=language-]{color:#e0e0e0;background:none;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none}.post pre[class*=language-]::-webkit-scrollbar{display:none}.post pre[class*=language-]{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:.6em}.post :not(pre)>code[class*=language-],.post pre[class*=language-]{background:#212121}.post :not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.5em;white-space:normal;color:#d66587;margin:0 .1em}.post .token.block-comment,.post .token.cdata,.post .token.comment,.post .token.doctype,.post .token.prolog{color:#616161}.post .token.punctuation{color:#e0e0e0}.post .token.attr-name,.post .token.deleted,.post .token.namespace,.post .token.tag{color:#e2777a}.post .token.function-name{color:#6196cc}.post .token.boolean,.post .token.function,.post .token.number{color:#ff9100}.post .token.class-name,.post .token.constant,.post .token.property,.post .token.symbol{color:#ff0}.post .token.atrule,.post .token.builtin,.post .token.important,.post .token.keyword,.post .token.selector{color:#b388ff}.post .token.attr-value,.post .token.char,.post .token.regex,.post .token.string,.post .token.variable{color:#00e676}.post .token.entity,.post .token.operator,.post .token.url{color:#67cdcc}.post .token.bold,.post .token.important{font-weight:700}.post .token.italic{font-style:italic}.post .token.entity{cursor:help}.post .token.inserted{color:green}.dark .anchor{fill:#dbd8d8}.light .anchor{fill:#615f5f}td[align=center]:first-child,th[align=center]:first-child{text-align:center!important;font-weight:bolder!important}table{margin-top:100px}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;user-select:none;margin:1.2em}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.tldr{padding-left:1em;margin-top:-26px}h3{margin-bottom:.5em}h3 code.language-text{font-size:16px!important}up{top:-.5em;font-size:75%}down,up{position:relative;line-height:0;vertical-align:baseline;font-weight:500}down{font-size:85%}figcaption{padding:3px;text-align:center}center,figcaption{font:italic smaller sans-serif;font-weight:700;font-size:14px}center{top:-.7em;position:relative}ol li,ol li p{margin-bottom:.3rem!important}.gatsby-resp-image-wrapper{margin-bottom:20px}p{position:relative}a.code_link{position:absolute;font-size:small;bottom:-2rem;left:1rem}a.code_link_2{bottom:-2rem}a.code_link_2,a.code_link_3{position:absolute;font-size:small;left:3.1rem;z-index:999}a.code_link_3{bottom:-2.5rem}a.code_link_4{position:absolute;font-size:small;bottom:-3rem;left:1rem}h4{font-weight:700}a.code_link_5{position:absolute;font-size:small;bottom:-3rem;left:3.1rem;z-index:999}strong{font-weight:700}a.code_link_6{position:absolute;font-size:small;bottom:-2.5rem;z-index:999;left:1rem}summary{display:list-item}a.code_link_7{position:absolute;font-size:small;bottom:-3.5rem;left:1rem}</style><meta name="generator" content="Gatsby 2.32.13"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=f24356c48475809626ea0c2ac67855c6" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#ffffff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f24356c48475809626ea0c2ac67855c6"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">React 톺아보기 - 04. Scheduler_2 | Deep Dive Magic Code</title><meta data-react-helmet="true" name="description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 5. Scheduler_scheduleCallback scheduler는 전달받은 callback을 Task 객체에 담아 관리합니다. 먼저 이 Task의 생김새부터 확인해봅시다. 위 속성중 scheduler가 전달받은 것은 과 입니다. 이 이외에는 scheduler…"/><meta data-react-helmet="true" property="og:title" content="React 톺아보기 - 04. Scheduler_2 | Deep Dive Magic Code"/><meta data-react-helmet="true" property="og:description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 5. Scheduler_scheduleCallback scheduler는 전달받은 callback을 Task 객체에 담아 관리합니다. 먼저 이 Task의 생김새부터 확인해봅시다. 위 속성중 scheduler가 전달받은 것은 과 입니다. 이 이외에는 scheduler…"/><meta data-react-helmet="true" property="og:image" content="/static/felog-f24356c48475809626ea0c2ac67855c6.png"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="google-site-verification" content="o402P1kCwteUVT_5s9zR21dD9lTF4ALZNLms22CIMx4"/><meta data-react-helmet="true" name="keywords" content="react, redux, javascript, web, development, frontend, 리액트, 리덕스, 리액트, react, fiber, hook, hooks, useState, useEffect, useLayoutEffect, useCallback, scheduler"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-1fa11aca75e3a2c54418.js"/><link as="script" rel="preload" href="/framework-8de36d3fd07627b19105.js"/><link as="script" rel="preload" href="/app-3c65e7b7ed72c5497f26.js"/><link as="script" rel="preload" href="/styles-0ec71dd62c66cb95665c.js"/><link as="script" rel="preload" href="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-707e424af4a0a27cbbeb.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-6020d22b933a677a17bf.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-26aea61718c6277f711a.js"/><link as="fetch" rel="preload" href="/page-data/react/in-depth-react-scheduler_2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2277278352.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/536400264.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:52rem;padding:2.4375rem 1.21875rem" class="post"><a class="link" href="/"><svg class="home" width="1.125em" font-size="2em" overflow="visible" viewBox="0 0 576 512"><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg></a><div class="switch-container"><label for="normal-switch"><div style="position:relative;display:inline-block;text-align:left;opacity:1;direction:ltr;border-radius:12px;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s;touch-action:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none"><div class="react-switch-bg" style="height:24px;width:48px;margin:0;position:relative;background:#d9dfe2;border-radius:12px;cursor:pointer;-webkit-transition:background 0.25s;-moz-transition:background 0.25s;transition:background 0.25s"><div style="height:24px;width:26px;position:relative;opacity:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon checkedIcon">D</div></div><div style="height:24px;width:26px;position:absolute;opacity:1;right:0;top:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon uncheckedIcon">L</div></div></div><div class="react-switch-handle" style="height:22px;width:22px;background:#ffffff;display:inline-block;cursor:pointer;border-radius:50%;position:absolute;transform:translateX(1px);top:1px;outline:0;border:0;-webkit-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;-moz-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s"></div><input type="checkbox" role="switch" style="border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px" id="normal-switch"/></div></label></div><h1>React 톺아보기 - 04. Scheduler_2</h1><p class="post-date">3 years ago</p><div><blockquote>
<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>
</blockquote>
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; ">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.06060606060607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABd0lEQVQoz5VTy3LCMAzk/z+PG9AD9NROS96xLcnOduUQCp32UM9srARp9VixW5YFvwLA+XzGfr/H8XjE6XTC4XDA5XLB/WRF+/aKpu1gqjVutxFgw3Ye7R8nmOGaIgZN9CtADV2+CQs/CB9KW3NGZMBoiolZEzGq4FMi2hhwnSd0ktDwW8gGob+VQo6N0Isp/EFnWBaoSSV1cncUW4PEbRJET+IkLCvyvU+pJnZfbIRFemB4AeJHtYsGIDVYdESWkbOKgPodsLDSQhKQLPHOvNcJ3SosrM5iW6vU2EPnzwpLAx3YCkdRLCDP7yRrYGFC6ujvGOnDMTyKufPZm0wULKyZLBKyilLyTSC2U9RbeVA4r3CfJ8JKYiiR7SVZs84zpLkitU0VpyeunNNEgkmkitOx3caVDjO6YUAI4XltHJkBS99V0kwlsytMsoGKOtxOnJmWm0hlVdh4P63NfRdRVwpPG1j385fd3By3uI3QqyrM8uc/5p/4AoimYHNzbqFEAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="scheduling flow" title="scheduling flow" src="/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png" srcset="/static/9e327099e752bd46cae5074351cfbe5c/18f77/scheduling_flow.png 198w,
/static/9e327099e752bd46cae5074351cfbe5c/2cb6c/scheduling_flow.png 395w,
/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png 790w,
/static/9e327099e752bd46cae5074351cfbe5c/471ef/scheduling_flow.png 1185w,
/static/9e327099e752bd46cae5074351cfbe5c/5d6a0/scheduling_flow.png 1580w,
/static/9e327099e752bd46cae5074351cfbe5c/c2d13/scheduling_flow.png 2560w" sizes="(max-width: 790px) 100vw, 790px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy">
    </span>
<h1 id="5-scheduler_schedulecallback" style="position:relative;"><a href="#5-scheduler_schedulecallback" aria-label="5 scheduler_schedulecallback permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Scheduler_scheduleCallback</h1>
<p><strong>scheduler</strong>는 전달받은 callback을 <strong>Task</strong> 객체에 담아 관리합니다. 먼저 이 <strong>Task</strong>의 생김새부터 확인해봅시다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">,</span>
  priorityLevel<span class="token punctuation">,</span>
  startTime<span class="token punctuation">,</span>
  expirationTime<span class="token punctuation">,</span>
  <span class="token literal-property property">sortIndex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>위 속성중 <strong>scheduler</strong>가 전달받은 것은 <code class="language-text">callback</code>과 <code class="language-text">priorityLevel</code>입니다. 이 이외에는 <strong>scheduler</strong>가 내부적으로 만들어내는 정보이며 이중 시간과 관련된 <code class="language-text">startTime</code>과 <code class="language-text">expirationTime</code>을 먼저 알아보도록 하겠습니다.</p>
<h2 id="5---1-starttime-expirationtime" style="position:relative;"><a href="#5---1-starttime-expirationtime" aria-label="5   1 starttime expirationtime permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5 - 1 startTime, expirationTime</h2>
<p><strong>reconciler</strong>는 시간 정보인 timeout과 delay를 options에 담아 전달합니다. delay와 timeout은 각각 startTime, expirationTime을 구하는데 사용됩니다.</p>
<blockquote>
<p><strong>reconciler</strong>에서는 expirationTime에 여러 의미가 있었지만, <strong>scheduler</strong>는 이름 그대로 <strong>Task</strong>의 만료 시간을 뜻합니다.</p>
</blockquote>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L295" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> startTime
  <span class="token keyword">var</span> timeout

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime
    <span class="token punctuation">}</span>
    timeout <span class="token operator">=</span>
      <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>timeout
        <span class="token operator">:</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    timeout <span class="token operator">=</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span>
    startTime <span class="token operator">=</span> currentTime
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>options가 없거나<up>18</up> timeout이 담겨 있지 않다면<up>15</up> <strong>reconciler</strong>가 넘겨준 우선순위를 기준 <code class="language-text">timeoutForPriorityLevel()</code>을 통해 구합니다.</p>
<blockquote>
<p><code class="language-text">options</code>는 concurrent mode에서 사용합니다.</p>
</blockquote>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L279" target="_blank" class="code_link">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">
<span class="token comment">// Times out immediately</span>
<span class="token keyword">var</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// Eventually times out</span>
<span class="token keyword">var</span> <span class="token constant">USER_BLOCKING_PRIORITY</span> <span class="token operator">=</span> <span class="token number">250</span>
<span class="token keyword">var</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">5000</span>
<span class="token keyword">var</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10000</span>
<span class="token comment">// Never times out</span>
<span class="token keyword">var</span> <span class="token constant">IDLE_PRIORITY</span> <span class="token operator">=</span> maxSigned31BitInt <span class="token comment">// 1073741823</span>

<span class="token keyword">function</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span>
    <span class="token keyword">case</span> <span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">USER_BLOCKING_PRIORITY</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IdlePriority</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">IDLE_PRIORITY</span>
    <span class="token keyword">case</span> <span class="token literal-property property">LowPriority</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span>
    <span class="token keyword">case</span> <span class="token literal-property property">NormalPriority</span><span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>reconciler</strong>는 sync <strong>Work</strong>를 <a href="/react/in-depth-react-scheduler_1/#scheduleSyncCallback" target="_blank">scheduleSyncCallback()</a>를 통해 넘겨줄 때 우선순위를 Scheduler_ImmediatePriority로 넘겨주었습니다. 해당 우선순위로 expirationTime을 계산해보면(<down>startTime + timeout</down>) currentTime보다 -1ms만큼 빠릅니다.</p>
<h2 id="5---2-task-생성하기" style="position:relative;"><a href="#5---2-task-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="5   2 task 생성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5 - 2 Task 생성하기</h2>
<p>사전작업은 모두 끝났습니다. 이제부터 본격적으로 새로 생성된 <strong>Task</strong>를 어떻게 다루는지 알아보겠습니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L318" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// var expirationTime = startTime + timeout</span>

  <span class="token keyword">var</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
    priorityLevel<span class="token punctuation">,</span>
    startTime<span class="token punctuation">,</span>
    expirationTime<span class="token punctuation">,</span>
    <span class="token literal-property property">sortIndex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">></span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*Timer..*/</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/*Task..*/</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>큰 틀을 보자면 <strong>Task</strong>를 생성한 후 실행 시점에 따라 분기<up>15</up>처리하고 <strong>reconciler</strong>에게 반환<up>21</up>합니다(<down>root에 기입하기 위해</down>). 여기서 생성된 <strong>Task</strong>는 <a href="https://en.wikipedia.org/wiki/Binary_heap" target="_blank">최소힙</a> 자료구조에 추가되어 우선순위에 맞춰 정렬됩니다. 이때 힙의 정렬 기준은 <strong>Task</strong>의 sortIndex입니다.</p>
<h3 id="1-timer" style="position:relative;"><a href="#1-timer" aria-label="1 timer permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1) Timer</h3>
<p>딜레이된 <strong>Task</strong>는 시간이 지나 timeout이 되어야 실행할 수 있는 <strong>Task</strong>이므로 <strong>Timer</strong>라고 부르고 있습니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L330" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">var</span> taskQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Task</span>
<span class="token keyword">var</span> timerQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// Delayed task</span>

<span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">/*var newTask = ...;*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">></span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> startTime
    <span class="token function">push</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// All tasks are delayed, and this is the task with the earliest delay.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 중복 실행 방지</span>
        <span class="token comment">// Cancel an existing timeout.</span>
        <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Schedule a timeout.</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/*General task..*/</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>힙 정렬 기준<up>sortIndex</up>은 <code class="language-text">startTime</code><up>11</up> 입니다. <strong>Timer</strong>는 시작 시간순으로 정렬됨을 알 수 있습니다.</li>
<li>
<p><strong>Timer</strong>를 힙에 추가<up>12</up>하는데 heap.push(newTask)를 생각했던 것과는 달리 행위<up>push</up>에 동작의 주체<up>timerQueue</up>와 <strong>Timer</strong>를 넘겨주고 있습니다.</p>
<blockquote>
<p>힙 구현은 <a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/SchedulerMinHeap.js" target="_blank">SchedulerMinHeap.js</a>에서 확인할 수 있습니다.</p>
</blockquote>
</li>
<li>
<p>taskQueue에 실행대기 중인 <strong>Task</strong>가 없고<up>13</up> 새로 생성된 <strong>Timer</strong>가 <strong>Timer</strong>중에서 가장 우선순위가 높다면<up> 13</up> 실행 1순위는 생성된 <strong>Timer</strong>입니다. <strong>Timer</strong>의 실행 방식은 timeout api를 이용하여 최소 딜레이된 시간 이후에 timeQueue 소비 함수가 실행되도록 구현되어 있습니다.</p>
<p>실행 1순위 <strong>Timer</strong>가 바뀌었으므로 <a href="#requestHostTimeout">requestHostTimeout</a>(<down>timeout api</down>)<up>22</up>를 1순위 <strong>Timer</strong>의 딜레이 시간으로 갈아 끼워<up>22</up>야 합니다. 이때 주의할 점은 실행된 timeout api가 있다면 취소<up>15</up> 해주어야 합니다.</p>
</li>
</ul>
<h4 id="timer소비-함수-handletimeout" style="position:relative;"><a href="#timer%EC%86%8C%EB%B9%84-%ED%95%A8%EC%88%98-handletimeout" aria-label="timer소비 함수 handletimeout permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Timer소비 함수 handleTimeout()</h4>
<p>handleTimeout()이 호출되었다는 건 1순위 <strong>Timer</strong>가 timeout되었음을 나타냅니다. timeout된 <strong>Timer</strong>는 실행 되어야 하는 <strong>Task</strong>로 취급 되므로 taskQueue로 옮겨집니다. 그리고 그 안에서 또 우선순위에 따라서 정렬되겠죠.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L105" target="_blank" class="code_link">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">handleTimeout</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 여기에 도달했다는 건 timeout api가 실행된 것이다.</span>
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token comment">// timeout Timer를 꺼내 taskQueue에 추가한다.</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L81" target="_blank" class="code_link_3">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">advanceTimers</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>timer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Task는 취소되면 callback은 null로 초기화된다.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 취소된 Timer를 꺼냄</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span>startTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Timer fired. Transfer to the task queue.</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
      timer<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> timer<span class="token punctuation">.</span>expirationTime
      <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> timer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Remaining timers are pending.</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    timer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>timerQueue에서 하나씩 timeout여부를 확인<up>9</up>하여 taskQueue에 추가합니다. taskQueue의 정렬기준은 timerQueue와는 달리 expirationTime<up>12</up>입니다.</li>
</ul>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L109" target="_blank" class="code_link_5">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">handleTimeout</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// advanceTimers(currentTime)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 중복 실행 방지</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>timeout <strong>Timer</strong>가 taskQueue로 옮겨졌는지 확인<up>7</up>합니다. 확인되었으면 taskQueue 소비 함수<up>flushWork</up>를 다음 프레임에 실행될 수 있도록 host_config의 함수인 <code class="language-text">requestHostCallback()</code><up>9</up>을 호출합니다.</li>
<li>만약 <code class="language-text">advanceTimers()</code>를 진행<up>4</up>했는데도 taskQueue가 비어<up>10</up>있다면 취소된 timeout <strong>Task</strong>로 인해 handleTimeout()이 호출된 것이므로 다음 <strong>Timer</strong>의 시간으로 다시 timeout api를 실행<up>13</up>합니다.</li>
</ul>
<h3 id="2-task" style="position:relative;"><a href="#2-task" aria-label="2 task permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2) Task</h3>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L345" target="_blank" class="code_link_5">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">/*var newTask = ...;*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">></span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*Timer..*/</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> expirationTime
    <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHostCallbackScheduled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPerformingWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newTask
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>taskQueue의 우선순위는 <code class="language-text">expirationTime</code><up>9</up>입니다.</li>
<li><code class="language-text">isPerformingWork</code>는 Work의 진행이 concurrent mode에서는 비동기로 동작하기 때문에 <strong>scheduler</strong>는 다른 VDOM root가 요청한 Work를 실행해버릴 수 있습니다. 이를 방지하기 위한 플래그입니다.</li>
<li><code class="language-text">requestHostCallback()</code>의 구현 코드는 <code class="language-text">requestHostTimeout()</code> 처럼 단순하지 않으므로 host_config를 분석할 때 다루도록 하겠습니다. 단지 지금은 flushWork()를 비동기로 실행하는 api라고 생각하면 됩니다.</li>
</ul>
<p>원래 흐름대로라면 다음 분석 대상은 host<em>config의 requestHostCallback()나 requestHostTimeout()가 이지만 host</em>config로 넘어갔다가 다시 돌아오기에는 너무 먼 길을 갔다 와야 하므로 <strong>scheduler</strong>를 마저 분석하고 난 후에 진행하도록 하겠습니다.</p>
<h1 id="9-flushwork" style="position:relative;"><a href="#9-flushwork" aria-label="9 flushwork permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>9. flushWork</h1>
<p>flushWork()는 taskQueue를 소비하기 전 사전작업 공간입니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L122" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  isHostCallbackScheduled <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHostTimeoutScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isHostTimeoutScheduled <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token function">cancelHostTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  isPerformingWork <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 중복 실행 방지</span>
  <span class="token keyword">const</span> previousPriorityLevel <span class="token operator">=</span> currentPriorityLevel
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    currentTask <span class="token operator">=</span> <span class="token keyword">null</span>
    currentPriorityLevel <span class="token operator">=</span> previousPriorityLevel
    isPerformingWork <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>flushWork()는 requestHostCallback()로 인해 다음 프레임에 호출됩니다. 그러니 비동기 관련 플래그 <code class="language-text">isHostCallbackScheduled</code>를 꺼줍니다<up>3</up>.</li>
<li>timeout api가 실행되어 있다면 <strong>Task</strong>를 처리할 것이므로 방해받지 않도록 취소<up>6</up>시켜 줍니다.</li>
<li><code class="language-text">workLoop()</code>가 반환<up>12</up>하는 값을 flushWork()도 그대로 반환하고 있음을 기억해 두세요. 이 값은 host_config가 받아 async <strong>Work</strong>의 잔여 작업 존재 여부를 판단하여 추가 처리하는데 사용됩니다.</li>
</ul>
<h1 id="10-workloop" style="position:relative;"><a href="#10-workloop" aria-label="10 workloop permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10. workLoop</h1>
<p>이해를 돕기 위해 간단한 의사코드로 흐름을 먼저 알아보고 실제 코드를 보겠습니다.</p>
<ol>
<li>currentTask = peek(taskQueue)</li>
<li>
<p><strong>while</strong> currentTask !== null</p>
<ol>
<li><strong>if</strong> currentTask의 만료 시간이 여유가 있는 와중에 <strong>scheduler</strong>에게 할당된 시간이 끝났다.</li>
<li>break</li>
<li>callback = currentTask.callback;</li>
<li><strong>if</strong> callback !== null</li>
<li>callback을 실행해 Work를 시작한다.</li>
<li>
<p><strong>if</strong> callback이 잔여 작업을 반환했다.</p>
<ul>
<li>currentTask.callback = continuationCallback;</li>
</ul>
</li>
<li>
<p><strong>else</strong></p>
<ul>
<li>잔여 작업이 없다면 currentTask를 taskQueue에서 꺼낸다.</li>
</ul>
</li>
<li><strong>end if</strong></li>
<li><strong>else</strong></li>
<li>callback이 없다는 건 Task가 취소되었다는 뜻이므로 taskQueue에서 꺼낸다.</li>
<li><strong>end if</strong></li>
<li>currentTask = peek(taskQueue);</li>
</ol>
</li>
<li><strong>end while</strong></li>
<li>
<p><strong>if</strong> currentTask !== null</p>
<ul>
<li>currentTask가 null이 아니라면 <strong>scheduler</strong>에게 할당된 시간이 끝나 while 문이 중단되어 Task가 아직 남아 있다는 뜻으로 config_host에게 계속해서 작업을 이어갈 수 있도록 알려준다.</li>
</ul>
</li>
<li>
<p><strong>else</strong></p>
<ul>
<li><strong>Task</strong>는 모두 처리되었으므로 <strong>Timer</strong>가 존재한다면 소비하기 위해 requestHostTimeout()를 호출하고 잔여 작업이 남아 있지 않음을 host_config에게 알린다.</li>
</ul>
</li>
<li><strong>end if</strong></li>
</ol>
<anchor id="work_loop">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L164" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token comment">// Task 소비 전 timeout Timer를 taskQueue로 옮겨놓는다.</span>
  currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">></span> currentTime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This currentTask hasn't expired, and we've reached the deadline.</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span>
      currentPriorityLevel <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>priorityLevel
      <span class="token keyword">const</span> didUserCallbackTimeout <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime
      <span class="token comment">// Work 진행, 잔여 작업 여부 반환(concurrent mode)</span>
      <span class="token keyword">const</span> continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>didUserCallbackTimeout<span class="token punctuation">)</span>
      currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> continuationCallback
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return whether there's additional work</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>추가 설명이 필요한 부분만 짚고 넘어가도록 하겠습니다.</p>
<ul>
<li>timerQueue의 기아상태(starvation)를 방지하기 위해서 틈틈이 timeout <strong>Timer</strong>를 꺼내<up>4, 32</up>줍니다.</li>
<li>
<p>if 문<up>9 ~ 10</up> 조건의 뜻은 현재 <strong>Task</strong>의 만료시간이 조금이라도 여유가 있으면 꼭 지금 처리해야 하는 게 아니므로 host<em>config에게 물어<up>shouldYieldToHost()</up>봅니다. 작업을 계속 동기적으로 처리해도 되는지? 만약 그렇지 않다면 while 문을 중단<up>13</up>하고 브라우저에게 메인 스레드를 양보하기 위해 제어권을 host</em>config에게 넘깁<up>41, 47</up>니다.</p>
<p>제어권을 전달받은 host_config는 잔여 여부에 따라 다음 프레임에 계속해서 <strong>Task</strong>를 소비할 수 있도록 준비합니다. 하지만 <strong>Task</strong>의 만료시간이 이미 지나버렸다면<up>9</up> 브라우저고 뭐고 바로 처리해야 하므로 제어권을 넘기지 않고 만료된 모든 <strong>Task</strong>를 동기적으로 처리해버립니다.</p>
</li>
</ul>
<p>여기까지가 <strong>scheduler</strong>가 하는 일입니다. 다음 섹션에서는 host_config가 어떻게 비동기 api를 구현했는지 확인합니다.</p>
<h1 id="6-requesthosttimeout-requesthostcallback" style="position:relative;"><a href="#6-requesthosttimeout-requesthostcallback" aria-label="6 requesthosttimeout requesthostcallback permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. requestHostTimeout, requestHostCallback</h1>
<p>간단한 timeout 구현부터 확인하겠습니다.</p>
<anchor id="requestHostTimeout">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L164" target="_blank" class="code_link">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">
<span class="token keyword">const</span> setTimeout <span class="token operator">=</span> window<span class="token punctuation">.</span>setTimeout
<span class="token keyword">const</span> clearTimeout <span class="token operator">=</span> window<span class="token punctuation">.</span>clearTimeout

<span class="token function-variable function">requestHostTimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  taskTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function-variable function">cancelHostTimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>taskTimeoutID<span class="token punctuation">)</span>
  taskTimeoutID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span></code></pre></div>
<p>우리가 브라우저 환경에서 사용하는 일반적인 비동기 코드와 크게 다르지 않습니다.</p>
<p>requestHostCallback()은 requestHostTimeout()과는 다르게 setTimeout() api로 구현하지 않고 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API" target="_blank">MessageChannel</a>을 이용하여 구현했습니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L221" target="_blank" class="code_link_2">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline

<span class="token function-variable function">requestHostCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduledHostCallback <span class="token operator">=</span> callback
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMessageLoopRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">true</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function-variable function">cancelHostCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li><strong>scheduler</strong>에서 requestHostCallback()을 호출할 때 넘겨준 <code class="language-text">callback</code><up>flushWork</up>을 전역으로 잡아<up>9</up>둡니다. 이 callback은 onmessage 핸들러인 <code class="language-text">performWorkUntilDeadline()</code><up>4</up>에서 사용됩니다.</li>
</ul>
<p>requestHostCallback() 호출을 호출했으니 메시지 채널을 통해 다음 프레임에 performWorkUntilDeadline()가 호출되면서 Work가 진행될 것입니다.</p>
<h1 id="8-performworkuntildeadline" style="position:relative;"><a href="#8-performworkuntildeadline" aria-label="8 performworkuntildeadline permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8. performWorkUntilDeadline</h1>
<p>performWorkUntilDeadline()는 callback<up>flushWork</up>를 호출하는데 flushWork()의 반환 값에 따라 작업을 모두 완료했거나 또는 작업 중 host_config가 할당한 시간<up>deadline</up>을 넘긴 경우로 해석할 수 있습니다. 후자의 경우 다음 프레임에 계속해서 작업이 이어갈 수 있도록 해주어야 합니다.</p>
<anchor id="performWorkUntilDeadline">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L186" target="_blank" class="code_link_2">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">let</span> yieldInterval <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// ms</span>
<span class="token keyword">let</span> deadline <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">const</span> <span class="token function-variable function">performWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    deadline <span class="token operator">=</span> currentTime <span class="token operator">+</span> yieldInterval
    <span class="token keyword">const</span> hasTimeRemaining <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hasMoreWork <span class="token operator">=</span> <span class="token function">scheduledHostCallback</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasMoreWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span>
        scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> error
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    isMessageLoopRunning <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  needsPaint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">yieldInterval</code>과 <code class="language-text">deadline</code>은 다음의 주석으로 설명을 대체합니다.</p>
<blockquote>
<h3 id="yieldinterval" style="position:relative;"><a href="#yieldinterval" aria-label="yieldinterval permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>yieldInterval</h3>
<p>Scheduler periodically yields in case there is other work on the main thread, like user events. By default, it yields multiple times per frame.<br>
It does not attempt to align with frame boundaries, since most tasks don’t need to be frame aligned; for those that do, use requestAnimationFrame.</p>
</blockquote>
<blockquote>
<h3 id="deadline" style="position:relative;"><a href="#deadline" aria-label="deadline permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deadline</h3>
<p>Yield after <code class="language-text">yieldInterval</code> ms, regardless of where we are in the vsync cycle. This means there’s always time remaining at the beginning of the message event.</p>
</blockquote>
<p>1초에 60프레임을 뽑으려면 약 16ms에 렌더링 파이프라인을 통과해야 합니다. 리액트는 Work를 꼭 VSync에 맞출 필요가 없다고 생각했습니다. <strong>Work</strong>는 메모리 작업이지 렌더링과 관련된 작업이 아니므로 한 프레임에 여러 번(<down>5ms</down>) 브라우저에 양보한다면 자바스크립트가 렌더링에 큰 영향을 미치지 않는다고 판단하는 것 같습니다.</p>
<p><code class="language-text">needsPaint</code><up>25</up>와 shouldYieldToHost() 등 언급은 되었지만, 아직 확인하지 않은 부분들은 다음 섹션에서 다룹니다.</p>
<h1 id="브라우저에게-양보하기-위한-시스템" style="position:relative;"><a href="#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%97%90%EA%B2%8C-%EC%96%91%EB%B3%B4%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C" aria-label="브라우저에게 양보하기 위한 시스템 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>브라우저에게 양보하기 위한 시스템</h1>
<p>host_config는 호스트 환경에 의존적인 모듈입니다. 사용하는 구현체 또한 그때그때 다르며 그중 하나가 shouldYieldToHost() 입니다. 분석은 이 함수로부터 시작합니다.</p>
<p>해당 함수는 제어권을 반납해야 하는지 다른 모듈들에 알려주는 역할을 합니다. 양보하는 이유는 자바스크립트가 브라우저의 사용자 이벤트 처리나 렌더링 작업을 방해하지 않게 하기 위함입니다.</p>
<p><strong>scheduler</strong> 시작 부분에서 <a href="/react/in-depth-react-scheduler_1#is-input-pending" target="_blank">isInputPending</a>에 대해 언급한 내용을 기억하시나요? 해당 api는 유저 이벤트가 대기 중인지 JS에서 알 수 있도록 해줍니다. shouldYieldToHost()는 이 api가 지원하는 환경인지에 따라 구현 코드가 달라집니다.</p>
<anchor id="isInputPending">
<h2 id="1-isinputpending-api를-지원하는-환경" style="position:relative;"><a href="#1-isinputpending-api%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%99%98%EA%B2%BD" aria-label="1 isinputpending api를 지원하는 환경 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. isInputPending api를 지원하는 환경</h2>
<p>이 환경에서는 사용자 이벤트와 페인트 두 가지를 각각 따로 확인할 수 있습니다.<br>
리액트는 위 두 상황이 아니라면 굳이 브라우저에 양보할 필요 없이 부지런히 Work를 진행하면 됩니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L125" target="_blank" class="code_link_2">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">let</span> maxYieldInterval <span class="token operator">=</span> <span class="token number">300</span>
<span class="token keyword">let</span> needsPaint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> deadline <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>
  enableIsInputPending <span class="token operator">&amp;&amp;</span>
  navigator <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
  navigator<span class="token punctuation">.</span>scheduling <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
  navigator<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>isInputPending <span class="token operator">!==</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scheduling <span class="token operator">=</span> navigator<span class="token punctuation">.</span>scheduling

  <span class="token function-variable function">shouldYieldToHost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">>=</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>needsPaint <span class="token operator">||</span> scheduling<span class="token punctuation">.</span><span class="token function">isInputPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
<span class="gatsby-highlight-code-line">      <span class="token keyword">return</span> currentTime <span class="token operator">>=</span> maxYieldInterval</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">requestPaint</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    needsPaint <span class="token operator">=</span> <span class="token boolean">true</span></span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// isInputPending를 지원하지 않는 환경..</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>16: <code class="language-text">deadline</code>을 넘겼다면 1차 신호입니다.</li>
<li>17: 사용자 이벤트가 대기 중이거나 렌더링이 필요하면<up>needsPaint</up> 바로 브라우저를 위해 콜 스택을 비워줘야 합니다.</li>
<li>20: 17라인에 해당하지 않는다면? <code class="language-text">maxYieldInterval</code>까지 작업을 계속해서 진행할 수 있습니다.</li>
</ul>
<p>사용자 이벤트 여부를 알려주는 isInputPending()의 경우 브라우저 api로 브라우저가 알려줍니다. 그렇다면 페인트가 필요한지에 대한 여부 needsPaint는 누가 알려주는 것일까요? needsPaint는 VDOM을 DOM에 모두 적용하였으니 브라우저의 렌더링이 필요하다는 여부를 <strong>reconciler</strong>가 알려주고 있는 것입니다. <strong>reconciler</strong>는 Commit phase가 모두 완료되면 <code class="language-text">requestPaint()</code>을 호출합니다.</p>
<h2 id="2-isinputpending-api를-지원하지-않는-환경" style="position:relative;"><a href="#2-isinputpending-api%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%ED%99%98%EA%B2%BD" aria-label="2 isinputpending api를 지원하지 않는 환경 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. isInputPending api를 지원하지 않는 환경</h2>
<p>isInputPending()이 지원되지 않는다면 <strong>reconciler</strong>가 알려주는 페인트 여부만 알 수 있습니다. 그래서 어쩔 수 없이 주기적으로 콜 스택을 비워줘야 합니다. 그래서 굳이 페인트 여부도 신경쓸 필요가 없습니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L159" target="_blank" class="code_link">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">
<span class="token keyword">let</span> maxYieldInterval <span class="token operator">=</span> <span class="token number">300</span>
<span class="token keyword">let</span> needsPaint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> deadline <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isInputPending <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*isInputPending를 지원하는 환경..*/</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">shouldYieldToHost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> deadline
  <span class="token punctuation">}</span>
  <span class="token function-variable function">requestPaint</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>isInputPending()을 사용하던 shouldYieldToHost()에서는 기준(<down>needsPaint, isInputPending</down>)이 명확하여 무리가 되지 않는 선<up>maxYieldInterval</up>에서 작업을 이어갈 수 있지만, 한 프레임에 짧은 기간 주기적으로 양보해야 되는 환경에서는 <code class="language-text">deadline</code>으로 작업을 끊어주어야 합니다.</p>
<p>deadline은 <a href="#performWorkUntilDeadline">performWorkUntilDeadline()</a>에서 기본적으로 5ms로 계산됩니다. 리액트는 deadline을 조절하기 위해 yieldInterval를 변경할 수 있는 함수를 제공합니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L170" target="_blank" class="code_link">scheduler > fork > SchedulerHostConfig.default.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token function-variable function">forceFrameRate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fps <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> fps <span class="token operator">></span> <span class="token number">125</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
      <span class="token string">'forceFrameRate takes a positive int between 0 and 125, '</span> <span class="token operator">+</span>
        <span class="token string">'forcing framerates higher than 125 fps is not unsupported'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fps <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    yieldInterval <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> fps<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// reset the framerate</span>
    yieldInterval <span class="token operator">=</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="3-양보를-위해-shouldyieldtohost가-사용되는-위치" style="position:relative;"><a href="#3-%EC%96%91%EB%B3%B4%EB%A5%BC-%EC%9C%84%ED%95%B4-shouldyieldtohost%EA%B0%80-%EC%82%AC%EC%9A%A9%EB%90%98%EB%8A%94-%EC%9C%84%EC%B9%98" aria-label="3 양보를 위해 shouldyieldtohost가 사용되는 위치 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 양보를 위해 shouldYieldToHost()가 사용되는 위치</h2>
<p>우리는 이미 한군데는 알고 있습니다. 바로 taskQueue를 소비하는 <a href="#work_loop">workLoop()</a> 입니다. <strong>scheduler</strong>에는 여기 말고도 한군데 더 있습니다. <strong>scheduler</strong> 내부에서 사용하는게 아닌 <strong>reconciler</strong>에게 알려주기 위해 작성된 함수입니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L398" target="_blank" class="code_link_2">scheduler > Scheduler.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">
<span class="token keyword">function</span> <span class="token function">unstable_shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">advanceTimers</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span> <span class="token comment">// timeout Timer를 taskQueue로 옮긴다.</span>
  <span class="token keyword">const</span> firstTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>firstTask <span class="token operator">!==</span> currentTask <span class="token operator">&amp;&amp;</span>
      currentTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      firstTask <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      firstTask<span class="token punctuation">.</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      firstTask<span class="token punctuation">.</span>startTime <span class="token operator">&lt;=</span> currentTime <span class="token operator">&amp;&amp;</span>
      firstTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> currentTask<span class="token punctuation">.</span>expirationTime<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>reconciler</strong>는 concurrent mode의 <strong>Work</strong>를 중간에 중지할 수 있습니다. 더 자세히는 Render phase에 국한되는 행위이며 일전에 보여드린 <a href="/react/in-depth-react-intro" target="_blank">컴포넌트 라이프 사이클 이미지</a>에 나와있는 <em>“May be paused, aborted or restarted”</em>에 대해 언급드리고 있는 것입니다.</p>
<p><strong>reconciler</strong>는 <code class="language-text">unstable_shouldYield()</code>를 통해 중지를 결정하므로 unstable_shouldYield()가 어떠한 근거를 가지고 판단하는지 확인해봅시다.</p>
<ul>
<li>7: advanceTimers()를 통해 삽인 된 timeout Timer든 <strong>reconciler</strong>의 스케줄 요청을 통해 삽입된 Task든 어쨌든 새롭게 삽입된 firstTask가 현재 진행 중인 currentTask보다 우선순위가 더 높다.</li>
<li>8 ~ 10: currentTask가 존재하고 firstTask 또한 Work를 가지고 있다.</li>
<li>11 ~ 12: firstTask는 이미 실행되어야 할 시간이 지났다.</li>
</ul>
<p>위 조건은 <strong>scheduler</strong> 입장에서의 기준이며 모두 만족해야 현재 진행 중인 Render phase를 중지할 수 있습니다. 또는 host_config 판단하에 브라우저에 메인 스레드를 양보해야 한다<up>13</up>면 Render phase를 바로 중지합니다.</p>
<p>마지막으로 <strong>reconciler</strong>가 unstable_shouldYield()를 어디에 사용하는지 확인하면서 이번 포스트를 마무리합니다.</p>
<anchor id="workLoopConcurrent">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1454" target="_blank" class="code_link">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">
<span class="token keyword">import</span> Scheduler_shouldYield <span class="token keyword">as</span> shouldYield <span class="token keyword">from</span> <span class="token string">'./SchedulerWithReactIntegration'</span>

<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Already timed out, so perform work without checking if we need to yield.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Perform work until Scheduler asks us to yield</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>위 함수들은 컴포넌트 단위의 재조정 작업을 진행하는 함수입니다. <code class="language-text">workLoopSync()</code>는 legacy mode, blocking mode에서 사용하고 <code class="language-text">workLoopConcurrent()</code>는 concurrent mode에서 사용합니다.</li>
<li>while 문의 조건을 보면 concurrent mode에서만 <code class="language-text">shouldYield()</code>를 사용하고 있습니다. 이 모드에서는 작업을 특정 컴포넌트까지 진행하다 중지시킬 수 있음을 해당 코드를 통해 짐작할 수 있습니다. 여기서 중지된 <strong>Work</strong>는 잔여 작업이 남아 있음을 <strong>scheduler</strong>에게 알려 주어야 계속해서 작업을 이어갈 수 있습니다.</li>
</ul>
<p>다음 포스트 <strong>reconciler</strong>에서는 <strong>Work</strong>가 하는 일이 도대체 무엇인지, 재조정 작업과 VDOM을 어떻게 DOM에 적용하는지, 함수형 컴포넌트의 라이프 사이클 격인 useEffect()와 useLayoutEffect()의 동작원리 등 리액트의 핵심 기능들을 알아볼 것입니다.</p></div><hr class="custom-hr"/><div class="bio"><div class="author"><div class="author-description"><a class="link" href="/"><img class="author-image" src="/static/felog-f24356c48475809626ea0c2ac67855c6.png" style="width:72px;height:79px"/></a><div class="author-name"><div><a class="author-name-content"><div><div style="float:left"><svg aria-hidden="true" focusable="false" class="bio_fontaswesome" data-prefix="fas" data-icon="envelope" role="img" width="1em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 496 512"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg> <!-- -->kgc4958@gmail.com</div></div></a></div><div class="author-introduction">오픈소스를 톺아보며 매직 코드라 생각했던 부분들의 동작 원리와 의미, 의도를 파악해보고 서로의 생각을 나누기 위한 블로그</div></div></div></div></div><ul class="navigator"><li class="left_navi"><a rel="prev" href="/react/in-depth-react-scheduler_1/">← <!-- -->React 톺아보기 - 04. Scheduler_1</a></li><li class="right_navi"><a rel="next" href="/react/in-depth-react-reconciler_1/">React 톺아보기 - 05. Reconciler_1<!-- --> →</a></li></ul><div class="utterences"></div><footer class="footer">©<a>Goidle</a>, Built with<!-- --> <a href="https://github.com/JaeYeopHan/gatsby-starter-bee">Gatsby-starter-bee</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-154981109-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react/in-depth-react-scheduler_2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-3df9f584718eda9580a2.js"],"app":["/app-3c65e7b7ed72c5497f26.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-44ceac2081f421b30e8f.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2a7b760bae899f5e9b0c.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b4c60ce3b2e714c9e16c.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-26aea61718c6277f711a.js"]};/*]]>*/</script><script src="/polyfill-3df9f584718eda9580a2.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-26aea61718c6277f711a.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-6020d22b933a677a17bf.js" async=""></script><script src="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-707e424af4a0a27cbbeb.js" async=""></script><script src="/styles-0ec71dd62c66cb95665c.js" async=""></script><script src="/app-3c65e7b7ed72c5497f26.js" async=""></script><script src="/framework-8de36d3fd07627b19105.js" async=""></script><script src="/webpack-runtime-1fa11aca75e3a2c54418.js" async=""></script></body></html>