{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_5/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"889d1c37-afc8-5171-b84c-decf2bd76d94","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM 재조정 작업을 진행한다. 완성된 VDOM을 commit phase를 통해 DOM…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<h3 id=\"포스트별-주제\"><a href=\"#%ED%8F%AC%EC%8A%A4%ED%8A%B8%EB%B3%84-%EC%A3%BC%EC%A0%9C\" aria-label=\"포스트별 주제 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>포스트별 주제</h3>\n<ol>\n<li>훅을 통해 컴포넌트 상태를 업데이트한다.</li>\n<li>업데이트를 반영할 <strong>Work</strong>를 <strong>scheduler</strong>에게 전달하고 <strong>scheduler</strong>는 스케줄링된 <strong>Task</strong>를 적절한 시기에 실행한다.</li>\n<li><strong>Work</strong>을 통해 VDOM 재조정 작업을 진행한다.</li>\n<li>\n<h3 id=\"u완성된-vdom을-commit-phase를-통해-dom에-적용한다u\"><a href=\"#u%EC%99%84%EC%84%B1%EB%90%9C-vdom%EC%9D%84-commit-phase%EB%A5%BC-%ED%86%B5%ED%95%B4-dom%EC%97%90-%EC%A0%81%EC%9A%A9%ED%95%9C%EB%8B%A4u\" aria-label=\"u완성된 vdom을 commit phase를 통해 dom에 적용한다u permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><u>완성된 VDOM을 commit phase를 통해 DOM에 적용한다.</u></h3>\n</li>\n<li>사용자의 상호작용으로 이벤트가 발생하고 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>\n</ol>\n<hr>\n<h1 id=\"7-commit-phase\"><a href=\"#7-commit-phase\" aria-label=\"7 commit phase permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. Commit phase</h1>\n<p><a class=\"code_link_3\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L977\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* render phase.. */</span>\n    <span class=\"token comment\">// executionContext = prevExecutionContext</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'Cannot commit an incomplete root. This error is likely caused by a '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'bug in React. Please file an issue.'</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">stopFinishedWorkLoopTimer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      root<span class=\"token punctuation\">.</span>finishedWork <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>alternate\n      root<span class=\"token punctuation\">.</span>finishedExpirationTime <span class=\"token operator\">=</span> expirationTime\n      <span class=\"token function\">finishSyncRender</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> workInProgressRootExitStatus<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// 잔여 작업이 없으므로 null을 리턴.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">finishSyncRender</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> exitStatus<span class=\"token punctuation\">,</span> expirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  workInProgressRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>commit phase에 진입하기에 앞서 render phase가 잘 마무리 되었는지 확인해야 됩니다.<br>\n<code class=\"language-text\">performSyncWorkOnRoot()</code>는 render phase를 동기적으로 처리하므로 정상적으로 끝났다면 <code class=\"language-text\">workInProgress</code>는 null<up>8</up>이어야 합니다.  </p>\n<h2 id=\"7---1-commitroot\"><a href=\"#7---1-commitroot\" aria-label=\"7   1 commitroot permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7 - 1 commitRoot</h2>\n<p>render phase와는 다르게 commit phase에서는 sub-phase가 추가적으로 존재합니다.<br>\n각 sub-phase는 effect를 소비한다는 큰 맥락은 같지만 소비 시점의 차이가 있습니다.<br>\n크게 effect의 성격에 따라 나뉘어 지며 DOM에 변형을 가하는 시점과 그 전, 후 나뉘어 집니다.</p>\n<p>DOM 변형 작업은 쉽게 생각해내실 수 있지만 그 전과 후에는 어떤 작업들이 있을까요?</p>\n<p>전</p>\n<ul>\n<li>클래스 컴포넌트: getSnapshotBeforeUpdate</li>\n<li>함수형 컴포넌트: clean-up-useEffect, useEffect</li>\n<li>호스트 컴포넌트: X</li>\n</ul>\n<p>변형</p>\n<ul>\n<li>클래스 컴포넌트: componentWillUnmount</li>\n<li>함수형 컴포넌트: clean-up-useLayoutEffect, clean-up-useEffect</li>\n<li>호스트 컴포넌트: element 삽입, 수정, 삭제</li>\n</ul>\n<p>후</p>\n<ul>\n<li>클래스 컴포넌트: componentDidMount, componentDidUpdate</li>\n<li>함수형 컴포넌트: useLayoutEffect</li>\n<li>호스트 컴포넌트: auto-focus</li>\n</ul>\n<p>위 작업은 useEffect를 제외하고는 모두 동기적으로 처리됩니다. 이 내용은 중요한 부분으로 DOM 변경과 화면 렌더링 사이 또는 그 후의 시점에 개발자의 코드가 개입할 수 있는 기회를 제공해줍니다. 함수형의 경우 각각 useLayoutEffect와 useEffect가 이에 해당하며 추후에 코드를 통해 자세히 다루어보도록 하겠습니다.</p>\n<anchor id=\"commitRootImpl\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1715\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitRootImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> renderPriorityLevel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> finishedWork <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>finishedWork\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>finishedExpirationTime\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 초기화</span>\n  root<span class=\"token punctuation\">.</span>finishedWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  root<span class=\"token punctuation\">.</span>finishedExpirationTime <span class=\"token operator\">=</span> NoWork\n  root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  root<span class=\"token punctuation\">.</span>callbackExpirationTime <span class=\"token operator\">=</span> NoWork\n  root<span class=\"token punctuation\">.</span>callbackPriority <span class=\"token operator\">=</span> NoPriority\n  root<span class=\"token punctuation\">.</span>nextKnownPendingLevel <span class=\"token operator\">=</span> NoWork\n\n  <span class=\"token comment\">// effect list의 head를 가지고 온다.</span>\n  <span class=\"token keyword\">let</span> firstEffect\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">></span> PerformedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      finishedWork<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> finishedWork\n      firstEffect <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>firstEffect\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      firstEffect <span class=\"token operator\">=</span> finishedWork\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// There is no effect on the root.</span>\n    firstEffect <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>firstEffect\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevExecutionContext <span class=\"token operator\">=</span> executionContext\n    executionContext <span class=\"token operator\">|=</span> CommitContext\n\n    <span class=\"token comment\">// 전</span>\n    nextEffect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">commitBeforeMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span>      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Should be working on an effect.'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">captureCommitPhaseError</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n        nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 변형</span>\n    nextEffect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">commitMutationEffects</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> renderPriorityLevel<span class=\"token punctuation\">)</span></span>      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Should be working on an effect.'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">captureCommitPhaseError</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n        nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// workInProgress tree를 DOM에 적용했으니 이젠 current로 취급한다.</span>\n    root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork\n\n    <span class=\"token comment\">// 후</span>\n    nextEffect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">commitLayoutEffects</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span></span>      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Should be working on an effect.'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">captureCommitPhaseError</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n        nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n    nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token comment\">// 브라우저가 화면을 렌더링 할 수 있도록 scheduler에게 알린다.</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">requestPaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span>\n    executionContext <span class=\"token operator\">=</span> prevExecutionContext\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// No effects.</span>\n    root<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> finishedWork\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Passive effect(useEffect)를 위한 설정</span>\n  <span class=\"token keyword\">const</span> rootDidHavePassiveEffects <span class=\"token operator\">=</span> rootDoesHavePassiveEffects\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rootDoesHavePassiveEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 화면이 그려지고 난 후에 실행될 effect들이 아직 남아 있으므로 root를 잡아둔다.</span>\n<span class=\"gatsby-highlight-code-line\">    rootDoesHavePassiveEffects <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"gatsby-highlight-code-line\">    rootWithPendingPassiveEffects <span class=\"token operator\">=</span> root</span><span class=\"gatsby-highlight-code-line\">    pendingPassiveEffectsExpirationTime <span class=\"token operator\">=</span> expirationTime</span><span class=\"gatsby-highlight-code-line\">    pendingPassiveEffectsRenderPriority <span class=\"token operator\">=</span> renderPriorityLevel</span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Passive effect가 없으면 effect를 모두 소비한 것이므로 GC를 위해 참조를 끊어준다.</span>\n    nextEffect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> nextNextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n      nextEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n      nextEffect <span class=\"token operator\">=</span> nextNextEffect\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">flushSyncCallbackQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>39, 51, 66: sub-phase</li>\n<li>79: <code class=\"language-text\">requestPaint()</code>의 설명은 일전에 다루었던 <a href=\"/react/in-depth-react-scheduler_2/#isInputPending\" target=\"_blank\">내용</a>으로 대체합니다.</li>\n<li>89 ~ 92: useEffect의 경우 브라우저가 화면을 그리고 난 후에 실행되는 effect입니다. shceduler가 다음 프레임에 effect 소비 함수를 실행할 때 effect list 정보를 담고있는 root가 필요합니다. 이 때문에 참조를 유지하기 위해 root를 잡아<up>90</up> 둘 필요가 있습니다.</li>\n<li>103, 104: commit phase를 진행하는 와중에 추가적인 작업이 스케줄링될 경우를 대비합니다.</li>\n</ul>\n<p>본격적으로 commit phase를 시작하겠습니다.</p>\n<h2 id=\"7---2-commitbeforemutationeffects\"><a href=\"#7---2-commitbeforemutationeffects\" aria-label=\"7   2 commitbeforemutationeffects permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7 - 2 commitBeforeMutationEffects</h2>\n<p>effect를 소비하는 방식은 간단합니다. firstEffect부터 lastEffect까지 순회하며 현재 시점에 처리해야되는 effect를 tag를 이용하여 필터링한 후 소비하는 방식입니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2031\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitBeforeMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag\n\n    <span class=\"token comment\">// getSnapshotBeforeUpdate</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> Snapshot<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate\n      <span class=\"token function\">commitBeforeMutationEffectOnFiber</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// useEffect()를 사용하면 Passive tag가 달린다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> Passive<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootDoesHavePassiveEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        rootDoesHavePassiveEffects <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// root를 잡아두기 위한 전역변수</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">scheduleCallback</span><span class=\"token punctuation\">(</span>NormalPriority<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token function\">flushPassiveEffects</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span></span>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>useEffect는 다음 프레임에 실행될 수 있도록 전문가인 scheduler에게 Passive effect 소비 함수를 넘겨줍니다.</p>\n<h3 id=\"1-commitbeforemutationeffectonfiber\"><a href=\"#1-commitbeforemutationeffectonfiber\" aria-label=\"1 commitbeforemutationeffectonfiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) commitBeforeMutationEffectOnFiber</h3>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L242\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitBeforeMutationLifeCycles</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> finishedWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// noop</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Snapshot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> prevProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps\n          <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState\n          <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode <span class=\"token comment\">// class instance</span>\n<span class=\"gatsby-highlight-code-line\">          <span class=\"token keyword\">const</span> snapshot <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">getSnapshotBeforeUpdate</span><span class=\"token punctuation\">(</span></span>            finishedWork<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">.</span>type\n              <span class=\"token operator\">?</span> prevProps\n              <span class=\"token punctuation\">:</span> <span class=\"token function\">resolveDefaultProps</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// defaultProps 적용</span>\n            prevState\n          <span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">          instance<span class=\"token punctuation\">.</span>__reactInternalSnapshotBeforeUpdate <span class=\"token operator\">=</span> snapshot</span>        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//HostRoot, HostComponent..</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'This unit of work tag should not have side-effects. This error is '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'likely caused by a bug in React. Please file an issue.'</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>클래스 컴포넌트는 DOM 변형전에 snapshot을 찍어놓기 위해 현재 시점에 getSnapshotBeforeUpdate()를 호출합니다.<br>\n그리고 돔 변형 이후에 componentDidUpdate(prevProps, prevState, snapshot)에서 사용할 수 있도록 instance에 저장해 놓습니다.</p>\n<h3 id=\"2-flushpassiveeffects\"><a href=\"#2-flushpassiveeffects\" aria-label=\"2 flushpassiveeffects permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) flushPassiveEffects</h3>\n<p>설명을 계속 미뤄두었던 useEffect가 나올 차례입니다.<br>\n먼저 아래 이미지를 통해 훅의 실행 흐름을 정확하게 짚고 넘어가겠습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 728px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 127.6098901098901%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEIUlEQVRIx6VV2VIbORTt/3/nFd4oIBVgKpkMFCRhMdgOeCNe2nbjDRsbb7249+3MvWq6YSqTeRlVHZ8jXekuLcmSQC2KIiY0m01sbW1hb28Ph4eHOD4+xv7+Pk5OTnBwcCDGz8/PsbOzg+3tbezu7uLo6Aiu64r1cRxDSgWDHVuWhc1mIzAej9FqtTAcDgVkWRbc6/UwGAxgGAYcxxHrUh8S//yuhWH4j8ncgiAQ479rWYar1UpEZKTZpk51XYemaSL79xXxGNu4Gl7Ha6TUeHFxIb5PoVDIMuFmmqb4hvw9i8WimOv7vrBx/+rqCudfz5HP5+F5XpLhv7b4bbN++RTBf5Q8Wg5RqOcJBcHXlWvc1HJoT2QYjgHLs2C6JjbORjD3dUsXWoy7m8zGkCbrMWqPVdSUKiqdMsrtEsrEyqwL1VKF0xS82HB0qKYKy7WEc2bTSQIxpNFqiO68g8elAmWRcG+lQH5uojGuQ541kXu4xpfrP1FS7tGaNtCddbKsGYZtZFra+BZUl6K6BtYcnbRGemVrgq3Ixpr03FhC96g06muUrR8G8CNC6MML/FcdQAqnU4R0SEM6sH6/T5zogA9uW8ayXodGh5t51WhgWi7DIlvMB9qyEdk2QjpOzAzJ6/fgNH7CbTXgNAnEia5jXSlBufiG/tUlWmeneLrNYXh9CUNuIaTjFNLZY3h0HlMtRRRJRCD4dEBDM4kW0KTpXRHD3BWmxQKei3k8Xn5HlwIsS/fwODgn0qhnzJBCdqKqCMmBR7cl0EjT6feXSyqxTiWWMK9VBb9UK5hVyvQJGgieRvBHQwFvNMi05MpN2JSJU76DU7qDXUrYKv2ARlkpp38JND79gfLHD+iRdmiNSOS1zIASeCvZopJ1/h4mGTZCRwaVr9IE6kc07qu6QKAlYz6P+wFiAnPk+UIzJAQzwB8SRojcQaKDRBtrui3rFky1DW3ZhKm1Rd81aU5s0920BOLQyrQUWzJi4w7xpkR8LxiEiPRL/yuG8gmelTOMO6eYD75j2PoCY16mxSbiQBcIPZUueKIl2lYhqGZhSDSV7i5A2wd1coPnx2+Y9S8wap/BXv5AbFYpcIX+iqq/aIkdxcGKylwjICexz5p22n2hJBrQZkUsnm4JN1iN8zAX9xTvJ7gy2FTdK1ItwXpArOcAI08l3wqAEKo8VoS7zGHc/gzl4RAj+RNlUqDNo2wCgwJroqLI195Kjn0q05vTZixot+aUIZUaLJIMvQTOZgLbeCKMyT5PKonoYSIwR4Gdaend/ynCiP/eEy34Vaf2lDPbK6IozmySul7Donv5/9qbd4mfxFqtJh4bfmhUuobMaZ85Bdv4jUnn8cP2/k0Wzyi/q51OB+12W3C32xWcQlEUYeP3OZ3H7/NkMhEObfojSR1y+xvxR6Uzn6gCwQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"hook flow\" title=\"hook flow\" src=\"/static/61abcbbac19bee4e8b43d4eb673ff438/9d3a0/hook_flow.png\" srcset=\"/static/61abcbbac19bee4e8b43d4eb673ff438/0780f/hook_flow.png 198w,\n/static/61abcbbac19bee4e8b43d4eb673ff438/47b26/hook_flow.png 395w,\n/static/61abcbbac19bee4e8b43d4eb673ff438/9d3a0/hook_flow.png 728w\" sizes=\"(max-width: 728px) 100vw, 728px\" loading=\"lazy\">\n    </span>\n<p>대부분의 훅이 <code class=\"language-text\">Render</code>에서 소비되는 것과는 달리 useEffect(), useLayoutEffect()는 commit phase에서 소비됩니다.<br>\nuseEffect()와 useLayoutEffect()는 life cycle effect를 생성한다는 점은 같지만 소비 시점의 차이가 존재합니다.</p>\n<p>diagram를 참고하여 시점을 확인해보자면 리액트가 DOM을 업데이트하는 <code class=\"language-text\">React updates DOM</code>, 브라우저가 화면을 렌더링하는 <code class=\"language-text\">Browser paints screen</code> 이후에 각각 실행됩니다. 이때 주의깊게 볼만한 점은 새로운 훅 실행 바로 직전에 clean-up function을 호출한다는 것입니다.</p>\n<p>useEffect()를 예로 들면 컴포넌트의 상태가 업데이트되어 리-렌더링이 진행될 때 바로 clean-up function을 호출하는게 아닌 다음 프레임에 새로운 useEffect()를 호출하기 바로 직전에 실행된다는 것입니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2177\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">flushPassiveEffectsImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// commitRoot()에서 잡아두었던 root</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rootWithPendingPassiveEffects <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> rootWithPendingPassiveEffects\n  <span class=\"token comment\">// 전역 변수 정리</span>\n  rootWithPendingPassiveEffects <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  pendingPassiveEffectsExpirationTime <span class=\"token operator\">=</span> NoWork\n\n  <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span>executionContext <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>RenderContext <span class=\"token operator\">|</span> CommitContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoContext<span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Cannot flush passive effects while already rendering.'</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> prevExecutionContext <span class=\"token operator\">=</span> executionContext\n  executionContext <span class=\"token operator\">|=</span> CommitContext\n\n  <span class=\"token keyword\">let</span> effect <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>firstEffect\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">commitPassiveHookEffects</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>effect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Should be working on an effect.'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">captureCommitPhaseError</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> nextNextEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>nextEffect\n    <span class=\"token comment\">// Remove nextEffect pointer to assist GC</span>\n    effect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    effect <span class=\"token operator\">=</span> nextNextEffect\n  <span class=\"token punctuation\">}</span>\n\n  executionContext <span class=\"token operator\">=</span> prevExecutionContext\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L395\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  NoEffect <span class=\"token keyword\">as</span> NoHookEffect<span class=\"token punctuation\">,</span>\n  UnmountPassive<span class=\"token punctuation\">,</span>\n  MountPassive<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./ReactHookEffectTags'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPassiveHookEffects</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Passive<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span>UnmountPassive<span class=\"token punctuation\">,</span> NoHookEffect<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span>NoHookEffect<span class=\"token punctuation\">,</span> MountPassive<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">commitHookEffectList()</code>는 life cycle effect를 소비하는 함수이며 먼저 useEffect(), useLayoutEffect()가 해당 effect를 어떻게 생성하는지 부터 확인하고 가겠습니다.</p>\n<h3 id=\"3-life-cycle-effect-생성\"><a href=\"#3-life-cycle-effect-%EC%83%9D%EC%84%B1\" aria-label=\"3 life cycle effect 생성 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3) Life cycle effect 생성</h3>\n<p>useEffect()와 useLayoutEffect()는 로직이 비슷하므로 같이 설명하도록 하겠습니다.<br>\n훅은 아시다시피 mount와 update 두 개의 실행환경으로 분류됩니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberHooks.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  Update <span class=\"token keyword\">as</span> UpdateEffect<span class=\"token punctuation\">,</span>\n  Passive <span class=\"token keyword\">as</span> PassiveEffect<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/ReactSideEffectTags'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  UnmountMutation<span class=\"token punctuation\">,</span>\n  MountLayout<span class=\"token punctuation\">,</span>\n  UnmountPassive<span class=\"token punctuation\">,</span>\n  MountPassive<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./ReactHookEffectTags'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// useEffect()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">mountEffect</span><span class=\"token punctuation\">(</span>\n  <span class=\"token function-variable function\">create</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    UpdateEffect <span class=\"token operator\">|</span> PassiveEffect<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    UnmountPassive <span class=\"token operator\">|</span> MountPassive<span class=\"token punctuation\">,</span></span>    create<span class=\"token punctuation\">,</span>\n    deps\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// useLayoutEffect()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">mountLayoutEffect</span><span class=\"token punctuation\">(</span>\n  <span class=\"token function-variable function\">create</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    UpdateEffect<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    UnmountMutation <span class=\"token operator\">|</span> MountLayout<span class=\"token punctuation\">,</span></span>    create<span class=\"token punctuation\">,</span>\n    deps\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>훅의 첫번째 인자로 넘어오는 함수를 <code class=\"language-text\">create</code>, create()가 반환하는 함수를 <code class=\"language-text\">destroy</code><up>clean-up </up>라고 명칭합니다.<br>\n<code class=\"language-text\">mountEffectImpl()</code>의 첫 번째 인자로 넘겨주는 tag는 fiber에 새겨지며 두 번째 인자 tag는 life cycle effect에 새겨집니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L895\" target=\"_blank\">reconciler > ReactFiberHooks.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n<span class=\"gatsby-highlight-code-line\">  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag</span>  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>mountWorkInProgressHook()가 기억 안나시는 분은 <a href=\"/react/in-depth-react-hooks_1/#mountWorkInProgressHook\" target=\"_blank\">hooks_1</a>를 참고하세요.</p>\n</blockquote>\n<p><code class=\"language-text\">sideEffectTag</code><up>5</up>는 workInProgress에 tag를 새겨넣기 위한 전역변수입니다. 이 변수는 renderWithHooks()에서 컴포넌트 호출이 끝나고 난 후에 사용됩니다.  </p>\n<blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"> <span class=\"token keyword\">function</span> <span class=\"token function\">renderWithHooks</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">/*...*/</span>\n  <span class=\"token keyword\">let</span> children <span class=\"token operator\">=</span> <span class=\"token function\">Component</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> refOrContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> renderedWork <span class=\"token operator\">=</span> currentlyRenderingFiber<span class=\"token punctuation\">;</span>\n  renderedWork<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> componentUpdateQueue<span class=\"token punctuation\">;</span> <span class=\"token comment\">// life cycle effect list</span>\n  renderedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> sideEffectTag<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/*...*/</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n</blockquote>\n<p><code class=\"language-text\">pushEffect()</code>는 effect를 생성하고 이를 <code class=\"language-text\">componentUpdateQueue</code>에 추가한 후에 effect를 반환<up>6</up>합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L854\" target=\"_blank\">reconciler > ReactFiberHooks.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> deps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> effect<span class=\"token punctuation\">:</span> Effect <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token punctuation\">,</span>\n    create<span class=\"token punctuation\">,</span>\n    destroy<span class=\"token punctuation\">,</span>\n    deps<span class=\"token punctuation\">,</span>\n    next<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>componentUpdateQueue <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    componentUpdateQueue <span class=\"token operator\">=</span> <span class=\"token function\">createFunctionComponentUpdateQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// return { lastEffect: null }</span>\n    componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> lastEffect <span class=\"token operator\">=</span> componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastEffect <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect <span class=\"token comment\">// circular</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> firstEffect <span class=\"token operator\">=</span> lastEffect<span class=\"token punctuation\">.</span>next <span class=\"token comment\">// circular</span>\n      lastEffect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> effect\n      effect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> firstEffect\n      componentUpdateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> effect\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> effect\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>컴포넌트 호출 와중에 생성되는 life cycle effect들은 <code class=\"language-text\">componentUpdateQueue</code>에 담기게 됩니다. </p>\n<p>세번째 인자로 넘어오는 destroy는 컴포넌트 mount 시점에서는 undefined로 넘어옵니다. 이 destroy는 clean-up 함수가 저장되는 변수로 현재 시점에서는 얻어낼 수 없고 flushPassiveEffectsImpl()이 다음 프레임에서 effect를 소비하여 create를 호출할 때 clean-up 함수를 반환받아 destroy에 저장합니다.</p>\n<blockquote>\n<p>잠시 헷갈릴 수 있으므로 리액트에서 저장소로 다루는 것들에 대해 짧게 정리하고 넘어가겠습니다.</p>\n<ul>\n<li>컴포넌트의 side-effect를 담고 있는 fiber의 firstEffect, nextEffect, lastEffect</li>\n<li>함수형 컴포넌트에서 사용되는 훅들의 리스트를 담고 있는 fiber의 memoizedState</li>\n<li>함수형 컴포넌트의 life cycle effect를 담고 있는 fiber의 updateQueue</li>\n</ul>\n<p>위에서 연급된 저장소들 중 다른 곳에서도 사용되는 것들을 정리해보자면</p>\n<ul>\n<li>훅의 memoizedState는 결괏값을 저장합니다. useState()는 action의 결과, useEffect()는 생성된 effect 등</li>\n<li>호스트 컴포넌트의 updateQueue에는 변경점을 담는다.</li>\n</ul>\n</blockquote>\n<p>effect 생성을 보았으니 다음은 컴포넌트 update 실행환경에서 호출되는 훅 update 구현체를 확인해보겠습니다.<br>\nmount와는 다르게 이전에 실행된 훅도 신경써야 합니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L902\" target=\"_blank\">reconciler > ReactFiberHooks.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token comment\">// useEffect()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// useLayoutEffect()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token keyword\">let</span> destroy <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentHook <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevEffect <span class=\"token operator\">=</span> currentHook<span class=\"token punctuation\">.</span>memoizedState\n    destroy <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>destroy\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextDeps <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> prevDeps <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>deps\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">areHookInputsEqual</span><span class=\"token punctuation\">(</span>nextDeps<span class=\"token punctuation\">,</span> prevDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>NoHookEffect<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span></span>        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag\n<span class=\"gatsby-highlight-code-line\">  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>updateWorkInProgressHook()가 기억 안나시는 분은 <a href=\"/react/in-depth-react-hooks_2/#updateWorkInProgressHook\" target=\"_blank\">hooks_2</a>를 참고하세요.</p>\n</blockquote>\n<p>이전에 실행된 훅이 없다면<up>17</up> 비교할 필요 없이 effect를 바로 생성<up>30</up>합니다. 만약 존재한다면 의존성 배열 유무<up>20</up>를 확인합니다. 만약 개발자가 의존성 배열을 사용하지 않았다면 이는 컴포넌트 호출마다 실행되어야 하므로 30번 라인으로 넘어갑니다.\n의존성 배열이 존재한다면 이를 이전 훅의 의존성 배열과 비교<up>22</up>합니다.  </p>\n<p>라인 23, 30의 각 <code class=\"language-text\">pushEffect()</code>의 쓰임새는 약간씩 다릅니다. 23은 컴포넌트가 언마운트될 때 각 훅의 destroy를 실행해주어야하는데 이때 참조할 수 있도록 effect를 componentUpdateQueue에 추가해 fiber에 저장하는 용도로 쓰입니다. 그래서 create가 실행되지 않도록 <code class=\"language-text\">NoHookEffect</code>를 넘겨주는 것입니다.</p>\n<p>마지막으로 life cycle effect를 소비하는 commitHookEffectList()을 보겠습니다.</p>\n<h3 id=\"4-life-cycle-effect-소비\"><a href=\"#4-life-cycle-effect-%EC%86%8C%EB%B9%84\" aria-label=\"4 life cycle effect 소비 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4) life cycle effect 소비</h3>\n<p>헷갈리지 않도록 useEffect를 소비하는 commitPassiveHookEffects()의 commitHookEffectList() 호출코드의 인자를 눈여겨 보세요.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L331\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token comment\">// function commitPassiveHookEffects(...) {</span>\n<span class=\"token comment\">//    /*...*/</span>\n<span class=\"token comment\">//    commitHookEffectList(UnmountPassive, NoHookEffect, finishedWork);</span>\n<span class=\"token comment\">//    commitHookEffectList(NoHookEffect, MountPassive, finishedWork);</span>\n<span class=\"token comment\">// }</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unmountTag<span class=\"token punctuation\">,</span> mountTag<span class=\"token punctuation\">,</span> finishedWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> updateQueue <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>updateQueue\n  <span class=\"token keyword\">let</span> lastEffect <span class=\"token operator\">=</span> updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> updateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> firstEffect <span class=\"token operator\">=</span> lastEffect<span class=\"token punctuation\">.</span>next\n    <span class=\"token keyword\">let</span> effect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> unmountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Unmount</span>\n        <span class=\"token keyword\">const</span> destroy <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>destroy\n        effect<span class=\"token punctuation\">.</span>destroy <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>destroy <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> mountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Mount</span>\n        <span class=\"token keyword\">const</span> create <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>create\n        effect<span class=\"token punctuation\">.</span>destroy <span class=\"token operator\">=</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      effect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">!==</span> firstEffect<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>clean-up 함수를 실행하기 위해 <code class=\"language-text\">UnmountPassive</code> tag를 먼저 넘기고<up>4</up> 그 다음에 <code class=\"language-text\">MountPassive</code> tag를 가진 effect를 소비 합니다<up>5</up>. 언마운트의 경우 destroy를 꺼내<up>17</up> 실행하면 끝입니다. mount는 create를 실행하고 반환하는 clean-up 함수를 effect의 destroy에 할당<up>26</up>합니다.</p>\n<h2 id=\"7---3-commitmutationeffects\"><a href=\"#7---3-commitmutationeffects\" aria-label=\"7   3 commitmutationeffects permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7 - 3 commitMutationEffects</h2>\n<p>여기에서는 삽입, 수정, 삭제 effect가 소비됩니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2058\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitMutationEffects</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">:</span> FiberRoot<span class=\"token punctuation\">,</span> renderPriorityLevel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> ContentReset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">commitResetTextContent</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span> <span class=\"token comment\">// node.textContent = text</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> primaryEffectTag <span class=\"token operator\">=</span> effectTag <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>Placement <span class=\"token operator\">|</span> Update <span class=\"token operator\">|</span> Deletion<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>primaryEffectTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> Placement<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span>\n        nextEffect<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>Placement\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> PlacementAndUpdate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span>nextEffect<span class=\"token punctuation\">)</span>\n        nextEffect<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>Placement\n        <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate\n        <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Update<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate\n        <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">case</span> Deletion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">,</span> renderPriorityLevel<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"1-commitplacement\"><a href=\"#1-commitplacement\" aria-label=\"1 commitplacement permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) commitPlacement</h3>\n<p>DOM에 element 삽입(이동, 추가)을 처리하기 위해선 다음의 두 가지 컴포넌트가 필요합니다.</p>\n<ol>\n<li>부모 호스트 컴포넌트</li>\n<li>Placement tag가 달려있지 않은 형제 컴포넌트</li>\n</ol>\n<p>1의 경우 당연히 현재 element를 삽입하기 위해선 부모가 필요합니다.<br>\n2는 필요할 수도 있고 없을 수도 있습니다. 무슨 말이냐면 element 이동이나 추가할 때 가장 이상적인 방법은 그냥 부모의 자식 노드 맨 뒤에 삽입 하는 것입니다. 하지만 기존 형제가 그 자리에 가만히 있을 경우 그리고 새로 삽입할 element의 위치가 해당 형제보다 앞에 위치해야 할 경우 앞에서 설명한 이상적인 방법은 사용할 수 없고 다른 방법을 모색해야 합니다. 이럴때 삽입 위치의 오른쪽 형제가 필요합니다. 그래야 해당 형제 노드를 기준으로 삽입할 수 있습니다.</p>\n<p>이를위해 형제를 참조할 때 주의해야될 중요한 점은 형제 노드에 Placement tag가 달려 있으면 안된다는 점입니다. 왜냐면 effect list의 순서는 후위 순회이므로 왼쪽부터 삽입됩니다. 그런데 형제 노드에 Placement tag가 달려있을 경우 VDOM에서는 참조 가능하지만 DOM 환경에서는 형제 노드의 삽입 처리가 되기전입니다. 그래서 Pacement tag가 달려있지 않은 형제를 찾아 기준점을 삼아야합니다.</p>\n<p>필요한 컴포넌트들을 준비했다면 마지막으로는 삽입 대상인 호스트 컴포넌트를 찾아내야 합니다.<br>\nPlacement tag는 커스텀 컴포넌트에도 달릴 수 있으므로 필터링이 필요합니다. 이때의 로직은 기존에 다루었던 <a href=\"/react/in-depth-react-reconciler_4/#append_all_children\" target=\"_blank\">appendAllChildren()</a>와 비슷합니다.</p>\n<p>먼저 부모를 찾는 코드부터 확인하겠습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1031\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Recursively insert all host nodes into the parent.</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> parentFiber <span class=\"token operator\">=</span> <span class=\"token function\">getHostParentFiber</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">let</span> parent\n  <span class=\"token keyword\">let</span> isContainer\n  <span class=\"token keyword\">const</span> parentStateNode <span class=\"token operator\">=</span> parentFiber<span class=\"token punctuation\">.</span>stateNode\n  <span class=\"token comment\">// 부모 html element 추출</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>parentFiber<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n      parent <span class=\"token operator\">=</span> parentStateNode\n      isContainer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> HostRoot<span class=\"token punctuation\">:</span>\n      <span class=\"token comment\">// host root의 stateNode는 root이므로 containerInfo에서 꺼내야 합니다.</span>\n      parent <span class=\"token operator\">=</span> parentStateNode<span class=\"token punctuation\">.</span>containerInfo\n      isContainer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'Invalid host parent fiber. This error is likely caused by a bug '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'in React. Please file an issue.'</span>\n      <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHostParentFiber</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> parent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>return\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>parent <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isHostParent</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> </span>      <span class=\"token keyword\">return</span> parent\n    <span class=\"token punctuation\">}</span>\n    parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">.</span>return\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Expected to find a host parent. This error is likely caused by a bug '</span> <span class=\"token operator\">+</span>\n      <span class=\"token string\">'in React. Please file an issue.'</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isHostParent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostComponent <span class=\"token operator\">||</span>\n    fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostRoot <span class=\"token operator\">||</span>\n    fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostPortal\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>부모는 어렵지 않게 구해올 수 있습니다.<br>\n다음으로는 참조할 수 있는 형제가 있는지 찾아보겠습니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L985\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// const parentFiber = getHostParentFiber(finishedWork)</span>\n  <span class=\"token comment\">// switch (parentFiber.tag) {...}</span>\n\n  <span class=\"token keyword\">const</span> before <span class=\"token operator\">=</span> <span class=\"token function\">getHostSibling</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHostSibling</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">?</span>Instance <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> node<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">=</span> fiber\n  siblings<span class=\"token punctuation\">:</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token function\">isHostParent</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>\n<span class=\"gatsby-highlight-code-line\">    node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return</span><span class=\"gatsby-highlight-code-line\">    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">!==</span> HostComponent <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">!==</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Placement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">continue</span> siblings</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>child <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">continue</span> siblings</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node</span><span class=\"gatsby-highlight-code-line\">        node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Placement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Found it!</span>\n      <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">.</span>stateNode\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>코드를 블럭으로 나누어 의미를 따져 보자면 다음과 같습니다.</p>\n<ul>\n<li>13 ~ 18: 부모로(<down>위로</down>) 올라갑니다. 현재 노드의 sibling이 null이고<up>13</up> 부모가 호스트 컴포넌트라면<up>14</up> 이는 형제 탐색 경로를 모두 지나왔음을 뜻하며 참조할만한 형제가 없으므로 탐색을 중단합니다.<br>\n하지만 만약 부모가 커스텀 컴포넌트이면서 형제를 가지고 있다면 실제 DOM에 적용되었을 때는 부모의 형제가 현재 노드의 형제가 됩니다. DOM에 삽입되는 건 호스트 컴포넌트이지 커스텀 컴포넌트는 아니기 때문입니다.\n이 이유로 노드의 형제가 없어도 탐색을 중단하는게 아닌 부모가 호스트 컴포넌트가 아니라면 일단 위로 올라가는 것입니다.</li>\n<li>20 ~ 21: 형제로(<down>옆으로</down>) 이동합니다.</li>\n<li>23 ~ 33: 자식으로(<down>아래로</down>) 이동합니다. 이동한 형제 노드가 커스텀 컴포넌트일 경우 위에서 설명드린 이유와 마찬가지로 일단 밑으로 내려가야 합니다. 이때 Placement tag가 달려있거나 자식이 없을 경우에는 해당 노드의 서브트리를 탐색할 필요가 없으므로 그다음 형제를 탐색하기 위해 siblings lable로 돌아갑니다.</li>\n</ul>\n<p>위 로직을 모두 거치고 난 후 Placement tag만 달려있지 않다면 그건 우리가 찾는 형제 노드<up>37</up>입니다.</p>\n<p>이제 마지막으로 실제 DOM에 삽입할 element를 찾아 봅시다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1079\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// const before = getHostSibling(finishedWork);</span>\n\n  <span class=\"token keyword\">let</span> node<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> isHost <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostComponent <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> stateNode <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>before<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isContainer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">insertInContainerBefore</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> stateNode<span class=\"token punctuation\">,</span> before<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// parent.insertBefore(stateNode, before)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> stateNode<span class=\"token punctuation\">,</span> before<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isContainer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">appendChildToContainer</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> stateNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// appendChild(parent, stateNode)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> stateNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 호스트 컴포넌트가 아니라면 밑으로 내려간다.</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 삽입한 노드가 finishedWork라면 작업완료를 뜻한다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 형제가 없다면 위로 올라간다.</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 형제로 이동</span>\n    node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>finishedWork가 호스트 컴포넌트라면 해당 컴포넌트만 삽입하면 되지만 커스텀 컴포넌트일 경우 해당 컴포넌트가 포함하고 있는 1 depth에 해당하는 모든 호스트 컴포넌트를 찾아 삽입시켜야 합니다. 로직은 많이 보던 형태이므로 자세한 설명은 생략하고 이해를 돕기 위해 예제를 통해 정리해봅니다.</p>\n<p><a href=\"/react/in-depth-react-reconciler_1/#todo\" target=\"_blank\">Todo 예제</a>에서 다음 하이라이트 부분을 살짝 변경 하겠습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isMounted<span class=\"token punctuation\">,</span> mountInput<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">mountInput</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">{</span>isMounted <span class=\"token operator\">?</span> <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">}</span></span>      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></span>  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Input 컴포넌트는 3초 뒤에 마운트될 것입니다(<down>코드가 억지 스러워도 양해좀..ㅜㅜ</down>). 이제 컴포넌트가 새롭게 추가되었으니 commit phase에서 commitPlacement()를 통해 삽입 처리를 할 것입니다. 여기서 아래의 질문에 답해보세요.  </p>\n<p>commit phase가 시작되기 전 각 fiber들은 어떤 effect tag들을 가지고 있을까요? 그리고 effect list와 VDOM, DOM의 형태는 어떤 상태일지 추측해봅시다.<br>\n아래 이미지에서 VDOM에는 effect tag, DOM에는 element를 마지막으로 effect list을 채워보세요.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.863921217546995%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB00lEQVQoz32TW2/aQBCF+f//IepLpT61ilRVVCXhUlorgiKHi4MxsUsCcVwwYGNs7LXXJ7POGiU07Uj7sLOz3zmzHlfyPIdYIlicQO12MdX1Yv/yzDSmmGiaSB5zY6pTFAWmaRaLc46KOOSywN5s8KFZR7XbQcwYyoiTBO3hAM1hH34YFkBxOY4iBL6PkHKhzFdeunBtG7WfLXRudSQsPQKjOIYy0XGhDbEOgmPeeLShOzaYEOcxcTLpkNQKh5aJ8+8NXA5UHMiViNJ9GXN3hU+dKzTHGup9FQ1yHkUHZEmAnEtgeSVIGGrXPVyNh0gy/uodMykaUJuj+ztYfxy0b0Zokev4EIOzvXQoXFBL2O2wXK/wbdBDS7+B529J8TU0P3GrGDrqBNwHe/DCYYpK0Rapfvxaxft2A667xGq7Rc8yoM4s/F46f0FLtwoJV9UePM8noP8M9PchZisHpjOHaS9g2TM8EnCxcTEnxzsSOwWWTru3UzSp7YhqeCJbFqNw1riAOp2gbxh4V6/h868ORot7DB7m8P4D/KGN8IVqozCSLYs3JPuM3rD40lQohptnGe0zpCl7E1YCl76Hh82axiZFnjHKy8E+/Sv+BXkLeqyXd54AhjpFhn54T3MAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"before commitPlacement example\" title=\"before commitPlacement example\" src=\"/static/add90b257f70e3869b4ecbb2f58e10cb/c94d1/before_commitPlacement_example.png\" srcset=\"/static/add90b257f70e3869b4ecbb2f58e10cb/0780f/before_commitPlacement_example.png 198w,\n/static/add90b257f70e3869b4ecbb2f58e10cb/47b26/before_commitPlacement_example.png 395w,\n/static/add90b257f70e3869b4ecbb2f58e10cb/c94d1/before_commitPlacement_example.png 790w,\n/static/add90b257f70e3869b4ecbb2f58e10cb/773cd/before_commitPlacement_example.png 1117w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<h1 id=\"\"><a href=\"#\" aria-label=\" permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h1 id=\"-1\"><a href=\"#-1\" aria-label=\" 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h1 id=\"-2\"><a href=\"#-2\" aria-label=\" 2 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h3 id=\"정답\"><a href=\"#%EC%A0%95%EB%8B%B5\" aria-label=\"정답 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정답</h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.975678203928915%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACAUlEQVQoz4VSa2+bUAzl//+AfZ8mTdqkddNUtVPaLGna0pIEAqGQdwh5kaYlCRASoMCZLylTM22ar6x7Zfse+9jm0jQFUyZxHEMWRaiyDDA7nSRJMp81m0EUqgj2e+Qyn89RLpfR6XSg6zo2jgPuLaDtOji5vsKpcIftbndIQoAMVOp1cdEQYa1WWTJmD8MQ7maD7XaLne9n8UeADjmKioQbXcH2TSVM1ImJYusBpv3822Z7LpTJGGEUYfy0hDwyDoDJK+ATZTuVajiXqtDabfC6hpPqHRqDPn5KIs5qAlRjiKKqoKipuG+38I3YOJ6HGr2/8DfHFfpBgKJUR0URMbEsdKcTCP0ujIUFqd/Dfa+DKVUiDQcQjQFkus/EGjxippkjFJrycYUuUSioDVy2NCgPTfxPhpToa13AiphpRLfQbIBjjiRJKVMdn/gKrvhrzKwFtOkIimmgO59lQ2GaDYgNhLaBSY98n4nmeLFAuPMQhT64F3I6vgd91IU2HsGcGVhTT8zlIyb2Mmt83pZcc0Ys5nu9iuV6jZjAkEbgSoqMd4VzFIRblHke78sX+FC6xI/bazSmJh5dN/t8BPi6m32q8GOlhIVt4yXwkcYhuIB2iU1pRwPZk7I328EgDMi2z9rxZ4X5EFcUqxIrtm5xFCBNokMP/yXZxxR/BcxBj+OBXxncOVCFwHHnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"before commitPlacement\" title=\"before commitPlacement\" src=\"/static/9923781de38618ced5350aa719a71857/c94d1/before_commitPlacement.png\" srcset=\"/static/9923781de38618ced5350aa719a71857/0780f/before_commitPlacement.png 198w,\n/static/9923781de38618ced5350aa719a71857/47b26/before_commitPlacement.png 395w,\n/static/9923781de38618ced5350aa719a71857/c94d1/before_commitPlacement.png 790w,\n/static/9923781de38618ced5350aa719a71857/7b8e7/before_commitPlacement.png 1069w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<ul>\n<li>\n<h4 id=\"vdom\"><a href=\"#vdom\" aria-label=\"vdom permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VDOM</h4>\n<p><code class=\"language-text\">Todo</code>의 상태가 변경되어 Work를 진행합니다. fiber에 새겨진 expirationTime을 통해 빠르게 <code class=\"language-text\">Todo</code>까지 내려갑니다. 그리고 <a href=\"/react/in-depth-react-reconciler_2/#updateFunctionComponent\" target=\"_blank\">updateFunctionComponent()</a>에서 renderWithHooks()을 통해 컴포넌트를 실행하고 PerformedWork<up>1</up> tag를 달아줍니다.  </p>\n<p>반환된 <code class=\"language-text\">div</code>를 대상으로 <a href=\"/react/in-depth-react-reconciler_3/#reconcileChildFibers\" target=\"_blank\">reconcileChildFibers()</a>을 진행합니다. current의 type, key가 모두 같으므로 current에 props만 갈아치워 재사용합니다. 이전 <code class=\"language-text\">div</code>가 삭제된 것도 아니고 current도 존재하기 때문에 effect tag는 여전히 0입니다.  </p>\n<p>beginWork()에서 <code class=\"language-text\">div</code>의 props변경 여부를 따져 bailout path를 할지 결정합니다. <code class=\"language-text\">div</code>의 경우 <code class=\"language-text\">Todo</code>가 재호출되면서 새 props를 가진 react element로 반환되었기 때문에 <a href=\"/react/in-depth-react-reconciler_2/#beginWork\" target=\"_blank\">props 비교</a>에서 참조값이 달라 bailout하지 못하고 div의 자식(<down><code class=\"language-text\">Input</code>과 <code class=\"language-text\">OrderList</code>를 포함한 배열</down>)을 대상으로 <a href=\"/react/in-depth-react-reconciler_3/#reconcileChildrenArray\" target=\"_blank\">재조정 작업</a>을 진행하게 됩니다.  </p>\n<p><code class=\"language-text\">Input</code>은 current가 없으므로 재조정 작업 중 <a href=\"/react/in-depth-react-reconciler_3/#placeChild\" target=\"_blank\">placeChild()</a>를 통해 Placement<up>2</up> tag가 달립니다.<br>\nfiber로 확장된 <code class=\"language-text\">Input</code>을 호출해 <code class=\"language-text\">input</code>과 <code class=\"language-text\">button</code>을 담고 있는 Fragment를 반환받지만 key가 없으므로 바로 벗겨내고 배열에 대한 재조정 작업을 진행합니다. 이 과정에서 <code class=\"language-text\">Input</code>에도 PerformedWork<up>1</up> tag가 달립니다. (<down>OrderList는 설명을 생략합니다.</down>)  </p>\n<p>이때 <code class=\"language-text\">div</code>가 반환한 배열과 <code class=\"language-text\">Input</code>이 반환한 배열의 처리가 placeChild()에서 조금 다르게 동작하게 됩니다. 부모가 새로 추가된 경우에는 그 하위 서브 트리는 다른 처리 필요 없이 그냥 마운트만 하면 됩니다. 그래서 서브 트리에 Placement tag를 달아줄 필요가 없습니다. 어차피 부모가 <a href=\"/react/in-depth-react-reconciler_4/#create_element\" target=\"_blank\">completeWork()</a>에서 html element를 생성함과 동시에 자식들을 연결하기 때문에 부모만 DOM에 마운트된다면 자식들도 자연스레 딸려 올라갑니다. 그래서 <code class=\"language-text\">input</code>과 <code class=\"language-text\">button</code>에는 Placement tag가 없는 것이 이 이유때문입니다. </p>\n</li>\n<li>\n<h4 id=\"effect-list\"><a href=\"#effect-list\" aria-label=\"effect list permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>effect list</h4>\n<p>모든 노드를 대상으로 Work를 진행했으므로 leaf 노드부터 completeWork()를 통해 마무리 합니다. effect를 위로 올려주는데 PerformedWork<up>1</up>보다 높은 tag를 가진 fiber는 <code class=\"language-text\">Input</code>밖에 없으므로 <code class=\"language-text\">Input</code>의 부모부터 <code class=\"language-text\">host root</code>까지 effect list는 <code class=\"language-text\">Input</code> 하나만 가지고 있게 됩니다.</p>\n</li>\n<li>\n<h4 id=\"dom\"><a href=\"#dom\" aria-label=\"dom permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DOM</h4>\n<p>render phase를 모두 마무리 하였으니 commit phase로 넘어가는데 effect는 <code class=\"language-text\">Input</code> 하나 이므로 Placement tag를 소비하기 위해 commitPlacement()을 진행합니다. 이때 DOM에는 <code class=\"language-text\">div</code>와 <code class=\"language-text\">ol</code>만이 존재합니다. <code class=\"language-text\">input</code>과 <code class=\"language-text\">button</code>의 element는 fiber의 stateNode에 저장만 해놓은 상태입니다. 바로 지금의 상태가 위 이미지에서 DOM 트리의 형태가 되겠습니다. div 자식으로 ol만 포함되어 있고 아직 <code class=\"language-text\">input</code>과 <code class=\"language-text\">button</code>은 포함되어 있지 않습니다. 왜냐면 Placement tag가 달린 effect가 아직 처리되지 않았기 때문입니다. </p>\n<p><code class=\"language-text\">input</code>, <code class=\"language-text\">button</code>은 DOM에는 연결되어 있지 않지만 VDOM에는 연결되어 있으므로 commitPlacement()에서 <code class=\"language-text\">Input</code> effect를 소비하면서 1 depth에 해당하는 모든 호스트 컴포넌트 자식들을 <code class=\"language-text\">Input</code>의 부모(<down>div</down>)에 추가시켜 주면서 DOM트리를 완성시킵니다.  </p>\n</li>\n</ul>\n<p>이제 commitPlacement()에서 호스트 컴포넌트 탐색 알고리즘의 존재 이유와 새로 생성된 Input의 경우 서브 트리에는 tag를 달지 않고 Input에만 Placement tag를 달아주는 이유를 이해하실거라 생각합니다.  </p>\n<h3 id=\"2-commitwork\"><a href=\"#2-commitwork\" aria-label=\"2 commitwork permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) commitWork</h3>\n<p>commitWork()는 호스트 컴포넌트의 수정사항을 DOM에 적용하거나 layoutEffect()의 clean-up 함수 호출을 담당합니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1284\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> MemoComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Note: We currently never use MountMutation, but useLayout uses UnmountMutation.</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span>UnmountMutation<span class=\"token punctuation\">,</span> MountMutation<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// clean-up 함수 호출.</span></span>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> instance<span class=\"token punctuation\">:</span> Instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> updatePayload<span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span> <span class=\"token comment\">// element의 변경점을 담고 있다.</span>\n        finishedWork<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">          <span class=\"token function\">commitUpdate</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostText<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> textInstance<span class=\"token punctuation\">:</span> TextInstance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> newText<span class=\"token punctuation\">:</span> string <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">commitTextUpdate</span><span class=\"token punctuation\">(</span>textInstance<span class=\"token punctuation\">,</span> newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// textInstance.nodeValue = newText;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'This unit of work tag should not have side-effects. This error is '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'likely caused by a bug in React. Please file an issue.'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>useLayoutEffect()는 useEffect()와는 다르게 DOM 변경 전과 후에 각각 실행되므로 clean-up 함수를 호출할 시점은 지금<up>8</up>입니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L371\" target=\"_blank\">reconciler > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitUpdate</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Instance<span class=\"token punctuation\">,</span>\n  updatePayload<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  newProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">updateProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateFiberProps()</code>는 이벤트 발생시 리액트가 element에서 props를 꺼내어 사용할 수 있도록 저장하는 함수입니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMComponentTree.js#L164\" target=\"_blank\">reconciler > client > ReactDOMComponentTree.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">const</span> internalEventHandlersKey <span class=\"token operator\">=</span> <span class=\"token string\">'__reactEventHandlers$'</span> <span class=\"token operator\">+</span> randomKey<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">[</span>internalEventHandlersKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateProperties()</code>는 변경점을 DOM 노드에 적용하는 함수입니다. </p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMComponent.js#L372\" target=\"_blank\">reconciler > client > ReactDOMComponent.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">updateProperties</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Apply the diff.</span>\n  <span class=\"token function\">updateDOMProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateDOMProperties</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span> updatePayload<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> updatePayload<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> propKey <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> propValue <span class=\"token operator\">=</span> updatePayload<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setValueForStyles</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setInnerHTML</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setValueForProperty</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">,</span> propValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>하이라이트 부분은 호스트 기능과 연관된 함수들로 다음의 링크들로 설명을 대체합니다.</p>\n<ul>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/shared/CSSPropertyOperations.js#L62\" target=\"_blank\">setValueForStyles</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setInnerHTML.js#L26\" target=\"_blank\">setInnerHTML</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setTextContent.js#L21\" target=\"_blank\">setTextContent</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/DOMPropertyOperations.js#L127\" target=\"_blank\">setValueForProperty</a></li>\n</ul>\n<h3 id=\"3-commitdeletion\"><a href=\"#3-commitdeletion\" aria-label=\"3 commitdeletion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3) commitDeletion</h3>\n<p>컴포넌트를 삭제합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1268\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>\n<span class=\"token parameter\">finishedRoot<span class=\"token punctuation\">:</span> FiberRoot<span class=\"token punctuation\">,</span>\ncurrent<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\nrenderPriorityLevel<span class=\"token punctuation\">:</span> ReactPriorityLevel<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">unmountHostComponents</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> renderPriorityLevel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">detachFiber</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">unmountHostComponents()</code>는 삭제와 삭제 대상의 서브 트리에 위치한 컴포넌트들의 언마운트 처리를 합니다.\n<code class=\"language-text\">detachFiber()</code>는 GC를 위한 fiber 초기화 처리를 합니다.</p>\n<p>비교적 간단한 detachFiber() 부터 확인하겠습니다.</p>\n<h4 id=\"detachfiber\"><a href=\"#detachfiber\" aria-label=\"detachfiber permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>detachFiber()</h4>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L895\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">detachFiber</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> alternate <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>pendingProps <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  current<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">detachFiber</span><span class=\"token punctuation\">(</span>alternate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>GC를 위해 fiber의 포인터을 초기화합니다. 해당 컴포넌트는 삭제 대상의 최상단 노드에 해당합니다. 해당 노드가 삭제 대상이라면 서브 트리의 컴포넌트 또한 자연스레 삭제대상에 포함됩니다. 이 때문에 서브 트리의 fiber도 초기화 해야 된다고 생각할 수 있지만 단순히 최상단 노드가 가리키는 포인터만 초기화 하여도 삭제 해야될 트리를 VDOM에서 떼어 놓는 것이 되므로 모든 노드 들이 알아서 GC대상이 될 것입니다.</p>\n<h4 id=\"unmounthostcomponents\"><a href=\"#unmounthostcomponents\" aria-label=\"unmounthostcomponents permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>unmountHostComponents()</h4>\n<p>컴포넌트를 삭제할 때 유의해야될 점은 호스트 컴포넌트가 아니라면 따로 해당 컴포넌트의 1depth에 해당하는 호스트 컴포넌트를 찾아 삭제해주어야 한다는 점입니다.  </p>\n<p>다시 말해 삭제 대상이 호스트 컴포넌트라면 삭제하면 그만이지만 그렇지 않을 경우에는 해당 컴포넌트만 삭제 한다면 VDOM에는 반영되지만 DOM에서는 하위 호스트 컴포넌트들은 그대로 살아 있을 것입니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1120\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">   \n<span class=\"token keyword\">function</span> <span class=\"token function\">unmountHostComponents</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">finishedRoot<span class=\"token punctuation\">,</span>\n  current<span class=\"token punctuation\">,</span>\n  renderPriorityLevel<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> node<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> currentParentIsValid <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 부모를 찾았는지 나타내는 flag</span>\n  <span class=\"token keyword\">let</span> currentParent<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> currentParentIsContainer<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>currentParentIsValid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> parent <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n      findParent<span class=\"token punctuation\">:</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n          parent <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">'Expected to find a host parent. This error is likely caused by '</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">'a bug in React. Please file an issue.'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> parentStateNode <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//  부모 html element 추출</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span>\n            currentParent <span class=\"token operator\">=</span> parentStateNode<span class=\"token punctuation\">;</span>\n            currentParentIsContainer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span> findParent<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">case</span> HostRoot<span class=\"token punctuation\">:</span>\n            currentParent <span class=\"token operator\">=</span> parentStateNode<span class=\"token punctuation\">.</span>containerInfo<span class=\"token punctuation\">;</span>\n            currentParentIsContainer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span> findParent<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">/*...*/</span>\n        <span class=\"token punctuation\">}</span>\n        parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      currentParentIsValid <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// DOM에서 호스트 컴포넌트 삭제</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostComponent <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentParentIsContainer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">removeChildFromContainer</span><span class=\"token punctuation\">(</span>currentParent<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// currentParent.removeChild(node.stateNode);</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>currentParent<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// currentParent.removeChild(node.stateNode);</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 컴포넌트 언마운트 처리</span>\n      <span class=\"token function\">commitUnmount</span><span class=\"token punctuation\">(</span>finishedRoot<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">,</span> renderPriorityLevel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span>\n        node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">===</span> current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol>\n<li>먼저 삭제 대상의 부모를 찾는다<up>15 ~ 38</up>. 부모를 찾았다면 로직의 중복 실행을 방지하기 위해 <code class=\"language-text\">currentParentIsValid</code>를 설정<up>28, 32</up>합니다. </li>\n<li>삭제 대상이 호스트 컴포넌트라면 DOM에서 삭제<up>44, 46</up>하고 돌아갑니다<up>59</up>.</li>\n<li>삭제 대상이 호스트 컴포넌트가 아니라면 해당 컴포넌트를 언마운트 처리<up>50</up>하고 1depth에 해당하는 호스트 컴포넌트를 찾아 아래로 내려<up>53</up>갑니다.</li>\n</ol>\n<blockquote>\n<p>나머지 트리 순회 코드의 경우 많이 언급하였으므로 설명을 생략하겠습니다.</p>\n</blockquote>\n<h4 id=\"commitunmount\"><a href=\"#commitunmount\" aria-label=\"commitunmount permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>commitUnmount()</h4>\n<p>컴포넌트를 삭제하기 위해 언마운트 처리를 합니다. 함수형 컴포넌트의 경우 life cycle effect의 destroy(<down>useEffect(), useLayoutEffect()</down>)를 클래스 컴포넌트는 componentWillUnmount()를 호출합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L736\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitUnmount</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">finishedRoot<span class=\"token punctuation\">:</span> FiberRoot<span class=\"token punctuation\">,</span>\n  current<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  renderPriorityLevel<span class=\"token punctuation\">:</span> ReactPriorityLevel<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> MemoComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> updateQueue <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> lastEffect <span class=\"token operator\">=</span> updateQueue<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> firstEffect <span class=\"token operator\">=</span> lastEffect<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n\n          <span class=\"token keyword\">const</span> priorityLevel <span class=\"token operator\">=</span>\n            renderPriorityLevel <span class=\"token operator\">></span> NormalPriority\n              <span class=\"token operator\">?</span> NormalPriority\n              <span class=\"token punctuation\">:</span> renderPriorityLevel<span class=\"token punctuation\">;</span>\n          <span class=\"token function\">runWithPriority</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> effect <span class=\"token operator\">=</span> firstEffect<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> destroy <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>destroy<span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>destroy <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">                <span class=\"token function\">safelyCallDestroy</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// destroy();</span></span>              <span class=\"token punctuation\">}</span>\n              effect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">!==</span> firstEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> instance<span class=\"token punctuation\">.</span>componentWillUnmount <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">safelyCallComponentWillUnmount</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// instance.componentWillUnmount();</span></span>      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"7---4-commitlayouteffects\"><a href=\"#7---4-commitlayouteffects\" aria-label=\"7   4 commitlayouteffects permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7 - 4 commitLayoutEffects</h2>\n<p>commitLayoutEffects()가 호출된 시점은 VDOM이 DOM에 모두 적용된 상태입니다.<br>\n커스텀 컴포넌트라면 life cycle, 호스트 컴포넌트라면 auto focus 처리를 해주어야 합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2135\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitLayoutEffects</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> committedExpirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>effectTag<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>Update <span class=\"token operator\">|</span> Callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> nextEffect<span class=\"token punctuation\">,</span> committedExpirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    nextEffect <span class=\"token operator\">=</span> nextEffect<span class=\"token punctuation\">.</span>nextEffect<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a class=\"code_link_3\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L411\" target=\"_blank\">reconciler > ReactFiberCommitWork.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitLifeCycles</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedRoot<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">,</span> committedExpirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ForwardRef<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span>UnmountLayout<span class=\"token punctuation\">,</span> MountLayout<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// layoutEffect</span></span>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> prevProps <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> finishedWork<span class=\"token punctuation\">.</span>type\n              <span class=\"token operator\">?</span> current<span class=\"token punctuation\">.</span>memoizedProps\n              <span class=\"token punctuation\">:</span> <span class=\"token function\">resolveDefaultProps</span><span class=\"token punctuation\">(</span>finishedWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// defaultProps 적용</span>\n          <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">          instance<span class=\"token punctuation\">.</span><span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span></span>            prevProps<span class=\"token punctuation\">,</span>\n            prevState<span class=\"token punctuation\">,</span>\n            instance<span class=\"token punctuation\">.</span>__reactInternalSnapshotBeforeUpdate <span class=\"token comment\">// commitBeforeMutationEffectOnFiber에서 찍어놨던 스냅샷</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> instance<span class=\"token punctuation\">:</span> Instance <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> finishedWork<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>memoizedProps<span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">commitMount</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> finishedWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// auto-focus</span></span>      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n     <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'This unit of work tag should not have side-effects. This error is '</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">'likely caused by a bug in React. Please file an issue.'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>클래스 컴포넌트는 마운트, 업데이트 여부<up>13</up>에 따라 각각 <code class=\"language-text\">componentDidMount()</code><up>14</up>, <code class=\"language-text\">componentDidUpdate()</code><up>20</up>를 호출합니다.  </li>\n<li>\n<p>호스트 컴포넌트는 auto focus를 지원해주어야 하는 element일 경우 처리<up>45</up>합니다.  </p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L350\" target=\"_blank\">react-dom > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">commitMount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">domElement<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> newProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldAutoFocusHostComponent</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      domElement<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>함수형 컴포넌트의 경우 해당 시점에 처리해야할 작업은 layout effect 입니다. </li>\n</ul>\n<p>commit phase는 여기서 끝입니다. <a href=\"#commitRootImpl\">commitRoot()</a>의 전체 로직을 확인해보세요.<br>\n이제는 어렵지 않게 이해하실 수 있지 않을까 기대해봅니다.</p>\n<p>tag를 통해 알수있듯이 commitWork()에서는 layout effect의 clean-up 함수를 실행하며 이 시점은 함수형 컴포넌트의 자식들이 모두 DOM에 적용된 후 입니다(<down>effect list가 후위 순회이므로</down>). commitLifeCycles()에서는 VDOM이 모두 DOM에 적용된 후 layout effect를 소비합니다. useEffect()와의 차이점은 실행 시점 말고도 이 부분이 다릅니다.</p>\n<h3 id=\"-useeffect와-uselayouteffect의-활용법\"><a href=\"#-useeffect%EC%99%80-uselayouteffect%EC%9D%98-%ED%99%9C%EC%9A%A9%EB%B2%95\" aria-label=\" useeffect와 uselayouteffect의 활용법 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>❗ useEffect()와 useLayoutEffect()의 활용법</h3>\n<p>useEffect()와 useLayoutEffect()의 활용도는 실행 시점의 차이에서 옵니다.   </p>\n<p>useEffect()를 사용하여 ui와 관련된 작업할 경우 예를 들면 <u>특정 element를 렌더링 한 후, 각 element의 위치나 크기에 따라서 추가적인 효과를 주었을 때</u> 사용자는 깜빡임 또는 부자연스러운 효과를 눈으로 확인하게 됩니다.  </p>\n<p>이때 useLayoutEffect()를 사용하면 위 문제점을 해결할 수 있습니다. element는 DOM에 마운트된 상황이므로 참조하여 위치나 크기를 얻어올 수 있지만 아직까지는 call stack를 비워주지 않았으므로 브라우저는 렌더링 작업을 진행하지 못한 상태입니다. 이때 추가적인 ui 작업을 함으로서 브라우저는 마지막 작업물을 기준으로 렌더링하게 만드는 것입니다.  </p>\n<p>이때 조심해야할 부분은 무거운 작업을 useLayoutEffect()에서 진행하게 된다면 브라우저의 렌더링을 블록킹하게 되는 불상사가 일어나므로 신중히 사용하길 권장하고 있습니다.</p>\n<p>다음 예제에서 useLayoutEffect()을 이용하여 화면이 렌더링되기 전에 element를 참조하여 정보를 가지고 올 수 있는지, useLayoutEffect()가 렌더링을 블록킹하는지 확인해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Foo</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> increase<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> counterRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useLayoutEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>offsetWidth<span class=\"token punctuation\">,</span> offsetHeight<span class=\"token punctuation\">,</span> firstChild<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> nodeValue <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> counterRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>offsetWidth<span class=\"token punctuation\">,</span> offsetHeight<span class=\"token punctuation\">,</span> nodeValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1e8</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>span ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>counterRef<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">increase</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>increase<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<img src=\"/path/to/dir/3b9d11346960ed8b5ebd2043544559b7/layout_effect.gif\" height=\"300px\" width=\"100%\">\n<h1 id=\"마무리\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h1>\n<p>다음 포스트는 Synthetic Event에 대한 글을 작성할 예정이었습니다. 하지만 다음 메이저 버전인 <a href=\"https://reactjs.org/blog/2020/08/10/react-v17-rc.html\" target=\"_blank\">v17</a>에서 해당 구현이 변경됩니다. 그러므로 해당 포스트는 추후 여유가 될 때 변경된 코드를 기준으로 작성하도록 하겠습니다.<br>\n더불어 reconciler 또한 <a href=\"https://github.com/facebook/react/tree/master/packages/react-reconciler/src\" target=\"_blank\">github</a>를 방문해 보시면 업데이트를 진행하고 있는걸 알 수 있습니다.<br>\n하지만 큰 틀은 변경되지 않을 것으로 보이므로 큰 걱정없이 지금까지 이해하셨던 설계 모델를 그대로 이해하고 계시면 될 것 같습니다.</p>\n<p>여기까지 잘 이해하시면서 넘어오셨을지가 궁금하네요. 아마도 그렇지 않은 분들이 대부분이지 않을까 생각합니다. 개인적으로 리액트를 분석하면서 이해한 것들을 100% 전달해드리지 못했다는 느낌이 들지만 한편으로는 빠져있는 이 부분들은 여러분들이 직접 코드를 분석해가며 채워나가야 할 부분들이라 생각해봅니다.  </p>\n<p>긴 글 끝까지 읽어주셔서 감사드립니다. </p>","frontmatter":{"title":"React 톺아보기 - 05. Reconciler_5","date":"2020-10-11","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-reconciler_5/","previous":{"fields":{"slug":"/react/in-depth-react-reconciler_4/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_4","category":"react"}},"next":null}}}