{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_4/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"82a05bfe-8b89-58ba-b288-10d8b35c799e","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 현재 분석을 1 ~ 5 업데이트된 컴포넌트를 호출하여 반환받은 element를 fiber로 확장까지 진행하였습니다. 그리고 이 fiber는 reconcileChildren()에서 반환되어 5 -> 3-> 2-> 1로 전달되어 다음 Work의  대상이 됩니다.   지금까지 Work…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 46.96969696969697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVQoz51Sy07DQAzs//8RvRGJXqjyB0gIIdFC2iTNo3nYHsZOWiJUBOIwWu/aOzv27MrMYMAEj80joKpr3K3XSJIEj9st7rmmaYqHzQbvWRY1urw7318FyTAQvZ9gubdxhKlC+w7adTCRWLWpYedz7O3cTrUek3XlzFpX0FMJYZF64bz3i9I0sKoiThi95pBBCcnzyOnxAC3LSQQwK3R2qhF//aJMxlAzFMWUJ3rGo5O3LcnqqI+ck6ksWp5ngOU8HGxX2NLyXAsqe36C7t4mkpsz/AksEqqJ9kmkZQEhhuyDyvOI/cxzofJXwqtJHAONCciXKs2PkNcX6H4H8/avM7wFN8iV0QxzV92ci0H8Uvb9y/yp5X/gE8YJwM2ieUG3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"render phase flow\" title=\"render phase flow\" src=\"/static/ea0101d7212866b4c6776ee262f8160e/2e237/render_phase_flow.png\" srcset=\"/static/ea0101d7212866b4c6776ee262f8160e/18f77/render_phase_flow.png 198w,\n/static/ea0101d7212866b4c6776ee262f8160e/2cb6c/render_phase_flow.png 395w,\n/static/ea0101d7212866b4c6776ee262f8160e/2e237/render_phase_flow.png 790w,\n/static/ea0101d7212866b4c6776ee262f8160e/471ef/render_phase_flow.png 1185w,\n/static/ea0101d7212866b4c6776ee262f8160e/f705a/render_phase_flow.png 1493w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>현재 분석을 1 ~ 5 <u>업데이트된 컴포넌트를 호출하여 반환받은 element를 fiber로 확장</u>까지 진행하였습니다. 그리고 이 fiber는 reconcileChildren()에서 반환되어 5 -> 3-> 2-> 1로 전달되어 다음 <strong>Work</strong>의  대상이 됩니다.  </p>\n<p>지금까지 <strong>Work</strong>를 통해 결과물을 만들어 내었으니 다음은 이 결과물을 마무리하는 방법을 확인할 차례입니다만 그 이전에 7. completeUnitOfWork()의 진입점인 2. performUnitOfWork()를 다시 한번 확인해보면서 어떤 상황일 때 Work를 마무리 하는지 확인하고 가겠습니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1469\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">unitOfWork</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">.</span>alternate\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> unitOfWork<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span></span>\n  unitOfWork<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">.</span>pendingProps\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    next <span class=\"token operator\">=</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>unitOfWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  ReactCurrentOwner<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">return</span> next\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li><code class=\"language-text\">beginWork()</code>가 null을 반환<up>8</up>한다는 것은 <code class=\"language-text\">unitOfWork</code>가 leaf 노드라는 뜻으로 하위 서브 트리는 존재하지 않기 때문에 unitOfWork에서 <strong>Work</strong> 진행을 끊고 마무리<up>9</up>합니다.</li>\n<li>현재 까지만 놓고 보면 트리의 밑으로만 내려갔지 옆으로 이동하는 부분은 없습니다. 이는 <code class=\"language-text\">completeUnitOfWork()</code>에서 leaf 노드를 처리하고 형제 노드가 있으면 반환<up>9</up>해줍니다. </li>\n</ul>\n<p>지금까지의 상황을 아래의 이미지를 통해 정리를 한번 해봅시다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.505050505050505%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB20lEQVQoz21S72/SUBTd///RD34wOmPMphJd4mJQyIYzmTpZhWGhguNnC7S08ErbQUvfK8f7WsARd5OT+37d8+695x6s12tsIS1JEpiMYeA4YEGQnmU3/7xgLsJuD6HvI46i7G7DcbBHSOCc4/3VNzz+eIrLhgruMiwdGyFB+ojN4NVVaG9zqOSOYbdvM0JKZJ9QZid/TwQ0fYDLmgJ9YkFQBvFyucECfLXCstNF/eQdfhY+gJnmA4TygDIDlSA3F40b5JQfKLc0IJhD+F6K2KP1XYA7XUe3dIbO5wKYoT9MKPwAhXwez86LOFO+IxiNoGl1KDcKKmoNt60mZsMhZvYEk2oV1TevUD55DZ3K3/Z+R7i13sSAOuhDH/cRzhnc+Rz6yMDYGsOZTuEOBvCp3JltwWo3YF8r8Jq1XXxKKBdfKINH+VMUq2UwUvioVMTT80+47rRx3+JeH7+Pj3D18jkahTwspYLKi0N8PXwC7aKUapASmqScSsEd6seUxqVJ/tefFobmGJxEWZEgSRynI+IODTh051kmFtRPZhhgVNXCdf8vORsyscOaiCISQyIkQVY0lzwKt/VlQt43SSibKSiYC04jk6Tg6V6k64Qe7WHzJtlAxgoZS17u/wL3V/CaZ9AtuQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"reconcile children\" title=\"reconcile children\" src=\"/static/8add8101dc88320afdd3537f1f4d6b98/2e237/reconcile_children.png\" srcset=\"/static/8add8101dc88320afdd3537f1f4d6b98/18f77/reconcile_children.png 198w,\n/static/8add8101dc88320afdd3537f1f4d6b98/2cb6c/reconcile_children.png 395w,\n/static/8add8101dc88320afdd3537f1f4d6b98/2e237/reconcile_children.png 790w,\n/static/8add8101dc88320afdd3537f1f4d6b98/98b29/reconcile_children.png 937w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<ol>\n<li>App, Todo, Input의 fiber들은 모두 bailout을 통해 기존 current를 그대로 가져와서 workInProgress로 사용합니다.  </li>\n<li>Input 컴포넌트를 호출하여 input과 button을 담고 있는 Fragment를 반환받습니다. key가 없으므로 바로 벗겨내어 배열을 얻고 배열에 대한 재조정 작업을 시작합니다.  </li>\n<li>배열 원소 중 재사용 가능한 경우 current에서 props만 교체하여 workInProgress를 만들어 냅니다. 다른 원소들도 같은 처리가 적용되며 동시에 sibling으로 연결해 준 후 첫번째 자식만 반환합니다.  </li>\n<li>반환된 첫 번째 자식인 input을 대상으로 <strong>Work</strong>를 진행합니다.</li>\n<li>beginWork(input)는 null을 반환하며 이번 포스트에서 분석할 <strong>Work</strong> 마무리 단계를 거치게 됩니다.</li>\n</ol>\n<p><strong>Work</strong> 마무리란 재조정 작업으로 얻은 fiber를 Commit phase에서 사용할 수 있도록 준비하는 걸 뜻합니다. fiber를 DOM에 올리기 위한 사전 작업으로 생각할 수 있으며 fiber와 대응하는 HTML element를 생성하거나 수정, 삭제, 이벤트 핸들러 등 <strong>Work</strong>를 통해 발생한 모든 결과물을 여기서 처리합니다.</p>\n<anchor id=\"processing_order\" />\n<blockquote>\n<h3 id=\"진행-순서\" style=\"position:relative;\"><a href=\"#%EC%A7%84%ED%96%89-%EC%88%9C%EC%84%9C\" aria-label=\"진행 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>진행 순서</h3>\n<p> App에서 업데이트가 발생하여 전체 컴포넌트가 호출된다고 가정하면 호출의 순서는 전위 순회와 같습니다.<br>\nApp -> Todo -> Input -> OrderList 입니다.<br>\ninput과 button, ol 등 호스트 컴포넌트는 호출 대상이 아니므로 제외했습니다.  </p>\n<p><strong>Work</strong> 마무리 순서는 후위 순회와 같습니다.<br>\ninput -> button -> Input … -> Todo -> App</p>\n</blockquote>\n<h2 id=\"6---7-completeunitofwork\" style=\"position:relative;\"><a href=\"#6---7-completeunitofwork\" aria-label=\"6   7 completeunitofwork permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 - 7 completeUnitOfWork()</h2>\n<p>먼저 VDOM 순회 코드부터 보도록 하겠습니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1498\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">unitOfWork</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  workInProgress <span class=\"token operator\">=</span> unitOfWork\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>alternate\n    <span class=\"token keyword\">const</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>return\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Incomplete<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// completeWork(current, workInProgress, renderExpirationTime);</span>\n      <span class=\"token comment\">// if (returnFiber !== null &amp;&amp; (returnFiber.effectTag &amp; Incomplete) === NoEffect) {...}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Work를 진행하던 중 에러가 발생한 경우.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 형제가 존재한다면 Work를 진행하기 위해 반환한다.</span>\n      <span class=\"token keyword\">return</span> siblingFiber\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 부모로 올라간다.</span>\n    workInProgress <span class=\"token operator\">=</span> returnFiber\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>leaf 노드의 <strong>Work</strong>를 마무리<up>9 ~ 10</up> 하고 형제 노드<up>15 ~ 16</up>를 찾습니다. </li>\n<li>만약 형제 노드가 없다면 이는 부모의 서브 트리가 모두 마무리 된 것으로 다음 대상은 부모<up>21</up>가 됩니다. 이때 부모 또한 leaf 노드처럼 하위 모든 노드들이 <strong>Work</strong>가 마무리된 상태이므로 현재 여기서 자식과 같이 마무리를 진행합니다.</li>\n<li>계속해서 while 문은 부모의 <strong>Work</strong>도 마무리하며 위 내용을 반복합니다. 그리고 최종적으로 최상단 노드인 Host root에 도달<up>22</up>하며 끝납니다.</li>\n</ul>\n<p>그러면 <strong>Work</strong>의 결과물들 중에 무엇을 마무리해야 하는 것일까요? 크게 다음의 두가지가 있습니다.</p>\n<anchor id=\"completeUnitOfWork\">\n<ol>\n<li>호스트 환경과 연관된 부분</li>\n<li>VDOM 변경점을 담고 있는 side-effect</li>\n</ol>\n<p>첫번째는 <code class=\"language-text\">completeWork()</code><up>9</up> 두번째는 if문<up>10</up>에서 각각 처리합니다.</p>\n<h2 id=\"6---8-completework\" style=\"position:relative;\"><a href=\"#6---8-completework\" aria-label=\"6   8 completework permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 - 8 completeWork()</h2>\n<p><strong>Work</strong>의 결과물 중 호스트와 연관된 부분이라 하면 HTML element에 해당하는 호스트 컴포넌트가 있습니다.  Commit phase에서는 완성된 element를 요구므로 여기서 fiber에 반영된 정보들을 바탕으로 element를 완성해야 합니다.  </p>\n<blockquote>\n<p>호스트 컴포넌트 이외에 suspense, portal도 대상에 포함되지만 생략합니다.</p>\n</blockquote>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L632\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">current</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">workInProgress</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">renderExpirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">IndeterminateComponent</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">SimpleMemoComponent</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">FunctionComponent</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">ClassComponent</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">HostComponent</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/*...*/</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// suspense, portal..</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>새롭게 생성된 fiber라면 element 역시 새로 만들어야 하고 그렇지 않다면 current와 workInProgress가 가지고 있는 props 사이의 차이점을 찾아내어 기존 element에 적용해야 합니다. 이 이외에도 이벤트 바인딩이 있습니다.</p>\n<p>먼저 element 생성 코드를 보고 난 후 업데이트 진행하겠습니다.</p>\n<h3 id=\"1-html-element-생성\" style=\"position:relative;\"><a href=\"#1-html-element-%EC%83%9D%EC%84%B1\" aria-label=\"1 html element 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) HTML element 생성</h3>\n<anchor id=\"create_element\">\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L675\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">HostComponent</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> rootContainerInstance <span class=\"token operator\">=</span> <span class=\"token function\">getRootHostContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Host root를 가지고 온다.</span>\n      <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 업데이트</span>\n        <span class=\"token comment\">// updateHostComponent(...);</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// element 생성</span>\n        <span class=\"token keyword\">let</span> instance <span class=\"token operator\">=</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>\n          type<span class=\"token punctuation\">,</span>\n          newProps<span class=\"token punctuation\">,</span>\n          rootContainerInstance<span class=\"token punctuation\">,</span>\n          workInProgress<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">appendAllChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// event binding</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">finalizeInitialChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> newProps<span class=\"token punctuation\">,</span> rootContainerInstance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>getRootHostContainer()<up>7</up>는 설명의 간략화를 위해 생략된 부분으로 스택에서 workInProgress 트리의 Host root를 가지고 온다고만 생각해주세요. 추가하는 부분은 <a href=\"https://github.com/facebook/react/blob/v16.13.0/packages/react-reconciler/src/ReactFiberBeginWork.js#L2931\" target=\"_blank\">beginWork()</a>에 있습니다. </p>\n</blockquote>\n<ul>\n<li>\n<p>element를 생성<up>14</up>하고 fiber의 <code class=\"language-text\">stateNode</code><up>22</up>에 저장합니다. 만약 해당 fiber가 자식을 가지고 있다면 새로 생성한 element에도 연결<up>21</up>해주어야 합니다.</p>\n<p>element를 생성하고 자식을 연결해줄 때 주의할 점은 VDOM 상에서의 자식이 아닌 DOM 입장에서의 자식입니다.문제는 VDOM에는 호스트 컴포넌트를 제외하고도 많은 종류의 컴포넌트들이 존재하므로 필터링를 통해 호스트 컴포넌트를 찾아내야 합니다.</p>\n</li>\n<li>마지막으로 <code class=\"language-text\">finalizeInitialChildren()</code>을 통해 element에 이벤트 바인딩, atrribute 적용 등 생성을 마무리<up>25</up>합니다. 동시에 해당 element의 auto focus 여부를 반환<up>25</up>하여 Update tag를 달아<up>26</up>줍니다. 만약 이 부분이 빠져있다면 해당 fiber에는 Placement tag만 존재하므로 삽입만 됩니다.</li>\n</ul>\n<p>차례대로 createInstance(), appendAllChildren(), finalizeInitialChildren() + markUpdate()를 확인하며 element 생성 섹션을 끝내도록 하겠습니다.</p>\n<h4 id=\"createinstance\" style=\"position:relative;\"><a href=\"#createinstance\" aria-label=\"createinstance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createInstance()</h4>\n<blockquote>\n<p>호스트 환경에 의존도가 높은 코드에 대해서는 깊게 들어가지 않고 기본만 확인하고 나오도록 하겠습니다.</p>\n</blockquote>\n<anchor id=\"createInstance\">\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L213\" target=\"_blank\">react-dom > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>\n  type<span class=\"token punctuation\">,</span>\n  props<span class=\"token punctuation\">,</span>\n  rootContainerInstance<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Host root</span>\n  internalInstanceHandle <span class=\"token comment\">// workInProgress</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> domElement <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n    rootContainerInstance\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token function\">precacheFiberNode</span><span class=\"token punctuation\">(</span>internalInstanceHandle<span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> domElement\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>브라우저 환경의 <code class=\"language-text\">createElement()</code><up>8</up>는 document.createElement(type)와 같습니다.</li>\n</ul>\n<p>completeWork()에서 생성한 element는 fiber의 stateNode에 저장해주었습니다. 이는 리액트가 호스트에 접근할 수 있도록 해주는 부분이고 그 반대로 호스트 영역에서 리액트에 접근할 수 있도록 fiber와 props를 element에 저장하는 부분이 <code class=\"language-text\">precacheFiberNode()</code>와 <code class=\"language-text\">updateFiberProps()</code>입니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMComponentTree.js#L18\" target=\"_blank\">react-dom > client > ReactDOMComponentTree.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">const</span> randomKey <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> internalInstanceKey <span class=\"token operator\">=</span> <span class=\"token string\">'__reactInternalInstance$'</span> <span class=\"token operator\">+</span> randomKey\n<span class=\"token keyword\">const</span> internalEventHandlersKey <span class=\"token operator\">=</span> <span class=\"token string\">'__reactEventHandlers$'</span> <span class=\"token operator\">+</span> randomKey\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">precacheFiberNode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hostInst<span class=\"token punctuation\">,</span> node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">[</span>internalInstanceKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hostInst\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">[</span>internalEventHandlersKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"appendallchildren\" style=\"position:relative;\"><a href=\"#appendallchildren\" aria-label=\"appendallchildren permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>appendAllChildren()</h4>\n<p>fiber를 새로 생성하였다면 다음은 ‘DOM 기준’으로 자식 호스트 컴포넌트를 찾아 연결해주어야 합니다. </p>\n<anchor id=\"append_all_children\"/>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L151\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">appendAllChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> workInProgress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>child\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 호스트 컴포넌트</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostComponent <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">appendInitialChild</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// parent.appendChild(node.stateNode)</span>\n    <span class=\"token comment\">// 이외 컴포넌트</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node\n      <span class=\"token comment\">// 호스트 컴포넌트를 찾기 위해 한 단계 밑으로 내려 간다.</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 내려갔던 만큼 다시 위로 올라간다.</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 형제가 더이상 없고 부모가 workInProgress라면 모든 경로를 탐색하였음을 뜻함.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 형제로 이동한다.</span>\n    node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>코드 설명은 주석으로 대신하고 <a href=\"/react/in-depth-react-reconciler_1/#todo\" target=\"_blank\">Todo 예제</a>를 이용하여 appendAllChildren()의 알고리즘이 어떻게 동작하는지 확인해봅시다.</p>\n<blockquote>\n<p>appendAllChildren() 알고리즘의 커버리지를 위해 Todo 컴포넌트의 Fragment를 div로 변경합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span></span>      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></span>  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음 이미지에서 Input 컴포넌트의 형제인 OrderList는 간략화를 위해 생략했음을 유의해주세요.</p>\n</blockquote>\n<img src=\"/path/to/dir/b0bbf0943d606f5f1770404c6c550e7c/append_all_children.gif\" width=\"100%\">\n<h4 id=\"finalizeinitialchildren-markupdate\" style=\"position:relative;\"><a href=\"#finalizeinitialchildren-markupdate\" aria-label=\"finalizeinitialchildren markupdate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>finalizeInitialChildren(), markUpdate()</h4>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L258\" target=\"_blank\">react-dom > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">finalizeInitialChildren</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">domElement</span><span class=\"token operator\">:</span> Instance<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> Props<span class=\"token punctuation\">,</span> \n  <span class=\"token literal-property property\">rootContainerInstance</span><span class=\"token operator\">:</span> Container</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setInitialProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> rootContainerInstance<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">shouldAutoFocusHostComponent</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span> <span class=\"token comment\">// auto focus 여부</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>상대적으로 간단한 <code class=\"language-text\">shouldAutoFocusHostComponent()</code> 부터 확인 하겠습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L132\" target=\"_blank\">react-dom > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldAutoFocusHostComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> Props</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'button'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'select'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'textarea'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>props<span class=\"token punctuation\">.</span>autoFocus\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>일전에 말씀드린대로 auto focus를 지원하는 태그들은 해당 여부를 반환해야 Update tag를 달아줄 수 있습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L134\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">workInProgress</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> Update<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">setInitialProperties()</code>는 새로 생성된 element에 이벤트 리스너를 달아주고 atrribute를 추가하는 함수입니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMComponent.js#L511\" target=\"_blank\">react-dom > client > ReactDOMComponent.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">    \n<span class=\"token keyword\">function</span> <span class=\"token function\">setInitialProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">domElement</span><span class=\"token operator\">:</span> Element<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rawProps</span><span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rootContainerElement</span><span class=\"token operator\">:</span> Element <span class=\"token operator\">|</span> Document</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> Object\n  <span class=\"token comment\">// 이벤트 바인딩</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'img'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'image'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'link'</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_ERROR</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_LOAD</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> rawProps\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'form'</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_RESET</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_SUBMIT</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> rawProps\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token operator\">:</span>\n      <span class=\"token function\">ReactDOMInputInitWrapperState</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> rawProps<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> rawProps<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_INVALID</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> <span class=\"token string\">'onChange'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      props <span class=\"token operator\">=</span> rawProps\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// attribute 추가</span>\n  <span class=\"token function\">setInitialDOMProperties</span><span class=\"token punctuation\">(</span>\n    tag<span class=\"token punctuation\">,</span>\n    domElement<span class=\"token punctuation\">,</span>\n    rootContainerElement<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n    isCustomComponentTag\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>코드가 중복되지 않는 몇 개의 태그만 추렸습니다.</p>\n</blockquote>\n<ul>\n<li>이벤트 바인딩과 관련된 부분은 다음 포스트인 Synthetic Event에서 다루게 되므로 자세한 설명은 생략하고 간략하게나마 알려드리자면 <code class=\"language-text\">trapBubbledEvent()</code>는 <strong><U>명시된 이벤트만 element에 바인딩</u></strong>하고 <code class=\"language-text\">ensureListeningTo()</code>는 <strong><u>명시된 이벤트이외에도 해당 이벤트와 의존성을 가지고 있는 이벤트를 document에 이벤트 위임 형식으로 바인딩</u></strong>합니다. ex) <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/events/ChangeEventPlugin.js#L33\" target=\"_blank\">onChange</a></li>\n<li>\n<p><code class=\"language-text\">ReactDOMInputInitWrapperState()</code><up>24</up> 와 <code class=\"language-text\">ReactDOMInputGetHostProps()</code><up>25</up>는 리액트에서 input 태그를 다룸에 있어 기본적으로 필요한 속성들을 추가합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMInput.js#L73\"    target=\"_blank\">react-dom > client > ReactDOMInput.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">           \n<span class=\"token comment\">// ReactDOMInputInitWrapperState</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">initWrapperState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> Element<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> Object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> defaultValue <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>defaultValue <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token string\">''</span> <span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>defaultValue\n\n  node<span class=\"token punctuation\">.</span>_wrapperState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">initialChecked</span><span class=\"token operator\">:</span>\n      props<span class=\"token punctuation\">.</span>checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>checked <span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>defaultChecked<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">initialValue</span><span class=\"token operator\">:</span> <span class=\"token function\">getToStringValue</span><span class=\"token punctuation\">(</span>\n      props<span class=\"token punctuation\">.</span>value <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>value <span class=\"token operator\">:</span> defaultValue\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">controlled</span><span class=\"token operator\">:</span> <span class=\"token function\">isControlled</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isControlled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> usesChecked <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'checkbox'</span> <span class=\"token operator\">||</span> props<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'radio'</span>\n  <span class=\"token keyword\">return</span> usesChecked <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>value <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ReactDOMInputGetHostProps</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHostProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> Element<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> Object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> checked <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>checked\n\n  <span class=\"token keyword\">const</span> hostProps <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">defaultChecked</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">defaultValue</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">checked</span><span class=\"token operator\">:</span> checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> checked <span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>_wrapperState<span class=\"token punctuation\">.</span>initialChecked<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> hostProps\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">setInitialDOMProperties()</code><up>34</up>는 호스트 컴포넌트가 가지고 있는 props를 element에 적용하는 함수입니다.<br>\n하지만 호스트 입장에서는 이렇게 넘어오는 props를 날것 그대로 사용할 수 없으므로 각 종류에 맞춰 가공처리가 필요합니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/   ReactDOMComponent.js#L308\" target=\"_blank\">react-dom > client > ReactDOMComponent.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">       \n<span class=\"token keyword\">function</span> <span class=\"token function\">setInitialDOMProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">domElement</span><span class=\"token operator\">:</span> Element<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rootContainerElement</span><span class=\"token operator\">:</span> Element <span class=\"token operator\">|</span> Document<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">nextProps</span><span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">isCustomComponentTag</span><span class=\"token operator\">:</span> boolean</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> propKey <span class=\"token keyword\">in</span> nextProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> nextProp <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setValueForStyles</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> nextHtml <span class=\"token operator\">=</span> nextProp <span class=\"token operator\">?</span> nextProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextHtml <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setInnerHTML</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextHtml<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registrationNameModules<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setValueForProperty</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">,</span> isCustomComponentTag<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">registrationNameModules</code><up>29</up> 는 HTML 모든 이벤트를 on***의 형태로 가지고 있으며 이 또한 추후에 Synthetic Event에서     다룹니다.  </p>\n<p>props를 처리하는 함수들은 다음 링크를 통해 확인하세요.</p>\n<ul>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/shared/CSSPropertyOperations.js#L62\"    target=\"_blank\">setValueForStyles</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setInnerHTML.js#L26\"     target=\"_blank\">setInnerHTML</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setTextContent.js#L21\"     target=\"_blank\">setTextContent</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/DOMPropertyOperations.js#L127\"     target=\"_blank\">setValueForProperty</a></li>\n</ul>\n</li>\n</ul>\n<p>다음은 기존 current를 재사용 했을 때 current와 workInProgress 사이의 변경점을 찾아 어떻게 HTML element에 적용하는지 알아보겠습니다.</p>\n<h3 id=\"2-html-element-업데이트\" style=\"position:relative;\"><a href=\"#2-html-element-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8\" aria-label=\"2 html element 업데이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) HTML element 업데이트</h3>\n<p><a class=\"code_link_5\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L632\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// const newProps = workInProgress.pendingProps</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*...*/</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">HostComponent</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// var rootContainerInstance = getRootHostContainer();</span>\n      <span class=\"token comment\">// const type = workInProgress.type;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// element 업데이트</span>\n        <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>\n          current<span class=\"token punctuation\">,</span>\n          workInProgress<span class=\"token punctuation\">,</span>\n          type<span class=\"token punctuation\">,</span>\n          newProps<span class=\"token punctuation\">,</span>\n          rootContainerInstance<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/*\n        element 생성\n        let instance = createInstance(...);\n        appendAllChildren(instance, ...);\n        ...\n        */</span>  \n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li><code class=\"language-text\">updateHostComponent()</code><up>11</up>는 current와 workInProgress 사이의 차이점을 찾아내 Commit phase에서 소비할 수 있도록 가공해놓습니다. 실질적으로 <strong><u>props가 element에 반영되는 시점은 Commit phase</u></strong> 입니다.</li>\n</ul>\n<p><a class=\"code_link_5\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCompleteWork.js#L191\" target=\"_blank\">reconciler > ReactFiberCompleteWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">current</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">workInProgress</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> Type<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">newProps</span><span class=\"token operator\">:</span> Props<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rootContainerInstance</span><span class=\"token operator\">:</span> Container</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps\n  <span class=\"token comment\">// 경로 최적화를 이용한 경우 변경된 부분이 없으므로</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps <span class=\"token operator\">===</span> newProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">instance</span><span class=\"token operator\">:</span> Instance <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>stateNode\n  <span class=\"token keyword\">const</span> updatePayload <span class=\"token operator\">=</span> <span class=\"token function\">prepareUpdate</span><span class=\"token punctuation\">(</span>\n    instance<span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    oldProps<span class=\"token punctuation\">,</span>\n    newProps<span class=\"token punctuation\">,</span>\n    rootContainerInstance\n  <span class=\"token punctuation\">)</span>\n  workInProgress<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> updatePayload\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updatePayload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li><code class=\"language-text\">prepareUpdate()</code>는 변경점을 찾아 가공된 데이터를 반환<up>16</up>합니다. 여기에는 추가, 수정, 삭제 해야 될 속성들이 담겨있습니다.  </li>\n<li>이것을 workInProgress의 <code class=\"language-text\">updateQueue</code>에 담아<up>23</up>놓습니다. 일전에도 updateQueue를 다룬적이 있습니다. 그때는 커스텀 컴포넌트의 updateQueue였으며 라이프 사이클 hook 정보가 저장된다고 언급했습니다.</li>\n<li>그리고 <code class=\"language-text\">updatePayload</code>가 비어 있지 않다면<up>24</up> Commit phase에서 element를 수정해야 하므로 Update tag를 달아<up>25</up>줍니다.</li>\n</ul>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L269\" target=\"_blank\">react-dom > client > ReactDOMHostConfig.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareUpdate</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">domElement</span><span class=\"token operator\">:</span> Instance<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">oldProps</span><span class=\"token operator\">:</span> Props<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">newProps</span><span class=\"token operator\">:</span> Props<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rootContainerInstance</span><span class=\"token operator\">:</span> Container<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">hostContext</span><span class=\"token operator\">:</span> HostContext</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">diffProperties</span><span class=\"token punctuation\">(</span>\n    domElement<span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    oldProps<span class=\"token punctuation\">,</span>\n    newProps<span class=\"token punctuation\">,</span>\n    rootContainerInstance\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>변경점을 추출할 때는 다음의 두 단계로 나누어 처리합니다(<down>style 제외</down>). 그래야 O(n)으로 처리할 수 있습니다.</p>\n<ul>\n<li>삭제: current를 기준으로 workInProgress에 없다면 삭제이다.</li>\n<li>추가, 수정: workInProgress를 기준으로 current에 없다면 추가, 값이 다르다면 수정이다.</li>\n</ul>\n<p>즉 current, workInProgress 기준으로 각각 한번의 전진으로 처리합니다. 이때 style만은 유일하게 추가, 수정, 삭제가 모두 한번에 일어날 수 있으므로 다른 속성들과는 조금 다르게 처리합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMComponent.js#L643\" target=\"_blank\">react-dom > client > ReactDOMComponent.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">diffProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">domElement</span><span class=\"token operator\">:</span> Element<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">lastRawProps</span><span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">nextRawProps</span><span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">rootContainerElement</span><span class=\"token operator\">:</span> Element <span class=\"token operator\">|</span> Document</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 변경점을 담을 저장소로 [[key, value], ...]의 형태를 취함.</span>\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">updatePayload</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">lastProps</span><span class=\"token operator\">:</span> Object\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">nextProps</span><span class=\"token operator\">:</span> Object\n\n  <span class=\"token comment\">// 기본 속성 추가</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token operator\">:</span>\n      lastProps <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> lastRawProps<span class=\"token punctuation\">)</span>\n      nextProps <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextRawProps<span class=\"token punctuation\">)</span>\n      updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token comment\">// option, select, textarea...</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> propKey\n  <span class=\"token keyword\">let</span> styleName\n  <span class=\"token keyword\">let</span> styleUpdates <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// style은 임시 변수를 두고 변경점을 추출하여 담아둔다.</span>\n\n  <span class=\"token comment\">// 삭제</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token keyword\">in</span> lastProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token comment\">// workInProgress에 있다면 삭제가 아니다.</span>\n      <span class=\"token operator\">!</span>lastProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 이하 workInProgress에는 존재하지 않는 속성들이므로 모두 삭제해준다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> lastStyle <span class=\"token operator\">=</span> lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> lastStyle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastStyle<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 추가, 수정</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token keyword\">in</span> nextProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> nextProp <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> lastProp <span class=\"token operator\">=</span> lastProps <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">!</span>nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      nextProp <span class=\"token operator\">===</span> lastProp <span class=\"token operator\">||</span>\n      <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> lastProp <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// style은 추가, 수정, 삭제가 동시에 일어날 수 있음.</span>\n      <span class=\"token comment\">// current에만 존재하면 삭제하면 그만이지만 그렇지 않을 경우 모든 케이스에 대한 처리가 필요함.</span>\n\n      <span class=\"token comment\">// 추가, 삭제, 수정</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> lastProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 삭제</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n            lastProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextProp <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>nextProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 추가, 수정</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> nextProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n            nextProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            lastProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> nextProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nextProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 추가</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>updatePayload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>\n          updatePayload<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> styleUpdates<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        styleUpdates <span class=\"token operator\">=</span> nextProp\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> nextHtml <span class=\"token operator\">=</span> nextProp <span class=\"token operator\">?</span> nextProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">const</span> lastHtml <span class=\"token operator\">=</span> lastProp <span class=\"token operator\">?</span> lastProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextHtml <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastHtml <span class=\"token operator\">!==</span> nextHtml<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n            propKey<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">toStringOrTrustedType</span><span class=\"token punctuation\">(</span>nextHtml<span class=\"token punctuation\">)</span> <span class=\"token comment\">// return '' + nextHtml</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        lastProp <span class=\"token operator\">!==</span> nextProp <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registrationNameModules<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>updatePayload <span class=\"token operator\">&amp;&amp;</span> lastProp <span class=\"token operator\">!==</span> nextProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// style 변경점을 가지고 있는 styleUpdates를 마지막으로 추가하면서 마무리한다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STYLE</span><span class=\"token punctuation\">,</span> styleUpdates<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> updatePayload\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>completeWork()의 첫 번째 역할인 호스트 영역에 대한 작업(<down>element 생성과 업데이트</down>)을 보았습니다.<br>\n다음은 side-effect를 가지고 있는 fiber를 Effect list로 연결하는 두번 째 역할을 보도록 하겠습니다.</p>\n<h2 id=\"6---9-effect-list-연결\" style=\"position:relative;\"><a href=\"#6---9-effect-list-%EC%97%B0%EA%B2%B0\" aria-label=\"6   9 effect list 연결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 - 9 Effect list 연결</h2>\n<p><strong>Work</strong>를 진행하며 발생한 VDOM에 산재되어 있는 side-effect을 어떻게 하면 Commit phase에서 편하게 사용할 수 있을까요? 그냥 Host root부터 시작해서 밑으로 내려가며 Effect를 소비하면 될까요?</p>\n<p>다행히도 Effect를 쉽게 수거해 갈 타이밍이 있습니다. 일전에 언급한 <a href=\"#processing_order\">Work 마무리 순서</a>를 생각해보시면 됩니다. 후위 순회이기 때문에 Host root로 되돌아가는데 이때 우리는 Effect만 위로 엮어주기만 하면 됩니다. 이렇게 되면 최종적으로 Host root는 side-effect가 발생한 fiber들이 모두 엮여있는 리스트의 head를 가지고 있게 됩니다. 이제 Commit phase에서는 root만 참조할 수 있으면 됩니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1498\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">unitOfWork</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*</span>\n<span class=\"token comment\">  workInProgress = unitOfWork</span>\n<span class=\"token comment\">  do {</span>\n<span class=\"token comment\">  const current = workInProgress.alternate</span>\n<span class=\"token comment\">  const returnFiber = workInProgress.return</span>\n<span class=\"token comment\"></span>\n<span class=\"token comment\">  if ((workInProgress.effectTag &amp; Incomplete) === NoEffect) {</span>\n<span class=\"token comment\">    completeWork(current, workInProgress, renderExpirationTime);</span>\n<span class=\"token comment\">  */</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      returnFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Incomplete<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoEffect\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// effect list의 head를 위로 올린다.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 서브 트리의 effect list를 부모 list 뒤에 연결한다.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect\n        <span class=\"token punctuation\">}</span>\n        returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>lastEffect\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 자신도 side-effect를 품고 있다면 부모 list에 연결한다.</span>\n      <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>effectTag\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">></span> PerformedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress\n        <span class=\"token punctuation\">}</span>\n        returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*</span>\n<span class=\"token comment\">  } else {</span>\n<span class=\"token comment\">    부모의 서브트리에서 Work를 진행하던 중 에러가 발생한 경우.</span>\n<span class=\"token comment\">  }</span>\n<span class=\"token comment\"></span>\n<span class=\"token comment\">  const siblingFiber = workInProgress.sibling</span>\n<span class=\"token comment\">  if (siblingFiber !== null) {</span>\n<span class=\"token comment\">    return siblingFiber</span>\n<span class=\"token comment\">  }</span>\n<span class=\"token comment\"></span>\n<span class=\"token comment\">  workInProgress = returnFiber</span>\n<span class=\"token comment\">  } while (workInProgress !== null)</span>\n<span class=\"token comment\"></span>\n<span class=\"token comment\">  return null</span>\n<span class=\"token comment\">  */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>하이라이트 코드만 설명하고 넘어가겠습니다.  </p>\n<p>기억 안나실 수 있지만 <code class=\"language-text\">PerformedWork</code> tag는 <a href=\"/react/in-depth-react-reconciler_2/#updateFunctionComponent\"       target=\"_blank\">updateFunctionComponent()<up>4</up></a>에서 커스텀 컴포넌트를 호출한 후에 달아주었습니다. 부등호(<down>></down>)를 통해 짐작해보자면 커스텀 컴포넌트의 호출 이외에 side-effect가 발생한다면 자신을 Effect로 간주하고 위로 올린다고      해석하시면 되겠습니다.</p>\n<blockquote>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactSideEffectTags.js#L13\" target=\"_blank\"    class=\"code_link\">shared > ReactSideEffectTags.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> NoEffect <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b0000000000000</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PerformedWork <span class=\"token operator\">=</span> <span class=\"token comment\">/*         */</span> <span class=\"token number\">0b0000000000001</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Placement <span class=\"token operator\">=</span> <span class=\"token comment\">/*             */</span> <span class=\"token number\">0b0000000000010</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Update <span class=\"token operator\">=</span> <span class=\"token comment\">/*                */</span> <span class=\"token number\">0b0000000000100</span>\n<span class=\"token comment\">/*...*/</span></code></pre></div>\n</blockquote>\n</li>\n</ul>\n<p>completeUnitOfWork()를 통해 Host root까지 올라왔다면 더 이상의 <strong>Work</strong>를 진행할 노드가 남아 있지 않으므로 자연스레 workLoop()의 반복은 중단될 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 다시 <strong>Work</strong>의 진입점이었던 performSyncWorkOnRoot()로 돌아가게 됩니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1022\" target=\"_blank\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  \n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// if (..) prepareFreshStack(root, expirationTime);</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevExecutionContext <span class=\"token operator\">=</span> executionContext\n    executionContext <span class=\"token operator\">|=</span> RenderContext\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>thrownValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> thrownValue<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    executionContext <span class=\"token operator\">=</span> prevExecutionContext</span>\n    <span class=\"token comment\">// Commit phase..</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// 잔여 작업이 없으므로 null을 리턴.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이전 context로 다시 설정해줌으로써 Render phase가 끝나게 됩니다.</p>\n<p>이번에도 마찬가지로 Todo를 통해 컴포넌트의 호출부터 side-effect tag가 어떤 순서로 달리고 Effect가 어떻게 Host root까지 전달되는지 확인해봅시다.</p>\n<blockquote>\n<p>Effect list 연결 로직의 커버리지를 위해 useEffect를 Input 컴포넌트에 추가합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> submit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Deep dive magic code'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</blockquote>\n<anchor id=\"effect_list\" />\n<figure>\n  <img src=\"/path/to/dir/d978a8fa3dc9fecda1104272ca46ab9e/effect_list.gif\" width=\"100%\">\n  <figcaption>Input 컴포넌트에서 타이핑이 발생한 이후 completeUnitOfWork()의 흐름</figcaption>\n</figure>\n<p>Render phase를 거치고 나면 Host root는 Effect 리스트의 head를 가지고 있게 됩니다. 이제 Commit phase에서 Host root의 firstEffect 참조를 통해 모든 변경점에 접근할 수 있게 되었습니다.</p>\n<blockquote>\n<p>호스트 컴포넌트의 tag 4는 Update(<down>props 변경</down>), Input 컴포넌트의 tag 517은 Passive(<down>useEffect</down>) + Update(<down>useState 상태 변경</down>) + PerformedWork 나타냅니다.</p>\n</blockquote>\n<p>다음 포스트는 Render phase를 진행하며 발생한 Effect을 Commit phase에서 어떻게 소비하는지, 라이프 사이클은 어느 시점에 동작하는지 등을 확인하며  <strong>reconciler</strong> 시리즈를 마무리합니다.</p>","frontmatter":{"title":"React 톺아보기 - 05. Reconciler_4","date":"2020-10-15","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"slug":"/react/in-depth-react-reconciler_4/","previous":{"fields":{"slug":"/react/in-depth-react-reconciler_3/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_3","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_5/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_5","category":"react"}}}},"staticQueryHashes":["2277278352","536400264"]}