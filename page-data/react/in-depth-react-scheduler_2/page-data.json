{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-scheduler_2/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"0e1c3466-b144-531f-9a89-e1850d255443","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 5. Scheduler_scheduleCallback 여기서는 스케줄링에 필요한 정보들을 담은 Task를 만듭니다. 그리고 호스트 환경에 따라 구현된 비동기 api에 Task를 실행하는 함수를 전달합니다. 마지막으로 Task를 reconciler가 root에 저장할 수 있도록 반환해줍니다. 먼저 Task…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABaElEQVQoz6VTXXODMAzj//9KXnq9G6OFUPJta3Io0G3d03KnMwHHluTQqSrewdYwDOj7HpfLBdfrtUV7Z98rISVhGS6YZoecc3vfHQV2AG0vKvhrLTnhI3rMjMdSnAWFG8/ziQ+xVKwlw5XCgxk+JczJCgSM3mN4LJhSxMycWCs8i4ZaUEUaoc44aU2ocaSEFbUEiFQoYbHUzOTaGNu+skgxVTznrSmbWTwLGsM4QZceEgaUMKFEB/H0Ki9stECLZ86dkfuwojweABlnMhYy3W1qkkVKK2L2lcRkPxI31Bwai01B2BqkOxuEVlDdDFA+QjiGqLvkmj0T3WauGU0JBqVX0jzehqQGpti4hBKbFXWzwaCnh/xgndlNJkpbHOL4icDniQ1Gm+pzEI55t+BxsyExOr9ico5Ew/dr0zpbXCnHvCEDJWyCgWxbfE5TD9Z62HJK/nmpd9+eCb/W6+V/80N0u/7XSf0HXxOEYWAsL3OCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"scheduling flow\" title=\"scheduling flow\" src=\"/static/9e327099e752bd46cae5074351cfbe5c/c94d1/scheduling_flow.png\" srcset=\"/static/9e327099e752bd46cae5074351cfbe5c/0780f/scheduling_flow.png 198w,\n/static/9e327099e752bd46cae5074351cfbe5c/47b26/scheduling_flow.png 395w,\n/static/9e327099e752bd46cae5074351cfbe5c/c94d1/scheduling_flow.png 790w,\n/static/9e327099e752bd46cae5074351cfbe5c/9e288/scheduling_flow.png 1185w,\n/static/9e327099e752bd46cae5074351cfbe5c/9adaa/scheduling_flow.png 1580w,\n/static/9e327099e752bd46cae5074351cfbe5c/bf7ce/scheduling_flow.png 2560w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<h1 id=\"5-scheduler_schedulecallback\"><a href=\"#5-scheduler_schedulecallback\" aria-label=\"5 scheduler_schedulecallback permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Scheduler_scheduleCallback</h1>\n<p>여기서는 스케줄링에 필요한 정보들을 담은 Task를 만듭니다. 그리고 호스트 환경에 따라 구현된 비동기 api에 Task를 실행하는 함수를 전달합니다. 마지막으로 Task를 reconciler가 root에 저장할 수 있도록 반환해줍니다.</p>\n<p>먼저 Task 객체의 생김새부터 확인하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> newTask <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token punctuation\">:</span> taskIdCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span>\n  callback<span class=\"token punctuation\">,</span>\n  priorityLevel<span class=\"token punctuation\">,</span>\n  startTime<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">,</span>\n  sortIndex<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>scheduler가 넘겨받은 인자는 <code class=\"language-text\">callback</code>과 <code class=\"language-text\">priorityLevel</code>입니다. 이 이외에는 scheduler가 추가하는 정보들입니다. 먼저 시간과 관련된 <code class=\"language-text\">startTime</code>, <code class=\"language-text\">expirationTime</code>을 구하도록 하겠습니다.</p>\n<h2 id=\"starttime-expirationtime\"><a href=\"#starttime-expirationtime\" aria-label=\"starttime expirationtime permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>startTime, expirationTime</h2>\n<p>reconciler에서는 expirationTime에 추가적인 의미가 있었지만 scheduler에서는 이름 그대로 Task의 시작시간과 만료 시간을 뜻합니다.\n넘겨받은 인자 중에 시간과 관련된 인자는 options로 timeout과 delay가 있습니다. delay와 timeout은 각각 startTime, expirationTime에 영향을 줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">var</span> startTime\n  <span class=\"token keyword\">var</span> timeout\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> options <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> options <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> delay <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>delay\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> delay <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span> <span class=\"token operator\">&amp;&amp;</span> delay <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      startTime <span class=\"token operator\">=</span> currentTime <span class=\"token operator\">+</span> delay\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      startTime <span class=\"token operator\">=</span> currentTime\n    <span class=\"token punctuation\">}</span>\n    timeout <span class=\"token operator\">=</span>\n      <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span>\n        <span class=\"token operator\">?</span> options<span class=\"token punctuation\">.</span>timeout\n        <span class=\"token punctuation\">:</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    timeout <span class=\"token operator\">=</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span>\n    startTime <span class=\"token operator\">=</span> currentTime\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> expirationTime <span class=\"token operator\">=</span> startTime <span class=\"token operator\">+</span> timeout\n\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">options</code>는 concurrent mode에서 사용합니다. 현재 대부분은 legacy mode를 사용하기 때문에 timeout은 <code class=\"language-text\">timeoutForPriorityLevel()</code>를 통해 구합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js</span>\n\n<span class=\"token comment\">// Times out immediately</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n<span class=\"token comment\">// Eventually times out</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">USER_BLOCKING_PRIORITY</span> <span class=\"token operator\">=</span> <span class=\"token number\">250</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">NORMAL_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">LOW_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\n<span class=\"token comment\">// Never times out</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">IDLE_PRIORITY</span> <span class=\"token operator\">=</span> maxSigned31BitInt <span class=\"token comment\">// 1073741823</span>\n\n<span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback() > timeoutForPriorityLevel()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> ImmediatePriority<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">IMMEDIATE_PRIORITY_TIMEOUT</span>\n    <span class=\"token keyword\">case</span> UserBlockingPriority<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">USER_BLOCKING_PRIORITY</span>\n    <span class=\"token keyword\">case</span> IdlePriority<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">IDLE_PRIORITY</span>\n    <span class=\"token keyword\">case</span> LowPriority<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">LOW_PRIORITY_TIMEOUT</span>\n    <span class=\"token keyword\">case</span> NormalPriority<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">NORMAL_PRIORITY_TIMEOUT</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"#scheduleSyncCallback()\">scheduleSyncCallback()</a>에서는 우선순위를 Scheduler<em>ImmediatePriority로 넘겨 주었습니다. Scheduler</em>ImmediatePriority로 expirationTime을 계산해보자면 현재 시간보다 -1ms이 빠르겠네요. 이 부분을 어떻게 이용하는지 다음 섹션에서 확인합니다.</p>\n<h2 id=\"task-생성하기\"><a href=\"#task-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0\" aria-label=\"task 생성하기 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Task 생성하기</h2>\n<p>사전작업은 모두 끝났습니다. 이제부터 본격적으로 새로운 Task와 기 Task들을 어떻게 관리하고 실행하는지 알아보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// var expirationTime = startTime + timeout</span>\n\n  <span class=\"token keyword\">var</span> newTask <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> taskIdCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span>\n    callback<span class=\"token punctuation\">,</span>\n    priorityLevel<span class=\"token punctuation\">,</span>\n    startTime<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n    sortIndex<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// delayed Task..</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//  general Task..</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>큰 틀을 먼저 보자면 Task 실행 시점에 따라 분기처리가 되고 <code class=\"language-text\">newTask</code>를 반환하여 reconciler가 해당 Task를 root의 callbackNode에 저장할 수 있도록 합니다(<down>교통정리를 위해</down>).<br>\nif의 분기처럼 <u>지연된 Task<up>Timer</up></u>의 처리방식은 조금 다릅니다. timer는 최소 startTime은 지나서 실행되어야 하기 때문입니다.</p>\n<p>그리고 Task의 실행 순서는 우선순위에 따라 정해집니다. 인입된 Task를 단순히 배열에 넣어두고 실행 시점마다 매번 우선순위가 높은 Task를 뽑아내 실행하면 매우 비효율적입니다. scheduler는 이 부분에서 <a href=\"https://en.wikipedia.org/wiki/Binary_heap\" target=\"_blank\">최소힙</a> 자료구조를 사용했습니다. 힙의 정렬 기준은 Task의 sortIndex입니다.</p>\n<p>if 문을 뜯어보겠습니다.</p>\n<h2 id=\"delayed-task\"><a href=\"#delayed-task\" aria-label=\"delayed task permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>delayed Task</h2>\n<p>흐름도를 보면 5에서 6번을 호출하는 코드를 이번 섹션에서 볼 텐데 진행하면서 두 모듈 사이에 역할이 혼동이 와 이해하기 어려울 수도 있습니다. 혼동을 방지하기 위해 scheduler와 scheduler__host__config의 역할에 대해 명확하게 짚고 넘어가는 게 좋을 것 같습니다.</p>\n<p>scheduler__host__config는 브라우저가 동작해야 할 때 리액트가 방해하는 불상사가 발생하지 않도록 하기 위한 모듈입니다. 이를 위한 비동기 api, 틱당 Work에 할당된 시간을 나타내는 deadline, isInputPending api 등 이 위치해 있습니다.<br>\nscheduler는 Task를 직접 관리하는 모듈이므로 Task와 연관된 모든 작업을 처리합니다.</p>\n<p>Timer를 어떻게 처리하는지 확인해 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js</span>\n<span class=\"token keyword\">var</span> taskQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">var</span> timerQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// var newTask = { ... }</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newTask<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> startTime\n    <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">,</span> newTask<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newTask <span class=\"token operator\">===</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// All tasks are delayed, and this is the task with the earliest delay.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHostTimeoutScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Cancel an existing timeout.</span>\n        <span class=\"token function\">cancelHostTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// Schedule a timeout.</span>\n      <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// general Task..</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>힙을 사용하는 코드는 8, 9라인입니다. 코드를 보면 대충 heap.push를 생각했던 것과는 달리 행위를 기술하고 주체는 동적으로 주입하고 있습니다. 해당 라인에서 주체는 <code class=\"language-text\">timerQueue</code>와 <code class=\"language-text\">taskQueue</code>로 각각 관심사가 다른 저장소입니다. Timer는 timer queue에 실행 대기 Task는 task queue에 저장됩니다.<br>\n힙 정렬 기준은 sortIndex로 7번 라인에서 <code class=\"language-text\">startTime</code>을 할당하고 있습니다.<br>\n이 내용만 보면 Timer는 시작 시간순으로 정렬됨을 알 수 있습니다.</p>\n<blockquote>\n<p>힙 구현 코드는 따로 분석하지 않고 위치만 알려드리자면 SchedulerMinHeap.js 모듈에 구현되어 있습니다.</p>\n</blockquote>\n<p>13라인 if 문 로직의 의미를 생각해보자면 Timer가 실행되는 상황은 언제일까요? 해당 Timer가 startTime에 도달하면? 만약 이때 task queue에 대기 중인 Task가 있다면?<br>\nWeb Worker를 제외하면 자바스크립트는 하나의 메인 스레드에서 돌아갑니다. task queue와 timer queue를 동시에 관찰하면서 병렬적으로 처리할 수가 없습니다. 그렇다면 scheduler는 이 두 개의 큐에 우선순위를 부여해야 합니다. 당연히 실행 대기 큐인 task queue가 timer queue보다 우선순위가 높습니다.</p>\n<p>13라인의 조건이 위 내용을 코드로 나타낸 것입니다. 현재 실행 대기 중인 Task가 없고 새롭게 만든 Task의 시작 시간이 Timer중에 가장 빠르다면 해당 Task의 시작시간으로 timeout을 걸어줍니다(<down>22라인</down>).<br>\n당연히 이미 timeout이 걸려 있다면 정리해줍니다(<down>17라인</down>).<br>\ntimeout api는 시간이 되면 알아서 <code class=\"language-text\">handleTimeout()</code>을 실행시켜 줄 겁니다.</p>\n<h2 id=\"handletimeout\"><a href=\"#handletimeout\" aria-label=\"handletimeout permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>handleTimeout()</h2>\n<p>handleTimeout()이 호출되었다는 건 timer queue의 맨 앞에서 대기하고 있는 timer가 timeout되었음을 나타냅니다. timeout Timer를 어떻게 처리 할 까요?<br>\nscheduler는 관심사 별로 저장소를 나누고 최소 힙을 사용했기 때문에 이를 쉽게 처리할 수 있습니다.<br>\ntimer queue에서 대기 중인 timeout Timer을 하나씩 꺼내어 taskQueue에 추가하기만 하면 끝입니다.</p>\n<p>이 이후 로직은 코드를 보면서 설명하도록 하고 일단 위 내용부터 확인하도록 하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > handleTimeout()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTimeout</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// 여기에 도달했다는 건 timeout api가 실행된 것이다.</span>\n  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span> <span class=\"token comment\">// timeout Timer를 꺼내어 taskQueue에 추가한다.</span>\n\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// scheduler > Scheduler.js > handleTimeout() > advanceTimers()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Check for tasks that are no longer delayed and add them to the queue.</span>\n  <span class=\"token keyword\">let</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>timer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Timer was cancelled.</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">&lt;=</span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Timer fired. Transfer to the task queue.</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n      timer<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> timer<span class=\"token punctuation\">.</span>expirationTime\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">,</span> timer<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Remaining timers are pending.</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    timer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>timer queue는 이미 시작 시간 순으로 정렬되어 있으므로 시간이 남아 있는 Timer를 만난다면 timeout Task를 task queue에 추가하는 동작을 중지해도 됩니다. 어차피 뒤에 있는 Timer들도 모두 시간이 남아있기 때문입니다.</p>\n<p>실행 시간이 다 된<up>timeout</up> Timer들을 task queue에 추가했으므로 빨리 task queue를 소비해야 합니다. 만약 Timer가 취소된 Timer로 여전히 task queue가 비어있다면 다음 Timer의 시작시간으로 timeout api를 실행합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > handleTimeout()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTimeout</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// advanceTimers(currentTime)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isHostCallbackScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">requestHostCallback</span><span class=\"token punctuation\">(</span>flushWork<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> firstTimer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstTimer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> firstTimer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span></span>      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>timeout Timer를 모두 task queue에 추가했으므로 이제 대기 중인 Task를 실행하면 됩니다. <code class=\"language-text\">flushWork()</code>는 handleTimeout()과는 반대로 task queue를 소비하는 함수입니다.</p>\n<h2 id=\"general-task\"><a href=\"#general-task\" aria-label=\"general task permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>general Task</h2>\n<p>다시 unstable_scheduleCallback()으로 돌아와서 우리가 분석한 부분을 확인하고 넘어가겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// var newTask = { ... }</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// delayed Task..</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// general Task..</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 delayed Task 처리 로직을 분석했습니다. 이제 general Task를 확인할 텐데 이전 섹션에서 flushWork()을 알아보지 않은 이유는 여기서도 똑같은 호출이 있기 때문에 생략했습니다.</p>\n<p>general Task는 delayed Task에서 이미 확인한 코드의 형태와 크게 다르지 않습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// var newTask = { ... }</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// delayed Task..</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    newTask<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> expirationTime\n    <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">,</span> newTask<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isHostCallbackScheduled <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>isPerformingWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token function\">requestHostCallback</span><span class=\"token punctuation\">(</span>flushWork<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>task queue의 우선순위는 <code class=\"language-text\">expirationTime</code>입니다.<br>\n<code class=\"language-text\">isPerformingWork</code>는 무엇을 나타내는 플래그냐면 비동기 api에 넘겨주는 flusthWork()는 실행되면 바로 VDOM 재조정 작업이 들어갑니다. 그리고 concurrent mode에서는 이 작업이 비동기로 동작하기 때문에 중간에 중복으로 flushWork()가 호출될 수 있습니다. 이를 방지하기 위한 장치입니다.</p>\n<p><code class=\"language-text\">requestHostCallback()</code>의 구현 코드는 <code class=\"language-text\">requestHostTimeout()</code> 처럼 단순하지 않으므로 host config를 분석할 때 다루도록 하겠습니다. 단지 지금은 flushWork()를 비동기로 실행하는 api라고 생각됩니다.</p>\n<p>다음은 flushWork()를 분석할 차례인데 현재 흐름도에서 우리의 위치가 5 -> 6 호출 부분입니다. 그리고 <code class=\"language-text\">requestHostCallback()</code>에 넘겨준 <code class=\"language-text\">flushWork()</code>가 호출 되는 부분이 9이구요. 지금 여기서 순서대로 host config를 넘어갔다가 돌아오기에는 너무 먼 길을 갔다 와야 하므로 잊어버리기 전에 scheduler의 모든 코드를 분석하고 host config로 넘어가도록 하겠습니다.</p>\n<h1 id=\"9-flushwork\"><a href=\"#9-flushwork\" aria-label=\"9 flushwork permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9. flushWork</h1>\n<p>flushWork()는 task queue를 소비하기 전에 사전작업을 하는 공간이고 <code class=\"language-text\">workLoop()</code>가 task queue를 소비하는 함수입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback() > requestHostCallback() > flushWork()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">flushWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// We'll need a host callback the next time work is scheduled.</span>\n  isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHostTimeoutScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// We scheduled a timeout but it's no longer needed. Cancel it.</span>\n    isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token function\">cancelHostTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  isPerformingWork <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token keyword\">const</span> previousPriorityLevel <span class=\"token operator\">=</span> currentPriorityLevel\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    currentTask <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    currentPriorityLevel <span class=\"token operator\">=</span> previousPriorityLevel\n    isPerformingWork <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>scheduler에서 보았던 모든 플래그 변수들이 여기에 있네요. <code class=\"language-text\">workLoop()</code>가 반환하는 값을 그대로 반환하고 있음을 기억해 둡시다. 이 값은 host config가 받게 됩니다.<br>\n그렇다면 이 값은 무엇이냐? concurrent mode에서는 하나의 Work도 중간에 중지될 수 있습니다. 그리고 적절할 때 재실행 되겠죠. workLoop는 추가 Work에 대한 여부를 반환합니다. 그리고 host config에서는 해당 여부에 따라 다음 틱에 Work가 재실행 될 수 있도록 flushWork()를 호출해줍니다.</p>\n<p>task queue를 어떻게 소비하는지 workLoop()을 통해 알아보겠습니다.</p>\n<h1 id=\"10-workloop\"><a href=\"#10-workloop\" aria-label=\"10 workloop permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10. workLoop</h1>\n<p>이해를 돕기 위해 간단한 의사코드로 흐름을 먼저 알아보고 실제 코드를 보겠습니다.</p>\n<ol>\n<li>currentTask = peek(taskQueue)</li>\n<li>\n<p><strong>while</strong> currentTask !== null</p>\n<ol>\n<li><strong>if</strong> currentTask의 만료 시간이 여유가 있는 와중에 scheduler에게 할당된 시간이 끝났다.</li>\n<li>break</li>\n<li>callback = currentTask.callback;</li>\n<li><strong>if</strong> callback !== null</li>\n<li>callback을 실행해 재조정 작업을 시작한다.</li>\n<li>\n<p><strong>if</strong> callback이 잔여 작업을 반환했다.</p>\n<ul>\n<li>currentTask.callback = continuationCallback;</li>\n</ul>\n</li>\n<li>\n<p><strong>else</strong></p>\n<ul>\n<li>추가 작업이 없다면 currentTask를 task queue에서 꺼낸다.</li>\n</ul>\n</li>\n<li><strong>end if</strong></li>\n<li><strong>else</strong></li>\n<li>callback이 없다는 건 Task가 취소되었다는 뜻이므로 task queue에서 꺼낸다.</li>\n<li><strong>end if</strong></li>\n<li>currentTask = peek(taskQueue);</li>\n</ol>\n</li>\n<li><strong>end while</strong></li>\n<li>\n<p><strong>if</strong> currentTask !== null</p>\n<ul>\n<li>currentTask가 null이 아니라면 while 문이 break 된 것이고 또한 Task가 남아 있으므로 config host에게 계속해서 작업을 이어갈 수 있도록 true를 반환한다.</li>\n</ul>\n</li>\n<li>\n<p><strong>else</strong></p>\n<ul>\n<li>task queue가 비어있고 timer queue에는 timer가 있다면 timeout을 걸어주고 false를 반환한다.</li>\n</ul>\n</li>\n<li><strong>end if</strong></li>\n</ol>\n<anchor id=\"work_loop\">\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > Scheduler.js > unstable_scheduleCallback() > requestHostCallback() > flushWork() > workLoop()</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> currentTime <span class=\"token operator\">=</span> initialTime\n  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span>\n  currentTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      currentTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">></span> currentTime <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasTimeRemaining <span class=\"token operator\">||</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// This currentTask hasn't expired, and we've reached the deadline.</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> callback <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>callback\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      currentTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n      currentPriorityLevel <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>priorityLevel\n      <span class=\"token keyword\">const</span> didUserCallbackTimeout <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;=</span> currentTime\n      <span class=\"token keyword\">const</span> continuationCallback <span class=\"token operator\">=</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>didUserCallbackTimeout<span class=\"token punctuation\">)</span>\n      currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> continuationCallback <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        currentTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> continuationCallback\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">===</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    currentTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Return whether there's additional work</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> firstTimer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstTimer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> firstTimer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>추가 설명이 필요한 부분만 짚고 넘어가도록 하겠습니다.<br>\ntimer queue의 기아상태(starvation)를 방지하기 위해서 3, 29 라인에서 틈틈히 timeout Timer를 꺼내줍니다.<br>\n<code class=\"language-text\">callback</code>은 흐름도에서 4 -> 5를 호출할 때 넘겨준 Work 함수<up>11번</up> 입니다.<br>\n8라인 if 문 조건의 뜻은 현재 Task의 만료시간이 조금이라도 여유가 있으면 꼭 지금 처리해야 되는 게 아니므로 host config에게 물어봅니다. 작업을 계속 동기적으로 처리해도 되는지? 만약 그렇지 않다면 while 문을 중단하고 제어권을 host config에게 넘깁니다. 하지만 Task의 만료시간이 이미 지나버렸다면 바로 처리해야 하므로 제어권을 넘기지 않고 시간이 지난 모든 Task를 동기적으로 처리합니다.</p>\n<p>여기까지가 scheduler가 하는 일입니다. 다음 섹션에서는 host config가 어떻게 비동기 api를 구현했는지 확인합니다.</p>\n<h1 id=\"6-requesthosttimeout-requesthostcallback\"><a href=\"#6-requesthosttimeout-requesthostcallback\" aria-label=\"6 requesthosttimeout requesthostcallback permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. requestHostTimeout, requestHostCallback</h1>\n<p>간단한 timeout 구현부터 확인하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js > requestHostTimeout(), cancelHostTimeout()</span>\n<span class=\"token function-variable function\">requestHostTimeout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> ms</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  taskTimeoutID <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-variable function\">cancelHostTimeout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>taskTimeoutID<span class=\"token punctuation\">)</span>\n  taskTimeoutID <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리가 브라우저에서 일반적으로 사용하는 형태와 크게 다르지 않습니다. 하지만 requestHostTimeout()과는 다르게 requestHostCallback()은 setTimeout api로 구현되지 않았고 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\" target=\"_blank\">MessageChannel</a>을 이용하여 비동기 api를 구현했습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js</span>\n<span class=\"token keyword\">const</span> channel <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span>port2</span>channel<span class=\"token punctuation\">.</span>port1<span class=\"token punctuation\">.</span>onmessage <span class=\"token operator\">=</span> performWorkUntilDeadline\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js > requestHostCallback(), cancelHostCallback()</span></span><span class=\"token function-variable function\">requestHostCallback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  scheduledHostCallback <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isMessageLoopRunning<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-variable function\">cancelHostCallback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  scheduledHostCallback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scheduler에서 requestHostCallback()을 호출 할 때 넘겨준 <code class=\"language-text\">callback</code><up>flushWork</up>을 6번 라인에서 전역으로 잡아둡니다. 이 callback은 onmessage 핸들러인 <code class=\"language-text\">performWorkUntilDeadline()</code>에서 호출됩니다.</p>\n<p>이제 마지막 하나만 남았습니다. 다음은 흐름도에서 8번에 해당하는 performWorkUntilDeadline()입니다.</p>\n<h1 id=\"8-performworkuntildeadline\"><a href=\"#8-performworkuntildeadline\" aria-label=\"8 performworkuntildeadline permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. performWorkUntilDeadline</h1>\n<p>해당 함수에서 callback<up>flushWork</up>을 실행하는데 이때 callback이 제어권을 performWorkUntilDeadline()에게 반납했을 때의 의미는 다음과 같습니다.<br>\n작업을 모두 완료했거나 또는 작업 중 host config가 할당한 시간<up>deadline</up>을 넘긴 경우를 뜻합니다.<br>\n후자의 경우 잔여 작업이 남아 있을 수 있는데 이때는 다음 틱에 deadline을 재설정하여 잔여 작업을 계속 진행할 수 있도록 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js</span>\n<span class=\"token keyword\">let</span> yieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token comment\">// ms</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js > performWorkUntilDeadline()</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">performWorkUntilDeadline</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>scheduledHostCallback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    deadline <span class=\"token operator\">=</span> currentTime <span class=\"token operator\">+</span> yieldInterval\n    <span class=\"token keyword\">const</span> hasTimeRemaining <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> hasMoreWork <span class=\"token operator\">=</span> <span class=\"token function\">scheduledHostCallback</span><span class=\"token punctuation\">(</span>hasTimeRemaining<span class=\"token punctuation\">,</span> currentTime<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasMoreWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        scheduledHostCallback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">throw</span> error\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n  needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">yieldInterval</code>과 <code class=\"language-text\">deadline</code>은 다음의 주석으로 설명을 대체합니다.</p>\n<blockquote>\n<h3 id=\"yieldinterval\"><a href=\"#yieldinterval\" aria-label=\"yieldinterval permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yieldInterval</h3>\n<p>Scheduler periodically yields in case there is other work on the main thread, like user events. By default, it yields multiple times per frame.<br>\nIt does not attempt to align with frame boundaries, since most tasks don’t need to be frame aligned; for those that do, use requestAnimationFrame.</p>\n</blockquote>\n<blockquote>\n<h3 id=\"deadline\"><a href=\"#deadline\" aria-label=\"deadline permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deadline</h3>\n<p>Yield after <code class=\"language-text\">yieldInterval</code> ms, regardless of where we are in the vsync cycle. This means there’s always time remaining at the beginning of the message event.</p>\n</blockquote>\n<p>1초에 60프레임을 뽑으려면 대충 16ms에 렌더링 파이프라인을 통과해야 합니다. 리액트는 비동기 함수의 실행을 vsync에 맞출 필요가 없다고 생각했습니다. Work는 메모리 작업이지 렌더링과 관련된 작업이 아니므로 한 프레임에 여러 번(<down>5ms</down>) 브라우저에 양보한다면 자바스크립트가 렌더링에 큰 영향을 미치지 않는다고 판단하는 것 같습니다.</p>\n<p><code class=\"language-text\">needsPaint</code>와 shouldYieldToHost() 등 언급은 되었지만 아직 확인하지 않은 부분들은 다음 섹션에서 한 번에 다루도록 하겠습니다.</p>\n<h1 id=\"브라우저에게-양보하기-위한-시스템\"><a href=\"#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%97%90%EA%B2%8C-%EC%96%91%EB%B3%B4%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C\" aria-label=\"브라우저에게 양보하기 위한 시스템 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>브라우저에게 양보하기 위한 시스템</h1>\n<p>host config는 호스트 환경에 따라서 사용하는 구현체가 다른데 그중 하나가 shouldYieldToHost()입니다.\n해당 함수는 제어권을 반납해야 하는지 다른 모듈들에게 알려줍니다. 분석은 이 함수부터 시작하겠습니다.</p>\n<p>양보하는 이유는 자바스크립트가 브라우저의 사용자 이벤트 처리나 페인트 작업을 방해하지 않게 하기 위함입니다.\n포스트 시작 부분에서 <a href=\"#is-input-pending\">isInputPending</a>에 대해 언급한 내용을 기억하시나요? 해당 api는 유저 이벤트가 대기 중인지 자바스크립트에서 알 수 있습니다. shouldYieldToHost()는 이 api에 따라서 구현 코드가 다릅니다.</p>\n<h2 id=\"isinputpending를-지원하는-환경\"><a href=\"#isinputpending%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%99%98%EA%B2%BD\" aria-label=\"isinputpending를 지원하는 환경 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>isInputPending를 지원하는 환경</h2>\n<p>이 환경에서는 사용자 이벤트와 페인트 두 가지를 각각 따로 확인할 수 있습니다.<br>\n리액트는 위 두 가지 모두 처리 대기 중이 아니라면 굳이 브라우저에 양보할 필요가 없이 부지런히 재조정 작업을 하면 됩니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js</span>\n<span class=\"token keyword\">let</span> maxYieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">300</span>\n<span class=\"token keyword\">let</span> needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  enableIsInputPending <span class=\"token operator\">&amp;&amp;</span>\n  navigator <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">.</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> scheduling <span class=\"token operator\">=</span> navigator<span class=\"token punctuation\">.</span>scheduling\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function-variable function\">shouldYieldToHost</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTime <span class=\"token operator\">>=</span> deadline<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needsPaint <span class=\"token operator\">||</span> scheduling<span class=\"token punctuation\">.</span><span class=\"token function\">isInputPending</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></span>      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> currentTime <span class=\"token operator\">>=</span> maxYieldInterval\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\"></span>  <span class=\"token function-variable function\">requestPaint</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// isInputPending를 지원하지 않는 환경..</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>14 deadline을 넘겼다면 1차 신호입니다.<br>\n15 페인트나 사용자 이벤트가 대기 중이라면 바로 브라우저를 위해 콜스택을 비워줘야 합니다.<br>\n18 15라인에 해당하지 않는다면? 최대 <code class=\"language-text\">maxYieldInterval</code><up>300ms</up>까지 동기적으로 작업을 계속해서 진행할 수 있습니다.</p>\n<p>사용자 이벤트 여부를 알려주는 isInputPending()의 경우 브라우저 api입니다. 그렇다면 페인트가 필요한지에 대한 여부는 어디서 알 수 있을까요? 이 부분은 리액트의 VDOM 결과물을 반영하기 위한 페인트 여부만 알 수 있습니다. 이 부분은 <code class=\"language-text\">requestPaint()</code>을 통해 commit phase에서 설정합니다. commit phase가 끝났다면 브라우저가 화면을 페인트 할 차례이기 때문입니다.</p>\n<h2 id=\"isinputpending를-지원하지-않는-환경\"><a href=\"#isinputpending%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%ED%99%98%EA%B2%BD\" aria-label=\"isinputpending를 지원하지 않는 환경 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>isInputPending를 지원하지 않는 환경</h2>\n<p>이전 환경과는 다르게 여기서는 페인트 여부만 알 수 있지 사용자의 이벤트 여부는 모릅니다. 그렇다는 건 어쩔 수 없이 주기적으로 콜스택을 비워줘야 합니다. 그래서 굳이 페인트 여부도 관리할 필요가 없습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// scheduler > SchedulerHostConfig.default.js</span>\n<span class=\"token keyword\">let</span> maxYieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">300</span>\n<span class=\"token keyword\">let</span> needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// isInputPending를 지원하는 환경..</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">shouldYieldToHost</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> deadline\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">requestPaint</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>isInputPending을 사용하던 shouldYieldToHost()에서는 maxYieldInterval를 비교했지만 한 프레임에 짧은 기간 주기적으로 양보를 해야 되는 환경에서는 <code class=\"language-text\">deadline</code>으로 비교합니다.</p>\n<p>deadline은 기본적으로 5ms입니다. 왜냐면 deadline을 계산하는 피연산자 중 하나인 yieldInterval가 숫자가 5였었습니다. 리액트는 이 주기를 변경할 수 있는 함수를 제공합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">forceFrameRate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fps <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> fps <span class=\"token operator\">></span> <span class=\"token number\">125</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'forceFrameRate takes a positive int between 0 and 125, '</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">'forcing framerates higher than 125 fps is not unsupported'</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fps <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    yieldInterval <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span> <span class=\"token operator\">/</span> fps<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// reset the framerate</span>\n    yieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"shouldyieldtohost을-사용하는-위치\"><a href=\"#shouldyieldtohost%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9C%84%EC%B9%98\" aria-label=\"shouldyieldtohost을 사용하는 위치 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>shouldYieldToHost을 사용하는 위치</h2>\n<p>우리는 이미 한군데는 알고 있습니다. 바로 scheduler에서 task queue를 소비하는 workLoop() 입니다. shceduler에는 한군데 더 있습니다.<br>\nscheduler 내부가 아닌 외부에 있는 reconciler에게 제공하는 함수에서 사용합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">unstable_shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> firstTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span></span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">(</span>firstTask <span class=\"token operator\">!==</span> currentTask <span class=\"token operator\">&amp;&amp;</span></span>      currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      firstTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"gatsby-highlight-code-line\">      firstTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span></span><span class=\"gatsby-highlight-code-line\">      firstTask<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">&lt;=</span> currentTime <span class=\"token operator\">&amp;&amp;</span></span><span class=\"gatsby-highlight-code-line\">      firstTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;</span> currentTask<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></span>    <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>reconciler에서 concurrent mode의 Work는 중간에 중지할 수 있다고 했습니다. 중지할 수 있는 근거가 바로 위 코드에 나와 있습니다.<br>\n<code class=\"language-text\">shouldYieldToHost()</code>는 당연하게 브라우저를 위해 중지합니다. 이때는 잔여 작업이 있음을 나타내는 <a href=\"#work_loop\">callback을 반환<up>21라인</up></a> 함으로서 다음 틱에 잔여 작업을 계속해서 처리할 수 있도록 했습니다.<br>\n이 함수는 그렇다 치고 옆에 있는 조건은 무엇을 뜻하는지 하나씩 뜯어보면서 확인해보겠습니다.</p>\n<p>3 timeout Timer를 task queue로 옮깁니다.<br>\n4 task queue가 3으로 인해 재정렬 되었을 수도 있으므로 가장 우선순위가 높은 Task를 task queue에서 꺼내옵니다.<br>\n6 ~ 11 현재 처리되고 있는 Task보다 우선순위가 높은 새로운 Task가 새롭게 task queue에 들어왔기 때문에 현재 Task를 잠시 중단하고 새로운 Task를 먼저 처리하기 위한 조건입니다.</p>\n<p>마지막으로 reconciler에서 위 함수를 사용하는 코드를 확인하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">import</span> Scheduler_shouldYield <span class=\"token keyword\">as</span> shouldYield <span class=\"token keyword\">from</span> <span class=\"token string\">'...'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Already timed out, so perform work without checking if we need to yield.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Perform work until Scheduler asks us to yield</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 함수들은 컴포넌트 단위의 재조정 작업을 진행하는 함수입니다.<br>\n첫 번째 함수는 legacy mode, blocking mode에서 사용하고 두번째는 concurrent mode에서 사용합니다.<br>\nwhile문의 조건을 자세히 보면 concurrent mode에서만 <code class=\"language-text\">shouldYield()</code>를 사용하고 있습니다. 이 모드에서는 작업을 특정 컴포넌트까지 진행하다 중지시킬 수 있음을 해당 코드를 보고 알 수 있습니다. 여기서 중지된 Work는 추가 작업을 알리는 callback을 반환해야 하는데 이 부분은 다음 포스트인 reconciler에서 재조정 작업과 함께 알아보도록 하겠습니다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">목록</th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-scheduler_1/\">React 톺아보기- 04. Scheduler_1</a></td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-reconciler/\">React 톺아보기- 05. Reconciler</a></td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"React 톺아보기- 04. Scheduler_2","date":"2020-06-23","keywords":["리액트","react","fiber","hook","hooks","useState","useEffect","useLayoutEffect","useCallback","scheduler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-scheduler_2/","previous":{"fields":{"slug":"/react/in-depth-react-scheduler_1/"},"frontmatter":{"title":"React 톺아보기- 04. Scheduler_1","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_1/"},"frontmatter":{"title":"React 톺아보기- 05. Reconciler_1","category":"react"}}}}}