{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_4 copy/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"df88634d-a3b0-5de8-aa52-f82952797c5f","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 우리는 업데이트된 컴포넌트를 호출해 react element를 반환받아 이를 fiber로 확장했습니다. fiber는 6.reconcileChildren에서 반환되어 5 -> 3-> 2-> 1로 거슬로 올라가 해당 fiber로 다시 Work를 진행합니다. 다음은 Work를 마무리 하는 로직을 확인해 볼텐데 그 이전에…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.22036168787676%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQoz4VS2W6DQBDj//8oH4AapEb5hR5qI+UAws0e43qGbkvVpH2wdgDb65khExEIsEBr0QooqwqbzQYP2y0edzvkeY79fo+iKFBfr8a5pc2sCGFBMowRbp5RlSXqukZTV6jLC7q25VnCDQOgfPLE+0WrdTKMTbPAOUQaxa6FtA3gHYUeGPoF0wjeAjkfEXhGGsfzidorjZ0lzSwujYRGXgkUaW3PfYdZDdxsF40Ue6aUaSK3RxgH+yaq0ZRmuJoD0jwSSIoUY/XNkr0+Q05HHdxP/tcM/4Bn+zoCa6vrEDhLd3iDu5wR+h7CroRp0w7uG663N46LiIiamu8j3wemDC9PiId3G8N3y7fA+eiiNJWlGD+hC9MF6WW62bThf1tO5HswHn79hx/bZsBJOgJy5wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"render phase flow\" title=\"render phase flow\" src=\"/static/ea0101d7212866b4c6776ee262f8160e/c94d1/render_phase_flow.png\" srcset=\"/static/ea0101d7212866b4c6776ee262f8160e/0780f/render_phase_flow.png 198w,\n/static/ea0101d7212866b4c6776ee262f8160e/47b26/render_phase_flow.png 395w,\n/static/ea0101d7212866b4c6776ee262f8160e/c94d1/render_phase_flow.png 790w,\n/static/ea0101d7212866b4c6776ee262f8160e/9e288/render_phase_flow.png 1185w,\n/static/ea0101d7212866b4c6776ee262f8160e/624a3/render_phase_flow.png 1493w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>우리는 업데이트된 컴포넌트를 호출해 react element를 반환받아 이를 fiber로 확장했습니다.<br>\nfiber는 6.reconcileChildren에서 반환되어 5 -> 3-> 2-> 1로 거슬로 올라가 해당 fiber로 다시 Work를 진행합니다.</p>\n<p>다음은 Work를 마무리 하는 로직을 확인해 볼텐데 그 이전에 2.performUnitOfWork()를 다시 한번 확인하면서 어떤 상황일 때 Work를 마무리 하는지 알아보겠습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">.</span>alternate\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> unitOfWork<span class=\"token punctuation\">,</span> renderExpirationTime<span class=\"token punctuation\">)</span></span>\n  unitOfWork<span class=\"token punctuation\">.</span>memoizedProps <span class=\"token operator\">=</span> unitOfWork<span class=\"token punctuation\">.</span>pendingProps\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    next <span class=\"token operator\">=</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span>unitOfWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  ReactCurrentOwner<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">return</span> next\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">beginWork()</code>가 null을 반환한다는 것은 <code class=\"language-text\">unitOfWork</code>가 leaf 노드라는 뜻으로 이를 호출해도 자식이 없으므로 null을 반환하게 됩니다 . 즉 하위 서브 트리에 Work를 진행할 fiber가 더 이상 없으면 현재 fiber의 Work를 마무리하는 것입니다.</p>\n<p>현재 까지만 놓고 보면 트리의 밑으로만 내려갔지 옆으로 이동하는 부분이 없습니다. 이는 <code class=\"language-text\">completeUnitOfWork()</code>에서 leaf 노드를 처리하고 형제 노드가 있으면 반환해주는 것으로 <code class=\"language-text\">next = completeUnitOfWork(unitOfWork)</code>의 next가 형제 노드가 됩니다.</p>\n<p>지금 까지의 상황을 다음의 VDOM 이미지를 통해 확인해봅시다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.58697972251868%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB00lEQVQoz22Sa1PaQBiF/f9f+hP6pZ2OIxbq2Km1zFQorcpFMJMQ7gIptxAEEUIgl6dvAlqlfWfe7CbZPXvOnnMQBAH7ba8dFqsVzmbD/ypwHDzTxPM8fN9/tffg5Ys8ogWfrn7x5jTOebGAO51iW2NWliU9xpne86hp1D7GUI4PGejl7SE74FeAvvwIAZv9Plm1SM8c4QrT9XLJxpaW0RV2jmGgn5yQPzth0uttAYN9QAFivZV4oSm8zaRIqQo8zvGlvfmczWyGK/NFt0vj6xeqZ6eMm/V/GUbMFkuy35IkRO73UpbZoE+9XkUrK+i1Kp27Fg/DIQ8Ti3tdR0skKH6OY6hqBOjLfT4DPpVutEgqJdRmRe7LxByN0Bs1aq06XaOL2W4zbXewhgO6tzna6TSWWvhrVggYTm5bTd79uCCt3uDYK87zlxxfZ1BE2svyfve4ix1RjMeoppJMSsL+8D2Fow9UM2k8kR0BNkVe8iZPVhzry/xnWSOZz6G2GvgSnY3EKBBJoSGjUP7VJcNKhdlkQk/WGoUcVqeNvy85KteN4kNokm2zmk1xxIxoFENC158l7uc0ApSNIVVXGIRjeIoroGF7O+f8XT73O3j6HgZ8F/I/II3wk+Y0GSAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"reconcile children\" title=\"reconcile children\" src=\"/static/8add8101dc88320afdd3537f1f4d6b98/c94d1/reconcile_children.png\" srcset=\"/static/8add8101dc88320afdd3537f1f4d6b98/0780f/reconcile_children.png 198w,\n/static/8add8101dc88320afdd3537f1f4d6b98/47b26/reconcile_children.png 395w,\n/static/8add8101dc88320afdd3537f1f4d6b98/c94d1/reconcile_children.png 790w,\n/static/8add8101dc88320afdd3537f1f4d6b98/d6df5/reconcile_children.png 937w\" sizes=\"(max-width: 790px) 100vw, 790px\" loading=\"lazy\">\n    </span>\n<p>App, Todo, Input의 fiber들은 모두 bailout을 통해 기존 current를 그대로 가져와서 workInProgress로 사용합니다.<br>\n그후 Input 컴포넌트를 호출하여 input과 button을 담고 있는 Fragment를 반환받습니다. key가 없으므로 바로 벗겨내어 배열을 얻고 배열에 대한 재조정 작업을 시작합니다.<br>\n배열 원소 중 재사용 가능한 경우 current에서 props만 교체하여 workInProgress를 만들어 냅니다. 다른 원소들도 같은 처리가 적용되며 동시에 sibling으로 연결해 준 후 첫번째 자식만 반환합니다.<br>\n반환된 첫 번째 자식인 input에 다시 Work를 진행하고 beginWork()는 null을 반화하며 이번 포스트에서 분석할 Work 마무리 단계를 거쳐가게 됩니다.</p>\n<p>input은 leaf 노드이므로 beginWork()는 null을 반환할 것입니다. 이말인즉슨 더 이상 서브트리에는 Work를 진행해야 할 대상이 없으므로 input의 작업을 마무리할 수 있다는 뜻입니다. 이때의 마무리란 html element를 생성하거나 이벤트, effect 연결 등 commit phase에서 필요한 결과물들을 만들어내는걸 말합니다.</p>\n<p>input이 마무리 되면 completeUnitOfWork()는 형제 노드를 탐색 할 것이고 button은 아직 Work 진행하지 않았으므로 반환될 것입니다. 이제 위 내용을 코드로 확인해봅시다.</p>\n<blockquote>\n<h3 id=\"처리-순서\"><a href=\"#%EC%B2%98%EB%A6%AC-%EC%88%9C%EC%84%9C\" aria-label=\"처리 순서 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>처리 순서</h3>\n<p>만약 App에서 업데이트가 발생하여 전체 컴포넌트가 호출된다고 가정하면 호출의 순서는 전위 순회와 같습니다.<br>\n즉 App -> Todo -> Input -> OrderList 입니다.<br>\ninput과 button, ol 등 호스트 컴포넌트는 호출 대상이 아니므로 제외했습니다.<br>\nWork 마무리 순서는 후위 순회와 같습니다.<br>\ninput -> button -> Input … -> Todo -> App</p>\n</blockquote>\n<h2 id=\"7-completeunitofwork\"><a href=\"#7-completeunitofwork\" aria-label=\"7 completeunitofwork permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. completeUnitOfWork</h2>\n<p>먼저 VDOM 순회 코드부터 보도록 하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  workInProgress <span class=\"token operator\">=</span> unitOfWork\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>alternate\n    <span class=\"token keyword\">const</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>return\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Incomplete<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// completeWork(current, workInProgress, renderExpirationTime);</span>\n      <span class=\"token comment\">// if (returnFiber !== null &amp;&amp; (returnFiber.effectTag &amp; Incomplete) === NoEffect) {...}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 부모의 서브트리에서 Work를 진행하던 중 에러가 발생한 경우.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 형제가 있으면 아직 Work를 진행하지 않은 것이므로 반환한다.</span>\n      <span class=\"token keyword\">return</span> siblingFiber\n    <span class=\"token punctuation\">}</span>\n\n    workInProgress <span class=\"token operator\">=</span> returnFiber\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>workInProgress의 Work를 마무리<up>8~9</up> 하고 형제 노드<up>14~15</up>를 찾습니다. 만약 형제 노드가 없다면 이는 부모의 서브 트리가 모두 마무리 된 것으로 다음 차례는 부모<up>20</up>가 됩니다. 계속해서 부모를 마무리하고 부모의 형제가 있으면 형제부터 다시 Work를 진행 할 것이고 없다면 부모의 부모를 마무리하는 순서로 흘러가며 끝에는 최상단 노드인 host root에 도달하며 끝납니다.</p>\n<p>그렇다면 우리가 진행했던 Work의 결과물에서 무엇을 마무리해야 하는 것일까요? 크게 다음의 두가지가 있습니다.</p>\n<anchor id=\"completeUnitOfWork\">\n<ol>\n<li>호스트와 관련된 부분</li>\n<li>VDOM 변경점을 담고 있는 effect list</li>\n</ol>\n<p>첫번째는 <code class=\"language-text\">completeWork()</code><up>8</up> 두번째는 if문<up>9</up>에서 각각 처리합니다.</p>\n<h2 id=\"8-completework\"><a href=\"#8-completework\" aria-label=\"8 completework permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. completeWork</h2>\n<p>호스트와 연관된 부분이라면 당연히 fiber에 대응하는 html element겠죠?<br>\n새롭게 생성된 fiber라면 element 역시 새로 만들어야 하고 그렇지 않은 경우에는 current와 workInProgress가 가지고 있는 props 사이의 차이점을 찾아내어 element에 적용시켜야 합니다. 이 이외에도 호스트와 연관된 부분은 이벤트 바인딩이 있습니다.</p>\n<p>위 설명에서 말씀드린 것 처럼 호스트 환경에 의존적인 작업을 할 것이고 이 작업의 대상은 호스트 컴포넌트 하나입니다.<br>\n커스텀 컴포넌트는 컨트롤러에 가깝고 호스트 컴포넌트는 뷰에 완전히 1:1 대응 됩니다. 그러므로 이 작업의 대상은 호스트 컴포넌트만 해당하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  renderExpirationTime<span class=\"token punctuation\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> IndeterminateComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> SimpleMemoComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> FunctionComponent<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 생략..</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// suspense, portal..</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>호스트 컴포넌트 말고도 suspense, portal과 관련된 로직들이 있지만 생략합니다.</p>\n</blockquote>\n<p>element 생성 코드를 먼저 본 후에 업데이트 부분을 확인하겠습니다.</p>\n<h4 id=\"html-element-생성\"><a href=\"#html-element-%EC%83%9D%EC%84%B1\" aria-label=\"html element 생성 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>html element 생성</h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> renderExpirationTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>pendingProps\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 생략..</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> rootContainerInstance <span class=\"token operator\">=</span> <span class=\"token function\">getRootHostContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// host root를 가지고 온다.</span>\n      <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// element 업데이트</span>\n        <span class=\"token comment\">// updateHostComponent(...);</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// element 생성</span>\n        <span class=\"token keyword\">let</span> instance <span class=\"token operator\">=</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>\n          type<span class=\"token punctuation\">,</span>\n          newProps<span class=\"token punctuation\">,</span>\n          rootContainerInstance<span class=\"token punctuation\">,</span>\n          workInProgress<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">appendAllChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> workInProgress<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// event binding..</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">finalizeInitialChildren</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 생략..</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>라인 7의 경우 설명의 간략화를 위해 생략된 부분으로 스택에서 host root를 가지고 온다 라고만 생각해주세요.<br>\n추가하는 부분은 <a href=\"https://github.com/facebook/react/blob/v16.13.0/packages/react-reconciler/src/ReactFiberBeginWork.js#L2931\" target=\"_blank\">beginWork()</a>에 있습니다. host root인 경우 스택에 push하는 코드가 생략되었습니다.</p>\n</blockquote>\n<p>element를 생성<up>13</up>하고 fiber의 <code class=\"language-text\">stateNode</code><up>21</up>에 저장합니다. 이때 우리는 현재 처리하고 있는 element이외에 자식들에 대한 처리도 추가적으로 필요합니다.\n왜냐하면 현재 여기에 도달했다는 건 workInProgress는 새로 만들어진 fiber라는 것이고 current는 존재하지 않습니다.</p>\n<p>이렇게 되면 서브 트리들도 current가 존재하지 않게 되므로 fiber, element 모두 새로이 만들어집니다. fiber 생성당시 부모의 fiber를 참조하도록 처리했던것과 같이 element도 여기서 생성하므로 바로 처리해줍니다. 다만 fiber와 다른 부분은 부모가 아닌 자식과 연결해주어야 한다는 점입니다. 즉 20라인에 진입하기 전에는 <code class=\"language-text\">instance</code>는 어떠한 자식들도 가지고 있지않은 상태 입니다.</p>\n<p>마지막으로 <code class=\"language-text\">finalizeInitialChildren()</code>을 통해 이벤트와 atrribute 추가 등 마무리 작업<up>24</up>을 진행합니다. 동시에 해당 element의 auto focus 여부를 반환하여 Update tag를 달아줍니다. 만약 이 부분이 빠져있다면 해당 fiber에는 Placement tag만 존재하므로 element의 삽입 또는 이동만 하게 됩니다.</p>\n<p>차례대로 createInstance(), appendAllChildren(), finalizeInitialChildren() + markUpdate()를 확인하고 난 후에 element 업데이트 로직으로 넘어가겠습니다.</p>\n<h4 id=\"createinstance\"><a href=\"#createinstance\" aria-label=\"createinstance permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createInstance</h4>\n<blockquote>\n<p>호스트 코드에 대해서는 깊게 들어가지 않고 기본만 확인하고 나오도록 하겠습니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > clinet > ReactDOMHostConfig.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>\n  type<span class=\"token punctuation\">,</span>\n  props<span class=\"token punctuation\">,</span>\n  rootContainerInstance<span class=\"token punctuation\">,</span>\n  internalInstanceHandle <span class=\"token comment\">// workInProgress</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> parentNamespace\n  <span class=\"token keyword\">const</span> domElement <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n    type<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n    rootContainerInstance<span class=\"token punctuation\">,</span>\n    parentNamespace\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token function\">precacheFiberNode</span><span class=\"token punctuation\">(</span>internalInstanceHandle<span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> domElement\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>브라우저 환경에서 <code class=\"language-text\">createElement()</code>는 documnet의 createElement입니다. <code class=\"language-text\">document.createElement(type)</code>과 같으며 호스트 컴포넌트의 경우 type은 html element의 tag명 문자열 입니다.</p>\n<p>일전에 생성한 element를 fiber의 stateNode에 저장해주었습니다. 이는 react에서 호스트를 접근할 수 있도록 해주는 부분이고 그 반대로 호스트 영역에서 react 코드를 접근할 수 있도록 fiber와 props를 연결해주는 부분이 <code class=\"language-text\">precacheFiberNode()</code>와 <code class=\"language-text\">updateFiberProps()</code>입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMComponentTree.js</span>\n<span class=\"token keyword\">const</span> randomKey <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> internalInstanceKey <span class=\"token operator\">=</span> <span class=\"token string\">'__reactInternalInstance$'</span> <span class=\"token operator\">+</span> randomKey\n<span class=\"token keyword\">const</span> internalEventHandlersKey <span class=\"token operator\">=</span> <span class=\"token string\">'__reactEventHandlers$'</span> <span class=\"token operator\">+</span> randomKey\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">precacheFiberNode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hostInst<span class=\"token punctuation\">,</span> node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">[</span>internalInstanceKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> hostInst\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFiberProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  node<span class=\"token punctuation\">[</span>internalEventHandlersKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>element를 생성했다면 다음은 해당 element에 하위 자식들을 연결해 줄 차례입니다.</p>\n<h4 id=\"appendallchildren\"><a href=\"#appendallchildren\" aria-label=\"appendallchildren permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>appendAllChildren</h4>\n<p>연결해 줄 것은 ‘자식’입니다. 자손이 아닙니다. 즉 우리에게 필요한 fiber는 자신을 기준으로 1depth에 해당하는 fiber들 입니다. 이 fiber들을 추려낼 때 한가지 주의해야 될 점이 있습니다.<br>\nhtml element로 반영되는 컴포넌트는 호스트 컴포넌트 하나 입니다. 하지만 VDOM에는 이 외에도 많은 컴포넌트들이 존재하기 때문에 이를 필터링하는 로직이 필수적으로 들어가야합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">appendAllChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> workInProgress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 자식 호스트 컴포넌트를 추려내기 위한 변수</span>\n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>child\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostComponent <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 호스트 컴포넌트</span>\n      <span class=\"token function\">appendInitialChild</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// parent.appendChild(node.stateNode)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 이외 컴포넌트</span>\n      node<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node\n      <span class=\"token comment\">// 호스트 컴포넌트를 찾기 위해 한 단계 밑으로 내려 간다</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 내려갔던 만큼 parent까지 올라가며 형제 여부를 판단한다.</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// node의 부모가 workInProgress라면 1depth 자식을 모두 순회했음을 뜻함.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> workInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 1depth의 호스트 컴포넌트를 모두 찾기 위해 형제를 모두 순회한다.</span>\n    node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>코드의 설명은 주석으로 대신하고 <a href=\"/react/in-depth-react-reconciler_1/#todo\" target=\"_blank\">Todo 예제</a>를 이용하여 appendAllChildren()의 알고리즘이 어떻게 동작하는지 다음의 이미지를 통해 확인해봅시다.</p>\n<blockquote>\n<p>appendAllChildren() 알고리즘의 커버리지를 위해 Todo 컴포넌트의 Fragment를 div로 변경합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span></span>      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></span>  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</blockquote>\n<blockquote>\n<p>다음의 이미지에서 Input 컴포넌트의 형제인 OrderList는 간략화를 위해 생략했음을 유의해주세요.</p>\n</blockquote>\n<img src=\"/path/to/dir/b0bbf0943d606f5f1770404c6c550e7c/append_all_children.gif\" width=\"100%\">\n<h4 id=\"생성된-element-마무리-하기\"><a href=\"#%EC%83%9D%EC%84%B1%EB%90%9C-element-%EB%A7%88%EB%AC%B4%EB%A6%AC-%ED%95%98%EA%B8%B0\" aria-label=\"생성된 element 마무리 하기 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>생성된 element 마무리 하기</h4>\n<p>우리는 다음의 코드에서 element를 생성<up>11</up>하고 자식을 연결<up>13</up>해주었습니다.<br>\n다음으로는 생성된 element를 마무리하는 작업을 할 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// const newProps = workInProgress.pendingProps</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 생략..</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// var rootContainerInstance = getRootHostContainer();</span>\n      <span class=\"token comment\">// const type = workInProgress.type;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// updateHostComponent(...);</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// let instance = createInstance(...);</span>\n\n        <span class=\"token comment\">// appendAllChildren(..);</span>\n        <span class=\"token comment\">// workInProgress.stateNode = instance;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token function\">finalizeInitialChildren</span><span class=\"token punctuation\">(</span>\n          instance<span class=\"token punctuation\">,</span>\n          type<span class=\"token punctuation\">,</span>\n          newProps<span class=\"token punctuation\">,</span>\n          rootContainerInstance\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 생략..</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMHostConfig.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">finalizeInitialChildren</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Instance<span class=\"token punctuation\">,</span>\n  type<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  props<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span>\n  rootContainerInstance<span class=\"token punctuation\">:</span> Container</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setInitialProperties</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> rootContainerInstance<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">shouldAutoFocusHostComponent</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span> <span class=\"token comment\">// auto focus 여부</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>상대적으로 간단한 <code class=\"language-text\">shouldAutoFocusHostComponent()</code>를 먼저 확인 하고 가겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMHostConfig.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldAutoFocusHostComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">:</span> Props</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'button'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'select'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'textarea'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>props<span class=\"token punctuation\">.</span>autoFocus\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>일전에 말씀드린대로 auto focus를 지원하는 태그들은 해당 여부를 반환<up>8, 10</up>해야 update tag를 달아줄 수 있습니다.</p>\n<p><code class=\"language-text\">setInitialProperties()</code>는 element에 이벤트 리스너를 달아주고 atrribute를 추가해 생성을 마무리하는 함수입니다.</p>\n<blockquote>\n<p>호스트 코드에 대해서는 깊게 들어가지 않고 기본만 확인하고 나오도록 하겠습니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">setInitialProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span>\n  tag<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  rawProps<span class=\"token punctuation\">:</span> Object<span class=\"token punctuation\">,</span>\n  rootContainerElement<span class=\"token punctuation\">:</span> Element <span class=\"token operator\">|</span> Document</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> props<span class=\"token punctuation\">:</span> Object\n  <span class=\"token comment\">// 이벤트 바인딩</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'img'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'image'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_ERROR</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_LOAD</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> rawProps\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'form'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_RESET</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_SUBMIT</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> rawProps\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token function\">ReactDOMInputInitWrapperState</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> rawProps<span class=\"token punctuation\">)</span>\n      props <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> rawProps<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">trapBubbledEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOP_INVALID</span><span class=\"token punctuation\">,</span> domElement<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> <span class=\"token string\">'onChange'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token comment\">// 생략..</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n      props <span class=\"token operator\">=</span> rawProps\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// attribute 추가</span>\n  <span class=\"token function\">setInitialDOMProperties</span><span class=\"token punctuation\">(</span>\n    tag<span class=\"token punctuation\">,</span>\n    domElement<span class=\"token punctuation\">,</span>\n    rootContainerElement<span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">,</span>\n    isCustomComponentTag\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이벤트 바인딩과 관련된 부분은 다음 포스트인 Synthetic Event에서 다루게 되므로 생략하고 간략하게만 설명하자면 <code class=\"language-text\">trapBubbledEvent()</code>는 element에 이벤트를 바인딩하고 <code class=\"language-text\">ensureListeningTo()</code>는 document에 이벤트를 위임하는 방식으로 인자로 넘어오는 이벤트와 의존성을 가지고 있는 이벤트들도 추가적으로 바인딩 합니다.</p>\n<p><code class=\"language-text\">ReactDOMInputInitWrapperState()</code> 와 <code class=\"language-text\">ReactDOMInputGetHostProps()</code>는 리액트에서 input 태그를 다룸에 있어 기본적으로 필요한 속성들을 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMInput.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">initWrapperState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">:</span> Object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> defaultValue <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>defaultValue <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">:</span> props<span class=\"token punctuation\">.</span>defaultValue\n\n  node<span class=\"token punctuation\">.</span>_wrapperState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    initialChecked<span class=\"token punctuation\">:</span>\n      props<span class=\"token punctuation\">.</span>checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>checked <span class=\"token punctuation\">:</span> props<span class=\"token punctuation\">.</span>defaultChecked<span class=\"token punctuation\">,</span>\n    initialValue<span class=\"token punctuation\">:</span> <span class=\"token function\">getToStringValue</span><span class=\"token punctuation\">(</span>\n      props<span class=\"token punctuation\">.</span>value <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>value <span class=\"token punctuation\">:</span> defaultValue\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    controlled<span class=\"token punctuation\">:</span> <span class=\"token function\">isControlled</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isControlled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> usesChecked <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'checkbox'</span> <span class=\"token operator\">||</span> props<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'radio'</span>\n  <span class=\"token keyword\">return</span> usesChecked <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> props<span class=\"token punctuation\">.</span>value <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHostProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">:</span> Object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> checked <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>checked\n\n  <span class=\"token keyword\">const</span> hostProps <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    defaultChecked<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    defaultValue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    checked<span class=\"token punctuation\">:</span> checked <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> checked <span class=\"token punctuation\">:</span> node<span class=\"token punctuation\">.</span>_wrapperState<span class=\"token punctuation\">.</span>initialChecked<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> hostProps\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 호스트 컴포넌트를 사용할 때 props를 전달하는 방식으로 개발합니다. 호스트 입장에서는 이렇게 넘어오는 props를 그대로 사용할 수 없으므로 각 사용법에 맞는 처리가 필요합니다. 분류는 다음과 같이 할 수 있습니다.<br>\n일반적인 attribute, style과 리액트 전용으로는 event, children, dangerouslySetInnerHTML 등이 있습니다.<br>\nchildren의 경우 html element를 fiber로 확장할 때 element가 하위에 문자열 하나만 가지고 있는 경우 해당 문자열을 fiber로 만들지 않고 그냥 두었습니다. 이렇게 남겨진 문자열은 여기서 처리해주어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMComponent.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">setInitialDOMProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">tag<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  domElement<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span>\n  rootContainerElement<span class=\"token punctuation\">:</span> Element <span class=\"token operator\">|</span> Document<span class=\"token punctuation\">,</span>\n  nextProps<span class=\"token punctuation\">:</span> Object<span class=\"token punctuation\">,</span>\n  isCustomComponentTag<span class=\"token punctuation\">:</span> boolean</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> propKey <span class=\"token keyword\">in</span> nextProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> nextProp <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setValueForStyles</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> nextHtml <span class=\"token operator\">=</span> nextProp <span class=\"token operator\">?</span> nextProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextHtml <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setInnerHTML</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextHtml<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTextContent</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registrationNameModules<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setValueForProperty</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">,</span> isCustomComponentTag<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">registrationNameModules</code><up>28</up> 는 html의 모든 이벤트를 on***의 형태로 가지고 있으며 추후에 Synthetic Event에서 다룹니다.<br>\n나머지 props를 처리하는 함수들의 설명은 다음의 링크들로 대체합니다.</p>\n<ul>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/shared/CSSPropertyOperations.js#L62\" target=\"_blank\">setValueForStyles</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setInnerHTML.js#L26\" target=\"_blank\">setInnerHTML</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setTextContent.js#L21\" target=\"_blank\">setTextContent</a></li>\n<li><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/DOMPropertyOperations.js#L127\" target=\"_blank\">setValueForProperty</a></li>\n</ul>\n<p>새로 생성된 fiber의 element를 만드는 작업은 여기 까지입니다. 다음은 기존 current를 재사용 했을 때 current와 workInProgress 사이의 변경점들을 어떻게 찾아내는지 알아보겠습니다.</p>\n<h4 id=\"변경점-추출하여-가공하기\"><a href=\"#%EB%B3%80%EA%B2%BD%EC%A0%90-%EC%B6%94%EC%B6%9C%ED%95%98%EC%97%AC-%EA%B0%80%EA%B3%B5%ED%95%98%EA%B8%B0\" aria-label=\"변경점 추출하여 가공하기 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변경점 추출하여 가공하기</h4>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// const newProps = workInProgress.pendingProps</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 생략..</span>\n    <span class=\"token keyword\">case</span> HostComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// var rootContainerInstance = getRootHostContainer();</span>\n      <span class=\"token comment\">// const type = workInProgress.type;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> workInProgress<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span></span>          current<span class=\"token punctuation\">,</span>\n          workInProgress<span class=\"token punctuation\">,</span>\n          type<span class=\"token punctuation\">,</span>\n          newProps<span class=\"token punctuation\">,</span>\n          rootContainerInstance<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// let instance = createInstance(...);</span>\n        <span class=\"token comment\">// 생략..</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 생략..</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">updateHostComponent()</code>는 current와 workInProgress 사이의 차이점을 찾아내어 가공해놓습니다. 이것은 commit phase에서 소비되어 html element에 반영됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberCompleteWork.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">current<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token punctuation\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  type<span class=\"token punctuation\">:</span> Type<span class=\"token punctuation\">,</span>\n  newProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span>\n  rootContainerInstance<span class=\"token punctuation\">:</span> Container</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>memoizedProps\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps <span class=\"token operator\">===</span> newProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> instance<span class=\"token punctuation\">:</span> Instance <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>stateNode\n  <span class=\"token keyword\">const</span> updatePayload <span class=\"token operator\">=</span> <span class=\"token function\">prepareUpdate</span><span class=\"token punctuation\">(</span>\n    instance<span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    oldProps<span class=\"token punctuation\">,</span>\n    newProps<span class=\"token punctuation\">,</span>\n    rootContainerInstance\n  <span class=\"token punctuation\">)</span>\n  workInProgress<span class=\"token punctuation\">.</span>updateQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>updatePayload<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updatePayload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">markUpdate</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">prepareUpdate()</code><up>15</up>는 변경점을 찾아 가공된 데이터를 반환합니다. 여기에는 추가, 수정, 삭제 해야 될 속성들이 담겨있습니다.<br>\n이것을 workInProgress의 <code class=\"language-text\">updateQueue</code>에 담아놓습니다. 일전에도 updateQueue를 다룬적이 있습니다. 그때는 커스텀 컴포넌트의 updateQueue였으며 라이프 사이클과 관련된 훅의 정보가 저장된다고 언급했습니다.</p>\n<p>그리고 <code class=\"language-text\">updatePayload</code>가 비어 있지 않다면<up>23</up> element를 수정해야 하므로 Update tag를 달아줍니다.<up>24</up></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMHostConfig.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareUpdate</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Instance<span class=\"token punctuation\">,</span>\n  type<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  oldProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span>\n  newProps<span class=\"token punctuation\">:</span> Props<span class=\"token punctuation\">,</span>\n  rootContainerInstance<span class=\"token punctuation\">:</span> Container<span class=\"token punctuation\">,</span>\n  hostContext<span class=\"token punctuation\">:</span> HostContext</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">diffProperties</span><span class=\"token punctuation\">(</span>\n    domElement<span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">,</span>\n    oldProps<span class=\"token punctuation\">,</span>\n    newProps<span class=\"token punctuation\">,</span>\n    rootContainerInstance\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>변경점을 추출할 때는 다음의 두 단계로 나누어 처리합니다. 그래야 O(n)으로 처리(<down>style 제외</down>)할 수 있습니다.</p>\n<ul>\n<li>삭제: current를 기준으로 workInProgress에 없다면 삭제이다.</li>\n<li>추가, 수정: workInProgress를 기준으로 current에 없다면 추가, 값이 다르다면 수정이다.</li>\n</ul>\n<p>즉 current, workInProgress기준으로 각각 한번의 반복을 통해 처리합니다.<br>\n이때 style만은 유일하게 추가, 수정, 삭제가 모두 한번에 일어날 수 있는 속성이므로 다른 속성들과는 조금 다르게 처리합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom > client > ReactDOMComponent.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">diffProperties</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">domElement<span class=\"token punctuation\">:</span> Element<span class=\"token punctuation\">,</span>\n  tag<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  lastRawProps<span class=\"token punctuation\">:</span> Object<span class=\"token punctuation\">,</span>\n  nextRawProps<span class=\"token punctuation\">:</span> Object<span class=\"token punctuation\">,</span>\n  rootContainerElement<span class=\"token punctuation\">:</span> Element <span class=\"token operator\">|</span> Document</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> updatePayload<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> Array<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// 변경점을 담을 저장소로 [[key, value], ...]의 자료구조를 취함.</span>\n\n  <span class=\"token keyword\">let</span> lastProps<span class=\"token punctuation\">:</span> Object\n  <span class=\"token keyword\">let</span> nextProps<span class=\"token punctuation\">:</span> Object\n\n  <span class=\"token comment\">// 기본 속성 추가</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">:</span>\n      lastProps <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> lastRawProps<span class=\"token punctuation\">)</span>\n      nextProps <span class=\"token operator\">=</span> <span class=\"token function\">ReactDOMInputGetHostProps</span><span class=\"token punctuation\">(</span>domElement<span class=\"token punctuation\">,</span> nextRawProps<span class=\"token punctuation\">)</span>\n      updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token comment\">// option, select, textarea...</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> propKey\n  <span class=\"token keyword\">let</span> styleName\n  <span class=\"token keyword\">let</span> styleUpdates <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// style은 임시 변수를 두고 변경점을 추출하여 담아둔다.</span>\n\n  <span class=\"token comment\">// 삭제</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token keyword\">in</span> lastProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token comment\">// workInProgress에 있다면 삭제가 아니다.</span>\n      <span class=\"token operator\">!</span>lastProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 이하 workInProgress에는 존재하지 않는 속성들이므로 삭제처리 한다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> lastStyle <span class=\"token operator\">=</span> lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> lastStyle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastStyle<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 추가, 수정</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token keyword\">in</span> nextProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> nextProp <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> lastProp <span class=\"token operator\">=</span> lastProps <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> lastProps<span class=\"token punctuation\">[</span>propKey<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">!</span>nextProps<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      nextProp <span class=\"token operator\">===</span> lastProp <span class=\"token operator\">||</span>\n      <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> lastProp <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">STYLE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// style은 추가, 수정, 삭제가 동시에 일어날 수 있음.</span>\n      <span class=\"token comment\">// current에만 존재하면 삭제 하면 그만이지만 그렇지 않을 경우 모든 케이스에 대한 처리가 필요함.</span>\n\n      <span class=\"token comment\">// 추가, 삭제, 수정</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> lastProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 삭제</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n            lastProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextProp <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>nextProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 추가, 수정</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>styleName <span class=\"token keyword\">in</span> nextProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n            nextProp<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>styleName<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            lastProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> nextProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              styleUpdates <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            styleUpdates<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nextProp<span class=\"token punctuation\">[</span>styleName<span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 추가</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>updatePayload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>\n          updatePayload<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> styleUpdates<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        styleUpdates <span class=\"token operator\">=</span> nextProp\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">DANGEROUSLY_SET_INNER_HTML</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> nextHtml <span class=\"token operator\">=</span> nextProp <span class=\"token operator\">?</span> nextProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">const</span> lastHtml <span class=\"token operator\">=</span> lastProp <span class=\"token operator\">?</span> lastProp<span class=\"token punctuation\">[</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextHtml <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastHtml <span class=\"token operator\">!==</span> nextHtml<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n            propKey<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">toStringOrTrustedType</span><span class=\"token punctuation\">(</span>nextHtml<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propKey <span class=\"token operator\">===</span> <span class=\"token constant\">CHILDREN</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        lastProp <span class=\"token operator\">!==</span> nextProp <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> nextProp <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> nextProp<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>registrationNameModules<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextProp <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ensureListeningTo</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">,</span> propKey<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>updatePayload <span class=\"token operator\">&amp;&amp;</span> lastProp <span class=\"token operator\">!==</span> nextProp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        updatePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>propKey<span class=\"token punctuation\">,</span> nextProp<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// style 변경점을 가지고 있는 styleUpdates를 마지막으로 추가하면서 마무리한다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>styleUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>updatePayload <span class=\"token operator\">=</span> updatePayload <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STYLE</span><span class=\"token punctuation\">,</span> styleUpdates<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> updatePayload\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기까지가 completeWork()의 호스트 영역에 대한 작업 내용입니다.<br>\n다음으로는 completeWork()를 호출한 completeUnitOfWork()로 다시 돌아가 Work마무리의 <a href=\"#completeUnitOfWork\">2번</a> effect list와 관련된 작업을 알아보겠습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  workInProgress <span class=\"token operator\">=</span> unitOfWork\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>alternate\n    <span class=\"token keyword\">const</span> returnFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>return\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Incomplete<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token comment\">// completeWork(current, workInProgress, renderExpirationTime);</span></span>      <span class=\"token comment\">// if (returnFiber !== null &amp;&amp; (returnFiber.effectTag &amp; Incomplete) === NoEffect) {...}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 부모의 서브트리에서 Work를 진행하던 중 에러가 발생한 경우.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> siblingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>siblingFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> siblingFiber\n    <span class=\"token punctuation\">}</span>\n\n    workInProgress <span class=\"token operator\">=</span> returnFiber\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>마지막으로 if문<up>9</up>을 완성시키면서 render phase를 마무리지을 것입니다.</p>\n<p>render phase를 시작할 때 rooT부터 시작하여 expirationTime을 통해 업데이트가 일어난 노드까지 최단 경로로 도달할 수 있었습니다. 그리고 하위 서브트리를 대상으로 재조정 작업을 시작했습니다. 이때 여러 side-effect들이 생겨납니다. 이렇게 생겨난 effect들은 commit phase에서 사용됩니다.<br>\n이렇게 발생한 effect들을 commit phase에서 어떻게 하면 편하게 사용할 수 있을까요? 각 fiber들이 이미 모든 정보를 들고 있으니 더이상의 처리가 필요하지 않을까요? 이때도 그냥 root부터 시작해서 밑으로 내려가면 되니깐?</p>\n<p>우리에게는 한번의 기회가 있습니다. Work의 마무리 순서를 생각해보면 됩니다. 후위 순회이기 때문에 어쨋든 host root로 되돌아가게 됩니다. 이때 우리는 effect가 발생한 fiber들을 위로 묶어서 전달하기만 하면 됩니다. 이렇게 되면 최종적으로 host root는 side-effect가 발생한 fiber들을 모두 가지고 있게 되므로 commit phase에서는 root만 참조하면 됩니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">completeUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unitOfWork<span class=\"token punctuation\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// workInProgress = unitOfWork</span>\n  <span class=\"token comment\">// do {</span>\n  <span class=\"token comment\">//   const current = workInProgress.alternate</span>\n  <span class=\"token comment\">//   const returnFiber = workInProgress.return</span>\n\n  <span class=\"token comment\">// if ((workInProgress.effectTag &amp; Incomplete) === NoEffect) {</span>\n  <span class=\"token comment\">// completeWork(current, workInProgress, renderExpirationTime);</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    returnFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">&amp;</span> Incomplete<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoEffect\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 서브 트리의 effect를 위로 올린다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>firstEffect\n      <span class=\"token punctuation\">}</span>\n      returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>lastEffect\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">.</span>effectTag\n    <span class=\"token comment\">// 자신에게도 side-effect가 있다면 부모의 effect list에 연결한다.</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">></span> PerformedWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        returnFiber<span class=\"token punctuation\">.</span>lastEffect<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> workInProgress\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> workInProgress\n      <span class=\"token punctuation\">}</span>\n      returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> workInProgress\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// } else {</span>\n  <span class=\"token comment\">// 부모의 서브트리에서 Work를 진행하던 중 에러가 발생한 경우.</span>\n  <span class=\"token comment\">// }</span>\n\n  <span class=\"token comment\">//   const siblingFiber = workInProgress.sibling</span>\n  <span class=\"token comment\">//   if (siblingFiber !== null) {</span>\n  <span class=\"token comment\">//     return siblingFiber</span>\n  <span class=\"token comment\">//   }</span>\n\n  <span class=\"token comment\">//   workInProgress = returnFiber</span>\n  <span class=\"token comment\">// } while (workInProgress !== null)</span>\n\n  <span class=\"token comment\">// return null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아마 하이라이트 부분만 살짝 이해가 안될 수 있으므로 이 부분만 추가적으로 설명하겠습니다.</p>\n<p>호스트 컴포넌트의 삽입, 삭제, 수정이 발생할 경우 completeWork()에서 effect tag를 달아주었습니다. 마찬가지로 커스텀 컴포넌트에도 tag를 달아주었는데 기억이 안나실 수 있지만 컴포넌트를 호출하는 <a href=\"/react/in-depth-react-reconciler_2/#updateFunctionComponent\" target=\"_blank\">updateFunctionComponent()</a>에서 PerformedWork tag를 달아주었습니다. 커스텀 컴포넌트는 이외에도 side-effect와 관련된 훅인 useEffect와 useLayoutEffect를 사용할 때도 tag가 달립니다. 이 부분은 commit phase에서 자세히 다루게 될 것입니다.</p>\n<p>정리하자면 일반적인 커스텀 컴포넌트의 호출을 제외한 나머지 side-effect가 발생한다면 자신을 effect로 간주하고 위로 올린다입니다.</p>\n<blockquote>\n<p>effect tag</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> NoEffect <span class=\"token operator\">=</span> <span class=\"token comment\">/*              */</span> <span class=\"token number\">0b0000000000000</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> PerformedWork <span class=\"token operator\">=</span> <span class=\"token comment\">/*     */</span> <span class=\"token number\">0b0000000000001</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Placement <span class=\"token operator\">=</span> <span class=\"token comment\">/*            */</span> <span class=\"token number\">0b0000000000010</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Update <span class=\"token operator\">=</span> <span class=\"token comment\">/*                */</span> <span class=\"token number\">0b0000000000100</span>\n<span class=\"token comment\">// 생략..</span></code></pre></div>\n</blockquote>\n<p>이번에도 마찬가지로 이미지를 통해 함수의 호출부터 tag가 어떤 순서로 달리고 effect가 어떻게 host root까지 전달되는지 눈으로 확인해 보겠습니다.</p>\n<blockquote>\n<p>completeUnitOfWork() 알고리즘의 커버리지를 위해 Input 컴포넌트에 useEffect를 추가합니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> submit <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Deep dive magic code'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n        <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n          <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">        submit</span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</blockquote>\n<blockquote>\n<p>Input 컴포넌트에서 사용자가 타이핑 했다고 가정합니다.</p>\n</blockquote>\n<img src=\"/path/to/dir/6eb00c097ec9c5b8813eb33b62e89697/effect_list.gif\" width=\"100%\">\n<p>render phase를 거치고 나면 Root<up>host root</up>는 firstEffect로 input을 lastEffect로 Input 가지고 있게 됩니다.<br>\n이제 commit phase에서 host root의 firstEffect 참조만을 통해 모든 변경점들을 알 수 있게 되었습니다.</p>\n<blockquote>\n<p>tag 4는 Update tag, tag 517은 Passive<down>(effect 훅)</down> + Update + PerformedWork tag를 나타냅니다.</p>\n</blockquote>\n<p>host root까지 올라왔다면 더 이상의 Work를 진행할 노드가 남아 있지 않으므로 자연스레 workLoop()의 반복은 중단될 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 다시 Work의 진입점이었던 performSyncWorkOnRoot()로 돌아가게 됩니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// reconciler > ReactFiberWorkLoop.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n  <span class=\"token comment\">// if (..) prepareFreshStack(root, expirationTime);</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevExecutionContext <span class=\"token operator\">=</span> executionContext\n    executionContext <span class=\"token operator\">|=</span> RenderContext\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>thrownValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> thrownValue<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    executionContext <span class=\"token operator\">=</span> prevExecutionContext</span>\n    <span class=\"token comment\">// commit phase..</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// 잔여 작업이 없으므로 null을 리턴.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>reconciler_2에서 사용했던 snippet을 그대로 가지고 왔습니다.<br>\n17라인에서 이전 context로 다시 설정해줌으로서 render phase가 끝납니다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">목록</th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-scheduler_1/\">React 톺아보기- 04. Scheduler_1</a></td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\"><a href=\"/react/in-depth-react-reconciler/\">React 톺아보기- 05. Reconciler</a></td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"React 톺아보기- 05. Reconciler_4","date":"2020-07-20","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react/in-depth-react-reconciler_4 copy/","previous":{"fields":{"slug":"/react/in-depth-react-reconciler_3/"},"frontmatter":{"title":"React 톺아보기- 05. Reconciler_3","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_4/"},"frontmatter":{"title":"React 톺아보기- 05. Reconciler_4","category":"react"}}}}}