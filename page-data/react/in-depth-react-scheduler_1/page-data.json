{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-scheduler_1/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"10c83b85-b0eb-5a5d-9a7c-a86598326294","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM 재조정 작업을 진행한다. Work…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<h3 id=\"포스트별-주제\" style=\"position:relative;\"><a href=\"#%ED%8F%AC%EC%8A%A4%ED%8A%B8%EB%B3%84-%EC%A3%BC%EC%A0%9C\" aria-label=\"포스트별 주제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>포스트별 주제</h3>\n<ol>\n<li>훅을 통해 컴포넌트 상태를 업데이트한다.</li>\n<li>\n<h3 id=\"u업데이트를-반영할-work를-scheduler에게-전달하고-scheduler는-스케줄링된-task를-적절한-시기에-실행한다u\" style=\"position:relative;\"><a href=\"#u%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%EB%A5%BC-%EB%B0%98%EC%98%81%ED%95%A0-work%EB%A5%BC-scheduler%EC%97%90%EA%B2%8C-%EC%A0%84%EB%8B%AC%ED%95%98%EA%B3%A0-scheduler%EB%8A%94-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81%EB%90%9C-task%EB%A5%BC-%EC%A0%81%EC%A0%88%ED%95%9C-%EC%8B%9C%EA%B8%B0%EC%97%90-%EC%8B%A4%ED%96%89%ED%95%9C%EB%8B%A4u\" aria-label=\"u업데이트를 반영할 work를 scheduler에게 전달하고 scheduler는 스케줄링된 task를 적절한 시기에 실행한다u permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><u>업데이트를 반영할 <strong>Work</strong>를 <strong>scheduler</strong>에게 전달하고 <strong>scheduler</strong>는 스케줄링된 <strong>Task</strong>를 적절한 시기에 실행한다.</u></h3>\n</li>\n<li><strong>Work</strong>을 통해 VDOM 재조정 작업을 진행한다.</li>\n<li><strong>Work</strong>를 진행하며 발생한 변경점을 적용한다.</li>\n<li>사용자의 상호작용으로 이벤트가 발생하고 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>\n</ol>\n<hr>\n<p><strong>reconciler</strong>는 비동기 호출이 필요한 <strong>Work</strong>의 실행 제어권을 해당 분야의 전문가인 <strong>scheduler</strong>에게 위임합니다. <strong>reconciler</strong>가 스스로 판단해서 실행하는 게 아닌 <strong>scheduler</strong>가 브라우저의 상태와 여러 조건을 기반으로 적절한 시기를 판단해서 실행하고 있다는 말입니다.</p>\n<p>아래는 <strong>reconciler</strong>가 <strong>Work</strong>를 스케줄링하고 <strong>scheduler</strong>에 의해 실행되기까지의 흐름입니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.06060606060607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABd0lEQVQoz5VTy3LCMAzk/z+PG9AD9NROS96xLcnOduUQCp32UM9srARp9VixW5YFvwLA+XzGfr/H8XjE6XTC4XDA5XLB/WRF+/aKpu1gqjVutxFgw3Ye7R8nmOGaIgZN9CtADV2+CQs/CB9KW3NGZMBoiolZEzGq4FMi2hhwnSd0ktDwW8gGob+VQo6N0Isp/EFnWBaoSSV1cncUW4PEbRJET+IkLCvyvU+pJnZfbIRFemB4AeJHtYsGIDVYdESWkbOKgPodsLDSQhKQLPHOvNcJ3SosrM5iW6vU2EPnzwpLAx3YCkdRLCDP7yRrYGFC6ujvGOnDMTyKufPZm0wULKyZLBKyilLyTSC2U9RbeVA4r3CfJ8JKYiiR7SVZs84zpLkitU0VpyeunNNEgkmkitOx3caVDjO6YUAI4XltHJkBS99V0kwlsytMsoGKOtxOnJmWm0hlVdh4P63NfRdRVwpPG1j385fd3By3uI3QqyrM8uc/5p/4AoimYHNzbqFEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"scheduling flow\" title=\"scheduling flow\" src=\"/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png\" srcset=\"/static/9e327099e752bd46cae5074351cfbe5c/18f77/scheduling_flow.png 198w,\n/static/9e327099e752bd46cae5074351cfbe5c/2cb6c/scheduling_flow.png 395w,\n/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png 790w,\n/static/9e327099e752bd46cae5074351cfbe5c/471ef/scheduling_flow.png 1185w,\n/static/9e327099e752bd46cae5074351cfbe5c/5d6a0/scheduling_flow.png 1580w,\n/static/9e327099e752bd46cae5074351cfbe5c/c2d13/scheduling_flow.png 2560w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>위 흐름에서 각 패키지 별로 하는 일은 명확합니다.<br>\n<strong>reconciler</strong>는 VDOM 재조정 작업 전에 설정해줘야 하는 부분들을 처리하며 <strong>scheduler</strong>는 스케줄링 된 <strong>Task</strong>에 우선순위 반영과 실행하기 적절한 때를 판단하고 작업의 실행과 중단을 담당합니다.</p>\n<p><strong>scheduler</strong>에는 host config라는 모듈이 존재하는데, 호스트 환경에 의존적인 api를 사용하는 모듈입니다.<br>\n여기에는 비동기 api, performance, isInputPending 등이 있습니다.</p>\n<anchor id=\"is-input-pending\">\n<blockquote>\n<h3 id=\"a-hrefhttpswicggithubiois-input-pending-target_blankisinputpendinga\" style=\"position:relative;\"><a href=\"#a-hrefhttpswicggithubiois-input-pending-target_blankisinputpendinga\" aria-label=\"a hrefhttpswicggithubiois input pending target_blankisinputpendinga permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://wicg.github.io/is-input-pending/\" target=\"_blank\">isInputPending</a></h3>\n<p>Facebook이 처음으로 기여한 브라우저 API로, 이름 그대로 JS에서는 알 수 없었던 input event의 존재 여부를 알 수 있으며 이를 이용하여 JS가 메인 스레드를 계속해서 점유하고 있어도 되는지 판단할 수 있습니다.</p>\n<p>리액트는 언제 isInputPending이 필요했느냐면 concurrent mode에서 Render phase가 진행 중 일 때 혹시 있을지 모를 사용자의 event나 브라우저의 렌더링 작업을 방해하지 않기 위해 특정 주기로 콜 스택을 비워주었습니다. 굳이 필요하지 않은 상황일 때도 말이죠.</p>\n<p>이제 리액트는 isInputPending api를 이용하여 브라우저가 메인 스레드의 점유가 필요할 때만 작업을 잠시 중단하고 이를 양보할 수 있게 되었습니다. 만약 그럴 필요가 없다면 리액트는 계속해서 재조정 작업을 동기적으로 진행합니다.</p>\n</blockquote>\n<h1 id=\"1-dispatchaction\" style=\"position:relative;\"><a href=\"#1-dispatchaction\" aria-label=\"1 dispatchaction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. dispatchAction</h1>\n<p>해당 함수는 Hooks에서 이미 자세히 알아보았으므로 생략합니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1358\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberHooks.js </a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAction</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* Render phase update... */</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* idle update... */</span>\n    <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"2-schedulework\" style=\"position:relative;\"><a href=\"#2-schedulework\" aria-label=\"2 schedulework permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. scheduleWork</h1>\n<p><strong>Work</strong>를 스케줄링하기 전에 reconciler에서 해야 할 일은 다음과 같습니다.</p>\n<ol>\n<li>해당 컴포넌트에서 이벤트가 발생했음을 알리는 expirationTime을 새긴다.</li>\n<li>이벤트가 발생한 컴포넌트의 VDOM root을 가지고 온다.</li>\n<li>root에 스케줄 정보를 기록한다.</li>\n</ol>\n<p>현 상황에서 root의 의미를 생각해 볼 필요가 있습니다.<br>\n리액트를 레거시 프로젝트에 도입한다고 했을 때 ReactDOM.render()를 통해 컴포넌트를 삽입한다면 영역별로 root가 생성됩니다. 그리고 root마다 VDOM도 같이 생성되겠죠. root는 VDOM을 대표하는 변하지 않는 객체입니다. 그래서 root에는 많은 정보가 기입되는데 그 중 하나가 스케줄정보입니다.</p>\n<p>만약 단일 VDOM에 여러 업데이트가 발생하여 복수의 <strong>Work</strong> 스케줄링 요청이 들어온다고 생각해봅시다. 이때 요청이 들어온 <strong>Work</strong>와 이미 스케줄링된 <strong>Work</strong> 사이에 교통정리가 필요합니다. 이 역할을 reconciler가 해주며 교통정리의 기준이 되는 게 바로 root에 새겨진 스케줄 정보입니다.</p>\n<h2 id=\"2---1-expirationtime-새기기\" style=\"position:relative;\"><a href=\"#2---1-expirationtime-%EC%83%88%EA%B8%B0%EA%B8%B0\" aria-label=\"2   1 expirationtime 새기기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 - 1 expirationTime 새기기</h2>\n<p>expirationTime을 어떻게 새기는지 알아보겠습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L374\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberWorkLoop.js </a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">‎\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">scheduleUpdateOnFiber</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">markUpdateTimeFromFiberToRoot</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> scheduleWork <span class=\"token operator\">=</span> scheduleUpdateOnFiber</code></pre></div>\n<p>먼저 업데이트가 발생한 fiber에 expirationTime을 새깁니다. 그리고 root를 찾기 위해 위로 올라가는데, 거쳐 가는 fiber에도 시간을 새겨줍니다. 이때는 expirationTime가 아닌 자손에서 이벤트가 발생했음을 나타내는 childExpirationTime를 새깁니다.\n이 부분은 재조정 작업에서 매우 중요하게 사용됩니다.</p>\n<anchor id=\"markUpdateTimeFromFiberToRoot\" />\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L450\" target=\"_blank\" class=\"code_link_2\">reconciler > ReactFiberWorkLoop.js </a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre style=\"counter-reset: linenumber 0\" class=\"language-ts line-numbers\"><code class=\"language-ts\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">markUpdateTimeFromFiberToRoot</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// expirationTime을 새긴다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> alternate <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>alternate\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> alternate<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    alternate<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">=</span> expirationTime\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// root를 찾는다.</span>\n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>return\n  <span class=\"token keyword\">let</span> root <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostRoot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    root <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>stateNode <span class=\"token comment\">// Host root의 stateNode가 root이다.</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      alternate <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>alternate\n      <span class=\"token comment\">// childExpirationTime를 새긴다.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">&lt;</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        node<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">=</span> expirationTime\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n          alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n          alternate<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">&lt;</span> expirationTime\n        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          alternate<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">=</span> expirationTime\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n        alternate<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">&lt;</span> expirationTime\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        alternate<span class=\"token punctuation\">.</span>childExpirationTime <span class=\"token operator\">=</span> expirationTime\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostRoot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        root <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>stateNode\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>return\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> root\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>current와 workInprogress 모두 처리해주고 있는 <a href=\"/react/in-depth-react-hooks_1/#dispatchAction\" target=\"_blank\">이유</a>를 우리는 알고 있습니다.</p>\n</blockquote>\n<h2 id=\"2---2-스케줄링-요청-전-work를-동기로-처리해야-하는지-확인하기\" style=\"position:relative;\"><a href=\"#2---2-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81-%EC%9A%94%EC%B2%AD-%EC%A0%84-work%EB%A5%BC-%EB%8F%99%EA%B8%B0%EB%A1%9C-%EC%B2%98%EB%A6%AC%ED%95%B4%EC%95%BC-%ED%95%98%EB%8A%94%EC%A7%80-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\" aria-label=\"2   2 스케줄링 요청 전 work를 동기로 처리해야 하는지 확인하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 - 2 스케줄링 요청 전 Work를 동기로 처리해야 하는지 확인하기</h2>\n<anchor id=\"scheduleUpdateOnFiber()\" />\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L394\" target=\"_blank\" class=\"code_link_2\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre style=\"counter-reset: linenumber 0\" class=\"language-ts line-numbers\"><code class=\"language-ts\">‎\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">scheduleUpdateOnFiber</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// scheduleWork()</span>\n  <span class=\"token comment\">// const root = markUpdateTimeFromFiberToRoot(fiber, expirationTime);</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">===</span> Sync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// VDOM 첫 생성 판단</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">(</span>executionContext <span class=\"token operator\">&amp;</span> LegacyUnbatchedContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoContext <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span>executionContext <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>RenderContext <span class=\"token operator\">|</span> CommitContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoContext\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>executionContext <span class=\"token operator\">===</span> NoContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">flushSyncCallbackQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>5: <strong>Work</strong>를 동기적으로 호출해야 하는지 판단합니다. lagacy mode에서는 대게 expirationTime는 Sync입니다.</li>\n<li>8 ~ 9: 해당 조건은 VDOM이 처음 생성될 때 충족합니다. 이때는 <strong>Work</strong>를 바로 진행하여 VDOM을 빠르게 완성해줍니다. 동기로 재조정 작업을 수행해줄 함수가 바로 <code class=\"language-text\">performSyncWorkOnRoot()</code><up>12</up>입니다.</li>\n<li>13 ~ 16: <code class=\"language-text\">ensureRootIsScheduled()</code>를 통해 재조정 작업이 필요한 root에 <strong>Work</strong>을 스케줄링 요청하고 정보를 새깁니다. <strong>reconciler</strong>가 NoContext라면<up>14</up> <code class=\"language-text\">flushSyncCallbackQueue()</code>를 통해 sync queue에 담겨 있는 <strong>Work</strong>를 바로 실행시켜 줍니다. 여기서의 NoContext란, 리액트 관리 밖에서 발생한 업데이트를 뜻합니다. 예를 들어 사용자 클릭에서 발생한 업데이트라면 executionContext<up>14</up>에는 <a target=\"_blank\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L197-L198\">EventContext, DiscreteEventContext</a> 가 새겨져 있습니다. 이는 리액트가 구성한 SyntheticEvent에서 사용자 이벤트 처리 과정 중에 설정됩니다. 즉 이벤트에서 발생한 업데이트는 <code class=\"language-text\">flushSyncCallbackQueue()</code>가 호출되지 않기 때문에 배치 처리되고(아래 Sync Work 섹션에서 다시 다룹니다.), NoContext(setTimeout이나 Promise 등)일 때는 업데이트가 발생(<code class=\"language-text\">dispatchAction()</code>)할 때마다 <code class=\"language-text\">flushSyncCallbackQueue()</code>로 인해 <code class=\"language-text\">ensureRootIsScheduled()</code>에서 스케줄링된 <strong>Work</strong>가 진행됩니다. 즉 업데이트 마다 렌더링이 발생한다는 의미입니다.</li>\n<li>19: <strong>Work</strong> 스케줄링 요청을 합니다. expirationTime이 Sync가 아니므로 비동기 전용 <strong>Work</strong>가 스케줄링 될 것입니다.</li>\n</ul>\n<p>scheduleUpdateOnFiber()<up>scheduleWork()</up>는 스케줄 요청 전과 후에 <strong>reconciler</strong> 입장에서의 추가 작업들이 위치할 수 있는 함수입니다. 스케줄링과 관련된 직접적인 코드는 존재하지 않으며 이와 관련된 코드들은 함수 이름에서 느껴지듯이 ensure<strong>Root</strong>Is<strong>Shceduled</strong>()가 모두 가지고 있습니다.</p>\n<h1 id=\"3-ensurerootisscheduled\" style=\"position:relative;\"><a href=\"#3-ensurerootisscheduled\" aria-label=\"3 ensurerootisscheduled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. ensureRootIsScheduled</h1>\n<h2 id=\"3---1-scheduler에게-work를-전달하기-전-사전-준비하기\" style=\"position:relative;\"><a href=\"#3---1-scheduler%EC%97%90%EA%B2%8C-work%EB%A5%BC-%EC%A0%84%EB%8B%AC%ED%95%98%EA%B8%B0-%EC%A0%84-%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84%ED%95%98%EA%B8%B0\" aria-label=\"3   1 scheduler에게 work를 전달하기 전 사전 준비하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 - 1 scheduler에게 Work를 전달하기 전 사전 준비하기</h2>\n<p><strong>Work</strong>를 스케줄링하기 전 필요한 정보들이 몇 가지 있습니다. 새로 요청할 작업의 우선순위와 expirationTime, 교통 정리에 필요한 스케줄 정보입니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L552\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token keyword\">const</span> existingCallbackNode <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token comment\">// 스케줄링되어 있는 Task 객체</span>\n  <span class=\"token keyword\">const</span> expirationTime <span class=\"token operator\">=</span> <span class=\"token function\">getNextRootExpirationTimeToWorkOn</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">requestCurrentTimeForUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> priorityLevel <span class=\"token operator\">=</span> <span class=\"token function\">inferPriorityFromExpirationTime</span><span class=\"token punctuation\">(</span>\n    currentTime<span class=\"token punctuation\">,</span>\n    expirationTime\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>시간, 우선순위와 관련된 내용은 깊게 들어가지 않겠습니다.</p>\n</blockquote>\n<p><code class=\"language-text\">getNextRootExpirationTimeToWorkOn()</code>은 root가 가지고 있는 정보들을 기반으로(<down>만료된 작업이 남아있음을 나타내는 lastExpiredTime, suspense와 관련된 ***PendingTime…</down>) 현재 처리해야 할 expirationTime을 가지고 옵니다.</p>\n<p><code class=\"language-text\">currentTime</code>은 이전 포스트의 <a href=\"/react/in-depth-react-hooks_1/#currentTime\" target=\"_blank\">expirationTime 섹션</a>에서 확인했던 msToExpirationTime() 함수를 이용하여 구합니다.</p>\n<p>우선순위는 코드를 직접 보는 게 이해하기가 더 편합니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberExpirationTime.js#L131\" target=\"_blank\" class=\"code_link_2\">reconciler > ReactFiberExpirationTime.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre style=\"counter-reset: linenumber 0\" class=\"language-ts line-numbers\"><code class=\"language-ts\">‎\n<span class=\"token keyword\">const</span> <span class=\"token constant\">HIGH_PRIORITY_EXPIRATION</span> <span class=\"token operator\">=</span> __DEV__ <span class=\"token operator\">?</span> <span class=\"token number\">500</span> <span class=\"token operator\">:</span> <span class=\"token number\">150</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">HIGH_PRIORITY_BATCH_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">LOW_PRIORITY_EXPIRATION</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">LOW_PRIORITY_BATCH_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">250</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">inferPriorityFromExpirationTime</span><span class=\"token punctuation\">(</span>\n  currentTime<span class=\"token operator\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token operator\">:</span> ExpirationTime\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ReactPriorityLevel <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">===</span> Sync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> ImmediatePriority\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">===</span> Never <span class=\"token operator\">||</span> expirationTime <span class=\"token operator\">===</span> Idle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> IdlePriority\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> msUntil <span class=\"token operator\">=</span>\n    <span class=\"token function\">expirationTimeToMs</span><span class=\"token punctuation\">(</span>expirationTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">expirationTimeToMs</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msUntil <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> ImmediatePriority\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msUntil <span class=\"token operator\">&lt;=</span> <span class=\"token constant\">HIGH_PRIORITY_EXPIRATION</span> <span class=\"token operator\">+</span> <span class=\"token constant\">HIGH_PRIORITY_BATCH_SIZE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> UserBlockingPriority\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msUntil <span class=\"token operator\">&lt;=</span> <span class=\"token constant\">LOW_PRIORITY_EXPIRATION</span> <span class=\"token operator\">+</span> <span class=\"token constant\">LOW_PRIORITY_BATCH_SIZE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> NormalPriority\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> IdlePriority\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">msUntil</code>은 expirationTime에서 ms를 구한 시간으로 expirationTime은 큰 수가 더 이전 시점을 나타내는 데 반해 ms는 우리가 통상 생각하는 시간으로 큰 수가 이후 시점을 나타냅니다.</p>\n<p>expirationTime이 currentTime을 넘기게 되면<up>21</up> 해당 작업은 이미 만료되었기 때문에 빠르게 처리해줘야 하므로 <code class=\"language-text\">ImmediatePriority</code>을 반환해주고 나머지 우선순위는 expirationTime이 얼마나 더 여유 있는지<up>25, 28</up>에 따라 우선순위를 반환합니다.</p>\n<blockquote>\n<p>다시 말씀드리지만 expirationTime, 우선순위는 주로 concurrent mode에서 사용됩니다.</p>\n</blockquote>\n<h2 id=\"3---2-교통정리-하기\" style=\"position:relative;\"><a href=\"#3---2-%EA%B5%90%ED%86%B5%EC%A0%95%EB%A6%AC-%ED%95%98%EA%B8%B0\" aria-label=\"3   2 교통정리 하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 - 2 교통정리 하기</h2>\n<p>스케줄링에 필요한 정보를 모두 구했으니 root에 <strong>Work</strong>가 예약되어 있는지 확인합니다. 예약되어 있다면 우선순위를 따져 기존 <strong>Work</strong>를 취소할지 결정해야 합니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L586\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">/* const priorityLevel = ...; */</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingCallbackNode <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> existingCallbackPriority <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>callbackPriority\n    <span class=\"token keyword\">const</span> existingCallbackExpirationTime <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>callbackExpirationTime\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      existingCallbackExpirationTime <span class=\"token operator\">===</span> expirationTime <span class=\"token operator\">&amp;&amp;</span>\n      existingCallbackPriority <span class=\"token operator\">>=</span> priorityLevel\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Existing callback is sufficient.</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">cancelCallback</span><span class=\"token punctuation\">(</span>existingCallbackNode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// scheduler에게 취소 요청</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"3---3-root에-스케줄링-정보-새기기\" style=\"position:relative;\"><a href=\"#3---3-root%EC%97%90-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81-%EC%A0%95%EB%B3%B4-%EC%83%88%EA%B8%B0%EA%B8%B0\" aria-label=\"3   3 root에 스케줄링 정보 새기기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 - 3 root에 스케줄링 정보 새기기</h2>\n<p><strong>Work</strong>의 스케줄을 요청하고 root에 정보를 새깁니다. 여기서도 <a href=\"#scheduleUpdateOnFiber()\">scheduleUpdateOnFiber()</a>와 마찬가지로 Sync 여부를 따지는데 scheduleUpdateOnFiber()는 <strong><u>Work를 동기 호출</u></strong>하기 위한 판단이었다면 ensureRootIsScheduled()는 <strong><u>Work의 진행</u></strong>을 동기적으로 처리해야 하는지에 대한 판단입니다.</p>\n<anchor id=\"ensureRootIsScheduled\">\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L608\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">ensureRootIsScheduled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">/* if (existingCallbackNode !== null) { ... } */</span>\n\n  root<span class=\"token punctuation\">.</span>callbackExpirationTime <span class=\"token operator\">=</span> expirationTime\n  root<span class=\"token punctuation\">.</span>callbackPriority <span class=\"token operator\">=</span> priorityLevel\n\n  <span class=\"token keyword\">let</span> callbackNode\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expirationTime <span class=\"token operator\">===</span> Sync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Sync React callbacks are scheduled on a special internal queue</span>\n    callbackNode <span class=\"token operator\">=</span> <span class=\"token function\">scheduleSyncCallback</span><span class=\"token punctuation\">(</span><span class=\"token function\">performSyncWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    callbackNode <span class=\"token operator\">=</span> <span class=\"token function\">scheduleCallback</span><span class=\"token punctuation\">(</span>\n      priorityLevel<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">performConcurrentWorkOnRoot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// Compute a task timeout based on the expiration time. This also affects</span>\n      <span class=\"token comment\">// ordering because tasks are processed in timeout order.</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">timeout</span><span class=\"token operator\">:</span> <span class=\"token function\">expirationTimeToMs</span><span class=\"token punctuation\">(</span>expirationTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  root<span class=\"token punctuation\">.</span>callbackNode <span class=\"token operator\">=</span> callbackNode <span class=\"token comment\">// Task를 root에 저장한다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">performSyncWorkOnRoot()</code>와 <code class=\"language-text\">performConcurrentWorkOnRoot()</code>가 동기, 비동기로 <strong>Work</strong>를 진행하는 함수입니다.\n이 함수들은 <strong>scheduler</strong>가 스케줄링 후 반환하는 <strong>Task</strong><up>callbackNode</up>를 반환합니다.</p>\n<p>아직까지도 <strong>scheduler</strong>와 직접적으로 연관된 코드들이 등장하지 않았습니다. ReactFiberWorkLoop.js에서 <strong>scheduler</strong>의 모듈을 import 하여 사용할 수도 있지만 리액트는 <strong>reconciler</strong>와 <strong>scheduler</strong> 사이의 의존도를 낮추기 위해 SchedulerWithReactIntegration.js라는 모듈을 따로 두었습니다. 이 모듈에 속한 함수가 <code class=\"language-text\">scheduleSyncCallback()</code>와 <code class=\"language-text\">scheduleCallback()</code>입니다.</p>\n<h1 id=\"4-schedulesynccallback-schedulecallback\" style=\"position:relative;\"><a href=\"#4-schedulesynccallback-schedulecallback\" aria-label=\"4 schedulesynccallback schedulecallback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. scheduleSyncCallback, scheduleCallback</h1>\n<h2 id=\"4---1-async-work\" style=\"position:relative;\"><a href=\"#4---1-async-work\" aria-label=\"4   1 async work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4 - 1 Async Work</h2>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/SchedulerWithReactIntegration.js#L128\" target=\"_blank\" class=\"code_link\">reconciler > SchedulerWithReactIntegration.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">‎\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Scheduler <span class=\"token keyword\">from</span> <span class=\"token string\">'scheduler'</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> unstable_scheduleCallback<span class=\"token operator\">:</span> Scheduler_scheduleCallback <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> Scheduler\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">scheduleCallback</span><span class=\"token punctuation\">(</span>\n  reactPriorityLevel<span class=\"token operator\">:</span> ReactPriorityLevel<span class=\"token punctuation\">,</span>\n  callback<span class=\"token operator\">:</span> SchedulerCallback<span class=\"token punctuation\">,</span>\n  options<span class=\"token operator\">:</span> SchedulerCallbackOptions <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> priorityLevel <span class=\"token operator\">=</span> <span class=\"token function\">reactPriorityToSchedulerPriority</span><span class=\"token punctuation\">(</span>reactPriorityLevel<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">Scheduler_scheduleCallback</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>reconciler</strong>와 <strong>scheduler</strong>의 우선순위 내부 값이 다르기 때문에(<down>ImmediatePriority는 각각 99, 1</down>) <strong>scheduler</strong>에게 넘기기 전에 변환해야 합니다.</p>\n<p>이 우선순위와 callback<up>performConcurrentWorkOnRoot()</up>, options를 넘겨주며 <strong>scheduler</strong>에게 스케줄링을 요청합니다. 이제 이 callback은 <strong>scheduler</strong>가 알아서 실행시킬 겁니다. <strong>reconciler</strong>는 더는 여기에 대해 신경 쓰지 않습니다.</p>\n<blockquote>\n<p>options에는 <strong>Task</strong>의 만료 시간을 나타내는 timeout과 시작 시간을 미룰수 있는 delay가 있습니다.</p>\n</blockquote>\n<h2 id=\"4---2-sync-work\" style=\"position:relative;\"><a href=\"#4---2-sync-work\" aria-label=\"4   2 sync work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4 - 2 Sync Work</h2>\n<p>async <strong>Work</strong>와는 다르게 sync <strong>Work</strong>의 처리는 조금 다릅니다.<br>\n<strong>Work</strong>을 동기적으로 호출해야 한다면 <strong>scheduler</strong>의 힘을 빌릴 필요 없이 <strong>reconciler</strong>가 내부적으로 처리하면 됩니다. <strong>Work</strong>가 곧 <strong>reconciler</strong>가 행하는 행위이기 때문입니다.</p>\n<p>그래서 sync 작업들은 내부 queue에 따로 저장해 놓습니다. 그리고 실행하기 적당한 때를 <strong><u>reconciler가 판단</u></strong>해서 queue에 있는 작업을 실행합니다. 이 행위를 하는 함수가 flushSyncCallbackQueue()이며 <a href=\"#scheduleUpdateOnFiber()\">scheduleWork()</a>에서 사용되었습니다.</p>\n<p>다음의 코드를 주석으로 너무 잘 설명하고 있어서 한번 읽어 보시길 바랍니다.</p>\n<anchor id=\"scheduleSyncCallback\" />\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/SchedulerWithReactIntegration.js#L137\" target=\"_blank\" class=\"code_link\">reconciler > SchedulerWithReactIntegration.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">scheduleSyncCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">callback</span><span class=\"token operator\">:</span> SchedulerCallback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Push this callback into an internal queue. We'll flush these either in</span>\n  <span class=\"token comment\">// the next tick, or earlier if something calls `flushSyncCallbackQueue`.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>syncQueue <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    syncQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>callback<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// Flush the queue in the next tick, at the earliest.</span>\n    immediateQueueCallbackNode <span class=\"token operator\">=</span> <span class=\"token function\">Scheduler_scheduleCallback</span><span class=\"token punctuation\">(</span>\n      Scheduler_ImmediatePriority<span class=\"token punctuation\">,</span>\n      flushSyncCallbackQueueImpl\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Push onto existing queue. Don't need to schedule a callback because</span>\n    <span class=\"token comment\">// we already scheduled one when we created the queue.</span>\n    syncQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> fakeCallbackNode <span class=\"token comment\">// Task는 없으니 가짜를 반환</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>async <strong>Work</strong>와는 다르게 callback을 shceulder에게 넘기지 않고 내부 큐에 넣습니다. 그리고 대신 이 큐를 소비하는 <code class=\"language-text\">flushSyncCallbackQueueImpl()</code>를 스케줄링하여 다음 틱에 실행되도록 합니다. 만약 <code class=\"language-text\">scheduleWork()</code>에서 executionContext가 NoContext가 아니라서 syncQueue를 비우지 않았다면 다음 틱에 이벤트(예. 클릭 이벤트)에서 동시에 발생한 업데이트는 배치 처리됩니다. 해당 이벤트의 업데이트는 같은 우선순위를 가지므로 하나의 <strong>Work</strong>만 스케줄링될 것이고 업데이트는 Linked List로 이미 연결되어 있기 때문에 한번의 렌더링(<strong>Work</strong>)으로 처리됩니다.</p>\n<p><code class=\"language-text\">scheduleWork()</code>에서 사용한 <code class=\"language-text\">flushSyncCallbackQueue()</code> 또한 내부적으로 <code class=\"language-text\">flushSyncCallbackQueueImpl()</code>를 사용하고 있습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/SchedulerWithReactIntegration.js#L161\" target=\"_blank\" class=\"code_link_2\">reconciler > SchedulerWithReactIntegration.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">flushSyncCallbackQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>immediateQueueCallbackNode <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> immediateQueueCallbackNode\n    immediateQueueCallbackNode <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">Scheduler_cancelCallback</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">flushSyncCallbackQueueImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>만약 리액트가 놀고 있어서 <code class=\"language-text\">scheduleWork()</code>에서 <code class=\"language-text\">flushSyncCallbackQueue()</code>를 호출했다면 반드시 스케줄링된 <code class=\"language-text\">flushSyncCallbackQueueImpl()</code>를 취소시켜 준 다음에 실행해야 합니다.</p>\n<p>마지막으로 sync queue를 소비하는 함수인 <code class=\"language-text\">flushSyncCallbackQueueImpl()</code>만 확인하면 우리는 <strong>reconciler</strong>가 하는 일을 모두 확인하게 되는 것입니다.</p>\n<h1 id=\"11-flushsynccallbackqueueimpl\" style=\"position:relative;\"><a href=\"#11-flushsynccallbackqueueimpl\" aria-label=\"11 flushsynccallbackqueueimpl permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>11. flushSyncCallbackQueueImpl</h1>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/SchedulerWithReactIntegration.js#L170\" target=\"_blank\" class=\"code_link_6\">reconciler > SchedulerWithReactIntegration.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">flushSyncCallbackQueueImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isFlushingSyncQueue <span class=\"token operator\">&amp;&amp;</span> syncQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 중복 실행 방지 플래그</span>\n    isFlushingSyncQueue <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> isSync <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> syncQueue\n      <span class=\"token function\">runWithPriority</span><span class=\"token punctuation\">(</span>ImmediatePriority<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> queue<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">let</span> callback <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n          <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            callback <span class=\"token operator\">=</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>isSync<span class=\"token punctuation\">)</span> <span class=\"token comment\">// performSyncWorkOnRoot()</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      syncQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 에러가 발생한 callback만 버린다.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>syncQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        syncQueue <span class=\"token operator\">=</span> syncQueue<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// Resume flushing in the next tick</span>\n      <span class=\"token function\">Scheduler_scheduleCallback</span><span class=\"token punctuation\">(</span>\n        Scheduler_ImmediatePriority<span class=\"token punctuation\">,</span>\n        flushSyncCallbackQueue\n      <span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">throw</span> error\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n      isFlushingSyncQueue <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>로직은 특별한 게 없으므로 생소한 <code class=\"language-text\">runWithPriority()</code>만 짚고 넘어가겠습니다.</p>\n<p><code class=\"language-text\">runWithPriority()</code>는 <strong>scheduler</strong>에게 콜백 함수의 우선순위를 알려주고 실행을 요청하는 함수입니다. 해당 우선순위는 shceduler의 컨텍스트 변수인 currentPriorityLevel에 저장됩니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L217\" target=\"_blank\" class=\"code_link\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_runWithPriority</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> eventHandler</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">ImmediatePriority</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">UserBlockingPriority</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">NormalPriority</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">LowPriority</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">IdlePriority</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      priorityLevel <span class=\"token operator\">=</span> NormalPriority\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> previousPriorityLevel <span class=\"token operator\">=</span> currentPriorityLevel\n  currentPriorityLevel <span class=\"token operator\">=</span> priorityLevel\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">eventHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    currentPriorityLevel <span class=\"token operator\">=</span> previousPriorityLevel\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 함으로써 <strong>Work</strong>와 관련된 작업의 실행과 우선순위를 모두 <strong>scheduler</strong>가 관리하게 되면서 <strong>reconciler</strong>와 <strong>scheduler</strong> 사이에 서로 혼재될 수 있는 부분을 확실히 나누게 되었습니다.</p>\n<p>이제 <strong>reconciler</strong>는 현재 진행되는 <strong>Work</strong>와 관련된 추가 작업이 필요할 때 <strong>scheduler</strong>의 컨텍스트 우선순위만 참고하면 됩니다. <strong>Work</strong>는 스케줄링된 순서대로 실행되는 것이 아니고 언제든지 중지되고 재실행 될 수 있기 때문에 재조정 작업만 할 줄 아는 <strong>reconciler</strong>는 더욱이 이 작업들의 우선순위를 가지고 있을 수 없습니다.</p>\n<p>다음 포스트에서는 이렇게 넘겨준 <strong>Work</strong>를 <strong>scheduler</strong>가 받아 본격적으로 스케줄링하는 동작을 확인하게 됩니다.</p>","frontmatter":{"title":"React 톺아보기 - 04. Scheduler_1","date":"2020-10-11","keywords":["리액트","react","fiber","hook","hooks","useState","useEffect","useLayoutEffect","useCallback","scheduler"]}}},"pageContext":{"slug":"/react/in-depth-react-scheduler_1/","previous":{"fields":{"slug":"/react/in-depth-react-hooks_2/"},"frontmatter":{"title":"React 톺아보기 - 03. Hooks_2","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-scheduler_2/"},"frontmatter":{"title":"React 톺아보기 - 04. Scheduler_2","category":"react"}}}},"staticQueryHashes":["2277278352","536400264"]}