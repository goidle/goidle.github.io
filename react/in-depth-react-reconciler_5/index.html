<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, minimum-scale=1, maximum-scale=2"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:Catamaran;font-weight:800;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:56px;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:20px;color:inherit;font-family:Catamaran;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:6px;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:2px;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#0687f0;text-decoration:none;box-shadow:none;}a:hover,a:active{text-decoration:underline;}a.gatsby-resp-image-link{box-shadow:none;text-decoration:none;}a:hover{text-decoration:none;}</style><style data-href="/styles.3e9ce66bb898a528e05f.css">@import url(https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css);@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:100;src:local("Noto Sans KR Thin "),local("Noto Sans KR-Thin"),url(/static/noto-sans-kr-latin-100-2de137ca3e12ea146ee47485a97f1e78.woff2) format("woff2"),url(/static/noto-sans-kr-latin-100-b965647685dd9fc531d1f8a1cc25e024.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:300;src:local("Noto Sans KR Light "),local("Noto Sans KR-Light"),url(/static/noto-sans-kr-latin-300-4f773a0fce88aa857d70b56c5b0a1d26.woff2) format("woff2"),url(/static/noto-sans-kr-latin-300-ee87751dac814562bac316d848e35748.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:400;src:local("Noto Sans KR Regular "),local("Noto Sans KR-Regular"),url(/static/noto-sans-kr-latin-400-be09f2ced7ff9fa6eda5f0416e2fc840.woff2) format("woff2"),url(/static/noto-sans-kr-latin-400-4c50be0fe5b21a153b8e40a392c2d3fe.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:500;src:local("Noto Sans KR Medium "),local("Noto Sans KR-Medium"),url(/static/noto-sans-kr-latin-500-416698c2fc4b3951f8d63d3d2ae23900.woff2) format("woff2"),url(/static/noto-sans-kr-latin-500-28601458e118110e494903a1fcd6dcf5.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:700;src:local("Noto Sans KR Bold "),local("Noto Sans KR-Bold"),url(/static/noto-sans-kr-latin-700-04e782e08729f3725ae5a9c95da0c8ba.woff2) format("woff2"),url(/static/noto-sans-kr-latin-700-b9e989a96027f839a9569d2d011e0b71.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:900;src:local("Noto Sans KR Black "),local("Noto Sans KR-Black"),url(/static/noto-sans-kr-latin-900-c41f1395489a117ca36d550142a1695f.woff2) format("woff2"),url(/static/noto-sans-kr-latin-900-589f5fbf84d9dc9984a969bae969fd60.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:100;src:local("Catamaran Thin "),local("Catamaran-Thin"),url(/static/catamaran-latin-100-3570195a7b5f619dd9b2419d8fa3f089.woff2) format("woff2"),url(/static/catamaran-latin-100-e82908f57f6d2f23eb9876b2d6868195.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:200;src:local("Catamaran Extra Light "),local("Catamaran-Extra Light"),url(/static/catamaran-latin-200-987ea210308405ac77ba2f36430a70c9.woff2) format("woff2"),url(/static/catamaran-latin-200-bb5993d2f001b739bb9ab7c3ed9725c3.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:300;src:local("Catamaran Light "),local("Catamaran-Light"),url(/static/catamaran-latin-300-2b8a4bd13e9d5ba755f010f8732b0bb6.woff2) format("woff2"),url(/static/catamaran-latin-300-c2696c65c33dcf37871b72bad51ee1ce.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:400;src:local("Catamaran Regular "),local("Catamaran-Regular"),url(/static/catamaran-latin-400-640947b787a38ec35d097129637d9130.woff2) format("woff2"),url(/static/catamaran-latin-400-97e5bc807a3e915e3fbf40ce5fcb1128.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:500;src:local("Catamaran Medium "),local("Catamaran-Medium"),url(/static/catamaran-latin-500-884483dd213f37ae3b5c98f73dd190a5.woff2) format("woff2"),url(/static/catamaran-latin-500-412cf386e31213e3601cb2132b9c4c2d.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:600;src:local("Catamaran SemiBold "),local("Catamaran-SemiBold"),url(/static/catamaran-latin-600-eb6ebda25331e50d3f42c45a41f613bb.woff2) format("woff2"),url(/static/catamaran-latin-600-215c58c6114e0556cb1c332c0fda463a.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:700;src:local("Catamaran Bold "),local("Catamaran-Bold"),url(/static/catamaran-latin-700-3196f49881b324fa5a5f937875cc380f.woff2) format("woff2"),url(/static/catamaran-latin-700-05f6e51c518dd3b521b258e5c05d0e72.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:800;src:local("Catamaran ExtraBold "),local("Catamaran-ExtraBold"),url(/static/catamaran-latin-800-601b1d0f1b78fd65c3205b2c004bbe60.woff2) format("woff2"),url(/static/catamaran-latin-800-3b1675e4ede7e86ec79fa84c1203908e.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:900;src:local("Catamaran Black "),local("Catamaran-Black"),url(/static/catamaran-latin-900-6bb5f96614acb7754020b922e1a63d24.woff2) format("woff2"),url(/static/catamaran-latin-900-79292dba48851cc3a212863c860d8f09.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.custom-hr{margin:64px 0;background:linear-gradient(72deg,#291e95,#cc007a);border:none;height:2px}.home-header{margin-top:0;border-bottom:none;font-weight:900;font-size:48px;letter-spacing:-2px}.link{box-shadow:none;text-decoration:none;color:inherit}.switch-container{text-align:right}.switch-container .icon{text-align:center;color:#222;font-size:14px;font-weight:900}.footer{padding-top:52px;text-align:center;font-size:12px}.footer a{text-decoration:none!important}.home{position:absolute;margin-top:-1.5px}body.light{background-color:#fff;color:#615f5f}body.light .home-header{color:#5a5a5a}body.light .bio .author-name-content{background-color:#ecf0f2}body.light .bio .author-introduction{color:#7d7d7d}body.light .bio a{color:navy}body.light .bio .bio_fontaswesome{fill:navy;vertical-align:-.125em}body.light .category-container{border-color:#ecf0f2;border-style:solid;border-width:1px 6px;background-color:#f4f7f8}body.light .category-container .item{border:1px solid #ecf0f2;background-color:#fff;box-shadow:0 1px 1px rgba(0,0,0,.1)}body.light .category-container .item a{color:#666}body.light .category-container .item[aria-selected=true]{border:2px solid #909da1;font-weight:bolder}body.light .category-container .item[aria-selected=true] a{color:#636c6e}body.light .category-container .item .badge{background-color:#f5222d;color:#fff}body.light .thumbnail{background-color:#fff;box-shadow:0 0 12px rgba(122,124,136,.212)}body.light .thumbnail h3{color:#5173b3}body.light .thumbnail p{color:#7d7d7d}body.light .thumbnail:hover{text-shadow:.1px .1px .1px rgba(68,67,67,.925);box-shadow:1px 3px 15px rgba(122,124,136,.432)}body.light .footer,body.light .thumbnail .thumbnail-subinfo{color:#615f5f}body.light .footer a{color:#5a5a5a}body.light .navigator a{background-color:#fceff7;color:#cc007a}body.light :not(pre)>code[class*=language-]{color:#fff;border:1.2px solid hsla(0,0%,100%,.64);background:#7d7d7d}body.dark{background-color:#282c35;color:#dbd8d8}body.dark .home-header{color:#eee}body.dark .bio .author-name-content{background-color:#383636}body.dark .bio .author-introduction{color:#dbd8d8}body.dark .bio a{color:#bb72ec}body.dark .bio .bio_fontaswesome{fill:#bb72ec;vertical-align:-.125em}body.dark .category-container{border-color:#383636;border-style:solid;border-width:1px 6px;background-color:#24272c}body.dark .category-container .item{border:1px solid #383636;background-color:#282c35;box-shadow:0 1px 1px hsla(0,0%,100%,.1)}body.dark .category-container .item a{color:#d8d7d7}body.dark .category-container .item[aria-selected=true]{border:2px solid #666;font-weight:bolder}body.dark .category-container .item[aria-selected=true] a{color:#fff}body.dark .category-container .item .badge{background-color:#d695ab;color:#eee}body.dark .thumbnail{background-color:#282c35;box-shadow:0 0 12px rgba(197,166,201,.2)}body.dark .thumbnail h3{color:#d695ab}body.dark .thumbnail p{color:#dbd8d8}body.dark .thumbnail:hover{box-shadow:1px 1px 13px rgba(195,153,201,.26);text-shadow:.1px .1px .1px #fff}body.dark .footer,body.dark .thumbnail .thumbnail-subinfo{color:#dbd8d8}body.dark .footer a{color:#fff}body.dark blockquote{border-left:4px solid hsla(0,0%,100%,.822)}body.dark h1,body.dark h2{border-bottom-color:hsla(0,0%,100%,.3)}body.dark .navigator a{background-color:#fceff7;color:#cc007a}body.dark td,body.dark th{border-bottom:1px solid hsla(0,0%,100%,.15)}body.dark :not(pre)>code[class*=language-]{color:#c85656;border:1.2px solid rgba(0,0,0,.64);background:#e1e1e1}body.dark hr{background:hsla(0,0%,100%,.3)}body{font-family:Noto Sans KR,sans-serif;background-color:#fff;-webkit-text-size-adjust:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-transition:background-color .3s,color .3s;transition:background-color .3s,color .3s}h1{margin-top:2em;font-size:2.15em}h1,h2{letter-spacing:-1px;border-bottom:transparent!important}h2{margin-top:1.5em;margin-bottom:0;font-size:1.5em}h3{font-weight:700;margin-bottom:.1rem;margin-top:0;letter-spacing:-1px}@media (max-width:500px){.home-header{font-size:40px}}.post-date{text-align:right;font-size:12px;font-style:italic}.bio{margin-bottom:15px}.bio .author-description{display:flex}.bio .author-image{margin-top:0;margin-right:12px;margin-bottom:0;min-width:95px}.bio .author-name{display:flex;flex-direction:column;justify-content:center}.bio .author-name-prefix{font-size:90%;margin-right:4px}.bio .author-name-content{display:inline-block;font-size:95%;padding:2px 6px;font-weight:bolder;border-radius:8px;-webkit-transform-origin:center;transform-origin:center;cursor:default}.bio .author-introduction{margin-top:4px;font-size:80%;line-height:1.4}.bio .author-socials{margin-top:4px}.bio a{margin-right:8px;font-size:80%;cursor:pointer}.bio a.visited{text-decoration:none}@-webkit-keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}@keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}.navigator{margin:40px 0;list-style:none;padding:0;overflow:hidden}.navigator li{margin-bottom:12px}.navigator a{padding:7px 16px 8px;border-radius:6px;font-size:12px;opacity:.8}ul.navigator li.right_navi{float:right}ul.navigator li.left_navi{float:left}.post h1{font-size:2.5rem;line-height:1.1}.post h2{margin-top:3.5rem;font-size:1.73286rem}.post h2,.post p{margin-bottom:1.75rem}.post li{margin-bottom:.875rem}.post .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1.2em;margin-left:-1.2em;padding-right:1em;padding-left:.75em;border-left:.35em solid #0687f0}.post blockquote{color:#999}.post code[class*=language-],.post pre[class*=language-]{color:#e0e0e0;background:none;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none}.post pre[class*=language-]::-webkit-scrollbar{display:none}.post pre[class*=language-]{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:.6em}.post :not(pre)>code[class*=language-],.post pre[class*=language-]{background:#212121}.post :not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.5em;white-space:normal;color:#d66587;margin:0 .1em}.post .token.block-comment,.post .token.cdata,.post .token.comment,.post .token.doctype,.post .token.prolog{color:#616161}.post .token.punctuation{color:#e0e0e0}.post .token.attr-name,.post .token.deleted,.post .token.namespace,.post .token.tag{color:#e2777a}.post .token.function-name{color:#6196cc}.post .token.boolean,.post .token.function,.post .token.number{color:#ff9100}.post .token.class-name,.post .token.constant,.post .token.property,.post .token.symbol{color:#ff0}.post .token.atrule,.post .token.builtin,.post .token.important,.post .token.keyword,.post .token.selector{color:#b388ff}.post .token.attr-value,.post .token.char,.post .token.regex,.post .token.string,.post .token.variable{color:#00e676}.post .token.entity,.post .token.operator,.post .token.url{color:#67cdcc}.post .token.bold,.post .token.important{font-weight:700}.post .token.italic{font-style:italic}.post .token.entity{cursor:help}.post .token.inserted{color:green}.dark .anchor{fill:#dbd8d8}.light .anchor{fill:#615f5f}td[align=center]:first-child,th[align=center]:first-child{text-align:center!important;font-weight:bolder!important}table{margin-top:100px}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none;margin:1.2em}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.tldr{padding-left:1em;margin-top:-26px}h3{margin-bottom:.5em}h3 code.language-text{font-size:16px!important}up{top:-.5em;font-size:75%}down,up{position:relative;line-height:0;vertical-align:baseline;font-weight:500}down{font-size:85%}figcaption{padding:3px;text-align:center}center,figcaption{font:italic smaller sans-serif;font-weight:700;font-size:14px}center{top:-.7em;position:relative}ol li,ol li p{margin-bottom:.3rem!important}.gatsby-resp-image-wrapper{margin-bottom:20px}p{position:relative}a.code_link{position:absolute;font-size:small;bottom:-2rem;left:1rem}a.code_link_2{bottom:-2rem}a.code_link_2,a.code_link_3{position:absolute;font-size:small;left:3.1rem;z-index:999}a.code_link_3{bottom:-2.5rem}a.code_link_4{position:absolute;font-size:small;bottom:-3rem;left:1rem}h4{font-weight:700}a.code_link_5{position:absolute;font-size:small;bottom:-3rem;left:3.1rem;z-index:999}strong{font-weight:700}a.code_link_6{position:absolute;font-size:small;bottom:-2.5rem;z-index:999;left:1rem}.item{position:relative}.item .badge{display:inline-block;position:absolute;top:1px;right:3px;-webkit-transform:translate(50%,-50%);transform:translate(50%,-50%);border-radius:10px;box-shadow:0 0 0 1px;padding:8px 7px;z-index:999;font-weight:700}.category-container{position:sticky;position:-webkit-sticky;top:0;line-height:0;white-space:nowrap;overflow-x:scroll;-ms-overflow-style:none;overflow:-moz-scrollbars-none;z-index:1;padding:6px 20px;margin:0 -5px!important}.category-container .item{display:inline-block;margin:.25rem 7px .25rem 0;border-radius:15px;white-space:normal;box-sizing:border-box;cursor:pointer}.category-container .item div{display:block;padding:14px 16px 16px;font-size:13px;box-sizing:border-box}.category-container .item:last-child{margin-right:0}.category-container::-webkit-scrollbar{display:none}.thumbnail-container{min-height:calc(100vh - 3.5rem)}.thumbnail{display:block;margin-top:12px;padding:15px 15px 12px;-webkit-transition:box-shadow .3s,text-shadow .3s,opacity .4s;transition:box-shadow .3s,text-shadow .3s,opacity .4s;opacity:0;border-radius:10px}.thumbnail p{font-size:90%;line-height:1.4}.thumbnail .thumbnail-subinfo{font-size:.75rem;margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid #e8e8e8}.thumbnail.visible{opacity:1}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ffffff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><meta name="generator" content="Gatsby 2.18.10"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">React 톺아보기 - 05. Reconciler_5 | Deep Dive Magic Code</title><meta data-react-helmet="true" name="description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM 재조정 작업을 진행한다. Work…"/><meta data-react-helmet="true" property="og:title" content="React 톺아보기 - 05. Reconciler_5 | Deep Dive Magic Code"/><meta data-react-helmet="true" property="og:description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM 재조정 작업을 진행한다. Work…"/><meta data-react-helmet="true" property="og:image" content="/static/felog-f24356c48475809626ea0c2ac67855c6.png"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="google-site-verification" content="o402P1kCwteUVT_5s9zR21dD9lTF4ALZNLms22CIMx4"/><meta data-react-helmet="true" name="keywords" content="react, redux, javascript, web, development, frontend, 리액트, react, fiber, VDOM, reconciler"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/app-a9221c1c374395f2ded5.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js"/><link as="script" rel="preload" href="/styles-f42f8789f3cee93e7f05.js"/><link as="script" rel="preload" href="/commons-84551787138db1029baf.js"/><link as="script" rel="preload" href="/webpack-runtime-9f6b1d2a45518b92e568.js"/><link as="fetch" rel="preload" href="/page-data/react/in-depth-react-reconciler_5/page-data.json" crossorigin="anonymous"/></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:52rem;padding:2.4375rem 1.21875rem" class="post"><a class="link" href="/"><svg class="home" width="1.125em" font-size="2em" overflow="visible" viewBox="0 0 576 512"><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg></a><div class="switch-container"><label for="normal-switch"><div style="position:relative;display:inline-block;text-align:left;opacity:1;direction:ltr;border-radius:12px;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s;touch-action:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none"><div class="react-switch-bg" style="height:24px;width:48px;margin:0;position:relative;background:#d9dfe2;border-radius:12px;cursor:pointer;-webkit-transition:background 0.25s;-moz-transition:background 0.25s;transition:background 0.25s"><div style="height:24px;width:26px;position:relative;opacity:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon checkedIcon">D</div></div><div style="height:24px;width:26px;position:absolute;opacity:1;right:0;top:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon uncheckedIcon">L</div></div></div><div class="react-switch-handle" style="height:22px;width:22px;background:#ffffff;display:inline-block;cursor:pointer;border-radius:50%;position:absolute;transform:translateX(1px);top:1px;outline:0;border:0;-webkit-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;-moz-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s"></div><input type="checkbox" role="switch" style="border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px" id="normal-switch"/></div></label></div><h1>React 톺아보기 - 05. Reconciler_5</h1><p class="post-date">5 days ago</p><div><blockquote>
<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>
</blockquote>
<h3 id="포스트별-주제"><a href="#%ED%8F%AC%EC%8A%A4%ED%8A%B8%EB%B3%84-%EC%A3%BC%EC%A0%9C" aria-label="포스트별 주제 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>포스트별 주제</h3>
<ol>
<li>훅을 통해 컴포넌트 상태를 업데이트한다.</li>
<li>업데이트를 반영할 <strong>Work</strong>를 <strong>scheduler</strong>에게 전달하고 <strong>scheduler</strong>는 스케줄링된 <strong>Task</strong>를 적절한 시기에 실행한다.</li>
<li><strong>Work</strong>을 통해 VDOM 재조정 작업을 진행한다.</li>
<li>
<h3 id="uwork를-진행하며-발생한-변경점을-적용한다u"><a href="#uwork%EB%A5%BC-%EC%A7%84%ED%96%89%ED%95%98%EB%A9%B0-%EB%B0%9C%EC%83%9D%ED%95%9C-%EB%B3%80%EA%B2%BD%EC%A0%90%EC%9D%84-%EC%A0%81%EC%9A%A9%ED%95%9C%EB%8B%A4u" aria-label="uwork를 진행하며 발생한 변경점을 적용한다u permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><u><strong>Work</strong>를 진행하며 발생한 변경점을 적용한다.</u></h3>
</li>
<li>사용자의 상호작용으로 이벤트가 발생하고 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>
</ol>
<hr>
<h1 id="7-commit-phase"><a href="#7-commit-phase" aria-label="7 commit phase permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7. Commit phase</h1>
<p><a class="code_link_3" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L977" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Render phase.. */</span>
    <span class="token comment">// executionContext = prevExecutionContext</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'Cannot commit an incomplete root. This error is likely caused by a '</span> <span class="token operator">+</span>
          <span class="token string">'bug in React. Please file an issue.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate
      root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> expirationTime
      <span class="token function">finishSyncRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> workInProgressRootExitStatus<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token comment">// 잔여 작업이 없으므로 null을 리턴.</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">finishSyncRender</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Commit phase에 진입하기에 앞서 Render phase가 잘 마무리 되었는지 확인해야 됩니다.<br>
<code class="language-text">performSyncWorkOnRoot()</code>는 Render phase를 동기적으로 처리하므로 정상적으로 끝났다면 <code class="language-text">workInProgress</code>는 null<up>8</up>이어야 합니다.  </p>
<h2 id="7---1-finishsyncrender"><a href="#7---1-finishsyncrender" aria-label="7   1 finishsyncrender permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7 - 1 finishSyncRender()</h2>
<p>Render phase와는 다르게 Commit phase에서는 sub-phase가 추가적으로 존재합니다.<br>
각 sub-phase는 Effect를 소비한다는 큰 맥락은 같지만 소비 시점의 차이가 있습니다.<br>
크게 Effect의 성격에 따라 나뉘어 지며 DOM에 변형을 가하는 시점과 그 전, 후로 나뉘어 집니다.</p>
<p>전</p>
<ul>
<li>클래스 컴포넌트: getSnapshotBeforeUpdate</li>
<li>함수형 컴포넌트: clean-up-useEffect, useEffect</li>
<li>호스트 컴포넌트: X</li>
</ul>
<p>변형</p>
<ul>
<li>클래스 컴포넌트: componentWillUnmount</li>
<li>함수형 컴포넌트: clean-up-useLayoutEffect, clean-up-useEffect</li>
<li>호스트 컴포넌트: element 삽입, 수정, 삭제</li>
</ul>
<p>후</p>
<ul>
<li>클래스 컴포넌트: componentDidMount, componentDidUpdate</li>
<li>함수형 컴포넌트: useLayoutEffect</li>
<li>호스트 컴포넌트: auto-focus</li>
</ul>
<p>위 작업은 useEffect()를 제외하고는 모두 동기적으로 처리됩니다. 이 내용은 중요한 부분으로 <strong><u>DOM 변경과 화면 렌더링 사이 또는 렌더링 이후 개발자가 개입</u></strong>할 수 있도록 해줍니다. 함수형 컴포넌트의 경우 각각 useLayoutEffect()와 useEffect()가 이에 해당합니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">finishSyncRender</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Set this to null to indicate there's no in-progress render.</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
    ImmediatePriority<span class="token punctuation">,</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<anchor id="commitRootImpl" />
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1715" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedExpirationTime
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 초기화</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span>
  root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span>
  root<span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> NoWork
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoPriority
  root<span class="token punctuation">.</span>nextKnownPendingLevel <span class="token operator">=</span> NoWork

  <span class="token comment">// Effect list의 head를 가지고 온다.</span>
  <span class="token keyword">let</span> firstEffect
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">></span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      firstEffect <span class="token operator">=</span> finishedWork
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// There is no effect on the root.</span>
    firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext
    executionContext <span class="token operator">|=</span> CommitContext

    <span class="token comment">// 전</span>
    nextEffect <span class="token operator">=</span> firstEffect
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">        <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span>
        <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token comment">// 변형</span>
    nextEffect <span class="token operator">=</span> firstEffect
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">        <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span></span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span>
        <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token comment">// workInProgress tree를 DOM에 적용했으니 이젠 current로 취급한다.</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork

    <span class="token comment">// 후</span>
    nextEffect <span class="token operator">=</span> firstEffect
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">        <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span></span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span>
        <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    nextEffect <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">// 브라우저가 화면을 렌더링 할 수 있도록 scheduler에게 알린다.</span>
<span class="gatsby-highlight-code-line">    <span class="token function">requestPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
    executionContext <span class="token operator">=</span> prevExecutionContext
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// No effects.</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork
  <span class="token punctuation">}</span>

  <span class="token comment">// Passive effect(useEffect)를 위한 설정</span>
  <span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 화면이 그려지고 난 후에 실행될 effect들이 아직 남아 있으므로 root를 잡아둔다.</span>
<span class="gatsby-highlight-code-line">    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    rootWithPendingPassiveEffects <span class="token operator">=</span> root</span><span class="gatsby-highlight-code-line">    pendingPassiveEffectsExpirationTime <span class="token operator">=</span> expirationTime</span><span class="gatsby-highlight-code-line">    pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Passive effect가 없으면 effect를 모두 소비한 것이므로 GC를 위해 참조를 끊어준다.</span>
    nextEffect <span class="token operator">=</span> firstEffect
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextNextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect
      nextEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span>
      nextEffect <span class="token operator">=</span> nextNextEffect
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>39, 51, 66: sub-phase</li>
<li>79: <code class="language-text">requestPaint()</code>의 설명은 일전에 다루었던 <a href="/react/in-depth-react-scheduler_2/#isInputPending" target="_blank">내용</a>으로 대체합니다.</li>
<li>89 ~ 92: useEffect()의 경우 브라우저가 화면을 그리고 난 후에 실행되는 Effect입니다. 그러기 위해 Effect 소비 함수를 <strong>shceduler</strong>에게 다음 프레임에 실행하도록 요청하는데, 이때 Effect list를 가지고 있는 root를 참조할 수 있어야 하므로 잡아<up>90</up> 둘 필요가 있습니다.</li>
<li>103, 104: Commit phase를 진행하는 와중에 추가적인 작업이 스케줄링될 경우를 대비합니다.</li>
</ul>
<p>본격적으로 Commit phase를 시작하겠습니다.</p>
<h2 id="7---2-commitbeforemutationeffects"><a href="#7---2-commitbeforemutationeffects" aria-label="7   2 commitbeforemutationeffects permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7 - 2 commitBeforeMutationEffects()</h2>
<p>Effect를 소비하는 방식은 간단합니다. firstEffect부터 lastEffect까지 순회하며 현재 시점에 처리해야되는 Effect를 tag를 이용하여 필터링한 후 소비하는 방식입니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2031" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag</span>
    <span class="token comment">// 클래스 컴포넌트의 getSnapshotBeforeUpdate()</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// useEffect()를 사용하면 Passive tag가 달린다.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// root를 잡아둬야 하는지 알려주는 플래그</span>
        <span class="token comment">// 다음 프레임이 실행될 수 있도록 Passive effect 소비 함수 전달</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> 
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line">    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>Passive tag는 useEffect() 구현체에서 달아줍니다.</p>
</blockquote>
<h3 id="1-commitbeforemutationeffectonfiber"><a href="#1-commitbeforemutationeffectonfiber" aria-label="1 commitbeforemutationeffectonfiber permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1) commitBeforeMutationEffectOnFiber()</h3>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L242" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// noop</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState
          <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode <span class="token comment">// class instance</span>
<span class="gatsby-highlight-code-line">          <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span></span>            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> prevProps
              <span class="token punctuation">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// defaultProps 적용</span>
            prevState
          <span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">          instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot</span>        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//HostRoot, HostComponent..</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'This unit of work tag should not have side-effects. This error is '</span> <span class="token operator">+</span>
          <span class="token string">'likely caused by a bug in React. Please file an issue.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>클래스 컴포넌트는 DOM 변형전에 snapshot을 찍어놓기 위해 현재 시점에 getSnapshotBeforeUpdate()를 호출합니다.<br>
그리고 돔 변형 이후에 componentDidUpdate(prevProps, prevState, snapshot)에서 사용할 수 있도록 instance에 저장해 놓습니다.</p>
<h3 id="2-flushpassiveeffects"><a href="#2-flushpassiveeffects" aria-label="2 flushpassiveeffects permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2) flushPassiveEffects()</h3>
<p>설명을 계속 미뤄두었던 useEffect()가 나올 차례입니다.<br>
먼저 아래 이미지를 통해 훅의 실행 흐름을 정확하게 짚고 넘어가겠습니다.</p>
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 728px;">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 127.6098901098901%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEIUlEQVRIx6VV2VIbORTt/3/nFd4oIBVgKpkMFCRhMdgOeCNe2nbjDRsbb7249+3MvWq6YSqTeRlVHZ8jXekuLcmSQC2KIiY0m01sbW1hb28Ph4eHOD4+xv7+Pk5OTnBwcCDGz8/PsbOzg+3tbezu7uLo6Aiu64r1cRxDSgWDHVuWhc1mIzAej9FqtTAcDgVkWRbc6/UwGAxgGAYcxxHrUh8S//yuhWH4j8ncgiAQ479rWYar1UpEZKTZpk51XYemaSL79xXxGNu4Gl7Ha6TUeHFxIb5PoVDIMuFmmqb4hvw9i8WimOv7vrBx/+rqCudfz5HP5+F5XpLhv7b4bbN++RTBf5Q8Wg5RqOcJBcHXlWvc1HJoT2QYjgHLs2C6JjbORjD3dUsXWoy7m8zGkCbrMWqPVdSUKiqdMsrtEsrEyqwL1VKF0xS82HB0qKYKy7WEc2bTSQIxpNFqiO68g8elAmWRcG+lQH5uojGuQ541kXu4xpfrP1FS7tGaNtCddbKsGYZtZFra+BZUl6K6BtYcnbRGemVrgq3Ixpr03FhC96g06muUrR8G8CNC6MML/FcdQAqnU4R0SEM6sH6/T5zogA9uW8ayXodGh5t51WhgWi7DIlvMB9qyEdk2QjpOzAzJ6/fgNH7CbTXgNAnEia5jXSlBufiG/tUlWmeneLrNYXh9CUNuIaTjFNLZY3h0HlMtRRRJRCD4dEBDM4kW0KTpXRHD3BWmxQKei3k8Xn5HlwIsS/fwODgn0qhnzJBCdqKqCMmBR7cl0EjT6feXSyqxTiWWMK9VBb9UK5hVyvQJGgieRvBHQwFvNMi05MpN2JSJU76DU7qDXUrYKv2ARlkpp38JND79gfLHD+iRdmiNSOS1zIASeCvZopJ1/h4mGTZCRwaVr9IE6kc07qu6QKAlYz6P+wFiAnPk+UIzJAQzwB8SRojcQaKDRBtrui3rFky1DW3ZhKm1Rd81aU5s0920BOLQyrQUWzJi4w7xpkR8LxiEiPRL/yuG8gmelTOMO6eYD75j2PoCY16mxSbiQBcIPZUueKIl2lYhqGZhSDSV7i5A2wd1coPnx2+Y9S8wap/BXv5AbFYpcIX+iqq/aIkdxcGKylwjICexz5p22n2hJBrQZkUsnm4JN1iN8zAX9xTvJ7gy2FTdK1ItwXpArOcAI08l3wqAEKo8VoS7zGHc/gzl4RAj+RNlUqDNo2wCgwJroqLI195Kjn0q05vTZixot+aUIZUaLJIMvQTOZgLbeCKMyT5PKonoYSIwR4Gdaend/ynCiP/eEy34Vaf2lDPbK6IozmySul7Donv5/9qbd4mfxFqtJh4bfmhUuobMaZ85Bdv4jUnn8cP2/k0Wzyi/q51OB+12W3C32xWcQlEUYeP3OZ3H7/NkMhEObfojSR1y+xvxR6Uzn6gCwQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="hook flow" title="hook flow" src="/static/61abcbbac19bee4e8b43d4eb673ff438/9d3a0/hook_flow.png" srcset="/static/61abcbbac19bee4e8b43d4eb673ff438/0780f/hook_flow.png 198w,
/static/61abcbbac19bee4e8b43d4eb673ff438/47b26/hook_flow.png 395w,
/static/61abcbbac19bee4e8b43d4eb673ff438/9d3a0/hook_flow.png 728w" sizes="(max-width: 728px) 100vw, 728px" loading="lazy">
    </span>
<p>대부분의 훅이 <code class="language-text">Render</code>에서 소비되는 것과는 달리 useEffect(), useLayoutEffect()는 Commit phase에서 소비됩니다.<br>
useEffect()와 useLayoutEffect()는 라이프 사이클 Effect를 생성한다는 점은 같지만 소비 시점의 차이가 존재합니다.</p>
<p>다이어그램을 참고하여 소비 시점을 확인해보자면 리액트가 DOM을 업데이트하는 <code class="language-text">React updates DOM</code>, 브라우저가 화면을 렌더링하는 <code class="language-text">Browser paints screen</code> 이후에 각각 실행됩니다. 이때 주의깊게 볼만한 점은 새로운 훅 실행 바로 직전에 clean-up function을 호출한다는 것입니다.</p>
<p>useEffect()를 예로 들면 컴포넌트의 상태가 업데이트되어 리-렌더링이 진행될 때 바로 clean-up function을 호출하는게 아닌 다음 프레임에 새로운 useEffect()를 호출하기 바로 직전에 실행된다는 것입니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2177" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">flushPassiveEffectsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// commitRoot()에서 잡아두었던 root</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> root <span class="token operator">=</span> rootWithPendingPassiveEffects
  <span class="token comment">// 전역 변수 정리</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> <span class="token keyword">null</span>
  pendingPassiveEffectsExpirationTime <span class="token operator">=</span> NoWork

  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext<span class="token punctuation">,</span>
    <span class="token string">'Cannot flush passive effects while already rendering.'</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext
  executionContext <span class="token operator">|=</span> CommitContext

  <span class="token keyword">let</span> effect <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>firstEffect
  <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">commitPassiveHookEffects</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span>
      <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> nextNextEffect <span class="token operator">=</span> effect<span class="token punctuation">.</span>nextEffect
    <span class="token comment">// Remove nextEffect pointer to assist GC</span>
    effect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span>
    effect <span class="token operator">=</span> nextNextEffect
  <span class="token punctuation">}</span>

  executionContext <span class="token operator">=</span> prevExecutionContext

  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L395" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  NoEffect <span class="token keyword">as</span> NoHookEffect<span class="token punctuation">,</span>
  UnmountPassive<span class="token punctuation">,</span>
  MountPassive<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactHookEffectTags'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">commitPassiveHookEffects</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>
      <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>
      <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span>UnmountPassive<span class="token punctuation">,</span> NoHookEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span>
        <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span>NoHookEffect<span class="token punctuation">,</span> MountPassive<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">commitHookEffectList()</code>는 라이프 사이클 Effect를 소비하는 함수이며 먼저 useEffect(), useLayoutEffect()가 해당 Effect를 어떻게 생성하는지 부터 확인하고 가겠습니다.</p>
<h4 id="life-cycle-effect-생성"><a href="#life-cycle-effect-%EC%83%9D%EC%84%B1" aria-label="life cycle effect 생성 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Life cycle effect 생성</h4>
<p>useEffect()와 useLayoutEffect()는 로직이 비슷하므로 같이 설명하도록 하겠습니다.<br>
훅은 아시다시피 mount와 update 두 개의 실행환경으로 분류됩니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L923" target="_blank" class="code_link">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Update <span class="token keyword">as</span> UpdateEffect<span class="token punctuation">,</span>
  Passive <span class="token keyword">as</span> PassiveEffect<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/ReactSideEffectTags'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  UnmountMutation<span class="token punctuation">,</span>
  MountLayout<span class="token punctuation">,</span>
  UnmountPassive<span class="token punctuation">,</span>
  MountPassive<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactHookEffectTags'</span><span class="token punctuation">;</span>

<span class="token comment">// useEffect()</span>
<span class="token keyword">function</span> <span class="token function">mountEffect</span><span class="token punctuation">(</span>
  <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">mountEffectImpl</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    UpdateEffect <span class="token operator">|</span> PassiveEffect<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    UnmountPassive <span class="token operator">|</span> MountPassive<span class="token punctuation">,</span></span>    create<span class="token punctuation">,</span>
    deps
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// useLayoutEffect()</span>
<span class="token keyword">function</span> <span class="token function">mountLayoutEffect</span><span class="token punctuation">(</span>
  <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">mountEffectImpl</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    UpdateEffect<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    UnmountMutation <span class="token operator">|</span> MountLayout<span class="token punctuation">,</span></span>    create<span class="token punctuation">,</span>
    deps
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>훅의 첫번째 인자로 넘어오는 함수를 <code class="language-text">create</code>, create()가 반환하는 함수를 <code class="language-text">destroy</code><up>clean-up </up>라고 명칭합니다.  </li>
<li><code class="language-text">mountEffectImpl()</code>의 첫 번째 인자로 넘겨주는 tag는 fiber에 새겨지며 두 번째 인자 tag는 라이프 사이클 Effect에 새겨집니다.</li>
</ul>
<p><a class="code_link_5" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L895" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberEffectTag<span class="token punctuation">,</span> hookEffectTag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nextDeps <span class="token operator">=</span> deps <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> deps
  sideEffectTag <span class="token operator">|=</span> fiberEffectTag
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token function">pushEffect</span><span class="token punctuation">(</span>hookEffectTag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> nextDeps<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>mountWorkInProgressHook()가 기억 안나시는 분은 <a href="/react/in-depth-react-hooks_1/#mountWorkInProgressHook" target="_blank">hooks_1</a>를 참고하세요.</p>
</blockquote>
<ul>
<li>
<p><code class="language-text">sideEffectTag</code><up>5</up>는 workInProgress에 side-effect tag를 새겨넣기 위한 전역변수입니다. 이 변수는 renderWithHooks()에서 컴포넌트 호출이 끝나고 난 후에 사용됩니다.  </p>
<blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">/*...*/</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> renderedWork <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">;</span>
  renderedWork<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> componentUpdateQueue<span class="token punctuation">;</span> <span class="token comment">// 라이프 사이클 Effect list</span>
  renderedWork<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> sideEffectTag<span class="token punctuation">;</span>

  <span class="token comment">/*...*/</span>
 <span class="token punctuation">}</span></code></pre></div>
</blockquote>
</li>
<li><code class="language-text">pushEffect()</code><up>6</up>에 create(), destroy()를 전달하여 라이프 사이클 hook을 만들고 저장합니다.</li>
</ul>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L854" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">pushEffect</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> effect<span class="token punctuation">:</span> Effect <span class="token operator">=</span> <span class="token punctuation">{</span>
    tag<span class="token punctuation">,</span>
    create<span class="token punctuation">,</span>
    destroy<span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentUpdateQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentUpdateQueue <span class="token operator">=</span> <span class="token function">createFunctionComponentUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// return { lastEffect: null }</span>
    componentUpdateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next <span class="token operator">=</span> effect
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> lastEffect <span class="token operator">=</span> componentUpdateQueue<span class="token punctuation">.</span>lastEffect
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentUpdateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next <span class="token operator">=</span> effect <span class="token comment">// circular</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next <span class="token comment">// circular</span>
      lastEffect<span class="token punctuation">.</span>next <span class="token operator">=</span> effect
      effect<span class="token punctuation">.</span>next <span class="token operator">=</span> firstEffect
      componentUpdateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> effect
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>컴포넌트 호출 와중에 생성되는 라이프 사이클 Effect들은 <code class="language-text">componentUpdateQueue</code>에 담기게 됩니다. </li>
<li>세번째 인자로 넘어오는 destroy는 컴포넌트 마운트 시점에서는 undefined로 넘어옵니다. 이 destroy는 현재 시점에서는 얻어낼 수 없고 소비 시점에 가서야 create를 호출해 clean-up 함수를 저장할 수 있습니다.</li>
</ul>
<blockquote>
<p>잠시 헷갈릴 수 있으므로 리액트에서 저장소로 다루는 것들에 대해 짧게 정리하고 넘어가겠습니다.</p>
<ul>
<li>컴포넌트의 side-effect를 담고 있는 fiber의 firstEffect, nextEffect, lastEffect</li>
<li>함수형 컴포넌트에서 사용되는 훅들의 리스트를 담고 있는 fiber의 memoizedState</li>
<li>함수형 컴포넌트의 라이프 사이클 Effect를 담고 있는 fiber의 updateQueue</li>
</ul>
<p>위에서 연급된 저장소들 중 다른 곳에서도 사용되는 것들을 정리해보자면</p>
<ul>
<li>훅의 memoizedState는 결괏값을 저장합니다. useState()는 action의 결과, useEffect()는 생성된 Effect 등</li>
<li>호스트 컴포넌트의 updateQueue에는 변경점을 담는다.</li>
</ul>
</blockquote>
<p>Effect 생성을 보았으니 다음은 업데이트 구현체를 확인해보겠습니다.<br>
마운트 구현체와는 다르게 이전에 실행된 훅도 신경써야 합니다.</p>
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L902" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token comment">// useEffect()</span>
<span class="token keyword">function</span> <span class="token function">updateEffect</span><span class="token punctuation">(</span>
  <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateEffectImpl</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    UpdateEffect <span class="token operator">|</span> PassiveEffect<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    UnmountPassive <span class="token operator">|</span> MountPassive<span class="token punctuation">,</span></span>    create<span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// useLayoutEffect()</span>
<span class="token keyword">function</span> <span class="token function">updateLayoutEffect</span><span class="token punctuation">(</span>
  <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  deps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateEffectImpl</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    UpdateEffect<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    UnmountMutation <span class="token operator">|</span> MountLayout<span class="token punctuation">,</span></span>    create<span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberEffectTag<span class="token punctuation">,</span> hookEffectTag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nextDeps <span class="token operator">=</span> deps <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> deps
  <span class="token keyword">let</span> destroy <span class="token operator">=</span> <span class="token keyword">undefined</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHook <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevEffect <span class="token operator">=</span> currentHook<span class="token punctuation">.</span>memoizedState
    destroy <span class="token operator">=</span> prevEffect<span class="token punctuation">.</span>destroy
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextDeps <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prevDeps <span class="token operator">=</span> prevEffect<span class="token punctuation">.</span>deps
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areHookInputsEqual</span><span class="token punctuation">(</span>nextDeps<span class="token punctuation">,</span> prevDeps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">        <span class="token function">pushEffect</span><span class="token punctuation">(</span>NoHookEffect<span class="token punctuation">,</span> create<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> nextDeps<span class="token punctuation">)</span></span>        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  sideEffectTag <span class="token operator">|=</span> fiberEffectTag
<span class="gatsby-highlight-code-line">  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token function">pushEffect</span><span class="token punctuation">(</span>hookEffectTag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> nextDeps<span class="token punctuation">)</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>updateWorkInProgressHook()가 기억 안나시는 분은 <a href="/react/in-depth-react-hooks_2/#updateWorkInProgressHook" target="_blank">hooks_2</a>를 참고하세요.</p>
</blockquote>
<ul>
<li>이전에 실행된 훅이 없다면<up>33</up> 비교할 필요 없이 Effect를 바로 생성<up>46</up>합니다. </li>
<li>
<p>실행된 훅이 존재한다면<up>33</up> 의존성 배열 유무<up>36</up>를 확인합니다. </p>
<ul>
<li>개발자가 의존성 배열을 사용하지 않았다면 이는 컴포넌트 호출마다 실행되어야 하므로 46 라인으로 넘어갑니다. </li>
<li>의존성 배열이 존재한다면 이를 이전 훅의 의존성 배열과 비교<up>38</up>합니다.  </li>
</ul>
</li>
<li>라인 39, 46의 각 <code class="language-text">pushEffect()</code>의 쓰임새는 약간씩 다릅니다. 39는 컴포넌트가 언마운트될 때 각 훅의 destroy를 실행해주어야하는데 이때 참조할 수 있도록 Effect를 componentUpdateQueue에 추가하는 용도로 쓰입니다. 그래서 create가 실행되지 않도록 <code class="language-text">NoHookEffect</code>를 넘겨주는 것입니다.</li>
</ul>
<h3 id="3-라이프-사이클-effect를-소비하는-commithookeffectlist"><a href="#3-%EB%9D%BC%EC%9D%B4%ED%94%84-%EC%82%AC%EC%9D%B4%ED%81%B4-effect%EB%A5%BC-%EC%86%8C%EB%B9%84%ED%95%98%EB%8A%94-commithookeffectlist" aria-label="3 라이프 사이클 effect를 소비하는 commithookeffectlist permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3) 라이프 사이클 Effect를 소비하는 commitHookEffectList()</h3>
<p>헷갈리지 않도록 아래 4, 5라인의 인자를 눈여겨보세요. 소비하려는 Effect의 tag를 넘겨주고 있는 것입니다.</p>
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L331" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token comment">// function commitPassiveHookEffects(...) {</span>
<span class="token comment">//    /*...*/</span>
<span class="gatsby-highlight-code-line"><span class="token comment">//    commitHookEffectList(UnmountPassive, NoHookEffect, finishedWork);</span></span><span class="gatsby-highlight-code-line"><span class="token comment">//    commitHookEffectList(NoHookEffect, MountPassive, finishedWork);</span></span><span class="token comment">// }</span>

<span class="token keyword">function</span> <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span><span class="token parameter">unmountTag<span class="token punctuation">,</span> mountTag<span class="token punctuation">,</span> finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue
  <span class="token keyword">let</span> lastEffect <span class="token operator">=</span> updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> updateQueue<span class="token punctuation">.</span>lastEffect <span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next
    <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> unmountTag<span class="token punctuation">)</span> <span class="token operator">!==</span> NoHookEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Unmount</span>
        <span class="token keyword">const</span> destroy <span class="token operator">=</span> effect<span class="token punctuation">.</span>destroy
        effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destroy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> mountTag<span class="token punctuation">)</span> <span class="token operator">!==</span> NoHookEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mount</span>
        <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create
        effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>clean-up 함수를 실행하기 위해 <code class="language-text">UnmountPassive</code> tag를 먼저 넘기고<up>4</up> 그 다음에 <code class="language-text">MountPassive</code> tag를 가진 Effect를 소비<up>5</up> 합니다. 언마운트의 경우 destroy를 꺼내<up>17</up> 실행하면 끝입니다. mount는 create를 실행하고 반환하는 clean-up 함수를 Effect의 destroy에 할당<up>26</up>합니다.</p>
<blockquote>
<p>UnmountPassive와 MountPassive tag는 useEffect() 구현체에서 달아주고 있습니다.</p>
</blockquote>
<h2 id="7---3-commitmutationeffects"><a href="#7---3-commitmutationeffects" aria-label="7   3 commitmutationeffects permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7 - 3 commitMutationEffects()</h2>
<p>여기에서는 삽입, 수정, 삭제 Effect가 소비됩니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2058" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag

    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span> <span class="token comment">// node.textContent = text</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> primaryEffectTag <span class="token operator">=</span> effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion<span class="token punctuation">)</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Placement<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> Update<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> Deletion<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="1-commitplacement"><a href="#1-commitplacement" aria-label="1 commitplacement permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1) commitPlacement</h3>
<p>DOM에 element 삽입(이동, 추가)을 처리하기 위해선 다음의 두 가지 컴포넌트가 필요합니다.</p>
<ol>
<li>부모 호스트 컴포넌트</li>
<li>Placement tag가 달려있지 않은 형제 컴포넌트</li>
</ol>
<p>1의 경우 당연히 현재 element를 삽입하기 위해선 부모가 필요합니다.<br>
2는 필요할 수도 있고 없을 수도 있습니다. 무슨 말이냐면 element 이동이나 추가할 때 가장 이상적인 방법은 그냥 부모의 자식 노드 맨 뒤에 삽입 하는 것입니다. 하지만 기존 형제가 그 자리에 가만히 있을 경우 그리고 새로 삽입할 element의 위치가 해당 형제보다 앞에 위치해야 할 경우 앞에서 설명한 이상적인 방법은 사용할 수 없고 다른 방법을 모색해야 합니다. 이럴때 삽입 위치의 오른쪽 형제가 필요합니다. 그래야 해당 형제 노드를 기준으로 삽입할 수 있습니다.</p>
<p>이를위해 형제를 참조할 때 주의해야될 중요한 점은 형제 노드에 Placement tag가 달려 있으면 안된다는 점입니다. 왜냐면 Effect list의 순서는 후위 순회이므로 왼쪽부터 삽입됩니다. 그런데 형제 노드에 Placement tag가 달려있을 경우 VDOM에서는 참조 가능하지만 DOM 환경에서는 형제 노드의 삽입 처리가 되기전입니다. 그래서 Pacement tag가 달려있지 않은 형제를 찾아 기준점을 삼아야합니다.</p>
<p>필요한 컴포넌트들을 준비했다면 마지막으로는 삽입 대상인 호스트 컴포넌트를 찾아내야 합니다.<br>
Placement tag는 커스텀 컴포넌트에도 달릴 수 있으므로 필터링이 필요합니다. 이때의 로직은 기존에 다루었던 <a href="/react/in-depth-react-reconciler_4/#append_all_children" target="_blank">appendAllChildren()</a>와 비슷합니다.</p>
<h4 id="삽입할-부모-찾기"><a href="#%EC%82%BD%EC%9E%85%ED%95%A0-%EB%B6%80%EB%AA%A8-%EC%B0%BE%EA%B8%B0" aria-label="삽입할 부모 찾기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>삽입할 부모 찾기</h4>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1031" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// Recursively insert all host nodes into the parent.</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span></span>
  <span class="token keyword">let</span> parent
  <span class="token keyword">let</span> isContainer
  <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode
  <span class="token comment">// 부모 HTML element 추출</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>
      parent <span class="token operator">=</span> parentStateNode
      isContainer <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>
      <span class="token comment">// Host root의 stateNode는 root이므로 containerInfo에서 꺼내야 합니다.</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo
      isContainer <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">break</span>
    <span class="token comment">/*...*/</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'Invalid host parent fiber. This error is likely caused by a bug '</span> <span class="token operator">+</span>
          <span class="token string">'in React. Please file an issue.'</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHostParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>      <span class="token keyword">return</span> parent
    <span class="token punctuation">}</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return
  <span class="token punctuation">}</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">'Expected to find a host parent. This error is likely caused by a bug '</span> <span class="token operator">+</span>
      <span class="token string">'in React. Please file an issue.'</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot <span class="token operator">||</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="삽입할-기준이-되는-형제-찾기"><a href="#%EC%82%BD%EC%9E%85%ED%95%A0-%EA%B8%B0%EC%A4%80%EC%9D%B4-%EB%90%98%EB%8A%94-%ED%98%95%EC%A0%9C-%EC%B0%BE%EA%B8%B0" aria-label="삽입할 기준이 되는 형제 찾기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>삽입할 기준이 되는 형제 찾기</h4>
<p><a class="code_link_5" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L985" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// const parentFiber = getHostParentFiber(finishedWork)</span>
  <span class="token comment">// switch (parentFiber.tag) {...}</span>

  <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Instance <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node<span class="token punctuation">:</span> Fiber <span class="token operator">=</span> fiber
  siblings<span class="token punctuation">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>return<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token keyword">null</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>
<span class="gatsby-highlight-code-line">    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return</span><span class="gatsby-highlight-code-line">    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostComponent <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">continue</span> siblings</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">continue</span> siblings</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node</span><span class="gatsby-highlight-code-line">        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Found it!</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>코드를 블럭으로 나누어 의미를 따져 보자면 다음과 같습니다.</p>
<ul>
<li>13 ~ 18: 부모로(<down>위로</down>) 올라갑니다. 현재 노드의 sibling이 null이고<up>13</up> 부모가 호스트 컴포넌트라면<up>14</up> 이는 형제 탐색 경로를 모두 지나왔음을 뜻하며 참조할만한 형제가 없으므로 탐색을 중단합니다.<br>
하지만 만약 부모가 커스텀 컴포넌트이면서 형제를 가지고 있다면 실제 DOM에 적용되었을 때는 부모의 형제가 현재 노드의 형제가 됩니다. DOM에 삽입되는 건 호스트 컴포넌트이지 커스텀 컴포넌트는 아니기 때문입니다.
이 이유로 노드의 형제가 없어도 탐색을 중단하는게 아닌 부모가 호스트 컴포넌트가 아니라면 일단 위로 올라가는 것입니다.</li>
<li>20 ~ 21: 형제로(<down>옆으로</down>) 이동합니다.</li>
<li>23 ~ 33: 자식으로(<down>아래로</down>) 이동합니다. 이동한 형제 노드가 커스텀 컴포넌트일 경우 위에서 설명드린 이유와 마찬가지로 일단 밑으로 내려가야 합니다. 이때 Placement tag가 달려있거나 자식이 없을 경우에는 해당 노드의 서브트리를 탐색할 필요가 없으므로 그다음 형제를 탐색하기 위해 siblings lable로 돌아갑니다.</li>
</ul>
<p>위 로직을 모두 거치고 난 후 Placement tag만 달려있지 않다면 그건 우리가 찾는 형제 노드<up>37</up>입니다.</p>
<h4 id="삽입-대상-element-찾기"><a href="#%EC%82%BD%EC%9E%85-%EB%8C%80%EC%83%81-element-%EC%B0%BE%EA%B8%B0" aria-label="삽입 대상 element 찾기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>삽입 대상 element 찾기</h4>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1079" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// const before = getHostSibling(finishedWork);</span>

  <span class="token keyword">let</span> node<span class="token punctuation">:</span> Fiber <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isHost <span class="token operator">=</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stateNode <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// parent.insertBefore(stateNode, before)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// appendChild(parent, stateNode)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">appendChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// 호스트 컴포넌트가 아니라면 밑으로 내려간다.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 삽입한 노드가 finishedWork라면 작업완료를 뜻한다.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> finishedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 형제가 없다면 위로 올라간다.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> finishedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 형제로 이동</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>finishedWork가 호스트 컴포넌트라면 해당 컴포넌트만 삽입하면 되지만 커스텀 컴포넌트일 경우 해당 컴포넌트의 자식(<down>DOM 기준</down>) 호스트 컴포넌트를 모두 찾아 삽입시켜야 합니다. 로직은 많이 보던 형태이므로 자세한 설명은 생략하고 이해를 돕기 위해 예제를 통해 정리해봅니다.</p>
<p><a href="/react/in-depth-react-reconciler_1/#todo" target="_blank">Todo 예제</a>에서 다음 하이라이트 부분을 살짝 변경 하겠습니다.</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Todo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> push<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>isMounted<span class="token punctuation">,</span> mountInput<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token function">mountInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    <span class="token operator">&lt;</span>div<span class="token operator">></span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span>isMounted <span class="token operator">?</span> <span class="token operator">&lt;</span>Input submit<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">todo</span> <span class="token operator">=></span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">todos</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>todos<span class="token punctuation">,</span> todo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span></span>      <span class="token operator">&lt;</span>OrderList list<span class="token operator">=</span><span class="token punctuation">{</span>todos<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="gatsby-highlight-code-line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></span>  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Input 컴포넌트는 3초 뒤에 마운트될 겁니다. 이제 컴포넌트가 새롭게 추가되었으니 Commit phase에서 commitPlacement()를 통해 삽입 처리를 할 것입니다.  </p>
<p><strong>Commit phase가 시작되기 전</strong> 각 fiber들은 어떤 side-effect tag을 가지고 있을까요? 그리고 Effect list와 VDOM, DOM의 형태는 어떤 상태일지 추측해봅시다.   </p>
<p>아래 이미지에서 VDOM에는 Effect tag, DOM에는 element, 마지막으로 Effect list을 채워보세요.</p>
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.863921217546995%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB00lEQVQoz32TW2/aQBCF+f//IepLpT61ilRVVCXhUlorgiKHi4MxsUsCcVwwYGNs7LXXJ7POGiU07Uj7sLOz3zmzHlfyPIdYIlicQO12MdX1Yv/yzDSmmGiaSB5zY6pTFAWmaRaLc46KOOSywN5s8KFZR7XbQcwYyoiTBO3hAM1hH34YFkBxOY4iBL6PkHKhzFdeunBtG7WfLXRudSQsPQKjOIYy0XGhDbEOgmPeeLShOzaYEOcxcTLpkNQKh5aJ8+8NXA5UHMiViNJ9GXN3hU+dKzTHGup9FQ1yHkUHZEmAnEtgeSVIGGrXPVyNh0gy/uodMykaUJuj+ztYfxy0b0Zokev4EIOzvXQoXFBL2O2wXK/wbdBDS7+B529J8TU0P3GrGDrqBNwHe/DCYYpK0Rapfvxaxft2A667xGq7Rc8yoM4s/F46f0FLtwoJV9UePM8noP8M9PchZisHpjOHaS9g2TM8EnCxcTEnxzsSOwWWTru3UzSp7YhqeCJbFqNw1riAOp2gbxh4V6/h868ORot7DB7m8P4D/KGN8IVqozCSLYs3JPuM3rD40lQohptnGe0zpCl7E1YCl76Hh82axiZFnjHKy8E+/Sv+BXkLeqyXd54AhjpFhn54T3MAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="before commitPlacement example" title="before commitPlacement example" src="/static/add90b257f70e3869b4ecbb2f58e10cb/c94d1/before_commitPlacement_example.png" srcset="/static/add90b257f70e3869b4ecbb2f58e10cb/0780f/before_commitPlacement_example.png 198w,
/static/add90b257f70e3869b4ecbb2f58e10cb/47b26/before_commitPlacement_example.png 395w,
/static/add90b257f70e3869b4ecbb2f58e10cb/c94d1/before_commitPlacement_example.png 790w,
/static/add90b257f70e3869b4ecbb2f58e10cb/773cd/before_commitPlacement_example.png 1117w" sizes="(max-width: 790px) 100vw, 790px" loading="lazy">
    </span>
<h1 id=""><a href="#" aria-label=" permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h1>
<h1 id="-1"><a href="#-1" aria-label=" 1 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h1>
<h1 id="-2"><a href="#-2" aria-label=" 2 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h1>
<h3 id="정답"><a href="#%EC%A0%95%EB%8B%B5" aria-label="정답 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>정답</h3>
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 790px;">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.975678203928915%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACAUlEQVQoz4VSa2+bUAzl//+AfZ8mTdqkddNUtVPaLGna0pIEAqGQdwh5kaYlCRASoMCZLylTM22ar6x7Zfse+9jm0jQFUyZxHEMWRaiyDDA7nSRJMp81m0EUqgj2e+Qyn89RLpfR6XSg6zo2jgPuLaDtOji5vsKpcIftbndIQoAMVOp1cdEQYa1WWTJmD8MQ7maD7XaLne9n8UeADjmKioQbXcH2TSVM1ImJYusBpv3822Z7LpTJGGEUYfy0hDwyDoDJK+ATZTuVajiXqtDabfC6hpPqHRqDPn5KIs5qAlRjiKKqoKipuG+38I3YOJ6HGr2/8DfHFfpBgKJUR0URMbEsdKcTCP0ujIUFqd/Dfa+DKVUiDQcQjQFkus/EGjxippkjFJrycYUuUSioDVy2NCgPTfxPhpToa13AiphpRLfQbIBjjiRJKVMdn/gKrvhrzKwFtOkIimmgO59lQ2GaDYgNhLaBSY98n4nmeLFAuPMQhT64F3I6vgd91IU2HsGcGVhTT8zlIyb2Mmt83pZcc0Ys5nu9iuV6jZjAkEbgSoqMd4VzFIRblHke78sX+FC6xI/bazSmJh5dN/t8BPi6m32q8GOlhIVt4yXwkcYhuIB2iU1pRwPZk7I328EgDMi2z9rxZ4X5EFcUqxIrtm5xFCBNokMP/yXZxxR/BcxBj+OBXxncOVCFwHHnAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="before commitPlacement" title="before commitPlacement" src="/static/9923781de38618ced5350aa719a71857/c94d1/before_commitPlacement.png" srcset="/static/9923781de38618ced5350aa719a71857/0780f/before_commitPlacement.png 198w,
/static/9923781de38618ced5350aa719a71857/47b26/before_commitPlacement.png 395w,
/static/9923781de38618ced5350aa719a71857/c94d1/before_commitPlacement.png 790w,
/static/9923781de38618ced5350aa719a71857/7b8e7/before_commitPlacement.png 1069w" sizes="(max-width: 790px) 100vw, 790px" loading="lazy">
    </span>
<ul>
<li>
<h4 id="vdom"><a href="#vdom" aria-label="vdom permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VDOM</h4>
<p><code class="language-text">Todo</code>의 상태가 변경되어 Work를 진행합니다. fiber에 새겨진 expirationTime을 통해 빠르게 <code class="language-text">Todo</code>까지 내려갑니다. 그리고 <a href="/react/in-depth-react-reconciler_2/#updateFunctionComponent" target="_blank">updateFunctionComponent()</a>에서 renderWithHooks()을 통해 컴포넌트를 실행하고 PerformedWork<up>1</up> tag를 달아줍니다.  </p>
<p>반환된 <code class="language-text">div</code>를 대상으로 <a href="/react/in-depth-react-reconciler_3/#reconcileChildFibers" target="_blank">reconcileChildFibers()</a>을 진행합니다. current의 type, key가 모두 같으므로 current에 props만 갈아끼워 재사용합니다. 이전 <code class="language-text">div</code>가 삭제된 것도 아니고 current도 존재하기 때문에 Effect tag는 여전히 0입니다.  </p>
<p>beginWork()에서 <code class="language-text">div</code>의 props변경 여부를 따져 bailout path를 할지 결정합니다. <code class="language-text">div</code>의 경우 <code class="language-text">Todo</code>가 재호출되면서 새 props를 가진 React element로 반환되었기 때문에 <a href="/react/in-depth-react-reconciler_2/#beginWork" target="_blank">props 비교</a>에서 참조값이 달라 bailout하지 못하고 div의 자식(<down><code class="language-text">Input</code>과 <code class="language-text">OrderList</code>를 포함한 배열</down>)을 대상으로 <a href="/react/in-depth-react-reconciler_3/#reconcileChildrenArray" target="_blank">재조정 작업</a>을 진행하게 됩니다.  </p>
<p><code class="language-text">Input</code>은 current가 없으므로 재조정 작업 중 <a href="/react/in-depth-react-reconciler_3/#placeChild" target="_blank">placeChild()</a>를 통해 Placement<up>2</up> tag가 달립니다.<br>
fiber로 확장된 <code class="language-text">Input</code>을 호출해 <code class="language-text">input</code>과 <code class="language-text">button</code>을 담고 있는 Fragment를 반환받지만 key가 없으므로 바로 벗겨내고 배열에 대한 재조정 작업을 진행합니다. 이 과정에서 <code class="language-text">Input</code>에도 PerformedWork<up>1</up> tag가 달립니다. (<down>OrderList는 설명을 생략합니다.</down>)  </p>
<p>이때 <code class="language-text">div</code>가 반환한 배열과 <code class="language-text">Input</code>이 반환한 배열의 처리가 placeChild()에서 조금 다르게 동작하게 됩니다. 부모가 새로 추가된 경우에는(<down>Input</down>) 그 하위 서브 트리는 다른 처리할 필요 없이 그냥 마운트만 하면 됩니다. 그래서 서브 트리에 Placement tag를 달아줄 필요가 없습니다. 어차피 부모가 <a href="/react/in-depth-react-reconciler_4/#create_element" target="_blank">completeWork()</a>에서 HTML element를 생성함과 동시에 자식들을 연결하기 때문에 부모만 DOM에 마운트된다면 자식들도 자연스레 딸려 올라갑니다. 그래서 <code class="language-text">input</code>과 <code class="language-text">button</code>에는 Placement tag가 없는 것이 이 이유때문입니다. </p>
</li>
<li>
<h4 id="effect-list"><a href="#effect-list" aria-label="effect list permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Effect list</h4>
<p>모든 노드를 대상으로 Work를 진행했으므로 leaf 노드부터 completeWork()를 통해 마무리 합니다. Effect를 위로 올려주는데 PerformedWork<up>1</up>보다 높은 tag를 가진 fiber는 <code class="language-text">Input</code>밖에 없으므로 <code class="language-text">Input</code>의 부모부터 <code class="language-text">Host root</code>까지 Effect list는 <code class="language-text">Input</code> 하나만 가지고 있게 됩니다.</p>
</li>
<li>
<h4 id="dom"><a href="#dom" aria-label="dom permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DOM</h4>
<p>Render phase를 모두 마무리 하였으니 Commit phase로 넘어가는데 Effect는 <code class="language-text">Input</code> 하나 이므로 Placement tag를 소비하기 위해 commitPlacement()을 진행합니다. 이때 DOM에는 <code class="language-text">div</code>와 <code class="language-text">ol</code>만이 존재합니다. <code class="language-text">input</code>과 <code class="language-text">button</code>의 element는 fiber의 stateNode에 저장만 해놓은 상태입니다. 바로 지금의 상태가 위 이미지에서 DOM 트리의 형태가 되겠습니다. div 자식으로 ol만 포함되어 있고 아직 <code class="language-text">input</code>과 <code class="language-text">button</code>은 포함되어 있지 않습니다. 왜냐면 Placement tag가 달린 Effect가 아직 처리되지 않았기 때문입니다. </p>
<p><code class="language-text">input</code>, <code class="language-text">button</code>은 DOM에는 연결되어 있지 않지만 VDOM에는 연결되어 있으므로 commitPlacement()에서 <code class="language-text">Input</code> Effect를 소비하면서 1 depth에 해당하는 모든 호스트 컴포넌트 자식들을 <code class="language-text">Input</code>의 부모(<down>div</down>)에 추가시켜 주면서 DOM트리를 완성시킵니다.  </p>
</li>
</ul>
<p>이제 commitPlacement()에서 호스트 컴포넌트 탐색 알고리즘의 존재 이유와 새로 생성된 Input의 서브 트리에는 tag를 달지 않고 Input에만 Placement tag를 달아주는 이유를 이해하실거라 생각합니다.  </p>
<h3 id="2-commitwork"><a href="#2-commitwork" aria-label="2 commitwork permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2) commitWork</h3>
<p>commitWork()는 호스트 컴포넌트의 수정사항을 DOM에 적용하거나 layoutEffect()의 clean-up 함수 호출을 담당합니다.</p>
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1284" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> MemoComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Note: We currently never use MountMutation, but useLayout uses UnmountMutation.</span>
<span class="gatsby-highlight-code-line">      <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span>UnmountMutation<span class="token punctuation">,</span> MountMutation<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clean-up 함수 호출.</span></span>      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance<span class="token punctuation">:</span> Instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newProps <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
        <span class="token keyword">const</span> updatePayload<span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span> <span class="token comment">// element의 변경점을 담고 있다.</span>
        finishedWork<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updatePayload <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">          <span class="token function">commitUpdate</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> updatePayload<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostText<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> textInstance<span class="token punctuation">:</span> TextInstance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">const</span> newText<span class="token punctuation">:</span> string <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
      <span class="token function">commitTextUpdate</span><span class="token punctuation">(</span>textInstance<span class="token punctuation">,</span> newText<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// textInstance.nodeValue = newText;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*...*/</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'This unit of work tag should not have side-effects. This error is '</span> <span class="token operator">+</span>
          <span class="token string">'likely caused by a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>useLayoutEffect()는 useEffect()와는 다르게 DOM 변경 전과 후에 각각 실행되므로 clean-up 함수를 호출할 시점은 지금<up>8</up>입니다.</p>
<blockquote>
<p>UnmountMutation tag는 useLayoutEffect() 구현체에서 달아줍니다.</p>
</blockquote>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L371" target="_blank">reconciler > client > ReactDOMHostConfig.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitUpdate</span><span class="token punctuation">(</span>
  <span class="token parameter">domElement<span class="token punctuation">:</span> Instance<span class="token punctuation">,</span>
  updatePayload<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">></span><span class="token punctuation">,</span>
  newProps<span class="token punctuation">:</span> Props<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">updateFiberProps</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateProperties</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> updatePayload<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>
<p><code class="language-text">updateFiberProps()</code>는 호스트 환경에서 리액트에 접근하기 위해 <a href="/react/in-depth-react-reconciler_4/#createInstance" target="_blank">THML element에 뚫어 놓았던</a> props 저장 공간을 새로운 props로 덮어주는 역할을 합니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/   ReactDOMComponentTree.js#L164" target="_blank">reconciler > client > ReactDOMComponentTree.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">     
<span class="token keyword">const</span> internalEventHandlersKey <span class="token operator">=</span> <span class="token string">'__reactEventHandlers$'</span> <span class="token operator">+</span> randomKey<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">updateFiberProps</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">[</span>internalEventHandlersKey<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><code class="language-text">updateProperties()</code>는 변경점을 DOM 노드에 적용하는 함수입니다. </p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/   ReactDOMComponent.js#L372" target="_blank">reconciler > client > ReactDOMComponent.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">      
<span class="token keyword">function</span> <span class="token function">updateProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">:</span> Element<span class="token punctuation">,</span> updatePayload<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// Apply the diff.</span>
  <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> updatePayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">:</span> Element<span class="token punctuation">,</span> updatePayload<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token function">setValueForStyles</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">DANGEROUSLY_SET_INNER_HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token function">setInnerHTML</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token function">setTextContent</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token function">setValueForProperty</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre></div>
<p>하이라이트 부분은 호스트 기능과 연관된 함수들로 다음의 링크들로 설명을 대체합니다.</p>
<ul>
<li><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/shared/CSSPropertyOperations.js#L62"    target="_blank">setValueForStyles</a></li>
<li><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setInnerHTML.js#L26"     target="_blank">setInnerHTML</a></li>
<li><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/setTextContent.js#L21"     target="_blank">setTextContent</a></li>
<li><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/DOMPropertyOperations.js#L127"     target="_blank">setValueForProperty</a></li>
</ul>
</li>
</ul>
<h3 id="3-commitdeletion"><a href="#3-commitdeletion" aria-label="3 commitdeletion permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3) commitDeletion</h3>
<p>컴포넌트를 삭제합니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1268" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span>
<span class="token parameter">finishedRoot<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span>
current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
renderPriorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> current<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">detachFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li><code class="language-text">unmountHostComponents()</code>는 삭제와 삭제 대상의 서브 트리에 위치한 컴포넌트들의 언마운트 처리를 합니다.</li>
<li><code class="language-text">detachFiber()</code>는 GC를 위한 fiber 초기화 처리를 합니다.</li>
</ul>
<p>비교적 간단한 detachFiber() 부터 확인하겠습니다.</p>
<h4 id="detachfiber"><a href="#detachfiber" aria-label="detachfiber permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>detachFiber()</h4>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L895" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">detachFiber</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> alternate <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  current<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">detachFiber</span><span class="token punctuation">(</span>alternate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>GC를 위해 fiber의 포인터을 초기화합니다. 해당 컴포넌트는 삭제 대상의 최상단 노드에 해당합니다. 해당 노드가 삭제 대상이라면 서브 트리의 컴포넌트 또한 삭제되어야 합니다. 이 때문에 서브 트리의 fiber도 초기화 해야 된다고 생각할 수 있지만 단순히 최상단 노드가 가리키는 포인터만 초기화 하여도 삭제 해야될 트리를 VDOM에서 떼어 놓는 것이 되므로 모든 노드 들이 알아서 GC 대상이 될 것입니다.</p>
<h4 id="unmounthostcomponents"><a href="#unmounthostcomponents" aria-label="unmounthostcomponents permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unmountHostComponents()</h4>
<p>컴포넌트를 삭제할 때 유의해야 될 점은 삽입과 마찬가지로 삽입 대상이 호스트 컴포넌트가 아니라면 해당 컴포넌트의 자식들 중 DOM 기준으로 자식에 해당하는 호스트 컴포넌트를 모두 찾아 삭제해주어야 한다는 점입니다.  </p>
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L1120" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">   
<span class="token keyword">function</span> <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span>
  <span class="token parameter">finishedRoot<span class="token punctuation">,</span>
  current<span class="token punctuation">,</span>
  renderPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node<span class="token punctuation">:</span> Fiber <span class="token operator">=</span> current<span class="token punctuation">;</span>

  <span class="token keyword">let</span> currentParentIsValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 부모를 찾았는지 알려주는 flag</span>
  <span class="token keyword">let</span> currentParent<span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentParentIsContainer<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 부모를 찾는다</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentParentIsValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      findParent<span class="token punctuation">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token string">'Expected to find a host parent. This error is likely caused by '</span> <span class="token operator">+</span>
            <span class="token string">'a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token comment">//  부모 HTML element 추출</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
            <span class="token comment">/*...*/</span>
        <span class="token punctuation">}</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      currentParentIsValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 부모에서 호스트 컴포넌트 삭제</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>currentParent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// currentParent.removeChild(node.stateNode);</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">removeChild</span><span class="token punctuation">(</span>currentParent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// currentParent.removeChild(node.stateNode);</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 컴포넌트 언마운트 처리</span>
      <span class="token function">commitUnmount</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 호스트 컴포넌트를 찾기 위해 밑으로 내려간다.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 내려온 만큼 위로 올라간다.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 옆으로 이동</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>먼저 삭제 대상의 부모를 찾는다<up>15 ~ 39</up>. 부모를 찾았다면 로직의 중복 실행을 방지하기 위해 <code class="language-text">currentParentIsValid</code>를 설정<up>28, 32</up>합니다. </li>
<li>삭제 대상이 호스트 컴포넌트라면<up>42</up> DOM에서 삭제<up>44, 46</up>하고 끝냅니다<up>60</up>.</li>
<li>삭제 대상이 호스트 컴포넌트가 아니라면 해당 컴포넌트를 언마운트 처리<up>50</up>하고 1 depth에 해당하는 호스트 컴포넌트를 찾아 아래로 내려<up>54</up>갑니다.</li>
</ol>
<blockquote>
<p>나머지 트리 순회 코드의 경우 많이 언급하였으므로 설명을 생략하겠습니다.</p>
</blockquote>
<h4 id="commitunmount"><a href="#commitunmount" aria-label="commitunmount permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitUnmount()</h4>
<p>컴포넌트를 삭제하기 위해 언마운트 처리를 합니다. 함수형 컴포넌트의 경우 라이프 사이클 Effect의 destroy(<down>useEffect(), useLayoutEffect()</down>)를 클래스 컴포넌트는 componentWillUnmount()를 호출해줘야합니다</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L736" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitUnmount</span><span class="token punctuation">(</span>
  <span class="token parameter">finishedRoot<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span>
  current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  renderPriorityLevel<span class="token punctuation">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>
    <span class="token keyword">case</span> MemoComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> lastEffect <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

          <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span>
            renderPriorityLevel <span class="token operator">></span> NormalPriority
              <span class="token operator">?</span> NormalPriority
              <span class="token punctuation">:</span> renderPriorityLevel<span class="token punctuation">;</span>
          <span class="token function">runWithPriority</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> destroy <span class="token operator">=</span> effect<span class="token punctuation">.</span>destroy<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>destroy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">                <span class="token function">safelyCallDestroy</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> destroy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// destroy();</span></span>              <span class="token punctuation">}</span>
              effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUnmount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">        <span class="token function">safelyCallComponentWillUnmount</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// instance.componentWillUnmount();</span></span>      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="7---4-commitlayouteffects"><a href="#7---4-commitlayouteffects" aria-label="7   4 commitlayouteffects permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7 - 4 commitLayoutEffects</h2>
<p>commitLayoutEffects()가 호출된 시점은 VDOM이 DOM에 모두 적용된 상태이며 커스텀 컴포넌트라면 라이프 사이클, 호스트 컴포넌트라면 auto focus 처리를 해주어야 합니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2135" target="_blank">reconciler > ReactFiberWorkLoop.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> committedExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> committedExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>Update tag는 useEffect()와 useLayoutEffect()에서 달아줍니다.</p>
</blockquote>
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberCommitWork.js#L411" target="_blank">reconciler > ReactFiberCommitWork.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span><span class="token parameter">finishedRoot<span class="token punctuation">,</span> current<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> committedExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>
    <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>
    <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">      <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span>UnmountLayout<span class="token punctuation">,</span> MountLayout<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// layoutEffect</span></span>      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">          instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
              <span class="token punctuation">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// defaultProps 적용</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">          instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span></span>            prevProps<span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
            instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token comment">// commitBeforeMutationEffectOnFiber에서 찍어놨던 스냅샷</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance<span class="token punctuation">:</span> Instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">const</span> props <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">        <span class="token function">commitMount</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// auto-focus</span></span>      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">/*...*/</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">'This unit of work tag should not have side-effects. This error is '</span> <span class="token operator">+</span>
          <span class="token string">'likely caused by a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>MountLayout tag<up>7</up>는 useLayoutEffect() 구현체에서 달아줍니다.</p>
</blockquote>
<ul>
<li>클래스 컴포넌트<up>10</up>는 마운트, 업데이트 여부<up>13</up>에 따라 각각 <code class="language-text">componentDidMount()</code><up>14</up>, <code class="language-text">componentDidUpdate()</code><up>20</up>를 호출합니다.  </li>
<li>함수형 컴포넌트<up>4</up>의 경우 해당 시점에 처리해야할 작업은 layout effect 입니다. </li>
<li>
<p>호스트 컴포넌트<up>29</up>는 auto focus를 지원해주어야 하는 element일 경우 처리<up>34</up>합니다.  </p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-dom/src/client/ReactDOMHostConfig.js#L350" target="_blank">react-dom > client > ReactDOMHostConfig.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">commitMount</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAutoFocusHostComponent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      domElement<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ul>
<p>Commit phase는 여기서 끝입니다. <a href="#commitRootImpl">commitRoot()</a>의 전체 로직을 확인해보세요. 이제는 어렵지 않게 이해하실 수 있지 않을까 기대해봅니다.</p>
<h3 id="-useeffect와-uselayouteffect의-활용법"><a href="#-useeffect%EC%99%80-uselayouteffect%EC%9D%98-%ED%99%9C%EC%9A%A9%EB%B2%95" aria-label=" useeffect와 uselayouteffect의 활용법 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>❗ useEffect()와 useLayoutEffect()의 활용법</h3>
<p>useEffect()와 useLayoutEffect()의 활용도는 실행 시점의 차이에서 옵니다.   </p>
<p>useEffect()를 사용하여 ui와 관련된 작업할 경우, 예를 들면 <u>특정 element를 렌더링 한 후, 각 element의 위치나 크기에 따라서 추가적인 효과를 주었을 때</u> 사용자는 깜빡임 또는 부자연스러운 효과를 눈으로 확인하게 됩니다. 이때 useLayoutEffect()를 사용하면 이 문제점을 해결할 수 있습니다. </p>
<p>useLayoutEffect()의 실행 시점에서는 element가 DOM에 마운트된 상황이므로 참조하여 위치나 크기를 얻어올 수 있지만 아직까지는 call stack를 비워주지 않았으므로 브라우저는 렌더링 작업을 진행하지 못한 상태입니다. 이때 추가적인 ui 작업을 함으로서 브라우저는 마지막 작업물을 기준으로 렌더링하게 만드는 것입니다.  </p>
<p>useLayoutEffect()를 사용할 때 조심해야할 부분은 무거운 작업을 useLayoutEffect()에서 진행하게 된다면 브라우저의 렌더링을 블록킹하게 되는 불상사가 일어나므로 신중히 사용하길 권장하고 있습니다.</p>
<p>다음 예제에서 useLayoutEffect()을 이용하여 화면이 렌더링되기 전에 element를 참조하여 정보를 가지고 올 수 있는지, 렌더링을 블록킹하는지 확인해봅시다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">Foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> increase<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> counterRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>offsetWidth<span class="token punctuation">,</span> offsetHeight<span class="token punctuation">,</span> firstChild<span class="token punctuation">:</span> <span class="token punctuation">{</span> nodeValue <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> counterRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>offsetWidth<span class="token punctuation">,</span> offsetHeight<span class="token punctuation">,</span> nodeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1e8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span>span ref<span class="token operator">=</span><span class="token punctuation">{</span>counterRef<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">increase</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>increase<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
<img src="/path/to/dir/3b9d11346960ed8b5ebd2043544559b7/layout_effect.gif" height="300px" width="100%">
<h1 id="마무리"><a href="#%EB%A7%88%EB%AC%B4%EB%A6%AC" aria-label="마무리 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>마무리</h1>
<p>다음 포스트는 Synthetic Event에 대한 글을 작성할 예정이었습니다. 하지만 다음 메이저 버전인 <a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html" target="_blank">v17</a>에서 이벤트 시스템 구현이 변경됩니다. 그러므로 해당 포스트는 추후 여유가 될 때 변경된 코드를 기준으로 작성하도록 하겠습니다.  </p>
<p>더불어 reconciler 또한 <a href="https://github.com/facebook/react/tree/master/packages/react-reconciler/src" target="_blank">github</a>를 방문해 보시면 업데이트를 진행하고 있다는걸 알 수 있습니다. 하지만 큰 틀은 변경되지 않을 것으로 보이며 큰 걱정없이 지금까지 이해하셨던 설계 모델를 그대로 이해하고 계시면 될 것 같습니다.</p>
<p>여기까지 잘 이해하시면서 넘어오셨을지가 궁금하네요. 아마도 그렇지 않은 분들이 대부분이지 않을까 생각합니다. 개인적으로 리액트를 분석하면서 이해한 것들을 100% 전달해드리지 못했다는 느낌이 들지만 한편으로는 빠져있는 이 부분들은 여러분들이 직접 코드를 분석해가며 채워나가야 할 부분들이라 생각해봅니다.  </p>
<p>긴 글 끝까지 읽어주셔서 감사드립니다. </p></div><hr class="custom-hr"/><div class="bio"><div class="author"><div class="author-description"><a class="link" href="/"><img class="author-image" src="/static/felog-f24356c48475809626ea0c2ac67855c6.png" style="width:72px;height:79px"/></a><div class="author-name"><div><a class="author-name-content"><div><div style="float:left"><svg aria-hidden="true" focusable="false" class="bio_fontaswesome" data-prefix="fas" data-icon="envelope" role="img" width="1em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 496 512"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg> <!-- -->kgc4958@gmail.com<!-- -->ㅤ</div><div style="float:left"><svg class="bio_fontaswesome" width="1.25em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"></path></svg> TMON</div></div></a></div><div class="author-introduction">오픈소스를 톺아보며 매직 코드라 생각했던 부분들의 동작 원리와 의미, 의도를 파악해보고 서로의 생각을 나누기 위한 블로그</div></div></div></div></div><ul class="navigator"><li class="left_navi"><a rel="prev" href="/react/in-depth-react-reconciler_4/">← <!-- -->React 톺아보기 - 05. Reconciler_4</a></li><li class="right_navi"></li></ul><div class="utterences"></div><footer class="footer">©<a href="https://github.com/JaeYeopHan">Goidle</a>, Built with<!-- --> <a href="https://github.com/JaeYeopHan/gatsby-starter-bee">Gatsby-starter-bee</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-154981109-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react/in-depth-react-reconciler_5/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-a9221c1c374395f2ded5.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5efb7b8fb8a6286e0a5c.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6bdb37d3a7ac9f5a4c88.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c9089e990f73b65ff865.js"]};/*]]>*/</script><script src="/webpack-runtime-9f6b1d2a45518b92e568.js" async=""></script><script src="/commons-84551787138db1029baf.js" async=""></script><script src="/styles-f42f8789f3cee93e7f05.js" async=""></script><script src="/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js" async=""></script><script src="/app-a9221c1c374395f2ded5.js" async=""></script></body></html>