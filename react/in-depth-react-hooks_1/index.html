<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, minimum-scale=1, maximum-scale=2"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:Catamaran;font-weight:800;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:56px;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:20px;color:inherit;font-family:Catamaran;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:6px;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:2px;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#0687f0;text-decoration:none;box-shadow:none;}a:hover,a:active{text-decoration:underline;}a.gatsby-resp-image-link{box-shadow:none;text-decoration:none;}a:hover{text-decoration:none;}</style><style data-href="/styles.b6d04d9fc568e0c0c4f5.css">@import url(https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css);@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:100;src:local("Noto Sans KR Thin "),local("Noto Sans KR-Thin"),url(/static/noto-sans-kr-latin-100-2de137ca3e12ea146ee47485a97f1e78.woff2) format("woff2"),url(/static/noto-sans-kr-latin-100-b965647685dd9fc531d1f8a1cc25e024.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:300;src:local("Noto Sans KR Light "),local("Noto Sans KR-Light"),url(/static/noto-sans-kr-latin-300-4f773a0fce88aa857d70b56c5b0a1d26.woff2) format("woff2"),url(/static/noto-sans-kr-latin-300-ee87751dac814562bac316d848e35748.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:400;src:local("Noto Sans KR Regular "),local("Noto Sans KR-Regular"),url(/static/noto-sans-kr-latin-400-be09f2ced7ff9fa6eda5f0416e2fc840.woff2) format("woff2"),url(/static/noto-sans-kr-latin-400-4c50be0fe5b21a153b8e40a392c2d3fe.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:500;src:local("Noto Sans KR Medium "),local("Noto Sans KR-Medium"),url(/static/noto-sans-kr-latin-500-416698c2fc4b3951f8d63d3d2ae23900.woff2) format("woff2"),url(/static/noto-sans-kr-latin-500-28601458e118110e494903a1fcd6dcf5.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:700;src:local("Noto Sans KR Bold "),local("Noto Sans KR-Bold"),url(/static/noto-sans-kr-latin-700-04e782e08729f3725ae5a9c95da0c8ba.woff2) format("woff2"),url(/static/noto-sans-kr-latin-700-b9e989a96027f839a9569d2d011e0b71.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:900;src:local("Noto Sans KR Black "),local("Noto Sans KR-Black"),url(/static/noto-sans-kr-latin-900-c41f1395489a117ca36d550142a1695f.woff2) format("woff2"),url(/static/noto-sans-kr-latin-900-589f5fbf84d9dc9984a969bae969fd60.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:100;src:local("Catamaran Thin "),local("Catamaran-Thin"),url(/static/catamaran-latin-100-3570195a7b5f619dd9b2419d8fa3f089.woff2) format("woff2"),url(/static/catamaran-latin-100-e82908f57f6d2f23eb9876b2d6868195.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:200;src:local("Catamaran Extra Light "),local("Catamaran-Extra Light"),url(/static/catamaran-latin-200-987ea210308405ac77ba2f36430a70c9.woff2) format("woff2"),url(/static/catamaran-latin-200-bb5993d2f001b739bb9ab7c3ed9725c3.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:300;src:local("Catamaran Light "),local("Catamaran-Light"),url(/static/catamaran-latin-300-2b8a4bd13e9d5ba755f010f8732b0bb6.woff2) format("woff2"),url(/static/catamaran-latin-300-c2696c65c33dcf37871b72bad51ee1ce.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:400;src:local("Catamaran Regular "),local("Catamaran-Regular"),url(/static/catamaran-latin-400-640947b787a38ec35d097129637d9130.woff2) format("woff2"),url(/static/catamaran-latin-400-97e5bc807a3e915e3fbf40ce5fcb1128.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:500;src:local("Catamaran Medium "),local("Catamaran-Medium"),url(/static/catamaran-latin-500-884483dd213f37ae3b5c98f73dd190a5.woff2) format("woff2"),url(/static/catamaran-latin-500-412cf386e31213e3601cb2132b9c4c2d.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:600;src:local("Catamaran SemiBold "),local("Catamaran-SemiBold"),url(/static/catamaran-latin-600-eb6ebda25331e50d3f42c45a41f613bb.woff2) format("woff2"),url(/static/catamaran-latin-600-215c58c6114e0556cb1c332c0fda463a.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:700;src:local("Catamaran Bold "),local("Catamaran-Bold"),url(/static/catamaran-latin-700-3196f49881b324fa5a5f937875cc380f.woff2) format("woff2"),url(/static/catamaran-latin-700-05f6e51c518dd3b521b258e5c05d0e72.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:800;src:local("Catamaran ExtraBold "),local("Catamaran-ExtraBold"),url(/static/catamaran-latin-800-601b1d0f1b78fd65c3205b2c004bbe60.woff2) format("woff2"),url(/static/catamaran-latin-800-3b1675e4ede7e86ec79fa84c1203908e.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:900;src:local("Catamaran Black "),local("Catamaran-Black"),url(/static/catamaran-latin-900-6bb5f96614acb7754020b922e1a63d24.woff2) format("woff2"),url(/static/catamaran-latin-900-79292dba48851cc3a212863c860d8f09.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.custom-hr{margin:64px 0;background:linear-gradient(72deg,#291e95,#cc007a);border:none;height:2px}.home-header{margin-top:0;border-bottom:none;font-weight:900;font-size:48px;letter-spacing:-2px}.link{box-shadow:none;text-decoration:none;color:inherit}.switch-container{text-align:right}.switch-container .icon{text-align:center;color:#222;font-size:14px;font-weight:900}.footer{padding-top:52px;text-align:center;font-size:12px}.footer a{text-decoration:none!important}.home{position:absolute;margin-top:-1.5px}body.light{background-color:#fff;color:#615f5f}body.light .home-header{color:#5a5a5a}body.light .bio .author-name-content{background-color:#ecf0f2}body.light .bio .author-introduction{color:#7d7d7d}body.light .bio a{color:navy}body.light .bio .bio_fontaswesome{fill:navy;vertical-align:-.125em}body.light .category-container{border-color:#ecf0f2;border-style:solid;border-width:1px 6px;background-color:#f4f7f8}body.light .category-container .item{border:1px solid #ecf0f2;background-color:#fff;box-shadow:0 1px 1px rgba(0,0,0,.1)}body.light .category-container .item a{color:#666}body.light .category-container .item[aria-selected=true]{border:2px solid #909da1;font-weight:bolder}body.light .category-container .item[aria-selected=true] a{color:#636c6e}body.light .category-container .item .badge{background-color:#f5222d;color:#fff}body.light .thumbnail{background-color:#fff;box-shadow:0 0 12px rgba(122,124,136,.212)}body.light .thumbnail h3{color:#5173b3}body.light .thumbnail p{color:#7d7d7d}body.light .thumbnail:hover{text-shadow:.1px .1px .1px rgba(68,67,67,.925);box-shadow:1px 3px 15px rgba(122,124,136,.432)}body.light .footer,body.light .thumbnail .thumbnail-subinfo{color:#615f5f}body.light .footer a{color:#5a5a5a}body.light .navigator a{background-color:#fceff7;color:#cc007a}body.light :not(pre)>code[class*=language-]{color:#fff;border:1.2px solid hsla(0,0%,100%,.64);background:#7d7d7d}body.dark{background-color:#282c35;color:#dbd8d8}body.dark .home-header{color:#eee}body.dark .bio .author-name-content{background-color:#383636}body.dark .bio .author-introduction{color:#dbd8d8}body.dark .bio a{color:#bb72ec}body.dark .bio .bio_fontaswesome{fill:#bb72ec;vertical-align:-.125em}body.dark .category-container{border-color:#383636;border-style:solid;border-width:1px 6px;background-color:#24272c}body.dark .category-container .item{border:1px solid #383636;background-color:#282c35;box-shadow:0 1px 1px hsla(0,0%,100%,.1)}body.dark .category-container .item a{color:#d8d7d7}body.dark .category-container .item[aria-selected=true]{border:2px solid #666;font-weight:bolder}body.dark .category-container .item[aria-selected=true] a{color:#fff}body.dark .category-container .item .badge{background-color:#d695ab;color:#eee}body.dark .thumbnail{background-color:#282c35;box-shadow:0 0 12px rgba(197,166,201,.2)}body.dark .thumbnail h3{color:#d695ab}body.dark .thumbnail p{color:#dbd8d8}body.dark .thumbnail:hover{box-shadow:1px 1px 13px rgba(195,153,201,.26);text-shadow:.1px .1px .1px #fff}body.dark .footer,body.dark .thumbnail .thumbnail-subinfo{color:#dbd8d8}body.dark .footer a{color:#fff}body.dark blockquote{border-left:4px solid hsla(0,0%,100%,.822)}body.dark h1,body.dark h2{border-bottom-color:hsla(0,0%,100%,.3)}body.dark .navigator a{background-color:#fceff7;color:#cc007a}body.dark td,body.dark th{border-bottom:1px solid hsla(0,0%,100%,.15)}body.dark :not(pre)>code[class*=language-]{color:#c85656;border:1.2px solid rgba(0,0,0,.64);background:#e1e1e1}body.dark hr{background:hsla(0,0%,100%,.3)}body{font-family:Noto Sans KR,sans-serif;background-color:#fff;-webkit-text-size-adjust:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-transition:background-color .3s,color .3s;transition:background-color .3s,color .3s}h1{margin-top:2em;font-size:2.15em}h1,h2{letter-spacing:-1px;border-bottom:transparent!important}h2{margin-top:1.5em;margin-bottom:0;font-size:1.5em}h3{font-weight:700;margin-bottom:.1rem;margin-top:0;letter-spacing:-1px}@media (max-width:500px){.home-header{font-size:40px}}.post-date{text-align:right;font-size:12px;font-style:italic}.bio{margin-bottom:15px}.bio .author-description{display:flex}.bio .author-image{margin-top:0;margin-right:12px;margin-bottom:0;min-width:95px}.bio .author-name{display:flex;flex-direction:column;justify-content:center}.bio .author-name-prefix{font-size:90%;margin-right:4px}.bio .author-name-content{display:inline-block;font-size:95%;padding:2px 6px;font-weight:bolder;border-radius:8px;-webkit-transform-origin:center;transform-origin:center}.bio .author-introduction{margin-top:4px;font-size:80%;line-height:1.4}.bio .author-socials{margin-top:4px}.bio a{margin-right:8px;font-size:80%;cursor:pointer}.bio a.visited{text-decoration:none}@-webkit-keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}@keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}.navigator{margin:40px 0;list-style:none;padding:0;overflow:hidden}.navigator li{margin-bottom:12px}.navigator li .right_navi{float:left}.navigator li .left_navi{float:right}.navigator a{padding:7px 16px 8px;border-radius:6px;font-size:12px;opacity:.8}.post h1{font-size:2.5rem;line-height:1.1}.post h2{margin-top:3.5rem;font-size:1.73286rem}.post h2,.post p{margin-bottom:1.75rem}.post li{margin-bottom:.875rem}.post .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1.2em;margin-left:-1.2em;padding-right:1em;padding-left:.75em;border-left:.35em solid #0687f0}.post blockquote{color:#999}.post code[class*=language-],.post pre[class*=language-]{color:#e0e0e0;background:none;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none}.post pre[class*=language-]::-webkit-scrollbar{display:none}.post pre[class*=language-]{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:.6em}.post :not(pre)>code[class*=language-],.post pre[class*=language-]{background:#212121}.post :not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.5em;white-space:normal;color:#d66587;margin:0 .1em}.post .token.block-comment,.post .token.cdata,.post .token.comment,.post .token.doctype,.post .token.prolog{color:#616161}.post .token.punctuation{color:#e0e0e0}.post .token.attr-name,.post .token.deleted,.post .token.namespace,.post .token.tag{color:#e2777a}.post .token.function-name{color:#6196cc}.post .token.boolean,.post .token.function,.post .token.number{color:#ff9100}.post .token.class-name,.post .token.constant,.post .token.property,.post .token.symbol{color:#ff0}.post .token.atrule,.post .token.builtin,.post .token.important,.post .token.keyword,.post .token.selector{color:#b388ff}.post .token.attr-value,.post .token.char,.post .token.regex,.post .token.string,.post .token.variable{color:#00e676}.post .token.entity,.post .token.operator,.post .token.url{color:#67cdcc}.post .token.bold,.post .token.important{font-weight:700}.post .token.italic{font-style:italic}.post .token.entity{cursor:help}.post .token.inserted{color:green}.dark .anchor{fill:#dbd8d8}.light .anchor{fill:#615f5f}td[align=center]:first-child,th[align=center]:first-child{text-align:center!important;font-weight:bolder!important}table{margin-top:100px}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none;margin:1.2em}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.tldr{padding-left:1em;margin-top:-26px}h3{margin-bottom:.5em}h3 code.language-text{font-size:16px!important}up{top:-.5em;font-size:75%}down,up{position:relative;line-height:0;vertical-align:baseline;font-weight:500}down{font-size:85%}figcaption{padding:3px;text-align:center}center,figcaption{font:italic smaller sans-serif;font-weight:700;font-size:14px}center{top:-.7em;position:relative}ol li,ol li p{margin-bottom:.3rem!important}.gatsby-resp-image-wrapper{margin-bottom:20px}p{position:relative}a.code_link{position:absolute;font-size:small;bottom:-2rem;left:1rem}a.code_link_2{bottom:-2rem}a.code_link_2,a.code_link_3{position:absolute;font-size:small;left:3.1rem;z-index:999}a.code_link_3{bottom:-2.5rem}a.code_link_4{position:absolute;font-size:small;bottom:-3rem;left:1rem}h4{font-weight:700}a.code_link_5{position:absolute;font-size:small;bottom:-3rem;left:3.1rem;z-index:999}strong{font-weight:700}a.code_link_6{position:absolute;font-size:small;bottom:-2.5rem;z-index:999;left:1rem}.item{position:relative}.item .badge{display:inline-block;position:absolute;top:1px;right:3px;-webkit-transform:translate(50%,-50%);transform:translate(50%,-50%);border-radius:10px;box-shadow:0 0 0 1px;padding:8px 7px;z-index:999;font-weight:700}.category-container{position:sticky;position:-webkit-sticky;top:0;line-height:0;white-space:nowrap;overflow-x:scroll;-ms-overflow-style:none;overflow:-moz-scrollbars-none;z-index:1;padding:6px 20px;margin:0 -5px!important}.category-container .item{display:inline-block;margin:.25rem 7px .25rem 0;border-radius:15px;white-space:normal;box-sizing:border-box;cursor:pointer}.category-container .item div{display:block;padding:14px 16px 16px;font-size:13px;box-sizing:border-box}.category-container .item:last-child{margin-right:0}.category-container::-webkit-scrollbar{display:none}.thumbnail-container{min-height:calc(100vh - 3.5rem)}.thumbnail{display:block;margin-top:12px;padding:15px 15px 12px;-webkit-transition:box-shadow .3s,text-shadow .3s,opacity .4s;transition:box-shadow .3s,text-shadow .3s,opacity .4s;opacity:0;border-radius:10px}.thumbnail p{font-size:90%;line-height:1.4}.thumbnail .thumbnail-subinfo{font-size:.75rem;margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid #e8e8e8}.thumbnail.visible{opacity:1}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ffffff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><meta name="generator" content="Gatsby 2.18.10"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">React 톺아보기 - 03. Hooks_1 | Deep Dive Magic Code</title><meta data-react-helmet="true" name="description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM…"/><meta data-react-helmet="true" property="og:title" content="React 톺아보기 - 03. Hooks_1 | Deep Dive Magic Code"/><meta data-react-helmet="true" property="og:description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다. 포스트별 주제 훅을 통해 컴포넌트 상태를 업데이트한다. 업데이트를 반영할 Work를 scheduler에게 전달하고 scheduler는 스케줄링된 Task를 적절한 시기에 실행한다. Work을 통해 VDOM…"/><meta data-react-helmet="true" property="og:image" content="/static/felog-f24356c48475809626ea0c2ac67855c6.png"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="google-site-verification" content="o402P1kCwteUVT_5s9zR21dD9lTF4ALZNLms22CIMx4"/><meta data-react-helmet="true" name="keywords" content="react, redux, javascript, web, development, frontend, 리액트, react, fiber, hook, hooks, useState, useEffect, useLayoutEffect, useCallback"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/app-69573b14c89d32433a71.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js"/><link as="script" rel="preload" href="/styles-f42f8789f3cee93e7f05.js"/><link as="script" rel="preload" href="/commons-e292b02c69f3a51ef82a.js"/><link as="script" rel="preload" href="/webpack-runtime-9f6b1d2a45518b92e568.js"/><link as="fetch" rel="preload" href="/page-data/react/in-depth-react-hooks_1/page-data.json" crossorigin="anonymous"/></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:52rem;padding:2.4375rem 1.21875rem" class="post"><a class="link" href="/"><svg class="home" width="1.125em" font-size="2em" overflow="visible" viewBox="0 0 576 512"><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg></a><div class="switch-container"><label for="normal-switch"><div style="position:relative;display:inline-block;text-align:left;opacity:1;direction:ltr;border-radius:12px;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s;touch-action:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none"><div class="react-switch-bg" style="height:24px;width:48px;margin:0;position:relative;background:#d9dfe2;border-radius:12px;cursor:pointer;-webkit-transition:background 0.25s;-moz-transition:background 0.25s;transition:background 0.25s"><div style="height:24px;width:26px;position:relative;opacity:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon checkedIcon">D</div></div><div style="height:24px;width:26px;position:absolute;opacity:1;right:0;top:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon uncheckedIcon">L</div></div></div><div class="react-switch-handle" style="height:22px;width:22px;background:#ffffff;display:inline-block;cursor:pointer;border-radius:50%;position:absolute;transform:translateX(1px);top:1px;outline:0;border:0;-webkit-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;-moz-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s"></div><input type="checkbox" role="switch" style="border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px" id="normal-switch"/></div></label></div><h1>React 톺아보기 - 03. Hooks_1</h1><p class="post-date">a day ago</p><div><blockquote>
<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>
</blockquote>
<p>각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다.</p>
<h3 id="포스트별-주제"><a href="#%ED%8F%AC%EC%8A%A4%ED%8A%B8%EB%B3%84-%EC%A3%BC%EC%A0%9C" aria-label="포스트별 주제 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>포스트별 주제</h3>
<ol>
<li>
<h3 id="u훅을-통해-컴포넌트-상태를-업데이트한다u"><a href="#u%ED%9B%85%EC%9D%84-%ED%86%B5%ED%95%B4-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EC%83%81%ED%83%9C%EB%A5%BC-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%ED%95%9C%EB%8B%A4u" aria-label="u훅을 통해 컴포넌트 상태를 업데이트한다u permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><u>훅을 통해 컴포넌트 상태를 업데이트한다.</u></h3>
</li>
<li>업데이트를 반영할 <strong>Work</strong>를 <strong>scheduler</strong>에게 전달하고 <strong>scheduler</strong>는 스케줄링된 <strong>Task</strong>를 적절한 시기에 실행한다.</li>
<li><strong>Work</strong>을 통해 VDOM 재조정 작업을 진행한다.</li>
<li>완성된 VDOM을 commit phase를 통해 DOM에 적용한다.</li>
<li>사용자의 상호작용으로 이벤트가 발생하고 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>
</ol>
<hr>
<p>이번 포스트에서는 훅의 동작 원리에 대해 알아볼 것이며 분석 순서는 아래와 같습니다.</p>
<ol>
<li>훅 구현체 찾아가기</li>
<li>훅은 어떻게 생성되는가? (마운트)</li>
<li>훅은 어떻게 상태를 변경하고 컴포넌트를 리-렌더링시키는가?</li>
<li>상태가 변경되어 리-렌더될 때 변경된 상태 값은 어떻게 가지고 오는 것일까? (업데이트)</li>
</ol>
<p>우리는 훅을 사용할 때 코어 패키지에서 불러 오지만 실제 구현체는 외부 모듈에 있습니다. 때문에 분석의 시작은 <em>코어가 어떻게 외부 모듈에 있는 훅 구현체를 가지고와서 제공하는지?</em> 에서 부터 출발합니다.</p>
<blockquote>
<p>❗ useState()를 기준으로 진행합니다. useEffect()와 useLayoutEffect()는 <strong>reconciler</strong>에서 다루며 나머지 훅은 짧게 등장하거나 혹은 분석대상에서 제외됩니다.</p>
</blockquote>
<h1 id="1-훅-구현체-찾아가기"><a href="#1-%ED%9B%85-%EA%B5%AC%ED%98%84%EC%B2%B4-%EC%B0%BE%EC%95%84%EA%B0%80%EA%B8%B0" aria-label="1 훅 구현체 찾아가기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 훅 구현체 찾아가기</h1>
<h2 id="1---1-hook의-구현체는-어디에-있을까"><a href="#1---1-hook%EC%9D%98-%EA%B5%AC%ED%98%84%EC%B2%B4%EB%8A%94-%EC%96%B4%EB%94%94%EC%97%90-%EC%9E%88%EC%9D%84%EA%B9%8C" aria-label="1   1 hook의 구현체는 어디에 있을까 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1 - 1 Hook의 구현체는 어디에 있을까?</h2>
<p>분석을 시작하기 가장 좋은 방법은 분석할 함수를 어디서 어떻게 가져오는지 먼저 확인하는 것입니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react/src/React.js#L66" target="_blank">react > React.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactHooks'</span></span><span class="token keyword">import</span> ReactSharedInternals <span class="token keyword">from</span> <span class="token string">'./ReactSharedInternals'</span> <span class="token comment">// 의존성을 주입받는 징검다리</span>

<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">,</span>
  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">:</span> ReactSharedInternals<span class="token punctuation">,</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React</code></pre></div>
<p>개발자가 코어를 통해 가져오는 훅은 <code class="language-text">ReactHooks.js</code> 모듈에서 가져오고 있습니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactHooks.js#L21" target="_blank">react > ReactHooks.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">import</span> ReactCurrentDispatcher <span class="token keyword">from</span> <span class="token string">'./ReactCurrentDispatcher'</span>

<span class="token keyword">function</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current</span>  <span class="token keyword">return</span> dispatcher
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">create<span class="token punctuation">,</span> inputs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span>create<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/*...*/</span></code></pre></div>
<p>우리가 사용하는 훅은 <code class="language-text">ReactCurrentDispatcher.js</code> 모듈에서 가지고온 <code class="language-text">dispatcher</code>의 메소드 였네요.<br>
함수를 호출해 반환받은 결괏값을 사용하는 모습이 꼭 동적 바인딩을 위한 패턴 같습니다. 아직 원하는 결과를 얻지 못했으니 의심가는 <code class="language-text">ReactCurrentDispatcher.current</code>를 따라가보겠습니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactCurrentDispatcher.js#L15" target="_blank">react > ReactCurrentDispatcher.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">const</span> ReactCurrentDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  current<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactCurrentDispatcher</code></pre></div>
<p>아무것도 없습니다.. 그냥 객체 하나가 끝입니다.</p>
<p>코어와 훅 사이의 관계에 대해서 좀만 더 생각해보자면 코어는 컴포넌트의 모델인 react element만 알고 있습니다. 이 element를 인스턴스화되기 전인 클래스라고 생각해보자면 훅은 이 클래스의 인스턴스화된 객체의 상태 값을 관리하는 역할을 합니다. 이렇게 따져보면 둘 사이의 괴리감이 존재합니다.</p>
<p>react element는 fiber로 확장되고 나서야 살아 숨 쉬게 됩니다. 그리고 이 역할은 <strong>reconciler</strong>가 가지고 있습니다. 그러므로 훅 또한 <strong>reconciler</strong>가 알고 있는 것이 맞습니다.</p>
<p>근데 위 리액트 코어를 보면 어디에도 <strong>reconciler</strong>에서 훅을 가져오는 부분을 확인하지 못했습니다. 그렇다는 말은 반대로 훅 객체를 외부에서 내부로 ReactCurrentDispatcher.current를 통해 주입해준다는 말이 됩니다.  </p>
<p>이렇듯 코어는 다른 패키지의 기능을 개발자에게 제공해 줄 때 의존성을 자기가 만들지 않고 외부에서 주입 받습니다. 스프링의 DI(Dependency Injection) 처럼요.</p>
<p>그리고 한발 더 나아가 리액트는 외부에서 의존성을 주입할 때 코어에 직접 주입하지 않습니다. 중간자를 하나 더 두게 되는데 코어에서는 ReactSharedInternals.js가 이에 해당하고 리액트 프로젝트 전체로 보면 shared라는 패키지가 이 역할을 합니다.</p>
<h3 id="1-의존성을-관리하는-reactsharedinternalsjs와-shared-패키지"><a href="#1-%EC%9D%98%EC%A1%B4%EC%84%B1%EC%9D%84-%EA%B4%80%EB%A6%AC%ED%95%98%EB%8A%94-reactsharedinternalsjs%EC%99%80-shared-%ED%8C%A8%ED%82%A4%EC%A7%80" aria-label="1 의존성을 관리하는 reactsharedinternalsjs와 shared 패키지 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1) 의존성을 관리하는 ReactSharedInternals.js와 shared 패키지</h3>
<p>먼저 ReactSharedInternals.js는 외부에서 주입받길 기다리는 모듈들의 대기소 같은 곳입니다. <code class="language-text">ReactCurrentDispatcher</code> 또한 여기에서 훅을 주입받길 기다리고 있습니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react/src/ReactSharedInternals.js" target="_blank">react > ReactSharedInternals.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="gatsby-highlight-code-line"><span class="token keyword">import</span> ReactCurrentDispatcher <span class="token keyword">from</span> <span class="token string">'./ReactCurrentDispatcher'</span></span><span class="token keyword">import</span> ReactCurrentBatchConfig <span class="token keyword">from</span> <span class="token string">'./ReactCurrentBatchConfig'</span>
<span class="token keyword">import</span> ReactCurrentOwner <span class="token keyword">from</span> <span class="token string">'./ReactCurrentOwner'</span>
<span class="token comment">/*...*/</span>

<span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  ReactCurrentDispatcher<span class="token punctuation">,</span></span>  ReactCurrentBatchConfig<span class="token punctuation">,</span>
  ReactCurrentOwner<span class="token punctuation">,</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactSharedInternals</code></pre></div>
<p>shared는 모든 패키지가 공유하는 공통 폴더의 역할을 합니다. 그 중 코어의 출입구 역할을 하는 모듈이 shared의 ReactSharedInternals.js입니다. <strong>reconciler</strong> 역시 훅을 주입할 때 Shared 패키지를 통해서 동적으로 구현체를 주입합니다. </p>
<blockquote>
<p>코어 모듈의 ReactSharedInternals.js와 이름이 같음을 유의하세요.</p>
</blockquote>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactSharedInternals.js#L10" target="_blank">shared > ReactSharedInternals.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span>
  React<span class="token punctuation">.</span>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED <span class="token comment">// core의 ReactSharedInternals.js</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ReactSharedInternals<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'ReactCurrentDispatcher'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReactSharedInternals<span class="token punctuation">.</span>ReactCurrentDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*...*/</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactSharedInternals</code></pre></div>
<p>훅이 개발자에게 도달되는 흐름은 다음과 같습니다.<br>
<strong>reconciler -> shared/ReactSharedInternal -> react/ReactSharedInternal -> react/ReactCurrentDispatcher -> react/ReactHooks -> react -> 개발자</strong></p>
<p>이제 우리는 훅의 위치를 <em>shared/ReactSharedInternal.js를 import하고 ReactCurrentDispatcher를 사용하고 있는 곳</em>을 찾아가면 확인할 수 있을 것이란 짐작을 할 수 있습니다.  </p>
<h2 id="1---2-hook-구현체-주입"><a href="#1---2-hook-%EA%B5%AC%ED%98%84%EC%B2%B4-%EC%A3%BC%EC%9E%85" aria-label="1   2 hook 구현체 주입 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1 - 2 Hook 구현체 주입</h2>
<blockquote>
<p>본격적으로 분석을 시작하기 전에 알려 드립니다.</p>
<ul>
<li>함수 내부에서 선언된 지역변수인지 모듈 최상단에 선언된 전역변수인지 잘 확인하시길 바랍니다.</li>
<li>설명하지 않고 넘어가는 코드는 크게 신경 쓰지 않으셔도 됩니다. 복잡하니 지금은 생략하고 뒷부분에서 다룰 것입니다.</li>
<li>실제 코드를 보면 __DEV__로 감싸진 코드들을 자주 보실 텐데 개발 모드에서만 사용됨을 뜻하므로 산뜻하게 무시해주시면 됩니다.</li>
<li>분석하기에 타입이 있으면 좋을 부분들은 타입을 제거하지 않았습니다.</li>
</ul>
</blockquote>
<p>훅 주입은 reconciler/renderWithHooks()에서 이루어집니다. 함수 이름에서 느껴지시나요? 컴포넌트 호출 또한 여기서 합니다. 이 함수는 render phase에서 실행되는데 그때 가서 자세히 다루고 지금은 훅과 관련된 코드들만 뜯어와서 보도록 하겠습니다.</p>
<anchor id="renderWithHooks" />
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L375" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts">  
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  props<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  refOrContext<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  nextRenderExpirationTime<span class="token punctuation">:</span> ExpirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress <span class="token comment">// 현재 작업 중인 fiber를 전역으로 잡아둠</span>
  nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token punctuation">:</span> <span class="token keyword">null</span>

<span class="gatsby-highlight-code-line">  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span></span><span class="gatsby-highlight-code-line">    nextCurrentHook <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> HooksDispatcherOnMount <span class="token punctuation">:</span> HooksDispatcherOnUpdate</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span>

  <span class="token comment">/*컴포넌트 재호출 로직..*/</span>

  <span class="token keyword">const</span> renderedWork <span class="token operator">=</span> currentlyRenderingFiber
  renderedWork<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> firstWorkInProgressHook

  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p><strong>reconciler</strong> 패키지의 여러 모듈은 자신의 컨텍스트를 현재 작업 중인 컴포넌트 전용으로 사용합니다. 이 말이 무슨 뜻이냐면 해당 모듈에서 선언되는
모든 전역 변수들(<down>firstWorkInProgressHook, nextCurrentHook..</down>)은 작업 중인 컴포넌트에만 국한되는 상태 값으로 관리한다는 뜻입니다.<br>
컴포넌트의 작업이 끝나게 되면 모두 초기화시켜 다음 컴포넌트에서 사용할 수 있도록 준비시켜 놓습니다.<br>
그렇기 때문에 전역변수인지 지역변수인지 유심히 살펴보시길 바랍니다.</p>
</blockquote>
<ul>
<li><code class="language-text">Component</code>는 fiber의 type에서 꺼낸 온 것인데 함수형 컴포넌트의 경우 개발자가 작성한 함수가 type이 됩니다.<br>
컴포넌트를 호출<up>17</up>할 때 해당 컴포넌트가 마운트되어야 한다면 전역변수 <code class="language-text">firstWorkInProgressHook</code>에 훅 리스트가 생성되어 저장됩니다. 이 변수를 fiber의 <code class="language-text">memoizedState</code>에 저장<up>22</up>해 놓음으로써 훅을 컴포넌트와 매핑시켜 줍니다.</li>
<li>이제 라인 12를 이해할 수 있습니다. <code class="language-text">memoizedState</code>가 null이 아니라면<up>12</up> 해당 컴포넌트는 마운트가 아닌 업데이트 상태이며 훅 리스트 또한 이미 존재함을 뜻합니다. 이를 이용하여 마운트 여부를 확인<up>15</up> 합니다. 그리고 거기에 맞게 훅 구현체를 다르게 사용합니다. 즉 컴포넌트가 마운트 될 때 훅은 마운트용 구현체를 사용할 것이고 그 이후에는 컴포넌트가 언마운트되지 않는 한 계속해서 업데이트용 구현체를 사용하게 됩니다.</li>
<li>라인 24를 보면 추가적으로 <code class="language-text">ContextOnlyDispatcher</code> 훅 구현체를 주입해주는 걸 확인할 수 있습니다. 이는 개발자의 실수로 컴포넌트 실행 시점이 지났음에도 훅 호출이 발생하는 상황을 대비하여 개발자가 올바르게 훅을 사용할 수 있도록 에러를 던져주는 장치입니다.</li>
</ul>
<p><a class="code_link_4" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1362" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token comment">// mount</span>
<span class="token keyword">const</span> HooksDispatcherOnMount <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> mountState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> mountEffect<span class="token punctuation">,</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// update</span>
<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> updateState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> updateEffect<span class="token punctuation">,</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// invalid hook call</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextOnlyDispatcher<span class="token punctuation">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<center>상황별 훅 구현체</center>
<p>훅 구현체는 찾았습니다. 그렇다면 컴포넌트와 매핑되는 훅 본체는 어떻게 생성되는 것일까요?</p>
<h1 id="2-훅은-어떻게-생성되는가"><a href="#2-%ED%9B%85%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%83%9D%EC%84%B1%EB%90%98%EB%8A%94%EA%B0%80" aria-label="2 훅은 어떻게 생성되는가 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. 훅은 어떻게 생성되는가?</h1>
<anchor id="mountWorkInProgressHook">
<h2 id="2---1-훅-객체-만들기"><a href="#2---1-%ED%9B%85-%EA%B0%9D%EC%B2%B4-%EB%A7%8C%EB%93%A4%EA%B8%B0" aria-label="2   1 훅 객체 만들기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2 - 1 훅 객체 만들기</h2>
<p>컴포넌트가 마운트 될 때 useState()를 호출할 경우 fiber의 memoizedState는 null이므로 mount 구현체인 <code class="language-text">mountState()</code>를 사용하게 됩니다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L823" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 훅 객체를 생성한다.</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code></pre></div>
<p>먼저 훅 객체부터 만들어 줍니다.</p>
<anchor id="hook_object">
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L572" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">    
<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// hook 객체에 대해서는 업데이트 구현체에서 자세히 다룹니다.</span>
  <span class="token keyword">const</span> hook<span class="token punctuation">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 컴포넌트에 적용된 마지막 상태 값</span>
    queue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 훅이 호출될 때마다 update를 연결 리스트로 queue에 집어넣습니다.</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 다음 훅을 가리키는 포인터</span>

    <span class="token comment">// 업데이트 구현체에서 설명</span>
    baseState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    baseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 맨 처음 실행되는 훅인 경우 연결 리스트의 head로 잡아둠</span>
    firstWorkInProgressHook <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 두번 째부터는 연결 리스트에 추가</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<h3 id="연결-리스트"><a href="#%EC%97%B0%EA%B2%B0-%EB%A6%AC%EC%8A%A4%ED%8A%B8" aria-label="연결 리스트 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>연결 리스트</h3>
<p>리액트는 많은 곳에서 built-in collection 대신 연결 리스트를 이용하여 구현하였습니다. 지금까지 확인한 것만 짚어 보자면 fiber 그 자체가 effect 연결 리스트의 노드였으며, 컴포넌트와 여러 훅을 매핑 시키기 위해, 하나의 훅이 여러 번 호출될 때 정보를 저장하기 위한 queue 등이 있었습니다.</p>
<p>built-in collection이 아닌 연결리스트를 사용하여 구현한 이유는 리스트 탐색 흐름 제어나 노드 삭제 등 조작이 쉽고 리스트 병합에 많은 리소스가 필요하지 않는다는 것입니다. 또한, 랜덤 액세스가 필요한 부분이 없으므로 더욱이 연결리스트를 쓰지 않을 이유가 없습니다.</p>
</blockquote>
<p><code class="language-text">firstWorkInProgressHook</code>은 훅 연결 리스트의 head로 renderWithHooks()에서 이미 봤듯이 컴포넌트 실행이 끝났을 때 fiber에 저장되어 컴포넌트와 훅 리스트를 연결해주고 <code class="language-text">workInProgressHook</code>은 현재 처리되고 있는 훅을 나타내면서 동시에 리스트의 tail 포인터로 사용합니다. </p>
<p>여러 블로그에서 훅을 설명할 때 배열을 이용하여 설명하지만 우리는 이제 실제 코드를 통해 연결 리스트로 되어 있다는 걸 알 수 있습니다. 추후에 업데이트 구현체를 보면 왜 훅의 순서가 항상 같아야 하는지에 대한 이유도 명확하게 알 수 있습니다.</p>
<p>훅 객체를 생성했으니 계속해서 mountState()의 분석을 진행해봅시다.</p>
<p><a class="code_link" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L827" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// const hook = mountWorkInProgressHook();</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 생성자 함수일 경우</span>
    initialState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> initialState
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code></pre></div>
<p>훅을 사용할 때 인자로 넘어오는 <code class="language-text">initialState</code>가 함수이면 바로 실행해서 결괏값을 얻어옵니다. 이 이후에는 mount 구현체가 아닌 update 구현체를 사용하므로 initialState가 실행되는 일은 없습니다.</p>
<h2 id="2---2-update를-담을-queue-생성"><a href="#2---2-update%EB%A5%BC-%EB%8B%B4%EC%9D%84-queue-%EC%83%9D%EC%84%B1" aria-label="2   2 update를 담을 queue 생성 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2 - 2 update를 담을 queue 생성</h2>
<p>훅을 이용하여 컴포넌트 상태를 변경하고자 할 때 업데이트 정보를 담고 있는 update 객체가 생성됩니다. 이 객체는 훅의 queue에 저장됩니다. 가령 한 번의 컴포넌트 호출에서 단일 훅의 setState()가 여러 번 호출되었다면 매 호출 생성된 update 객체는 이 queue에 쌓이게 되는 것입니다. 그 후 컴포넌트가 리-렌더링 될 때 queue에 저장되어 있던 update을 차례대로 실행해 최종적으로 적용될 state를 도출하게 됩니다.</p>
<anchor id="create_queue">
<p><a class="code_link_2" href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L831" target="_blank">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber 0" class="language-js line-numbers"><code class="language-js">  
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// hook.memoizedState = hook.baseState = initialState;</span>

  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
    last<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 마지막 update</span>
    dispatch<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// push 함수</span>

    lastRenderedReducer<span class="token punctuation">:</span> basicStateReducer<span class="token punctuation">,</span>
    lastRenderedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    currentlyRenderingFiber<span class="token punctuation">,</span>
    queue
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">basicStateReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">dispatch</code>는 <code class="language-text">queue</code>의 push 함수입니다. <code class="language-text">dispatch</code> 할당<up>14</up>을 자세히 보면 bind()를 통해 인자를 잡아둔 상태로 외부에 노출<up>19</up>시키고 있습니다. dispatch는 홀로 외부로 노출되기 때문에 필요한 인자들을 잡아둘 필요가 있습니다. 그 중 하나는 훅과 매핑되는 컴포넌트의 fiber<up>16</up>이며 다른 하나는 자신의 존재 목적인 queue입니다.</p>
<p>마지막에 반환하는 배열<up>19</up>이 바로 우리가 사용하고 있는 <code class="language-text">const [foo, setFoo] = useState(0)</code>가 되겠습니다.</p>
<p>훅과 update에 대해 혹시나 혼동될까 한 번 더 짚고 가자면 하나의 컴포넌트에서 여러 훅이 실행될 때는 훅 자체의 연결 리스트로 저장되고 그 중 단일 훅의 dispatchAction()이 여러 번 호출될 때는 해당 훅 객체의 queue에 update를 연결 리스트로 저장하는 것입니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token constant">FC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// aHook</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>b<span class="token punctuation">,</span> setB<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// bHook</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// firstUpdate</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// secondUpdate</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// thirdUpdate</span>

 <span class="token comment">/*
  *  fiber의 훅 리스트
  *  fiber.memoizedState => aHook.next => bHook.next => null
  *
  *  aHook의 queue
  *  fiber.memoizedState => aHook.queue.last => thirdUpdate.next =>
  *  firstUpdate.next => secondUpdate.next => thirdUpdate.next => firstUpdate
  */</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>queue가 원형 연결 리스트(Circular Linked List)인 이유는 업데이트 구현체에서 확인합니다.</p>
</blockquote>
<h1 id="3-훅은-어떻게-상태를-변경하고-컴포넌트를-리-렌더링시키는가"><a href="#3-%ED%9B%85%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%83%81%ED%83%9C%EB%A5%BC-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B3%A0-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8%EB%A5%BC-%EB%A6%AC-%EB%A0%8C%EB%8D%94%EB%A7%81%EC%8B%9C%ED%82%A4%EB%8A%94%EA%B0%80" aria-label="3 훅은 어떻게 상태를 변경하고 컴포넌트를 리 렌더링시키는가 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 훅은 어떻게 상태를 변경하고 컴포넌트를 리-렌더링시키는가?</h1>
<h2 id="3---1-훅-상태를-업데이트하는-dispatchaction"><a href="#3---1-%ED%9B%85-%EC%83%81%ED%83%9C%EB%A5%BC-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%ED%95%98%EB%8A%94-dispatchaction" aria-label="3   1 훅 상태를 업데이트하는 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3 - 1 훅 상태를 업데이트하는 dispatchAction</h2>
<p>dispatchAction()은 queue에 update를 push함과 동시에 <strong>scheduler</strong>에게 <strong>Work</strong>를 예약하는 함수입니다.</p>
<anchor id="dispatchAction" />
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1221" target="_blank" class="code_link_2">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    fiber <span class="token operator">===</span> currentlyRenderingFiber <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate <span class="token operator">===</span> currentlyRenderingFiber<span class="token punctuation">)</span></span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render phase update</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// idle update</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>재조정 작업과 관련된 <strong>reconciler</strong> 코드를 들여다 보면 render phase 도중에 발생한 것인지<up>5</up> 아니면 유휴 상태에서 발생한 것인지<up>10</up>에 따른 분기 처리를 자주 확인할 수 있습니다. 두 케이스 모두 처리해야 할 방법과 최적화 방식이 조금씩 다르므로 현재 분석하고 있는 코드가 어떤 상황에 위치해 있는지 정확히 알고 있어야 이해하기 쉽습니다.</p>
<h3 id="render-phase-update"><a href="#render-phase-update" aria-label="render phase update permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Render phase update</h3>
<p>컴포넌트가 렌더링 되고 있는 상황에서 추가로 업데이트가 발생할 경우를 말합니다.<br>
아래 코드에서 버튼을 클릭했을 때 컴포넌트는 변경된 상태 값을 반영하기 위해 호출되는데 <code class="language-text">setA(2)</code>로 인해 추가적인 업데이트가 발생한 경우입니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token constant">FC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
</blockquote>
<p>먼저 if 문의 조건이 무엇을 뜻하는지부터 알아보겠습니다.<br>
<code class="language-text">currentlyRenderingFiber</code>는 renderWithHooks()에서 workInProgress로 할당됩니다. 그리고 renderWithHooks()는 render phase 진행 중에 호출되는 함수이죠. 그러니 <code class="language-text">currentlyRenderingFiber</code>가 비어있지 않다는 건<up>6 ~ 7</up> render phase가 진행 중이라는 뜻입니다.</p>
<p>currentlyRenderingFiber를 이용하여 render phase를 판단하는 건 대충 알겠는데 그렇다면 왜 <code class="language-text">fiber</code>와 <code class="language-text">alternate</code>를 동시에 비교하는 것일까요?</p>
<p>VDOM은 하나의 노드를 current와 workInProgress로 관리한다고 했습니다. 하지만 우리는 fiber를 bind()를 통해 고정해 놨습니다. 문제는 current와 workInProgress는 고정이 아닌 commit phase를 지나면 서로 교체 된다는 점입니다. 그래서 현재 작업 중인 currentlyRenderingFiber가 둘 중 어떤 것인지 알 수가 없습니다. 이 때문에 fiber와 alternate를 모두 비교해야지만 올바르게 render phase update임을 확인할 수 있습니다.</p>
<p>다음으로 분기 로직 중 idle update를 먼저 알아보겠습니다.</p>
<h2 id="3---2-유휴-상태에서의-dispatchaction"><a href="#3---2-%EC%9C%A0%ED%9C%B4-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C%EC%9D%98-dispatchaction" aria-label="3   2 유휴 상태에서의 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3 - 2 유휴 상태에서의 dispatchAction</h2>
<p>dispatchAction()이 하는 일은 다음과 같습니다.</p>
<ol>
<li>사용자의 업데이트 정보를 담은 <code class="language-text">update</code>객체를 만든다.</li>
<li><code class="language-text">update</code>를 <code class="language-text">queue</code>에 저장한다.</li>
<li>불필요한 렌더링이 발생하지 않도록 최적화를 한다.</li>
<li>업데이트를 적용하기 위해 <strong>Work</strong>를 스케줄링한다.</li>
</ol>
<p>위 내용은 idle update일 경우이고 render phase update는 또 4번을 제외하고는 로직이 다릅니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1275" target="_blank" class="code_link_2">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// const alternate = fiber.alternate</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render phase update</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 시간을 구하는 부분은 잠시 생략하고 포스트 마지막에 다루겠습니다.
    const currentTime = requestCurrentTimeForUpdate()
    const suspenseConfig = requestCurrentSuspenseConfig()
    const expirationTime = computeExpirationForFiber(
      currentTime,
      fiber,
      suspenseConfig
    )
    */</span>

    <span class="token comment">// update 생성</span>
    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
      expirationTime<span class="token punctuation">,</span>
      action<span class="token punctuation">,</span> <span class="token comment">// setState()의 인자</span>
      next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 노드 포인터</span>
      <span class="token comment">// 이하 최적화에 사용되는 속성</span>
      eagerReducer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      eagerState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// update를 queue에 추가</span>
    <span class="token keyword">const</span> last <span class="token operator">=</span> queue<span class="token punctuation">.</span>last
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the first update. Create a circular list.</span>
      update<span class="token punctuation">.</span>next <span class="token operator">=</span> update
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> first <span class="token operator">=</span> last<span class="token punctuation">.</span>next
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Still circular.</span>
        update<span class="token punctuation">.</span>next <span class="token operator">=</span> first
      <span class="token punctuation">}</span>
      last<span class="token punctuation">.</span>next <span class="token operator">=</span> update
    <span class="token punctuation">}</span>

    queue<span class="token punctuation">.</span>last <span class="token operator">=</span> update
    <span class="token comment">/*...*/</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>update를 queue에 추가할 때는 연결 리스트로 추가<up>28 ~ 39</up>합니다. 로직을 보면 <em>Circular Linked List</em>로 만들어 주는 부분<up>34 ~ 37</up>이 있는데 왜 이렇게 만들어 주는지는 업데이트 구현체에서 설명하도록 하겠습니다.</p>
<h3 id="불필요한-컴포넌트-리-렌더링-방지"><a href="#%EB%B6%88%ED%95%84%EC%9A%94%ED%95%9C-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EB%A6%AC-%EB%A0%8C%EB%8D%94%EB%A7%81-%EB%B0%A9%EC%A7%80" aria-label="불필요한 컴포넌트 리 렌더링 방지 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>불필요한 컴포넌트 리-렌더링 방지</h3>
<p>리액트는 이 시점에(<down><em>idle</em> 상태에서 업데이트가 발생한 상황</down>) 아래와 같은 상황이라면 간단하게 성능 최적화를 할 수 있습니다. </p>
<ol>
<li>현재 컴포넌트의 업데이트로 인해 <strong>Work</strong>가 스케줄링 되어있지 않은 상태이고</li>
<li><code class="language-text">action</code>의 결괏값이 현재 상태 값과 같다면?
이때는 변경된 게 없으므로 더 이상 진행하지 않고 중단할 수 있습니다.</li>
</ol>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1312" target="_blank" class="code_link_4">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// queue.last = update;</span>

  <span class="token comment">// 컴포넌트에서 업데이트가 발생한 적이 있는지 확인</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 최적화 로직..</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code></pre></div>
<p>이제 우리는 dispatchAction()에서 <code class="language-text">fiber</code>와 <code class="language-text">alternate</code>를 모두 비교하는 이유를 알고 있습니다. 여기서 <code class="language-text">expirationTime</code>은 업데이트가 발생하여 <strong>Work</strong>가 스케줄링 될 경우 fiber에 발생 시간을 기록하게 되는데 그게 expirationTime입니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1319" target="_blank" class="code_link_2">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token comment">// queue.last = update;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> lastRenderedReducer <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedReducer
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRenderedReducer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentState <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedState <span class="token comment">// 컴포넌트에 적용된 상태값</span>
      <span class="token keyword">const</span> eagerState <span class="token operator">=</span> <span class="token function">lastRenderedReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token comment">// 리듀서를 통해 action의 결괏값을 얻는다</span>
      update<span class="token punctuation">.</span>eagerReducer <span class="token operator">=</span> lastRenderedReducer
      update<span class="token punctuation">.</span>eagerState <span class="token operator">=</span> eagerState
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">(</span>eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>useState()의 queue를 만들 때 <code class="language-text">lastRenderedReducer</code><up>7</up>에 기본 리듀서인 <a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L642" target="_blank">basicStateReducer()</a>를 할당했습니다.
참고로 lastRenderedReducer에는 useReducer(reducer, initialArg, init)의 reducer 함수가 할당되기도 합니다. 결론적으로
useState()는 useReducer()와 같은 업데이트 구현체를 공유합니다. 그러므로 useState() 하나를 분석하면 useReducer()도 함께 알 수 있습니다.</p>
<p>현재 상태와 같지 않다면<up>13</up> 컴포넌트 리-렌더링을 진행해야 하므로 <strong>Work</strong>를 스케줄링<up>18</up>합니다. <strong>scheduler</strong>와 연관이 있는 <code class="language-text">scheduleWork()</code>는 다음 포스트인 <strong>scheduler</strong>에서 자세히 다루게 되므로 잠시 생략하고, 단지 fiber에 expirationTime을 새기고 재조정을 진행할 <strong>Work</strong> 함수를 스케줄링한다고 이해하시면 됩니다.</p>
<p>여기 까지가 유휴 상황에서의 컴포넌트 상태 업데이트 흐름 입니다. 좀 더 오래 기억할 수 있도록 아래의 질문에 답해보세요.</p>
<ul>
<li>dispatchAction()이 여러번 호출될 경우 매 호출 <strong>Work</strong>가 스케줄링 되는가?</li>
</ul>
<p>답은 <em>아니다</em>입니다.<br>
특정 컴포넌트의 상태 변경으로 <strong>Work</strong>가 스케줄링 되면 해당 fiber에는 expirationTime이 새겨지므로 if 문<up>6</up>에서 걸러져 중복으로 스케줄링 되는 경우는 없습니다. 또한, eagerState를 얻기 위해 action을 소비하는 행동도 마찬가지로 한 번만 하지 매 호출 소비하진 않습니다. 원래 action은 컴포넌트가 호출될 때 소비되는 것이지 업데이트를 위한 dispatchAction() 호출에서 소비되는 게 아닙니다.</p>
<h2 id="3---3-render-phase에서의-dispatchaction"><a href="#3---3-render-phase%EC%97%90%EC%84%9C%EC%9D%98-dispatchaction" aria-label="3   3 render phase에서의 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3 - 3 Render phase에서의 dispatchAction</h2>
<p>유휴 상태에서 dispatchAction()이 호출되었다면 <strong>Work</strong>를 통해 render phase가 진행될 것입니다. 그리고 컴포넌트를 재호출하는데 이 와중에 추가로 dispatchAction()가 호출되었다고 생각해봅시다. </p>
<p>이때는 유휴 상태에서 dispatchAction()이 해야 할 일(<down><strong>Work</strong> 스케줄링, 성능 최적화</down>)을 할 필요가 없습니다. 이미 <strong>Work</strong>는 진행 중이므로 <strong>Work</strong>를 스케줄링하거나 성능 최적화를 위한 처리가 필요 없습니다. 단지 render phase update가 더 이상 발생하지 않을 때까지 계속해서 컴포넌트를 재호출하여 action을 소비시키기만 하면 됩니다.</p>
<p>render phase update를 바로 소비하기 위해서는 update를 잠깐 담아둘 임시 저장소가 필요합니다. 그래야 다음 컴포넌트 호출 때 이 저장소에서 꺼내 소비할 수 있습니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1242" target="_blank" class="code_link">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// const alternate = fiber.alternate</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// renderWithHooks()에게 컴포넌트 재실행을 알려줄 플래그</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
      expirationTime<span class="token punctuation">:</span> renderExpirationTime<span class="token punctuation">,</span>
      action<span class="token punctuation">,</span>
      suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      eagerReducer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      eagerState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderPhaseUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// update 임시 저장소</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> firstRenderPhaseUpdate <span class="token operator">=</span> renderPhaseUpdates<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRenderPhaseUpdate <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderPhaseUpdates<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Append the update to the end of the list.</span>
      <span class="token keyword">let</span> lastRenderPhaseUpdate <span class="token operator">=</span> firstRenderPhaseUpdate<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>lastRenderPhaseUpdate<span class="token punctuation">.</span>next <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastRenderPhaseUpdate <span class="token operator">=</span> lastRenderPhaseUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      lastRenderPhaseUpdate<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/*idle update..*/</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">renderPhaseUpdates</code>를 소비하기 위한 컴포넌트 재호출 로직을 <a href="#renderWithHooks">renderWithHooks()</a>를 분석할 때 생략했었습니다. 이 부분을 마저 채우고 가도록 하겠습니다.</p>
<p>renderWithHooks()는 <code class="language-text">didScheduleRenderPhaseUpdate</code> 플래그를 통해 render phase update가 발생했는지 판단합니다. </p>
<anchor id="renderWithHooks_2">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L439" target="_blank" class="code_link_2">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts">  
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*...*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// 무한 루프 방지와 업데이트 구현체에게 render phase update를 알려주는 플래그</span>
      numberOfReRenders <span class="token operator">+=</span> <span class="token number">1</span> 

      <span class="token comment">//이하 훅 업데이트 구현체에서 render phase update를 소비하는데 필요한 변수들을 설정</span>
      nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token punctuation">:</span> <span class="token keyword">null</span>
      nextWorkInProgressHook <span class="token operator">=</span> firstWorkInProgressHook
      currentHook <span class="token operator">=</span> <span class="token keyword">null</span>
      workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span>

      ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> HooksDispatcherOnUpdate <span class="token comment">// 업데이트 구현체 주입</span>

      children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span> <span class="token comment">// 컴포넌트 재호출</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span>

    renderPhaseUpdates <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// render phase update 저장소 초기화</span>
    numberOfReRenders <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>❗기억하세요. 컴포넌트 실행<up>17</up>전 훅 구현체는 업데이트용으로 갈아끼워<up>15</up> 졌습니다. useState()는 더 이상 마운트용 구현체가 아닙니다.</p>
<blockquote>
<p>훅에 익숙하지 않다면 자주 확인하게 되는 <em><em>“Too many re-renders. React limits the number of renders to prevent an infinite > loop.”</em></em> 메세지는 dispatchAction()에서 <code class="language-text">numberOfReRenders</code>을 기준으로 출력합니다.</p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberHooks.js#L1226" target="_blank" class="code_link">reconciler > ReactFiberHooks.js</a></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  
<span class="token keyword">const</span> <span class="token constant">RE_RENDER_LIMIT</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    numberOfReRenders <span class="token operator">&lt;</span> <span class="token constant">RE_RENDER_LIMIT</span><span class="token punctuation">,</span>
    <span class="token string">'Too many re-renders. React limits the number of renders to prevent '</span> <span class="token operator">+</span>
      <span class="token string">'an infinite loop.'</span>
  <span class="token punctuation">)</span>
  <span class="token comment">/*...*/</span>
<span class="token punctuation">}</span></code></pre></div>
</blockquote>
<p>여기까지 마운트 구현체의 코드입니다. 다음은 컴포넌트를 재호출하면서 실행될 업데이트 구현체이지만, 이는 다음 포스트로 넘기고 먼저 지금까지의 내용을 정리부터 해보고 넘어갑시다.</p>
<h2 id="정리"><a href="#%EC%A0%95%EB%A6%AC" aria-label="정리 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>정리</h2>
<p>리액트 초보자가 아래와 같은 질문을 남겼습니다. 여러분은 이제 코드에 기반하여 대답할 수 있습니다.</p>
<ol>
<li>단일 혹은 복수의 setState()를 동시에 호출하면 setState()가 호출될 때 마다 컴포넌트가 리-렌더링 되나요?</li>
<li>클릭을 통해 컴포넌트 상태를 업데이트했습니다. 그리고 변경된 상태를 기준으로 setState()를 추가로 호출했어요. 컴포넌트 렌더링은 클릭을 통한 상태 업데이트 때 한번, 추가 setState() 때 또 한 번. 이렇게 매번 리-렌더링 되나요?</li>
</ol>
<p>이런 질문이 들어오면 일단 가장 먼저 질문자에게 해주어야 할 행동은 렌더링의 의미를 명확하게 인식시키는 겁니다. 이 부분만 제대로 이해해도 개발자의 입장에서만 바라보던 것들을 리액트의 시선으로 바라볼 수 있게 됩니다.</p>
<p>하나씩 답변 해봅시다.</p>
<ol>
<li>setState() 실행이 훅의 현재 상태와 같다면 아무 일도 일어나지 않는다. 그게 아니라면 한데 묶어 한 번만 컴포넌트를 재호출한다. 왜냐하면 dispatchAction()은 컴포넌트를 재호출할 <strong>Work</strong>를 딱 한 번만 스케줄링하고 모든 업데이트는 훅 객체에 저장되었다가 render phase에서 한 번에 소비되기 때문이다.</li>
<li>
<p>클릭을 통한 업데이트로 컴포넌트가 재호출 된다. 그리고 재호출 시점에 추가로 발생하는 여러 setState()는 1번처럼 묶어서 한 번만 실행한다.  </p>
<p>여기서 추가적인 업데이트가 발생하지 않을 때까지 계속해서 함수를 재실행하는데, 결국 최소 2번 최대 25번(<down>RE<em>RENDER</em>LIMIT = 25</down>) 컴포넌트가 재실행될 수 있다. </p>
</li>
</ol>
<p>참고로 위 내용은 render phase에서 동작하고 있는 것입니다. 다시 말해 VDOM에 변경 점을 적용하는 것이지 화면에 반영하는 단계가 아닙니다. 이 단계는 commit phase에서 진행되므로 아무리 컴포넌트가 재호출된다고 하여도 브라우저의 렌더링과 관련된 리소스가 낭비되지 않음을 이해하시길 바랍니다.</p>
<h2 id="번외"><a href="#%EB%B2%88%EC%99%B8" aria-label="번외 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>번외</h2>
<h3 id="expirationtime"><a href="#expirationtime" aria-label="expirationtime permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expirationTime</h3>
<p>설명을 생략한 expirationTime에 대해 마저 알아보겠습니다.  </p>
<p>expirationTime는 <strong>scheduler</strong>와 <strong>reconciler</strong>에서 사용하는데 살짝 다른 뜻으로 쓰이며 구현도 다릅니다. <strong>scheduler</strong>에서는 이름 그대로 Task의 만료시간을 나타내는 데 비해 <strong>reconciler</strong>에서는 이벤트를 구분하는 기준으로 쓰입니다. <strong>reconciler</strong>는 같은 expirationTime에서 발생한 연속적인 이벤트는 하나의 이벤트로 간주하고 expirationTime이 달라야지만 개별 이벤트로 판단합니다.</p>
<p>expirationTime의 가장 큰 수는 부호 있는 31bit 값입니다. 이 값을 <code class="language-text">Sync</code>로 다룹니다.
시간을 이렇게 특정 고유명사로 다룰 수 있는 이유는 위에서 설명한 것처럼 <strong>reconciler</strong>는 expirationTime을 이벤트를 구분하는데 사용하기 때문입니다. 그래서 구현 또한 일반적으로 시간을 다루는 방식과는 다르게 구현되었으며 아무리 시간이 지나도 절대로 Sync 값에 도달하지 않습니다. </p>
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberExpirationTime.js#L23" target="_blank" class="code_link">reconciler > ReactFiberExpirationTime.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token keyword">export</span> <span class="token keyword">const</span> NoWork <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Never <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Idle <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Sync <span class="token operator">=</span> <span class="token constant">MAX_SIGNED_31_BIT_INT</span> <span class="token comment">// 1073741823</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Batched <span class="token operator">=</span> Sync <span class="token operator">-</span> <span class="token number">1</span>
<span class="token keyword">const</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">=</span> Batched <span class="token operator">-</span> <span class="token number">1</span></code></pre></div>
<p>이벤트 발생 시간을 구할 때 형식은 Date.now()가 아닌 performance.now() 입니다.</p>
<blockquote>
<p>performance.now()는 브라우저가 시작되고 현재까지의 경과시간을 나타냅니다.</p>
</blockquote>
<p>이걸 바로 expirationTime으로 사용하지 않고 다음의 계산식을 이용합니다.<br>
<code class="language-text">MAX_SIGNED_31_BIT_INT</code> - now()</p>
<p>now()가 오른쪽 피연산자에 있다는 건 나중에 발생한 작업일수록 더 작은 expirationTime 값을 가지게 된다는 뜻입니다.
이 부분은 나중에 코드에서 fiber에 새겨진 expirationTime를 가지고 대소비교를 할 때 헷갈릴 수 있으므로 기억해두시길 바랍니다.</p>
<p>여기서 주의할 점은 performance.now()로 시간을 구하기 때문에 이론상으로 발생 시간이 0일 수 있습니다. 이렇게 되면 <code class="language-text">Sync</code>나 <code class="language-text">Batched</code>와 값이 겹칠 수 있어 기존 상수들과 겹치지 않도록 offset 값을 추가로 사용하는데 그게 바로 <code class="language-text">MAGIC_NUMBER_OFFSET</code>입니다.
MAGIC_NUMBER_OFFSET이 있기 때문에 더 이상 MAX_SIGNED_31_BIT_INT를 시간을 구하는데 사용할 필요가 없습니다. </p>
<p>이제 브라우저 시작과 동시에 이벤트가 발생해도 offset을 이용한 다음의 계산식이라면 Sync, Batched와 겹칠 일은 없습니다.<br>
MAGIC<em>NUMBER</em>OFFSET - now()</p>
<p>아래의 코드가 발생시간에서 expirationTime을 expirationTime에서 다시 발생시간을 구하는 계산식입니다.</p>
<anchor id="currentTime">
<p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberExpirationTime.js#L46" target="_blank" class="code_link">reconciler > ReactFiberExpirationTime.js</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">  
<span class="token comment">/*...*/</span>
<span class="token comment">// const MAGIC_NUMBER_OFFSET = Batched - 1</span>

<span class="token keyword">const</span> <span class="token constant">UNIT_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment">// 1 unit of expiration time represents 10ms.</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">msToExpirationTime</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token parameter">expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">-</span> expirationTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">UNIT_SIZE</span>
<span class="token punctuation">}</span></code></pre></div>
<p>간략하게 정리하자면 <strong>fiber의 expirationTime이 NoWork라면 놀고 있다는 뜻이고 Sync는 작업이 동기적으로 처리될 것이며 expirationTime을 대소로 비교하는 조건문이 있을 때는 큰 숫자가 더 먼저 발생한 작업이다.</strong> 라고만 생각하고 넘어가시면 분석할 때 큰 무리 없이 이해할 수 있을 것입니다. </p>
<p>expirationTime은 주로 concurrent mode에서 더 넓은 의미로 사용됩니다. 우선순위와 같은 뜻으로 말이죠. legacy mode에서는 대게 expirationTime을 Sync로 설정하여 동기적으로 처리합니다. 그러므로 시간과 관련된 부분은 concurrent mode를 일반적으로 사용하게 되는 날, 그때 깊이 있게 들어가 보고 지금은 이 정도면 충분합니다.</p></div><hr class="custom-hr"/><div class="bio"><div class="author"><div class="author-description"><a class="link" href="/"><img class="author-image" src="/static/felog-f24356c48475809626ea0c2ac67855c6.png" alt="Goidle" style="width:72px;height:79px"/></a><div class="author-name"><div><a class="author-name-content"><div><svg class="bio_fontaswesome" width="1em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> <!-- -->Goidle<!-- --> <svg class="bio_fontaswesome" width="1.25em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"></path></svg> TMON</div></a></div><div class="author-introduction">오픈소스를 톺아보며 매직 코드라 생각했던 부분들의 동작 원리와 의미, 의도를 파악해보고 서로의 생각을 나누기 위한 블로그</div></div></div></div></div><ul class="navigator"><li class="left_navi"><a rel="prev" href="/react/in-depth-react-intro/">← <!-- -->React 톺아보기 - 02. Intro</a></li><li class="right_navi"><a rel="next" href="/react/in-depth-react-hooks_2/">React 톺아보기 - 03. Hooks_2<!-- --> →</a></li></ul><div class="utterences"></div><footer class="footer">©<a href="https://github.com/JaeYeopHan">Goidle</a>, Built with<!-- --> <a href="https://github.com/JaeYeopHan/gatsby-starter-bee">Gatsby-starter-bee</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-154981109-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react/in-depth-react-hooks_1/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-69573b14c89d32433a71.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5efb7b8fb8a6286e0a5c.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6bdb37d3a7ac9f5a4c88.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c9089e990f73b65ff865.js"]};/*]]>*/</script><script src="/webpack-runtime-9f6b1d2a45518b92e568.js" async=""></script><script src="/commons-e292b02c69f3a51ef82a.js" async=""></script><script src="/styles-f42f8789f3cee93e7f05.js" async=""></script><script src="/component---src-templates-blog-post-js-4dc9112f7d4bfc5bdeb9.js" async=""></script><script src="/app-69573b14c89d32433a71.js" async=""></script></body></html>