{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-scheduler_2/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"c94e9da7-4892-5cde-8435-3b3ef392900c","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 5. Scheduler_scheduleCallback scheduler는 전달받은 callback을 Task 객체에 담아 관리합니다. 먼저 이 Task의 생김새부터 확인해봅시다. 위 속성중 scheduler가 전달받은 것은 과 입니다. 이 이외에는 scheduler…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.06060606060607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABd0lEQVQoz5VTy3LCMAzk/z+PG9AD9NROS96xLcnOduUQCp32UM9srARp9VixW5YFvwLA+XzGfr/H8XjE6XTC4XDA5XLB/WRF+/aKpu1gqjVutxFgw3Ye7R8nmOGaIgZN9CtADV2+CQs/CB9KW3NGZMBoiolZEzGq4FMi2hhwnSd0ktDwW8gGob+VQo6N0Isp/EFnWBaoSSV1cncUW4PEbRJET+IkLCvyvU+pJnZfbIRFemB4AeJHtYsGIDVYdESWkbOKgPodsLDSQhKQLPHOvNcJ3SosrM5iW6vU2EPnzwpLAx3YCkdRLCDP7yRrYGFC6ujvGOnDMTyKufPZm0wULKyZLBKyilLyTSC2U9RbeVA4r3CfJ8JKYiiR7SVZs84zpLkitU0VpyeunNNEgkmkitOx3caVDjO6YUAI4XltHJkBS99V0kwlsytMsoGKOtxOnJmWm0hlVdh4P63NfRdRVwpPG1j385fd3By3uI3QqyrM8uc/5p/4AoimYHNzbqFEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"scheduling flow\" title=\"scheduling flow\" src=\"/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png\" srcset=\"/static/9e327099e752bd46cae5074351cfbe5c/18f77/scheduling_flow.png 198w,\n/static/9e327099e752bd46cae5074351cfbe5c/2cb6c/scheduling_flow.png 395w,\n/static/9e327099e752bd46cae5074351cfbe5c/2e237/scheduling_flow.png 790w,\n/static/9e327099e752bd46cae5074351cfbe5c/471ef/scheduling_flow.png 1185w,\n/static/9e327099e752bd46cae5074351cfbe5c/5d6a0/scheduling_flow.png 1580w,\n/static/9e327099e752bd46cae5074351cfbe5c/c2d13/scheduling_flow.png 2560w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<h1 id=\"5-scheduler_schedulecallback\" style=\"position:relative;\"><a href=\"#5-scheduler_schedulecallback\" aria-label=\"5 scheduler_schedulecallback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Scheduler_scheduleCallback</h1>\n<p><strong>scheduler</strong>는 전달받은 callback을 <strong>Task</strong> 객체에 담아 관리합니다. 먼저 이 <strong>Task</strong>의 생김새부터 확인해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> newTask <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> taskIdCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span>\n  callback<span class=\"token punctuation\">,</span>\n  priorityLevel<span class=\"token punctuation\">,</span>\n  startTime<span class=\"token punctuation\">,</span>\n  expirationTime<span class=\"token punctuation\">,</span>\n  sortIndex<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 속성중 <strong>scheduler</strong>가 전달받은 것은 <code class=\"language-text\">callback</code>과 <code class=\"language-text\">priorityLevel</code>입니다. 이 이외에는 <strong>scheduler</strong>가 내부적으로 만들어내는 정보이며 이중 시간과 관련된 <code class=\"language-text\">startTime</code>과 <code class=\"language-text\">expirationTime</code>을 먼저 알아보도록 하겠습니다.</p>\n<h2 id=\"5---1-starttime-expirationtime\" style=\"position:relative;\"><a href=\"#5---1-starttime-expirationtime\" aria-label=\"5   1 starttime expirationtime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5 - 1 startTime, expirationTime</h2>\n<p><strong>reconciler</strong>는 시간 정보인 timeout과 delay를 options에 담아 전달합니다. delay와 timeout은 각각 startTime, expirationTime을 구하는데 사용됩니다.</p>\n<blockquote>\n<p><strong>reconciler</strong>에서는 expirationTime에 여러 의미가 있었지만, <strong>scheduler</strong>는 이름 그대로 <strong>Task</strong>의 만료 시간을 뜻합니다.</p>\n</blockquote>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L295\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">var</span> startTime\n  <span class=\"token keyword\">var</span> timeout\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> options <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> options <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> delay <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>delay\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> delay <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span> <span class=\"token operator\">&amp;&amp;</span> delay <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      startTime <span class=\"token operator\">=</span> currentTime <span class=\"token operator\">+</span> delay\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      startTime <span class=\"token operator\">=</span> currentTime\n    <span class=\"token punctuation\">}</span>\n    timeout <span class=\"token operator\">=</span>\n      <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span>\n        <span class=\"token operator\">?</span> options<span class=\"token punctuation\">.</span>timeout\n        <span class=\"token operator\">:</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    timeout <span class=\"token operator\">=</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span>\n    startTime <span class=\"token operator\">=</span> currentTime\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">var</span> expirationTime <span class=\"token operator\">=</span> startTime <span class=\"token operator\">+</span> timeout\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>options가 없거나<up>18</up> timeout이 담겨 있지 않다면<up>15</up> <strong>reconciler</strong>가 넘겨준 우선순위를 기준 <code class=\"language-text\">timeoutForPriorityLevel()</code>을 통해 구합니다.</p>\n<blockquote>\n<p><code class=\"language-text\">options</code>는 concurrent mode에서 사용합니다.</p>\n</blockquote>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L279\" target=\"_blank\" class=\"code_link\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Times out immediately</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n<span class=\"token comment\">// Eventually times out</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">USER_BLOCKING_PRIORITY</span> <span class=\"token operator\">=</span> <span class=\"token number\">250</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">NORMAL_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">LOW_PRIORITY_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token number\">10000</span>\n<span class=\"token comment\">// Never times out</span>\n<span class=\"token keyword\">var</span> <span class=\"token constant\">IDLE_PRIORITY</span> <span class=\"token operator\">=</span> maxSigned31BitInt <span class=\"token comment\">// 1073741823</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeoutForPriorityLevel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>priorityLevel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> ImmediatePriority<span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">IMMEDIATE_PRIORITY_TIMEOUT</span>\n    <span class=\"token keyword\">case</span> UserBlockingPriority<span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">USER_BLOCKING_PRIORITY</span>\n    <span class=\"token keyword\">case</span> IdlePriority<span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">IDLE_PRIORITY</span>\n    <span class=\"token keyword\">case</span> LowPriority<span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">LOW_PRIORITY_TIMEOUT</span>\n    <span class=\"token keyword\">case</span> NormalPriority<span class=\"token operator\">:</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">NORMAL_PRIORITY_TIMEOUT</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>reconciler</strong>는 sync <strong>Work</strong>를 <a href=\"/react/in-depth-react-scheduler_1/#scheduleSyncCallback\" target=\"_blank\">scheduleSyncCallback()</a>를 통해 넘겨줄 때 우선순위를 Scheduler_ImmediatePriority로 넘겨주었습니다. 해당 우선순위로 expirationTime을 계산해보면(<down>startTime + timeout</down>) currentTime보다 -1ms만큼 빠릅니다.</p>\n<h2 id=\"5---2-task-생성하기\" style=\"position:relative;\"><a href=\"#5---2-task-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0\" aria-label=\"5   2 task 생성하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5 - 2 Task 생성하기</h2>\n<p>사전작업은 모두 끝났습니다. 이제부터 본격적으로 새로 생성된 <strong>Task</strong>를 어떻게 다루는지 알아보겠습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L318\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// var expirationTime = startTime + timeout</span>\n\n  <span class=\"token keyword\">var</span> newTask <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> taskIdCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span>\n    callback<span class=\"token punctuation\">,</span>\n    priorityLevel<span class=\"token punctuation\">,</span>\n    startTime<span class=\"token punctuation\">,</span>\n    expirationTime<span class=\"token punctuation\">,</span>\n    sortIndex<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*Timer..*/</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*Task..*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>큰 틀을 보자면 <strong>Task</strong>를 생성한 후 실행 시점에 따라 분기<up>15</up>처리하고 <strong>reconciler</strong>에게 반환<up>21</up>합니다(<down>root에 기입하기 위해</down>). 여기서 생성된 <strong>Task</strong>는 <a href=\"https://en.wikipedia.org/wiki/Binary_heap\" target=\"_blank\">최소힙</a> 자료구조에 추가되어 우선순위에 맞춰 정렬됩니다. 이때 힙의 정렬 기준은 <strong>Task</strong>의 sortIndex입니다.</p>\n<h3 id=\"1-timer\" style=\"position:relative;\"><a href=\"#1-timer\" aria-label=\"1 timer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) Timer</h3>\n<p>딜레이된 <strong>Task</strong>는 시간이 지나 timeout이 되어야 실행할 수 있는 <strong>Task</strong>이므로 <strong>Timer</strong>라고 부르고 있습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L330\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">var</span> taskQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// Task</span>\n<span class=\"token keyword\">var</span> timerQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// Delayed task</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">/*var newTask = ...;*/</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newTask<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> startTime\n    <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">,</span> newTask<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newTask <span class=\"token operator\">===</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// All tasks are delayed, and this is the task with the earliest delay.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHostTimeoutScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 중복 실행 방지</span>\n        <span class=\"token comment\">// Cancel an existing timeout.</span>\n        <span class=\"token function\">cancelHostTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// Schedule a timeout.</span>\n      <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*General task..*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>힙 정렬 기준<up>sortIndex</up>은 <code class=\"language-text\">startTime</code><up>11</up> 입니다. <strong>Timer</strong>는 시작 시간순으로 정렬됨을 알 수 있습니다.</li>\n<li>\n<p><strong>Timer</strong>를 힙에 추가<up>12</up>하는데 heap.push(newTask)를 생각했던 것과는 달리 행위<up>push</up>에 동작의 주체<up>timerQueue</up>와 <strong>Timer</strong>를 넘겨주고 있습니다.</p>\n<blockquote>\n<p>힙 구현은 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/SchedulerMinHeap.js\" target=\"_blank\">SchedulerMinHeap.js</a>에서 확인할 수 있습니다.</p>\n</blockquote>\n</li>\n<li>\n<p>taskQueue에 실행대기 중인 <strong>Task</strong>가 없고<up>13</up> 새로 생성된 <strong>Timer</strong>가 <strong>Timer</strong>중에서 가장 우선순위가 높다면<up> 13</up> 실행 1순위는 생성된 <strong>Timer</strong>입니다. <strong>Timer</strong>의 실행 방식은 timeout api를 이용하여 최소 딜레이된 시간 이후에 timeQueue 소비 함수가 실행되도록 구현되어 있습니다.</p>\n<p>실행 1순위 <strong>Timer</strong>가 바뀌었으므로 <a href=\"#requestHostTimeout\">requestHostTimeout</a>(<down>timeout api</down>)<up>22</up>를 1순위 <strong>Timer</strong>의 딜레이 시간으로 갈아 끼워<up>22</up>야 합니다. 이때 주의할 점은 실행된 timeout api가 있다면 취소<up>15</up> 해주어야 합니다.</p>\n</li>\n</ul>\n<h4 id=\"timer소비-함수-handletimeout\" style=\"position:relative;\"><a href=\"#timer%EC%86%8C%EB%B9%84-%ED%95%A8%EC%88%98-handletimeout\" aria-label=\"timer소비 함수 handletimeout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Timer소비 함수 handleTimeout()</h4>\n<p>handleTimeout()이 호출되었다는 건 1순위 <strong>Timer</strong>가 timeout되었음을 나타냅니다. timeout된 <strong>Timer</strong>는 실행 되어야 하는 <strong>Task</strong>로 취급 되므로 taskQueue로 옮겨집니다. 그리고 그 안에서 또 우선순위에 따라서 정렬되겠죠.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L105\" target=\"_blank\" class=\"code_link\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleTimeout</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// 여기에 도달했다는 건 timeout api가 실행된 것이다.</span>\n  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span> <span class=\"token comment\">// timeout Timer를 꺼내 taskQueue에 추가한다.</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L81\" target=\"_blank\" class=\"code_link_3\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>timer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Task는 취소되면 callback은 null로 초기화된다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 취소된 Timer를 꺼냄</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">&lt;=</span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Timer fired. Transfer to the task queue.</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n      timer<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> timer<span class=\"token punctuation\">.</span>expirationTime\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">,</span> timer<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Remaining timers are pending.</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    timer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>timerQueue에서 하나씩 timeout여부를 확인<up>9</up>하여 taskQueue에 추가합니다. taskQueue의 정렬기준은 timerQueue와는 달리 expirationTime<up>12</up>입니다.</li>\n</ul>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L109\" target=\"_blank\" class=\"code_link_5\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleTimeout</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// advanceTimers(currentTime)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isHostCallbackScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 중복 실행 방지</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token function\">requestHostCallback</span><span class=\"token punctuation\">(</span>flushWork<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> firstTimer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstTimer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> firstTimer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>timeout <strong>Timer</strong>가 taskQueue로 옮겨졌는지 확인<up>7</up>합니다. 확인되었으면 taskQueue 소비 함수<up>flushWork</up>를 다음 프레임에 실행될 수 있도록 host_config의 함수인 <code class=\"language-text\">requestHostCallback()</code><up>9</up>을 호출합니다.</li>\n<li>만약 <code class=\"language-text\">advanceTimers()</code>를 진행<up>4</up>했는데도 taskQueue가 비어<up>10</up>있다면 취소된 timeout <strong>Task</strong>로 인해 handleTimeout()이 호출된 것이므로 다음 <strong>Timer</strong>의 시간으로 다시 timeout api를 실행<up>13</up>합니다.</li>\n</ul>\n<h3 id=\"2-task\" style=\"position:relative;\"><a href=\"#2-task\" aria-label=\"2 task permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) Task</h3>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L345\" target=\"_blank\" class=\"code_link_4\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">unstable_scheduleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">priorityLevel<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">/*var newTask = ...;*/</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startTime <span class=\"token operator\">></span> currentTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*Timer..*/</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    newTask<span class=\"token punctuation\">.</span>sortIndex <span class=\"token operator\">=</span> expirationTime\n    <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">,</span> newTask<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isHostCallbackScheduled <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>isPerformingWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n      <span class=\"token function\">requestHostCallback</span><span class=\"token punctuation\">(</span>flushWork<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> newTask\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>taskQueue의 우선순위는 <code class=\"language-text\">expirationTime</code><up>9</up>입니다.</li>\n<li><code class=\"language-text\">isPerformingWork</code>는 Work의 진행이 concurrent mode에서는 비동기로 동작하기 때문에 <strong>scheduler</strong>는 다른 VDOM root가 요청한 Work를 실행해버릴 수 있습니다. 이를 방지하기 위한 플래그입니다.</li>\n<li><code class=\"language-text\">requestHostCallback()</code>의 구현 코드는 <code class=\"language-text\">requestHostTimeout()</code> 처럼 단순하지 않으므로 host_config를 분석할 때 다루도록 하겠습니다. 단지 지금은 flushWork()를 비동기로 실행하는 api라고 생각하면 됩니다.</li>\n</ul>\n<p>원래 흐름대로라면 다음 분석 대상은 host<em>config의 requestHostCallback()나 requestHostTimeout()가 이지만 host</em>config로 넘어갔다가 다시 돌아오기에는 너무 먼 길을 갔다 와야 하므로 <strong>scheduler</strong>를 마저 분석하고 난 후에 진행하도록 하겠습니다.</p>\n<h1 id=\"9-flushwork\" style=\"position:relative;\"><a href=\"#9-flushwork\" aria-label=\"9 flushwork permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9. flushWork</h1>\n<p>flushWork()는 taskQueue를 소비하기 전 사전작업 공간입니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L122\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">flushWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  isHostCallbackScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHostTimeoutScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isHostTimeoutScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token function\">cancelHostTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  isPerformingWork <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// 중복 실행 방지</span>\n  <span class=\"token keyword\">const</span> previousPriorityLevel <span class=\"token operator\">=</span> currentPriorityLevel\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    currentTask <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    currentPriorityLevel <span class=\"token operator\">=</span> previousPriorityLevel\n    isPerformingWork <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>flushWork()는 requestHostCallback()로 인해 다음 프레임에 호출됩니다. 그러니 비동기 관련 플래그 <code class=\"language-text\">isHostCallbackScheduled</code>를 꺼줍니다<up>3</up>.</li>\n<li>timeout api가 실행되어 있다면 <strong>Task</strong>를 처리할 것이므로 방해받지 않도록 취소<up>6</up>시켜 줍니다.</li>\n<li><code class=\"language-text\">workLoop()</code>가 반환<up>12</up>하는 값을 flushWork()도 그대로 반환하고 있음을 기억해 두세요. 이 값은 host_config가 받아 async <strong>Work</strong>의 잔여 작업 존재 여부를 판단하여 추가 처리하는데 사용됩니다.</li>\n</ul>\n<h1 id=\"10-workloop\" style=\"position:relative;\"><a href=\"#10-workloop\" aria-label=\"10 workloop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10. workLoop</h1>\n<p>이해를 돕기 위해 간단한 의사코드로 흐름을 먼저 알아보고 실제 코드를 보겠습니다.</p>\n<ol>\n<li>currentTask = peek(taskQueue)</li>\n<li>\n<p><strong>while</strong> currentTask !== null</p>\n<ol>\n<li><strong>if</strong> currentTask의 만료 시간이 여유가 있는 와중에 <strong>scheduler</strong>에게 할당된 시간이 끝났다.</li>\n<li>break</li>\n<li>callback = currentTask.callback;</li>\n<li><strong>if</strong> callback !== null</li>\n<li>callback을 실행해 Work를 시작한다.</li>\n<li>\n<p><strong>if</strong> callback이 잔여 작업을 반환했다.</p>\n<ul>\n<li>currentTask.callback = continuationCallback;</li>\n</ul>\n</li>\n<li>\n<p><strong>else</strong></p>\n<ul>\n<li>잔여 작업이 없다면 currentTask를 taskQueue에서 꺼낸다.</li>\n</ul>\n</li>\n<li><strong>end if</strong></li>\n<li><strong>else</strong></li>\n<li>callback이 없다는 건 Task가 취소되었다는 뜻이므로 taskQueue에서 꺼낸다.</li>\n<li><strong>end if</strong></li>\n<li>currentTask = peek(taskQueue);</li>\n</ol>\n</li>\n<li><strong>end while</strong></li>\n<li>\n<p><strong>if</strong> currentTask !== null</p>\n<ul>\n<li>currentTask가 null이 아니라면 <strong>scheduler</strong>에게 할당된 시간이 끝나 while 문이 중단되어 Task가 아직 남아 있다는 뜻으로 config_host에게 계속해서 작업을 이어갈 수 있도록 알려준다.</li>\n</ul>\n</li>\n<li>\n<p><strong>else</strong></p>\n<ul>\n<li><strong>Task</strong>는 모두 처리되었으므로 <strong>Timer</strong>가 존재한다면 소비하기 위해 requestHostTimeout()를 호출하고 잔여 작업이 남아 있지 않음을 host_config에게 알린다.</li>\n</ul>\n</li>\n<li><strong>end if</strong></li>\n</ol>\n<anchor id=\"work_loop\">\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L164\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> currentTime <span class=\"token operator\">=</span> initialTime\n  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Task 소비 전 timeout Timer를 taskQueue로 옮겨놓는다.</span>\n  currentTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      currentTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">></span> currentTime <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasTimeRemaining <span class=\"token operator\">||</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// This currentTask hasn't expired, and we've reached the deadline.</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> callback <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>callback\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      currentTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n      currentPriorityLevel <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>priorityLevel\n      <span class=\"token keyword\">const</span> didUserCallbackTimeout <span class=\"token operator\">=</span> currentTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;=</span> currentTime\n      <span class=\"token comment\">// Work 진행, 잔여 작업 여부 반환(concurrent mode)</span>\n      <span class=\"token keyword\">const</span> continuationCallback <span class=\"token operator\">=</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>didUserCallbackTimeout<span class=\"token punctuation\">)</span>\n      currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> continuationCallback <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        currentTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> continuationCallback\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">===</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    currentTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Return whether there's additional work</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> firstTimer <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>timerQueue<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firstTimer <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">requestHostTimeout</span><span class=\"token punctuation\">(</span>handleTimeout<span class=\"token punctuation\">,</span> firstTimer<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">-</span> currentTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>추가 설명이 필요한 부분만 짚고 넘어가도록 하겠습니다.</p>\n<ul>\n<li>timerQueue의 기아상태(starvation)를 방지하기 위해서 틈틈이 timeout <strong>Timer</strong>를 꺼내<up>4, 32</up>줍니다.</li>\n<li>\n<p>if 문<up>9 ~ 10</up> 조건의 뜻은 현재 <strong>Task</strong>의 만료시간이 조금이라도 여유가 있으면 꼭 지금 처리해야 하는 게 아니므로 host<em>config에게 물어<up>shouldYieldToHost()</up>봅니다. 작업을 계속 동기적으로 처리해도 되는지? 만약 그렇지 않다면 while 문을 중단<up>13</up>하고 브라우저에게 메인 스레드를 양보하기 위해 제어권을 host</em>config에게 넘깁<up>41, 47</up>니다.</p>\n<p>제어권을 전달받은 host_config는 잔여 여부에 따라 다음 프레임에 계속해서 <strong>Task</strong>를 소비할 수 있도록 준비합니다. 하지만 <strong>Task</strong>의 만료시간이 이미 지나버렸다면<up>9</up> 브라우저고 뭐고 바로 처리해야 하므로 제어권을 넘기지 않고 만료된 모든 <strong>Task</strong>를 동기적으로 처리해버립니다.</p>\n</li>\n</ul>\n<p>여기까지가 <strong>scheduler</strong>가 하는 일입니다. 다음 섹션에서는 host_config가 어떻게 비동기 api를 구현했는지 확인합니다.</p>\n<h1 id=\"6-requesthosttimeout-requesthostcallback\" style=\"position:relative;\"><a href=\"#6-requesthosttimeout-requesthostcallback\" aria-label=\"6 requesthosttimeout requesthostcallback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. requestHostTimeout, requestHostCallback</h1>\n<p>간단한 timeout 구현부터 확인하겠습니다.</p>\n<anchor id=\"requestHostTimeout\">\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L164\" target=\"_blank\" class=\"code_link\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> setTimeout <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>setTimeout\n<span class=\"token keyword\">const</span> clearTimeout <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>clearTimeout\n\n<span class=\"token function-variable function\">requestHostTimeout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> ms</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  taskTimeoutID <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-variable function\">cancelHostTimeout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>taskTimeoutID<span class=\"token punctuation\">)</span>\n  taskTimeoutID <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리가 브라우저 환경에서 사용하는 일반적인 비동기 코드와 크게 다르지 않습니다.</p>\n<p>requestHostCallback()은 requestHostTimeout()과는 다르게 setTimeout() api로 구현하지 않고 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\" target=\"_blank\">MessageChannel</a>을 이용하여 구현했습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L221\" target=\"_blank\" class=\"code_link_2\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> channel <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span>port2\nchannel<span class=\"token punctuation\">.</span>port1<span class=\"token punctuation\">.</span>onmessage <span class=\"token operator\">=</span> performWorkUntilDeadline\n\n<span class=\"token function-variable function\">requestHostCallback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  scheduledHostCallback <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isMessageLoopRunning<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-variable function\">cancelHostCallback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  scheduledHostCallback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li><strong>scheduler</strong>에서 requestHostCallback()을 호출할 때 넘겨준 <code class=\"language-text\">callback</code><up>flushWork</up>을 전역으로 잡아<up>9</up>둡니다. 이 callback은 onmessage 핸들러인 <code class=\"language-text\">performWorkUntilDeadline()</code><up>4</up>에서 사용됩니다.</li>\n</ul>\n<p>requestHostCallback() 호출을 호출했으니 메시지 채널을 통해 다음 프레임에 performWorkUntilDeadline()가 호출되면서 Work가 진행될 것입니다.</p>\n<h1 id=\"8-performworkuntildeadline\" style=\"position:relative;\"><a href=\"#8-performworkuntildeadline\" aria-label=\"8 performworkuntildeadline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. performWorkUntilDeadline</h1>\n<p>performWorkUntilDeadline()는 callback<up>flushWork</up>를 호출하는데 flushWork()의 반환 값에 따라 작업을 모두 완료했거나 또는 작업 중 host_config가 할당한 시간<up>deadline</up>을 넘긴 경우로 해석할 수 있습니다. 후자의 경우 다음 프레임에 계속해서 작업이 이어갈 수 있도록 해주어야 합니다.</p>\n<anchor id=\"performWorkUntilDeadline\">\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L186\" target=\"_blank\" class=\"code_link_2\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">let</span> yieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token comment\">// ms</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">performWorkUntilDeadline</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>scheduledHostCallback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    deadline <span class=\"token operator\">=</span> currentTime <span class=\"token operator\">+</span> yieldInterval\n    <span class=\"token keyword\">const</span> hasTimeRemaining <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> hasMoreWork <span class=\"token operator\">=</span> <span class=\"token function\">scheduledHostCallback</span><span class=\"token punctuation\">(</span>hasTimeRemaining<span class=\"token punctuation\">,</span> currentTime<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasMoreWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        scheduledHostCallback <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      port<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">throw</span> error\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    isMessageLoopRunning <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n  needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">yieldInterval</code>과 <code class=\"language-text\">deadline</code>은 다음의 주석으로 설명을 대체합니다.</p>\n<blockquote>\n<h3 id=\"yieldinterval\" style=\"position:relative;\"><a href=\"#yieldinterval\" aria-label=\"yieldinterval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yieldInterval</h3>\n<p>Scheduler periodically yields in case there is other work on the main thread, like user events. By default, it yields multiple times per frame.<br>\nIt does not attempt to align with frame boundaries, since most tasks don’t need to be frame aligned; for those that do, use requestAnimationFrame.</p>\n</blockquote>\n<blockquote>\n<h3 id=\"deadline\" style=\"position:relative;\"><a href=\"#deadline\" aria-label=\"deadline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deadline</h3>\n<p>Yield after <code class=\"language-text\">yieldInterval</code> ms, regardless of where we are in the vsync cycle. This means there’s always time remaining at the beginning of the message event.</p>\n</blockquote>\n<p>1초에 60프레임을 뽑으려면 약 16ms에 렌더링 파이프라인을 통과해야 합니다. 리액트는 Work를 꼭 VSync에 맞출 필요가 없다고 생각했습니다. <strong>Work</strong>는 메모리 작업이지 렌더링과 관련된 작업이 아니므로 한 프레임에 여러 번(<down>5ms</down>) 브라우저에 양보한다면 자바스크립트가 렌더링에 큰 영향을 미치지 않는다고 판단하는 것 같습니다.</p>\n<p><code class=\"language-text\">needsPaint</code><up>25</up>와 shouldYieldToHost() 등 언급은 되었지만, 아직 확인하지 않은 부분들은 다음 섹션에서 다룹니다.</p>\n<h1 id=\"브라우저에게-양보하기-위한-시스템\" style=\"position:relative;\"><a href=\"#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%97%90%EA%B2%8C-%EC%96%91%EB%B3%B4%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C\" aria-label=\"브라우저에게 양보하기 위한 시스템 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>브라우저에게 양보하기 위한 시스템</h1>\n<p>host_config는 호스트 환경에 의존적인 모듈입니다. 사용하는 구현체 또한 그때그때 다르며 그중 하나가 shouldYieldToHost() 입니다. 분석은 이 함수로부터 시작합니다.</p>\n<p>해당 함수는 제어권을 반납해야 하는지 다른 모듈들에 알려주는 역할을 합니다. 양보하는 이유는 자바스크립트가 브라우저의 사용자 이벤트 처리나 렌더링 작업을 방해하지 않게 하기 위함입니다.</p>\n<p><strong>scheduler</strong> 시작 부분에서 <a href=\"/react/in-depth-react-scheduler_1#is-input-pending\" target=\"_blank\">isInputPending</a>에 대해 언급한 내용을 기억하시나요? 해당 api는 유저 이벤트가 대기 중인지 JS에서 알 수 있도록 해줍니다. shouldYieldToHost()는 이 api가 지원하는 환경인지에 따라 구현 코드가 달라집니다.</p>\n<anchor id=\"isInputPending\">\n<h2 id=\"1-isinputpending-api를-지원하는-환경\" style=\"position:relative;\"><a href=\"#1-isinputpending-api%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%99%98%EA%B2%BD\" aria-label=\"1 isinputpending api를 지원하는 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. isInputPending api를 지원하는 환경</h2>\n<p>이 환경에서는 사용자 이벤트와 페인트 두 가지를 각각 따로 확인할 수 있습니다.<br>\n리액트는 위 두 상황이 아니라면 굳이 브라우저에 양보할 필요 없이 부지런히 Work를 진행하면 됩니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L125\" target=\"_blank\" class=\"code_link_2\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">let</span> maxYieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">300</span>\n<span class=\"token keyword\">let</span> needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  enableIsInputPending <span class=\"token operator\">&amp;&amp;</span>\n  navigator <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">.</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> scheduling <span class=\"token operator\">=</span> navigator<span class=\"token punctuation\">.</span>scheduling\n\n  <span class=\"token function-variable function\">shouldYieldToHost</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentTime <span class=\"token operator\">>=</span> deadline<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needsPaint <span class=\"token operator\">||</span> scheduling<span class=\"token punctuation\">.</span><span class=\"token function\">isInputPending</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></span>      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> currentTime <span class=\"token operator\">>=</span> maxYieldInterval\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span>      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function-variable function\">requestPaint</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// isInputPending를 지원하지 않는 환경..</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>16: <code class=\"language-text\">deadline</code>을 넘겼다면 1차 신호입니다.</li>\n<li>17: 사용자 이벤트가 대기 중이거나 렌더링이 필요하면<up>needsPaint</up> 바로 브라우저를 위해 콜 스택을 비워줘야 합니다.</li>\n<li>20: 17라인에 해당하지 않는다면? <code class=\"language-text\">maxYieldInterval</code>까지 작업을 계속해서 진행할 수 있습니다.</li>\n</ul>\n<p>사용자 이벤트 여부를 알려주는 isInputPending()의 경우 브라우저 api로 브라우저가 알려줍니다. 그렇다면 페인트가 필요한지에 대한 여부 needsPaint는 누가 알려주는 것일까요? needsPaint는 VDOM을 DOM에 모두 적용하였으니 브라우저의 렌더링이 필요하다는 여부를 <strong>reconciler</strong>가 알려주고 있는 것입니다. <strong>reconciler</strong>는 Commit phase가 모두 완료되면 <code class=\"language-text\">requestPaint()</code>을 호출합니다.</p>\n<h2 id=\"2-isinputpending-api를-지원하지-않는-환경\" style=\"position:relative;\"><a href=\"#2-isinputpending-api%EB%A5%BC-%EC%A7%80%EC%9B%90%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%ED%99%98%EA%B2%BD\" aria-label=\"2 isinputpending api를 지원하지 않는 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. isInputPending api를 지원하지 않는 환경</h2>\n<p>isInputPending()이 지원되지 않는다면 <strong>reconciler</strong>가 알려주는 페인트 여부만 알 수 있습니다. 그래서 어쩔 수 없이 주기적으로 콜 스택을 비워줘야 합니다. 그래서 굳이 페인트 여부도 신경쓸 필요가 없습니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L159\" target=\"_blank\" class=\"code_link\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> maxYieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">300</span>\n<span class=\"token keyword\">let</span> needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token keyword\">let</span> deadline <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*isInputPending를 지원하는 환경..*/</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">shouldYieldToHost</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> deadline\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">requestPaint</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>isInputPending()을 사용하던 shouldYieldToHost()에서는 기준(<down>needsPaint, isInputPending</down>)이 명확하여 무리가 되지 않는 선<up>maxYieldInterval</up>에서 작업을 이어갈 수 있지만, 한 프레임에 짧은 기간 주기적으로 양보해야 되는 환경에서는 <code class=\"language-text\">deadline</code>으로 작업을 끊어주어야 합니다.</p>\n<p>deadline은 <a href=\"#performWorkUntilDeadline\">performWorkUntilDeadline()</a>에서 기본적으로 5ms로 계산됩니다. 리액트는 deadline을 조절하기 위해 yieldInterval를 변경할 수 있는 함수를 제공합니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L170\" target=\"_blank\" class=\"code_link\">scheduler > fork > SchedulerHostConfig.default.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">forceFrameRate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fps <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> fps <span class=\"token operator\">></span> <span class=\"token number\">125</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'forceFrameRate takes a positive int between 0 and 125, '</span> <span class=\"token operator\">+</span>\n        <span class=\"token string\">'forcing framerates higher than 125 fps is not unsupported'</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fps <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    yieldInterval <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span> <span class=\"token operator\">/</span> fps<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// reset the framerate</span>\n    yieldInterval <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"3-양보를-위해-shouldyieldtohost가-사용되는-위치\" style=\"position:relative;\"><a href=\"#3-%EC%96%91%EB%B3%B4%EB%A5%BC-%EC%9C%84%ED%95%B4-shouldyieldtohost%EA%B0%80-%EC%82%AC%EC%9A%A9%EB%90%98%EB%8A%94-%EC%9C%84%EC%B9%98\" aria-label=\"3 양보를 위해 shouldyieldtohost가 사용되는 위치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 양보를 위해 shouldYieldToHost()가 사용되는 위치</h2>\n<p>우리는 이미 한군데는 알고 있습니다. 바로 taskQueue를 소비하는 <a href=\"#work_loop\">workLoop()</a> 입니다. <strong>scheduler</strong>에는 여기 말고도 한군데 더 있습니다. <strong>scheduler</strong> 내부에서 사용하는게 아닌 <strong>reconciler</strong>에게 알려주기 위해 작성된 함수입니다.</p>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/scheduler/src/Scheduler.js#L398\" target=\"_blank\" class=\"code_link_2\">scheduler > Scheduler.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">unstable_shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">advanceTimers</span><span class=\"token punctuation\">(</span>currentTime<span class=\"token punctuation\">)</span> <span class=\"token comment\">// timeout Timer를 taskQueue로 옮긴다.</span>\n  <span class=\"token keyword\">const</span> firstTask <span class=\"token operator\">=</span> <span class=\"token function\">peek</span><span class=\"token punctuation\">(</span>taskQueue<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span>firstTask <span class=\"token operator\">!==</span> currentTask <span class=\"token operator\">&amp;&amp;</span>\n      currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      firstTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      firstTask<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      firstTask<span class=\"token punctuation\">.</span>startTime <span class=\"token operator\">&lt;=</span> currentTime <span class=\"token operator\">&amp;&amp;</span>\n      firstTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">&lt;</span> currentTask<span class=\"token punctuation\">.</span>expirationTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n    <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>reconciler</strong>는 concurrent mode의 <strong>Work</strong>를 중간에 중지할 수 있습니다. 더 자세히는 Render phase에 국한되는 행위이며 일전에 보여드린 <a href=\"/react/in-depth-react-intro\" target=\"_blank\">컴포넌트 라이프 사이클 이미지</a>에 나와있는 <em>“May be paused, aborted or restarted”</em>에 대해 언급드리고 있는 것입니다.</p>\n<p><strong>reconciler</strong>는 <code class=\"language-text\">unstable_shouldYield()</code>를 통해 중지를 결정하므로 unstable_shouldYield()가 어떠한 근거를 가지고 판단하는지 확인해봅시다.</p>\n<ul>\n<li>7: advanceTimers()를 통해 삽인 된 timeout Timer든 <strong>reconciler</strong>의 스케줄 요청을 통해 삽입된 Task든 어쨌든 새롭게 삽입된 firstTask가 현재 진행 중인 currentTask보다 우선순위가 더 높다.</li>\n<li>8 ~ 10: currentTask가 존재하고 firstTask 또한 Work를 가지고 있다.</li>\n<li>11 ~ 12: firstTask는 이미 실행되어야 할 시간이 지났다.</li>\n</ul>\n<p>위 조건은 <strong>scheduler</strong> 입장에서의 기준이며 모두 만족해야 현재 진행 중인 Render phase를 중지할 수 있습니다. 또는 host_config 판단하에 브라우저에 메인 스레드를 양보해야 한다<up>13</up>면 Render phase를 바로 중지합니다.</p>\n<p>마지막으로 <strong>reconciler</strong>가 unstable_shouldYield()를 어디에 사용하는지 확인하면서 이번 포스트를 마무리합니다.</p>\n<anchor id=\"workLoopConcurrent\">\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1454\" target=\"_blank\" class=\"code_link\">reconciler > ReactFiberWorkLoop.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Scheduler_shouldYield <span class=\"token keyword\">as</span> shouldYield <span class=\"token keyword\">from</span> <span class=\"token string\">'./SchedulerWithReactIntegration'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Already timed out, so perform work without checking if we need to yield.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Perform work until Scheduler asks us to yield</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>위 함수들은 컴포넌트 단위의 재조정 작업을 진행하는 함수입니다. <code class=\"language-text\">workLoopSync()</code>는 legacy mode, blocking mode에서 사용하고 <code class=\"language-text\">workLoopConcurrent()</code>는 concurrent mode에서 사용합니다.</li>\n<li>while 문의 조건을 보면 concurrent mode에서만 <code class=\"language-text\">shouldYield()</code>를 사용하고 있습니다. 이 모드에서는 작업을 특정 컴포넌트까지 진행하다 중지시킬 수 있음을 해당 코드를 통해 짐작할 수 있습니다. 여기서 중지된 <strong>Work</strong>는 잔여 작업이 남아 있음을 <strong>scheduler</strong>에게 알려 주어야 계속해서 작업을 이어갈 수 있습니다.</li>\n</ul>\n<p>다음 포스트 <strong>reconciler</strong>에서는 <strong>Work</strong>가 하는 일이 도대체 무엇인지, 재조정 작업과 VDOM을 어떻게 DOM에 적용하는지, 함수형 컴포넌트의 라이프 사이클 격인 useEffect()와 useLayoutEffect()의 동작원리 등 리액트의 핵심 기능들을 알아볼 것입니다.</p>","frontmatter":{"title":"React 톺아보기 - 04. Scheduler_2","date":"2020-10-11","keywords":["리액트","react","fiber","hook","hooks","useState","useEffect","useLayoutEffect","useCallback","scheduler"]}}},"pageContext":{"slug":"/react/in-depth-react-scheduler_2/","previous":{"fields":{"slug":"/react/in-depth-react-scheduler_1/"},"frontmatter":{"title":"React 톺아보기 - 04. Scheduler_1","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_1/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_1","category":"react"}}}},"staticQueryHashes":["2277278352","536400264"]}