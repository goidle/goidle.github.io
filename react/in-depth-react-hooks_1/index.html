<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, minimum-scale=1, maximum-scale=2"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:Catamaran;font-weight:800;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:56px;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:20px;color:inherit;font-family:Catamaran;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.2;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:6px;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:2px;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#0687f0;text-decoration:none;box-shadow:none;}a:hover,a:active{text-decoration:underline;}a.gatsby-resp-image-link{box-shadow:none;text-decoration:none;}a:hover{text-decoration:none;}</style><style data-href="/styles.b1eba2561ae31f618bed.css">@import url(https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css);@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:100;src:local("Noto Sans KR Thin "),local("Noto Sans KR-Thin"),url(/static/noto-sans-kr-latin-100-2de137ca3e12ea146ee47485a97f1e78.woff2) format("woff2"),url(/static/noto-sans-kr-latin-100-b965647685dd9fc531d1f8a1cc25e024.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:300;src:local("Noto Sans KR Light "),local("Noto Sans KR-Light"),url(/static/noto-sans-kr-latin-300-4f773a0fce88aa857d70b56c5b0a1d26.woff2) format("woff2"),url(/static/noto-sans-kr-latin-300-ee87751dac814562bac316d848e35748.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:400;src:local("Noto Sans KR Regular "),local("Noto Sans KR-Regular"),url(/static/noto-sans-kr-latin-400-be09f2ced7ff9fa6eda5f0416e2fc840.woff2) format("woff2"),url(/static/noto-sans-kr-latin-400-4c50be0fe5b21a153b8e40a392c2d3fe.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:500;src:local("Noto Sans KR Medium "),local("Noto Sans KR-Medium"),url(/static/noto-sans-kr-latin-500-416698c2fc4b3951f8d63d3d2ae23900.woff2) format("woff2"),url(/static/noto-sans-kr-latin-500-28601458e118110e494903a1fcd6dcf5.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:700;src:local("Noto Sans KR Bold "),local("Noto Sans KR-Bold"),url(/static/noto-sans-kr-latin-700-04e782e08729f3725ae5a9c95da0c8ba.woff2) format("woff2"),url(/static/noto-sans-kr-latin-700-b9e989a96027f839a9569d2d011e0b71.woff) format("woff")}@font-face{font-family:Noto Sans KR;font-style:normal;font-display:swap;font-weight:900;src:local("Noto Sans KR Black "),local("Noto Sans KR-Black"),url(/static/noto-sans-kr-latin-900-c41f1395489a117ca36d550142a1695f.woff2) format("woff2"),url(/static/noto-sans-kr-latin-900-589f5fbf84d9dc9984a969bae969fd60.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:100;src:local("Catamaran Thin "),local("Catamaran-Thin"),url(/static/catamaran-latin-100-3570195a7b5f619dd9b2419d8fa3f089.woff2) format("woff2"),url(/static/catamaran-latin-100-e82908f57f6d2f23eb9876b2d6868195.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:200;src:local("Catamaran Extra Light "),local("Catamaran-Extra Light"),url(/static/catamaran-latin-200-987ea210308405ac77ba2f36430a70c9.woff2) format("woff2"),url(/static/catamaran-latin-200-bb5993d2f001b739bb9ab7c3ed9725c3.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:300;src:local("Catamaran Light "),local("Catamaran-Light"),url(/static/catamaran-latin-300-2b8a4bd13e9d5ba755f010f8732b0bb6.woff2) format("woff2"),url(/static/catamaran-latin-300-c2696c65c33dcf37871b72bad51ee1ce.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:400;src:local("Catamaran Regular "),local("Catamaran-Regular"),url(/static/catamaran-latin-400-640947b787a38ec35d097129637d9130.woff2) format("woff2"),url(/static/catamaran-latin-400-97e5bc807a3e915e3fbf40ce5fcb1128.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:500;src:local("Catamaran Medium "),local("Catamaran-Medium"),url(/static/catamaran-latin-500-884483dd213f37ae3b5c98f73dd190a5.woff2) format("woff2"),url(/static/catamaran-latin-500-412cf386e31213e3601cb2132b9c4c2d.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:600;src:local("Catamaran SemiBold "),local("Catamaran-SemiBold"),url(/static/catamaran-latin-600-eb6ebda25331e50d3f42c45a41f613bb.woff2) format("woff2"),url(/static/catamaran-latin-600-215c58c6114e0556cb1c332c0fda463a.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:700;src:local("Catamaran Bold "),local("Catamaran-Bold"),url(/static/catamaran-latin-700-3196f49881b324fa5a5f937875cc380f.woff2) format("woff2"),url(/static/catamaran-latin-700-05f6e51c518dd3b521b258e5c05d0e72.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:800;src:local("Catamaran ExtraBold "),local("Catamaran-ExtraBold"),url(/static/catamaran-latin-800-601b1d0f1b78fd65c3205b2c004bbe60.woff2) format("woff2"),url(/static/catamaran-latin-800-3b1675e4ede7e86ec79fa84c1203908e.woff) format("woff")}@font-face{font-family:Catamaran;font-style:normal;font-display:swap;font-weight:900;src:local("Catamaran Black "),local("Catamaran-Black"),url(/static/catamaran-latin-900-6bb5f96614acb7754020b922e1a63d24.woff2) format("woff2"),url(/static/catamaran-latin-900-79292dba48851cc3a212863c860d8f09.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.custom-hr{margin:64px 0;background:linear-gradient(72deg,#291e95,#cc007a);border:none;height:2px}.home-header{margin-top:0;border-bottom:none;font-weight:900;font-size:48px;letter-spacing:-2px}.link{box-shadow:none;text-decoration:none;color:inherit}.switch-container{text-align:right}.switch-container .icon{text-align:center;color:#222;font-size:14px;font-weight:900}.footer{padding-top:52px;text-align:center;font-size:12px}.footer a{text-decoration:none!important}.home{position:absolute;margin-top:-1.5px}body.light{background-color:#fff;color:#615f5f}body.light .home-header{color:#5a5a5a}body.light .bio .author-name-content{background-color:#ecf0f2}body.light .bio .author-introduction{color:#7d7d7d}body.light .bio a{color:navy}body.light .bio .bio_fontaswesome{fill:navy;vertical-align:-.125em}body.light .category-container{border-color:#ecf0f2;border-style:solid;border-width:1px 6px;background-color:#f4f7f8}body.light .category-container .item{border:1px solid #ecf0f2;background-color:#fff;box-shadow:0 1px 1px rgba(0,0,0,.1)}body.light .category-container .item a{color:#666}body.light .category-container .item[aria-selected=true]{border:2px solid #909da1;font-weight:bolder}body.light .category-container .item[aria-selected=true] a{color:#636c6e}body.light .category-container .item .badge{background-color:#f5222d;color:#fff}body.light .thumbnail{background-color:#fff;box-shadow:0 0 12px rgba(122,124,136,.212)}body.light .thumbnail h3{color:#5173b3}body.light .thumbnail p{color:#7d7d7d}body.light .thumbnail:hover{text-shadow:.1px .1px .1px rgba(68,67,67,.925);box-shadow:1px 3px 15px rgba(122,124,136,.432)}body.light .footer,body.light .thumbnail .thumbnail-subinfo{color:#615f5f}body.light .footer a{color:#5a5a5a}body.light .navigator a{background-color:#fceff7;color:#cc007a}body.light :not(pre)>code[class*=language-]{color:#fff;border:1.2px solid hsla(0,0%,100%,.64);background:#7d7d7d}body.dark{background-color:#282c35;color:#dbd8d8}body.dark .home-header{color:#eee}body.dark .bio .author-name-content{background-color:#383636}body.dark .bio .author-introduction{color:#dbd8d8}body.dark .bio a{color:#bb72ec}body.dark .bio .bio_fontaswesome{fill:#bb72ec;vertical-align:-.125em}body.dark .category-container{border-color:#383636;border-style:solid;border-width:1px 6px;background-color:#24272c}body.dark .category-container .item{border:1px solid #383636;background-color:#282c35;box-shadow:0 1px 1px hsla(0,0%,100%,.1)}body.dark .category-container .item a{color:#d8d7d7}body.dark .category-container .item[aria-selected=true]{border:2px solid #666;font-weight:bolder}body.dark .category-container .item[aria-selected=true] a{color:#fff}body.dark .category-container .item .badge{background-color:#d695ab;color:#eee}body.dark .thumbnail{background-color:#282c35;box-shadow:0 0 12px rgba(197,166,201,.2)}body.dark .thumbnail h3{color:#d695ab}body.dark .thumbnail p{color:#dbd8d8}body.dark .thumbnail:hover{box-shadow:1px 1px 13px rgba(195,153,201,.26);text-shadow:.1px .1px .1px #fff}body.dark .footer,body.dark .thumbnail .thumbnail-subinfo{color:#dbd8d8}body.dark .footer a{color:#fff}body.dark blockquote{border-left:4px solid hsla(0,0%,100%,.822)}body.dark h1,body.dark h2{border-bottom-color:hsla(0,0%,100%,.3)}body.dark .navigator a{background-color:#fceff7;color:#cc007a}body.dark td,body.dark th{border-bottom:1px solid hsla(0,0%,100%,.15)}body.dark :not(pre)>code[class*=language-]{color:#020202;border:1.2px solid rgba(0,0,0,.64);background:#fffbfe}body{font-family:Noto Sans KR,sans-serif;background-color:#fff;-webkit-text-size-adjust:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-transition:background-color .3s,color .3s;transition:background-color .3s,color .3s}h1{margin-top:2em;font-size:2.15em}h1,h2{letter-spacing:-1px;border-bottom:transparent!important}h2{margin-top:1.5em;margin-bottom:0;font-size:1.5em}h3{font-weight:700;margin-bottom:.1rem;margin-top:0;letter-spacing:-1px}@media (max-width:500px){.home-header{font-size:40px}}.post-date{text-align:right;font-size:12px;font-style:italic}.bio{margin-bottom:15px}.bio .author-description{display:flex}.bio .author-image{margin-top:0;margin-right:12px;margin-bottom:0;min-width:95px}.bio .author-name{display:flex;flex-direction:column;justify-content:center}.bio .author-name-prefix{font-size:90%;margin-right:4px}.bio .author-name-content{display:inline-block;font-size:95%;padding:2px 6px;font-weight:bolder;border-radius:8px;-webkit-transform-origin:center;transform-origin:center}.bio .author-introduction{margin-top:4px;font-size:80%;line-height:1.4}.bio .author-socials{margin-top:4px}.bio a{margin-right:8px;font-size:80%;cursor:pointer}.bio a.visited{text-decoration:none}@-webkit-keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}@keyframes flutter{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}35%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}40%{-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}60%{-webkit-transform:rotate(5deg);transform:rotate(5deg)}65%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}.navigator{margin:40px 0;display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0}.navigator li{margin-bottom:12px}.navigator a{padding:7px 16px 8px;border-radius:6px;font-size:12px;opacity:.8}.post h1{font-size:2.5rem;line-height:1.1}.post h2{margin-top:3.5rem;font-size:1.73286rem}.post h2,.post p{margin-bottom:1.75rem}.post li{margin-bottom:.875rem}.post .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1.2em;margin-left:-1.2em;padding-right:1em;padding-left:.75em;border-left:.35em solid #0687f0}.post blockquote{color:#999}.post code[class*=language-],.post pre[class*=language-]{color:#e0e0e0;background:none;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none}.post pre[class*=language-]::-webkit-scrollbar{display:none}.post pre[class*=language-]{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:.6em}.post :not(pre)>code[class*=language-],.post pre[class*=language-]{background:#212121}.post :not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.5em;white-space:normal;color:#d66587;margin:0 .1em}.post .token.block-comment,.post .token.cdata,.post .token.comment,.post .token.doctype,.post .token.prolog{color:#616161}.post .token.punctuation{color:#e0e0e0}.post .token.attr-name,.post .token.deleted,.post .token.namespace,.post .token.tag{color:#e2777a}.post .token.function-name{color:#6196cc}.post .token.boolean,.post .token.function,.post .token.number{color:#ff9100}.post .token.class-name,.post .token.constant,.post .token.property,.post .token.symbol{color:#ff0}.post .token.atrule,.post .token.builtin,.post .token.important,.post .token.keyword,.post .token.selector{color:#b388ff}.post .token.attr-value,.post .token.char,.post .token.regex,.post .token.string,.post .token.variable{color:#00e676}.post .token.entity,.post .token.operator,.post .token.url{color:#67cdcc}.post .token.bold,.post .token.important{font-weight:700}.post .token.italic{font-style:italic}.post .token.entity{cursor:help}.post .token.inserted{color:green}.dark .anchor{fill:#dbd8d8}.light .anchor{fill:#615f5f}td[align=center]:first-child,th[align=center]:first-child{text-align:center!important;font-weight:bolder!important}table{margin-top:100px}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none;margin:1.2em}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.tldr{padding-left:1em;margin-top:-26px}h3{margin-bottom:.5em}h3 code.language-text{font-size:16px!important}up{top:-.5em;font-size:75%}down,up{position:relative;line-height:0;vertical-align:baseline;font-weight:500}down{font-size:85%}figcaption{padding:3px;text-align:center}center,figcaption{font:italic smaller sans-serif;font-weight:700;font-size:14px}center{top:-.7em;position:relative}ol li,ol li p{margin-bottom:.3rem!important}.item{position:relative}.item .badge{display:inline-block;position:absolute;top:1px;right:3px;-webkit-transform:translate(50%,-50%);transform:translate(50%,-50%);border-radius:10px;box-shadow:0 0 0 1px;padding:8px 7px;z-index:999;font-weight:700}.category-container{position:sticky;position:-webkit-sticky;top:0;line-height:0;white-space:nowrap;overflow-x:scroll;-ms-overflow-style:none;overflow:-moz-scrollbars-none;z-index:1;padding:6px 20px;margin:0 -5px!important}.category-container .item{display:inline-block;margin:.25rem 7px .25rem 0;border-radius:15px;white-space:normal;box-sizing:border-box;cursor:pointer}.category-container .item div{display:block;padding:14px 16px 16px;font-size:13px;box-sizing:border-box}.category-container .item:last-child{margin-right:0}.category-container::-webkit-scrollbar{display:none}.thumbnail-container{min-height:calc(100vh - 3.5rem)}.thumbnail{display:block;margin-top:12px;padding:15px 15px 12px;-webkit-transition:box-shadow .3s,text-shadow .3s,opacity .4s;transition:box-shadow .3s,text-shadow .3s,opacity .4s;opacity:0;border-radius:10px}.thumbnail p{font-size:90%;line-height:1.4}.thumbnail .thumbnail-subinfo{font-size:.75rem;margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px solid #e8e8e8}.thumbnail.visible{opacity:1}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ffffff"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9dbdaa6d9a815c4dab57eaac04ef491f"/><meta name="generator" content="Gatsby 2.18.10"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">React 톺아보기- 03. Hooks_1 | Deep Dive Magic Code</title><meta data-react-helmet="true" name="description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다. 훅을 통해 컴포넌트 상태를 업데이트한다. VDOM 재조정을 해줄 Work를 scheduler에게 스케줄링 시키고 scheduler가 스케줄링된 Task를 꺼내 실행한다 Work을 통해 VDOM 재조정 작업을 진행한다. 완성된 VDOM을 commit phase…"/><meta data-react-helmet="true" property="og:title" content="React 톺아보기- 03. Hooks_1 | Deep Dive Magic Code"/><meta data-react-helmet="true" property="og:description" content="모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다. 훅을 통해 컴포넌트 상태를 업데이트한다. VDOM 재조정을 해줄 Work를 scheduler에게 스케줄링 시키고 scheduler가 스케줄링된 Task를 꺼내 실행한다 Work을 통해 VDOM 재조정 작업을 진행한다. 완성된 VDOM을 commit phase…"/><meta data-react-helmet="true" property="og:image" content="/static/felog-f24356c48475809626ea0c2ac67855c6.png"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="google-site-verification" content="o402P1kCwteUVT_5s9zR21dD9lTF4ALZNLms22CIMx4"/><meta data-react-helmet="true" name="keywords" content="react, redux, javascript, web, development, frontend, 리액트, react, fiber, hook, hooks, useState, useEffect, useLayoutEffect, useCallback"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/app-69573b14c89d32433a71.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-ef229068f1a7461d6597.js"/><link as="script" rel="preload" href="/styles-f42f8789f3cee93e7f05.js"/><link as="script" rel="preload" href="/commons-fbb6f814cffdadebdb5b.js"/><link as="script" rel="preload" href="/webpack-runtime-e1056f6722281b635472.js"/><link as="fetch" rel="preload" href="/page-data/react/in-depth-react-hooks_1/page-data.json" crossorigin="anonymous"/></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:52rem;padding:2.4375rem 1.21875rem" class="post"><a class="link" href="/"><svg class="home" width="1.125em" font-size="2em" overflow="visible" viewBox="0 0 576 512"><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg></a><div class="switch-container"><label for="normal-switch"><div style="position:relative;display:inline-block;text-align:left;opacity:1;direction:ltr;border-radius:12px;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s;touch-action:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none"><div class="react-switch-bg" style="height:24px;width:48px;margin:0;position:relative;background:#d9dfe2;border-radius:12px;cursor:pointer;-webkit-transition:background 0.25s;-moz-transition:background 0.25s;transition:background 0.25s"><div style="height:24px;width:26px;position:relative;opacity:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon checkedIcon">D</div></div><div style="height:24px;width:26px;position:absolute;opacity:1;right:0;top:0;pointer-events:none;-webkit-transition:opacity 0.25s;-moz-transition:opacity 0.25s;transition:opacity 0.25s"><div class="icon uncheckedIcon">L</div></div></div><div class="react-switch-handle" style="height:22px;width:22px;background:#ffffff;display:inline-block;cursor:pointer;border-radius:50%;position:absolute;transform:translateX(1px);top:1px;outline:0;border:0;-webkit-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;-moz-transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s;transition:background-color 0.25s, transform 0.25s, box-shadow 0.15s"></div><input type="checkbox" role="switch" style="border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px" id="normal-switch"/></div></label></div><h1>React 톺아보기- 03. Hooks_1</h1><p class="post-date">a month ago</p><div><blockquote>
<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트 기준입니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>
</blockquote>
<p>각 포스트의 주제는 다음과 같이 리액트의 일반적인 흐름을 따라가도록 구성되었습니다.</p>
<ol>
<li>훅을 통해 컴포넌트 상태를 업데이트한다.</li>
<li>VDOM 재조정을 해줄 Work를 scheduler에게 스케줄링 시키고 scheduler가 스케줄링된 Task를 꺼내 실행한다</li>
<li>Work을 통해 VDOM 재조정 작업을 진행한다.</li>
<li>완성된 VDOM을 commit phase에서 처리하여 DOM에 적용한다.</li>
<li>사용자의 상호작용으로 이벤트가 발생하고 해당 이벤트에 등록된 핸들러가 실행되면서 다시 1번으로 되돌아간다.</li>
</ol>
<p>위 흐름의 내용만 제대로 이해하게 된다면 이 이외의 케이스들에 대해서는 굳이 설명하지 않아도 혼자서 충분히 알아볼 수 있지 않을까 기대해봅니다.</p>
<p>이번 포스트에서는 첫 번째인 훅을 다룹니다. 훅이 어떻게 컴포넌트를 업데이트하는지 알아보도록 하겠습니다.<br>
목차는 다음과 같습니다.</p>
<ol>
<li>훅 가져오기</li>
<li>컴포넌트가 처음 마운트될 때 훅이 어떻게 같이 만들어지는가?</li>
<li>훅을 통해 컴포넌트를 업데이트 했을 때 컴포넌트 렌더링 과정에서 어떻게 업데이트된 값을 가지고 와서 적용시키는가?</li>
</ol>
<p>훅은 리액트 코어에 구현되어 있지 않고 외부 모듈에서 가지고 옵니다. 그래서 훅을 사용하는 코드를 바로 찾아가서 시작하지 않고 어떠한 방식으로 개발자에게 전달하는지부터 확인하겠습니다.</p>
<h1 id="1-hook의-구현체는-어디에-있을까"><a href="#1-hook%EC%9D%98-%EA%B5%AC%ED%98%84%EC%B2%B4%EB%8A%94-%EC%96%B4%EB%94%94%EC%97%90-%EC%9E%88%EC%9D%84%EA%B9%8C" aria-label="1 hook의 구현체는 어디에 있을까 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. Hook의 구현체는 어디에 있을까?</h1>
<p>분석을 시작하기 가장 좋은 방법은 분석할 함수를 어디서 어떻게 가져오는지 먼저 확인하는 것입니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// react > React.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactHooks'</span>
<span class="token keyword">import</span> ReactSharedInternals <span class="token keyword">from</span> <span class="token string">'./ReactSharedInternals'</span> <span class="token comment">// 의존성을 주입받는 징검다리</span>

<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  useState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">,</span>
  <span class="token comment">// 생략..</span>
  __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">:</span> ReactSharedInternals<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React</code></pre></div>
<p>개발자가 코어를 통해 가져오는 훅은 <code class="language-text">ReactHooks.js</code> 모듈에서 가져오고 있습니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// react > ReactHooks.js</span>
<span class="token keyword">import</span> ReactCurrentDispatcher <span class="token keyword">from</span> <span class="token string">'./ReactCurrentDispatcher'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">create<span class="token punctuation">,</span> inputs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span>create<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current
  <span class="token keyword">return</span> dispatcher
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">ReactCurrentDispatcher.js</code> 모듈에서 <code class="language-text">dispatcher</code>를 가지고 오네요. 훅의 구현체는 <code class="language-text">dispatcher</code>가 가지고 있나 봅니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// react > ReactCurrentDispatcher.js</span>
<span class="token keyword">const</span> ReactCurrentDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  current<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactCurrentDispatcher</code></pre></div>
<p>아무것도 없습니다.. 그냥 객체 하나가 끝입니다.</p>
<p>훅에 대해서 좀만 더 생각해보자면 훅은 컴포넌트의 상태를 업데이트하는데 코어에서는 컴포넌트의 겉 정보인 react element만을 관리합니다. 인스턴스화 되기 전인 클래스라고 생각하시면 편할것 같습니다.<br>
컴포넌트의 상태는 VDOM의 fiber에 저장되는데 이 fiber를 업데이트할 수 있는 권한은 fiber를 만들어내는 reconciler에게 있습니다. 그러므로 상태를 변경 시킬 수 있는 훅의 구현체 또한 reconciler에 위치해 있습니다.</p>
<p>근데 위 리액트 코어를 보면 어디에도 reconciler에서 훅을 가져오는 부분을 보지 못했습니다. 그렇다는 말은 반대로 훅 객체를 밖에서 안으로 누군가가 <code class="language-text">ReactCurrentDispatcher.current</code>에 주입해준다는 말이 됩니다.<br>
코어가 다른 패키지의 기능을 개발자에게 제공해 줄 때 의존성을 자기가 만들지 않고 외부에서 주입 받습니다. 스프링의 DI(Dependency Injection)와 같습니다.</p>
<p>그리고 한발 더 나아가서 리액트는 외부에서 의존성을 주입할 때 코어에 직접적으로 주입하지 않습니다. 중간자를 하나 더 두게 되는데 그게 코어에서는 <code class="language-text">ReactSharedInternals.js</code> 모듈이고 더 넓게 패키지로 보면 Shared라는 패키지가 있습니다.</p>
<h3 id="의존성을-관리하는-code-classlanguage-textreactsharedinternalsjscode-shared-패키지"><a href="#%EC%9D%98%EC%A1%B4%EC%84%B1%EC%9D%84-%EA%B4%80%EB%A6%AC%ED%95%98%EB%8A%94-code-classlanguage-textreactsharedinternalsjscode-shared-%ED%8C%A8%ED%82%A4%EC%A7%80" aria-label="의존성을 관리하는 code classlanguage textreactsharedinternalsjscode shared 패키지 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>의존성을 관리하는 <code class="language-text">ReactSharedInternals.js</code>, Shared 패키지</h3>
<p>먼저 <code class="language-text">ReactSharedInternals.js</code>부터 보면 여기에 있는 모든 모듈은 외부에서 주입받아 개발자에게 제공되는 모듈입니다. <code class="language-text">ReactCurrentDispatcher</code>도 여기에서 훅을 주입받길 기다리고 있습니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// react > ReactSharedInternals.js</span>
<span class="token keyword">import</span> ReactCurrentDispatcher <span class="token keyword">from</span> <span class="token string">'./ReactCurrentDispatcher'</span>
<span class="token keyword">import</span> ReactCurrentBatchConfig <span class="token keyword">from</span> <span class="token string">'./ReactCurrentBatchConfig'</span>
<span class="token keyword">import</span> ReactCurrentOwner <span class="token keyword">from</span> <span class="token string">'./ReactCurrentOwner'</span>
<span class="token comment">// 생략..</span>

<span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span> <span class="token punctuation">{</span>
  ReactCurrentDispatcher<span class="token punctuation">,</span>
  ReactCurrentBatchConfig<span class="token punctuation">,</span>
  ReactCurrentOwner<span class="token punctuation">,</span>
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactSharedInternals</code></pre></div>
<p>Shared는 모든 패키지들이 공유하는 정보들을 가지고 있는데 <code class="language-text">ReactSharedInternals.js</code>가 여기에서 import되어 reconciler에서 사용할 수 있게 해줍니다.<br>
이 내용의 모듈은 shared의 <code class="language-text">ReactSharedInternals.js</code>입니다. 코어의 모듈과 같은 이름이기 때문에 헷갈릴수 있습니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// shared > ReactSharedInternals.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span>
  React<span class="token punctuation">.</span>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ReactSharedInternals<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'ReactCurrentDispatcher'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReactSharedInternals<span class="token punctuation">.</span>ReactCurrentDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
    current<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 생략..</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactSharedInternals</code></pre></div>
<p>맨 처음 React 선언 코드에서 본 <code class="language-text">__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</code>를 통해 코어의 <code class="language-text">ReactSharedInternals.js</code>을 가져와서 다른 패키지들이 코어에 의존성을 주입할 수 있도록 해줍니다. 이제 reconciler는 shared의 <code class="language-text">ReactSharedInternals.js</code>을 이용하여 코어에 훅을 마음대로 주입할 수 있습니다.</p>
<p>개발자에게 도달되는 흐름은 다음과 같습니다.
reconciler -> shared/ReactSharedInternal -> react/ReactSharedInternal -> react/ReactCurrentDispatcher -> react/ReactHooks -> react -> 개발자의 형태가 됩니다. 다시 코드를 한 번 쭉 훑어 보시면서 흐름을 느껴 보시길 바랍니다.</p>
<p>이제 우리는 훅이 어디에 있는지 shared/ReactSharedInternal.js를 import하고 <code class="language-text">ReactCurrentDispatcher</code>를 사용하고 있는 곳을 찾아가면 확인할 수 있습니다.<br>
훅은 reconciler/ReactFiberHooks.js에 위치해 있습니다.</p>
<h1 id="2-hook은-내부에서-어떻게-사용되는가"><a href="#2-hook%EC%9D%80-%EB%82%B4%EB%B6%80%EC%97%90%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%82%AC%EC%9A%A9%EB%90%98%EB%8A%94%EA%B0%80" aria-label="2 hook은 내부에서 어떻게 사용되는가 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Hook은 내부에서 어떻게 사용되는가?</h1>
<blockquote>
<p>본격적으로 들어가기에 전에 알려드립니다.</p>
<ul>
<li>함수 내부에서 선언된 지역변수인지 모듈 최상단에 선언된 전역변수인지 잘 확인하시길 바랍니다.</li>
<li>설명하지 않고 넘어가는 코드는 크게 신경 쓰지 않으셔도 됩니다. 복잡하니 그때는 생략되고 사용되는 뒷부분에서 다룹니다.</li>
<li>실제 코드를 보면 __DEV__로 감싸진 코드들을 많이 보실 텐데 개발 모드에서만 사용됨을 뜻하므로 산뜻하게 무시해주시면 됩니다.</li>
<li>분석하기에 type이 있으면 좋을 부분들은 type를 제거하지 않고 그대로 사용하도록 하겠습니다.</li>
</ul>
</blockquote>
<p>훅을 <code class="language-text">ReactCurrentDispatcher.current</code>에 주입하는 곳은 <code class="language-text">renderWithHooks()</code>입니다. 함수 이름에서 느껴지시나요? 컴포넌트 실행을 여기서 합니다. 이 함수의 주목적은 훅을 넘겨주는 게 아니라 함수 실행이고 훅 주입은 부수적으로 따라오는 부분입니다. 이 함수는 render phase에서 호출되는데 그때 가서 자세히 다루고 지금은 훅과 관련된 코드들만 뜯어와서 보도록 하겠습니다.</p>
<anchor id="renderWithHooks()" />
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > renderWithHooks()</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  props<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  refOrContext<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  nextRenderExpirationTime<span class="token punctuation">:</span> ExpirationTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress <span class="token comment">// 현재 작업 중인 fiber를 전역으로 잡아둠</span>
  nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token punctuation">:</span> <span class="token keyword">null</span>

  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
    nextCurrentHook <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> HooksDispatcherOnMount <span class="token punctuation">:</span> HooksDispatcherOnUpdate

  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span>

  <span class="token comment">// 컴포넌트 재실행 로직 생략..</span>

  <span class="token keyword">const</span> renderedWork <span class="token operator">=</span> currentlyRenderingFiber
  renderedWork<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> firstWorkInProgressHook

  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>reconciler 패키지의 여러 모듈들은 자신의 컨텍스트을 현재 작업 중인 컴포넌트 전용으로 사용합니다. 이 말이 무슨 뜻이냐면 해당 모듈에서 선언되는
모든 전역 변수들(<down>firstWorkInProgressHook, nextCurrentHook..</down>)은 작업중인 컴포넌트에만 국한되는 상태값으로 관리한다는 뜻입니다.<br>
컴포넌트의 작업이 끝나게 되면 모두 초기화시켜 다음 컴포넌트에서 사용할 수 있도록 준비시켜 놓습니다.<br>
그렇기 때문에 전역변수인지 지역변수인지 유심히 살펴보시길 바랍니다.</p>
</blockquote>
<p><strong>17</strong>, <strong>20</strong> 라인을 먼저 확인하겠습니다.<br>
<code class="language-text">Component</code>는 fiber의 type에서 꺼낸 온 것인데 여기에는 개발자가 작성한 컴포넌트 함수가 저장되어 있습니다.
<strong>17</strong> 라인을 통해 훅을 사용하고 있는 컴포넌트를 실행하면 전역변수 <code class="language-text">firstWorkInProgressHook</code>에 hook 객체가 저장됩니다.
이 변수를 fiber의 <code class="language-text">memoizedState</code>에 저장해 놓음으로서 훅을 컴포넌트와 매핑시켜 줍니다.</p>
<p>이제 <strong>12</strong>번 라인을 이해할 수 있습니다. <code class="language-text">memoizedState</code>가 null이 아니라면 이전 컴포넌트 렌더에서 훅이 사용되었다는 뜻이 됩니다.<br>
그리고 <strong>15</strong> 라인에서 <code class="language-text">nextCurrentHook</code>을 이용하여 훅이 마운트인지 업데이트인지 판단을 하게 됩니다. 그리고 거기에 맞게 훅 구현체를 다르게 사용합니다.<br>
즉 컴포넌트가 마운트 될 때 훅은 마운트용 구현체를 사용할 것이고 그 이후에는 컴포넌트가 언마운트되지 않는 한 계속 업데이트용 구현체를 사용하게 됩니다.</p>
<p>마지막으로 <strong>22</strong>번 라인에서 한 번 더 다른 훅 구현체 <code class="language-text">ContextOnlyDispatcher</code>를 사용합니다. 이는 컴포넌트 실행이 모두 끝난 다음 혹시나 훅을 호출하는 상황이 발생할 때
에러를 던져 개발자가 올바르게 훅을 사용할 수 있도록 해주는 장치입니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// reconciler > ReactFiberHooks.js</span>

<span class="token comment">// mount</span>
<span class="token keyword">const</span> HooksDispatcherOnMount <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> mountState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> mountEffect<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// update</span>
<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> updateState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> updateEffect<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// invalid hook call</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextOnlyDispatcher<span class="token punctuation">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  useState<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<center>상황별 훅 구현체</center>
<h1 id="3-hook은-어떻게-구현되어-있을까"><a href="#3-hook%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EA%B5%AC%ED%98%84%EB%90%98%EC%96%B4-%EC%9E%88%EC%9D%84%EA%B9%8C" aria-label="3 hook은 어떻게 구현되어 있을까 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Hook은 어떻게 구현되어 있을까?</h1>
<p>목차의 2번 <strong><em>‘컴포넌트가 처음 마운트될 때 훅은 어떻게 같이 만들어지는가?’</em></strong>는 마운트 구현체를 통해 확인할 것이고 3번 <strong><em>‘훅을 통해 컴포넌트를 업데이트 했을 때 컴포넌트 렌더링 과정에서 어떻게 업데이트된 값을 가지고 와서 적용시키는가?’</em></strong>는 업데이트 구현체를 통해 확인하면서 훅 분석을 마무리 합니다.</p>
<h2 id="mount-구현체"><a href="#mount-%EA%B5%AC%ED%98%84%EC%B2%B4" aria-label="mount 구현체 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mount 구현체</h2>
<h3 id="1-훅-객체-만들기"><a href="#1-%ED%9B%85-%EA%B0%9D%EC%B2%B4-%EB%A7%8C%EB%93%A4%EA%B8%B0" aria-label="1 훅 객체 만들기 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 훅 객체 만들기</h3>
<p>컴포넌트가 마운트될 때 <code class="language-text">renderWithHooks()</code>에서 마운트 훅 구현체를 주입했습니다. useState()의 경우 아래의 <code class="language-text">mountState()</code>를 사용하게 됩니다. 가장 먼저 훅 객체를 생성합니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > mountState()</span>
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 훅 객체를 생성한다.</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span>

<span class="token comment">// reconciler > ReactFiberHooks.js > mountState() > mountWorkInProgressHook()</span>
<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// hook 객체에 대해서는 update에서 더욱 자세히 다루게 됩니다.</span>
  <span class="token keyword">const</span> hook<span class="token punctuation">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 컴포넌트에 적용된 마지막 상태값</span>
    queue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 훅이 여러 번 실행될 때 update들을 queue에 연결리스트로 저장한다.</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 다음 훅을 가리키는 노드 포인터</span>

    <span class="token comment">// 이하 update 구현체에서 설명</span>
    baseState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    baseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 맨 처음 실행되는 훅인 경우 연결 리스트의 head로 잡아둠</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    firstWorkInProgressHook <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 두번 째부터는 연결 리스트에 추가</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook
<span class="token punctuation">}</span></code></pre></div>
<p>이제 변수명에서 first만 보면 바로 연결 리스트로 생각 하셔도됩니다. 리액트는 많은 곳에서 built-in collection 대신 연결 리스트를 이용하여 구현했습니다.</p>
<blockquote>
<p>built-in collection이 아닌 연결리스트로 구현된 이유는 탐색할 때 제어하기가 매우 쉽기 때문입니다. 탐색 조건이나 중지, 노드의 삭제 등 제어가 간편합니다.<br>
또 다른 이점 하나는 연결 리스트끼리 이어 붙이는데 많은 리소스가 들지 않는다는 겁니다. tail 포인터만 연결할 리스트의 head를 가리키기만 하면 됩니다. 더불어 리액트에서는 랜덤 엑세스가 필요한 부분이 없으므로 더욱이 연결리스트를 쓰지 않을 이유가 없어 많은 곳에서 사용되고 있습니다.</p>
</blockquote>
<p><code class="language-text">firstWorkInProgressHook</code>은 <code class="language-text">renderWithHooks()</code>에서 이미 봤듯이 컴포넌트 실행이 끝났을 때 <code class="language-text">renderedWork.memoizedState = firstWorkInProgressHook;</code>으로 fiber에 head를 저장하는데 사용되고
<code class="language-text">workInProgressHook</code>은 연결 리스트에서 현재 처리되고 있는 훅의 tail 포인터로 사용합니다.<br>
여러 블로그에서 훅 구현체를 설명할 때 index와 배열을 이용하여 설명하지만 우리는 이제 실제 코드를 통해 연결 리스트로 되어 있다는 걸 알 수 있습니다.
그리고 왜 훅의 순서가 항상 같아야 하는지는 업데이트 구현체를 보면 명확하게 알 수 있습니다.</p>
<p>다음으로 훅을 사용할 때 넘겨받은 초기값인 <code class="language-text">initialState</code>가 함수이면 바로 실행해서 결괏값을 얻어옵니다. 이 이후 <code class="language-text">initialState</code>가 실행되는 일은 없습니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > mountState()</span>
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// const hook = mountWorkInProgressHook();</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 생성자 함수일 경우</span>
    initialState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> initialState
  <span class="token comment">//생략..</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="2-update를-담을-queue-생성"><a href="#2-update%EB%A5%BC-%EB%8B%B4%EC%9D%84-queue-%EC%83%9D%EC%84%B1" aria-label="2 update를 담을 queue 생성 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. update를 담을 queue 생성</h3>
<p>다음은 useState()가 반환하는 상태 업데이트 함수<up>setState</up> 를 호출할 때 넘겨주는 인자<up>action</up> 를 저장해놓을 <code class="language-text">queue</code>를 만듭니다.
한 번의 컴포넌트 실행에서 여러 번의 setState()가 호출되면 이 <code class="language-text">queue</code>에 다가 쌓아 놓습니다.
그리고 컴포넌트가 리-렌더링 될 때 <code class="language-text">queue</code>에 저장되어 있던 action들을 차례대로 꺼내서 실행해 최종 state를 도출합니다.
<anchor id="create_queue"></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// reconciler > ReactFiberHooks.js > mountState()</span>
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  <span class="token comment">// hook.memoizedState = hook.baseState = initialState;</span>

  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
    last<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 마지막 update</span>
    dispatch<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// push 함수</span>

    lastRenderedReducer<span class="token punctuation">:</span> basicStateReducer<span class="token punctuation">,</span> <span class="token comment">// return typeof action === 'function' ? action(state) : action;</span>
    lastRenderedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    currentlyRenderingFiber<span class="token punctuation">,</span>
    queue
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">dispatch</code>는 <code class="language-text">queue</code>의 push 함수입니다. <code class="language-text">dispatch</code> 할당을 자세히 보면 bind를 통해서 인자를 잡아둔 상태로 외부에 노출시키고 있습니다. 여기서 인자들에 대해 생각해 볼 부분은</p>
<ol>
<li>훅을 잡지 않고 queue를 잡아둔 것이고</li>
<li>다른 하나는 현재 작업중인 fiber를 잡아둔 것입니다.</li>
</ol>
<p>1번 <code class="language-text">dispatch</code>는 <code class="language-text">queue</code>의 push 함수이기 때문에 그렇습니다. <code class="language-text">dispatch</code>는 훅 객체를 알 필요가 없습니다. 단지 배열처럼 this를 통해 자신만 알면 됩니다. 그리고 이 this를 위 <code class="language-text">queue</code>를 잡아둔 방법으로 해결합니다.</p>
<p>2번 fiber에는 모든 정보가 있습니다. 그래서 update나 side effect, VDOM 재조정 작업을 나타내는 Work를 다룰 때 관련된 값만 따로 전달하지 않고 fiber 그 자체를 상황에 맞게 인식하는 방법으로 복잡도를 줄였습니다. <code class="language-text">dispatch</code>를 사용할 때 우리에게 필요한 정보가 fiber에 모두 존재하기 때문에 잡아둡니다. 이 fiber를 이용하여 <code class="language-text">dispatch</code>에서 어떠한 정보들을 뽑아내는지 바로 다음 섹션에서 알아보도록 하겠습니다.</p>
<p>마지막에 반환하는 배열 <code class="language-text">return [hook.memoizedState, dispatch]</code>이 우리가 사용하고 있는 <code class="language-text">const [a, setA] = useState(0);</code>입니다.</p>
<p>훅과 update에 대해 혹시나 혼동될까 봐 한 번 더 설명하자면 하나의 컴포넌트에서 여러 훅이 실행될 때는 훅 자체의 연결 리스트로 저장하고 그 중 하나의 훅이 여러 번 호출될 때는 호출되는 훅 객체의 queue에 update를 연결 리스트로 저장합니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token constant">FC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// aHook</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>b<span class="token punctuation">,</span> setB<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// bHook</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// firstUpdate</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// secondUpdate</span>
  <span class="token function">setA</span><span class="token punctuation">(</span><span class="token parameter">_a</span> <span class="token operator">=></span> _a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// thirdUpdate</span>

  <span class="token comment">// hook linked list</span>
  <span class="token comment">// fiber.memoizedState => aHook.next => bHook.next => null</span>

  <span class="token comment">// update circular linked list in queue of aHook</span>
  <span class="token comment">// fiber.memoizedState => aHook.queue.last => thirdUpdate.next</span>
  <span class="token comment">// firstUpdate.next => secondUpdate.next => thirdUpdate.next => firstUpdate</span>
<span class="token punctuation">}</span></code></pre></div>
<p>마지막으로 <code class="language-text">queue</code>에 push 해줄 <code class="language-text">dispatchAction()</code>를 알아보겠습니다.</p>
<h3 id="3-훅-상태를-업데이트하는-dispatchaction"><a href="#3-%ED%9B%85-%EC%83%81%ED%83%9C%EB%A5%BC-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%ED%95%98%EB%8A%94-dispatchaction" aria-label="3 훅 상태를 업데이트하는 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 훅 상태를 업데이트하는 dispatchAction</h3>
<p>VDOM 재조정 작업과 관련된 reconciler 코드를 보면 항상 render phase가 진행 중일 때 발생한 것인지 아니면 idle 상태에서 발생한 것인지에 따라 로직이 나뉩니다.<br>
두 케이스 모두 처리해야 할 방법과 최적화 방식이 조금씩 다르므로 현재 분석하고 있는 코드가 어떤 상황에서 사용되고 있는지 확실히 알고 가야 이해하기가 편합니다.</p>
<blockquote>
<p>render phase update란?<br>
컴포넌트가 렌더링 되고 있는 상황에서 추가적으로 업데이트가 발생할 경우를 말합니다.<br>
다음 코드에서 버튼을 클릭했을 때 컴포넌트는 변경된 상태값을 반영하기 위해 실행되는데 <code class="language-text">setA(2)</code>로 인해 추가적인 업데이트가 발생한 경우입니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token constant">FC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
</blockquote>
<p><code class="language-text">dispatchAction</code> 함수는 <code class="language-text">queue</code>에 update를 push함과 동시에 컴포넌트를 리-렌더링 시키기 위해 scheduler에게 Work를 스케줄링 시키는 함수입니다.<br>
<anchor id="dispatchAction()" /></p>
<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber 0" class="language-ts line-numbers"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span>
  <span class="token comment">// fiber와 queue는 이미 bind를 통해 currentlyRenderingFiber, queue로 인자가 잡혀있음을 유의하세요.</span>
  fiber<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  action
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    fiber <span class="token operator">===</span> currentlyRenderingFiber <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate <span class="token operator">===</span> currentlyRenderingFiber<span class="token punctuation">)</span></span>  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render phase update</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// idle update</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>if문의 조건이 무엇을 뜻하는지 알아보겠습니다.<br>
<code class="language-text">currentlyRenderingFiber</code>는 <a href="#renderWithHooks()">renderWithHooks()</a>에서 할당되었었습니다. <code class="language-text">renderWithHooks()</code>는 VDOM 재조정 작업 중 일때 호출됩니다. 즉 <code class="language-text">currentlyRenderingFiber</code>가 비어있지 않다는건 render phase가 진행 중인 상황임을 뜻합니다.</p>
<p><em>11</em>번 라인 bind로 잡아 두었던 <code class="language-text">fiber</code>와 <code class="language-text">currentlyRenderingFiber</code> 가 같다면 이는 현재 컴포넌트가 render phase에서 작업중인 컴포넌트이며 동시에 <code class="language-text">dispatchAction()</code>가 호출 되었으므로 업데이트가 발생한 상황임을 나타냅니다.</p>
<p>한가지 더 <code class="language-text">alternate</code>도 비교를 하는데 VDOM 트리는 두 개가 있다고 했습니다(<down>current, workInProgress</down>).<br>
하지만 우리는 <code class="language-text">fiber</code>를 bind로 고정시켜 놨습니다. 문제는 current와 workInProgress는 고정이 아닌 commit이 되면 서로 교체가 되기 때문에 현재 작업 중인 <code class="language-text">currentlyRenderingFiber</code>가 두 개의 트리 중 어느 트리인지 알 수가 없습니다. 그래서 <code class="language-text">fiber</code>와 <code class="language-text">alternate</code>를 모두 비교를 해야 현재 컴포넌트가 작업 중인지 확인할 수 있습니다.</p>
<p>if문의 분기된 로직 중 render phase update 코드는 idle update를 먼저 보고 난 후에 확인해 보도록 하겠습니다.</p>
<h3 id="3-1-유휴-상태에서의-dispatchaction"><a href="#3-1-%EC%9C%A0%ED%9C%B4-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C%EC%9D%98-dispatchaction" aria-label="3 1 유휴 상태에서의 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3-1. 유휴 상태에서의 dispatchAction</h3>
<p><code class="language-text">dispatchAction()</code>이 하는일을 미리 나열하면 다음과 같습니다.</p>
<ol>
<li>사용자의 업데이트 정보를 담은 <code class="language-text">update</code>객체를 만든다.</li>
<li><code class="language-text">update</code>를 <code class="language-text">queue</code>에 저장한다.</li>
<li>불필요한 렌더링이 발생하지 않도록 최적화를 한다.</li>
<li>업데이트를 적용시키기 위해 Work를 스케줄링 시킨다.</li>
</ol>
<p>위 순서는 idle update의 경우에 해당하고 render phase update는 4번을 제외하고는 다른 로직을 가지고 있으므로 추후에 가서 알아봅니다.</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// if (render phase update) {</span>
  <span class="token comment">// 생략..</span>
  <span class="token comment">// } else {</span>
  <span class="token comment">// idle update</span>
  <span class="token comment">// 아래 만료 시간을 구하는 부분은 잠시 설명을 생략 합니다.</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
    currentTime<span class="token punctuation">,</span>
    fiber<span class="token punctuation">,</span>
    suspenseConfig
  <span class="token punctuation">)</span>

  <span class="token comment">// update 생성</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    expirationTime<span class="token punctuation">,</span>
    action<span class="token punctuation">,</span> <span class="token comment">// setState의 인자</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 연결 리스트</span>
    <span class="token comment">// 이하 최적화에 사용되는 속성</span>
    eagerReducer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    eagerState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// update를 queue에 연결리스트로 추가</span>
  <span class="token keyword">const</span> last <span class="token operator">=</span> queue<span class="token punctuation">.</span>last
  <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first update. Create a circular list.</span>
<span class="gatsby-highlight-code-line">    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> first <span class="token operator">=</span> last<span class="token punctuation">.</span>next</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// Still circular.</span></span><span class="gatsby-highlight-code-line">      update<span class="token punctuation">.</span>next <span class="token operator">=</span> first</span>    <span class="token punctuation">}</span>
    last<span class="token punctuation">.</span>next <span class="token operator">=</span> update
  <span class="token punctuation">}</span>
  queue<span class="token punctuation">.</span>last <span class="token operator">=</span> update
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span></code></pre></div>
<p>update를 큐에 추가할 때 연결 리스트로 추가합니다. 로직을 보면 <em>Circular Linked List</em>로 만들어 주는 부분(<down>하이라이트</down>)이 있는데 왜 이렇게 만들어 주는지는 update 구현체에서 설명하도록 하겠습니다. 그리고 만들어진 update를 <code class="language-text">queue</code>의 tail pointer(<code class="language-text">last</code>)에 추가해줍니다.</p>
<h3 id="3-2-불필요한-컴포넌트-리-렌더링-방지"><a href="#3-2-%EB%B6%88%ED%95%84%EC%9A%94%ED%95%9C-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EB%A6%AC-%EB%A0%8C%EB%8D%94%EB%A7%81-%EB%B0%A9%EC%A7%80" aria-label="3 2 불필요한 컴포넌트 리 렌더링 방지 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3-2. 불필요한 컴포넌트 리-렌더링 방지</h3>
<p>리액트는 이 시점에(<down><em>idle</em> 상태에서 업데이트가 발생한 상황</down>) 성능 최적화를 위한 한가지 선택지가 있습니다.<br>
다음과 같이 가정을 해보겠습니다.</p>
<ol>
<li>현재 컴포넌트에 대한 Work가 스케줄링 되어있지 않은 상태이고</li>
<li>넘겨받은 <code class="language-text">action</code>의 결괏값이 현재 state와 같다면?
이때는 state가 변경된게 없으므로 더 이상 진행하지 않고 <strong>bail out</strong>할 수 있습니다.</li>
</ol>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  <span class="token comment">// queue.last = update;</span>

  <span class="token comment">// 컴포넌트가 유휴 상태인지 확인</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 최적화 로직..</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>if문에서 현재 컴포넌트가 idle 상태인지 확인합니다. <code class="language-text">fiber</code>와 <code class="language-text">alternate</code>를 모두 비교하는 이유를 우리는 이제 알고 있습니다.
여기서 <code class="language-text">expirationTime</code>은 업데이트가 발생한 컴포넌트에서 Work가 스케줄링 되면 해당 컴포넌트<up>fiber</up>에 <code class="language-text">expirationTime</code>를 새깁니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  <span class="token comment">// if (</span>
  <span class="token comment">//     fiber.expirationTime === NoWork &amp;&amp;</span>
  <span class="token comment">//     (alternate === null || alternate.expirationTime === NoWork)</span>
  <span class="token comment">//   ) {</span>
  <span class="token keyword">const</span> lastRenderedReducer <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedReducer
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRenderedReducer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentState <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedState <span class="token comment">// 컴포넌트에 적용된 상태값</span>
    <span class="token keyword">const</span> eagerState <span class="token operator">=</span> <span class="token function">lastRenderedReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    update<span class="token punctuation">.</span>eagerReducer <span class="token operator">=</span> lastRenderedReducer
    update<span class="token punctuation">.</span>eagerState <span class="token operator">=</span> eagerState
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">(</span>eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//  }</span>
  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">queue</code>를 만들 때 <code class="language-text">lastRenderedReducer</code>에 <code class="language-text">basicStateReducer</code>를 <a href="#create_queue">할당</a>했었습니다.
<code class="language-text">basicStateReducer</code>의 로직은 간단합니다(<down>return typeof action === ‘function’ ? action(state) : action;</down>).<br>
추가로 말씀드자면 <code class="language-text">lastRenderedReducer</code>에는 <code class="language-text">useReduer</code>를 사용할 때 넘겨주는 reducer 함수가 할당되기도 합니다.
<code class="language-text">useState()</code>는 <code class="language-text">useReducer</code>와 같은 update 구현체를 공유합니다. 그러므로 <code class="language-text">useState()</code> 하나를 분석하면 <code class="language-text">useReducer</code>도 함께 알 수 있습니다.</p>
<p>현재 state와 같지 않다면 VDOM을 재조정해줄 Work를 스케줄링합니다. 여러 번 setState()를 호출해도 한 번만 스케줄링 되기 때문에 중복으로 Work가 중복으로 스케줄링 되지 않습니다. <code class="language-text">scheduleWork()</code>와 <code class="language-text">scheduler</code>에 대한 자세한 내용은 다음 포스트에서 다룹니다.</p>
<p>이제 생략했던 render phase update를 확인하도록 하겠습니다.</p>
<h3 id="4-render-phase에서의-dispatchaction"><a href="#4-render-phase%EC%97%90%EC%84%9C%EC%9D%98-dispatchaction" aria-label="4 render phase에서의 dispatchaction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. render phase에서의 dispatchAction</h3>
<p>render phase는 VDOM 재조정 작업 중인 상황입니다. 이 상황에서 컴포넌트를 실행하는 목적은 DOM에 마운트할 자식 react element를 얻기 위해서 인데 이 실행에서 추가적으로 <code class="language-text">setState()</code>가 호출되어 업데이트가 발생하면 idle update에서 처리해주었던(<down>schedule a work, bail out ..</down>) 작업없이 바로 컴포넌트를 재실행해 업데이트를 소비하여 반영된 react element를 얻어오면 됩니다.</p>
<p>render phase update를 바로 소비하기 위해서 이 업데이트를 잠깐 담아둘 임시 저장소가 필요합니다. 그래야 다음 컴포넌트 실행때 이 저장소에서 업데이트를 꺼내 적용시킬 수 있습니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// if (</span>
<span class="token comment">//   fiber === currentlyRenderingFiber ||</span>
<span class="token comment">//   (alternate !== null &amp;&amp; alternate === currentlyRenderingFiber)</span>
<span class="token comment">// ) {</span>
  didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// renderWithHooks()에게 컴포넌트 재실행을 알려줄 플래그</span>

  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    expirationTime<span class="token punctuation">:</span> renderExpirationTime<span class="token punctuation">,</span>
    action<span class="token punctuation">,</span>
    suspenseConfig<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    eagerReducer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    eagerState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>renderPhaseUpdates <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderPhaseUpdates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 업데이트를 저장할 맵</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> firstRenderPhaseUpdate <span class="token operator">=</span> renderPhaseUpdates<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRenderPhaseUpdate <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderPhaseUpdates<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Append the update to the end of the list.</span>
    <span class="token keyword">let</span> lastRenderPhaseUpdate <span class="token operator">=</span> firstRenderPhaseUpdate<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>lastRenderPhaseUpdate<span class="token punctuation">.</span>next <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lastRenderPhaseUpdate <span class="token operator">=</span> lastRenderPhaseUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lastRenderPhaseUpdate<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">// else {</span>
<span class="token comment">//   idle update..</span>
<span class="token comment">//   scheduleWork(fiber, expirationTime);</span>
<span class="token comment">// }</span></code></pre></div>
<p>업데이트를 알고 있는 건 <code class="language-text">queue</code>이기 때문에 <code class="language-text">queue</code>로 키를 잡아 업데이트를 저장합니다.<br>
이 맵을 소비하기 위해서는 컴포넌트를 재실행해주어야 하는데 컴포넌트 실행은 <code class="language-text">renderWithHooks()</code>에서 해주었습니다. 이제 이 함수에서 컴포넌트 재실행과 관련된 생략된 로직을 확인하도록 하겠습니다.</p>
<p>render phase update가 발생했을 때 <code class="language-text">didScheduleRenderPhaseUpdate</code> 플래그를 활성화시켜 주었습니다. <code class="language-text">renderWithHooks()</code>는 이 플래그를 통해 render phase update가 발생했는지 판단합니다. 그리고 컴포넌트를 재실행했는데 또 render phase update가 발생할 수도 있습니다. 이때는 발생하지 않을 때까지 재실행 로직을 반복하게 됩니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberHooks.js > renderWithHooks()</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략..</span>
  <span class="token comment">// let children = Component(props, refOrContext)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 재실행 플래그 초기화</span>
      numberOfReRenders <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment">// 무한 루프 방지</span>

      <span class="token comment">//이하 update 구현체에서 현재 컴포넌트가 재실행되는 상황인지 확인하는데 사용됨</span>
      nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState <span class="token punctuation">:</span> <span class="token keyword">null</span>
      nextWorkInProgressHook <span class="token operator">=</span> firstWorkInProgressHook

      <span class="token comment">// 필요한 전역 변수 초기화</span>
      currentHook <span class="token operator">=</span> <span class="token keyword">null</span>
      workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span>

      ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> HooksDispatcherOnUpdate <span class="token comment">// update 구현체 사용</span>

      children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> refOrContext<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>didScheduleRenderPhaseUpdate<span class="token punctuation">)</span>

    renderPhaseUpdates <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// render phase update 저장소 초기화</span>
    numberOfReRenders <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// const renderedWork = currentlyRenderingFiber</span>
  <span class="token comment">// ReactCurrentDispatcher.current = ContextOnlyDispatcher</span>
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span></code></pre></div>
<p>훅을 사용하면서 많이 보셨을 메시지인 <strong><em>“Too many re-renders. React limits the number of renders to prevent an infinite loop.”</em></strong>는 <code class="language-text">dispatchAction()</code>에서 <code class="language-text">numberOfReRenders</code>을 기준으로 출력됩니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// reconciler > ReactFiberHooks.js > dispatchAction()</span>
<span class="token keyword">function</span> dispatchAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">(</span>
  fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">,</span>
  action<span class="token punctuation">:</span> <span class="token constant">A</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    numberOfReRenders <span class="token operator">&lt;</span> <span class="token constant">RE_RENDER_LIMIT</span><span class="token punctuation">,</span>
    <span class="token string">'Too many re-renders. React limits the number of renders to prevent '</span> <span class="token operator">+</span>
      <span class="token string">'an infinite loop.'</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 생략..</span>
<span class="token punctuation">}</span></code></pre></div>
<p>여기까지가 mount 구현체 입니다. 글이 너무 길기 때문에 update 구현체는 다음 포스트에 작성합니다.<br>
<code class="language-text">renderPhaseUpdates</code>에 저장된 업데이트 소비는 컴포넌트가 재실행될 때 update 구현체에서 소비되므로 다음 포스트에서 다룹니다.</p>
<h2 id="정리"><a href="#%EC%A0%95%EB%A6%AC" aria-label="정리 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>정리</h2>
<p>이제 여러분은 다음과 같은 질문에 대답할 수 있어야 합니다.</p>
<ol>
<li><code class="language-text">setState()</code>를 한번에 여러 번 실행하면 매 실행마다 렌더링 되나요?</li>
<li>클릭을 통해 컴포넌트 상태를 업데이트시켰습니다. 그리고 변경된 상태를 기준으로 <code class="language-text">setState()</code>를 호출했어요. 그러면 클릭을 통한 상태 업데이트 때 한번, 추가적인 <code class="language-text">setState()</code> 때 또 한 번. 이렇게 매번 렌더링 되나요?</li>
</ol>
<p>이런 질문이 들어오면 일단 가장 먼저 질문자에게 해주어야 할 부분은 렌더링 단어의 의미를 명확하게 인식시키는 겁니다. 이 부분만 제대로 이해해도 개발자의 입장에서만 바라보던 것들을 리액트의 입장에서 바라볼 수 있도록 시야를 트여줍니다.</p>
<p>이제 하나씩 답변을 해보겠습니다.</p>
<ol>
<li>복수개의 훅 실행이 현재 state와 같다면 아무 일도 일어나지 않는다. 그게 아니면 한데 묶어서 다음 프레임 때 한 번만 컴포넌트가 재실행된다. 화면에 그려지는 것 또한 한 번이다.(<down>스케줄링도 한번</down>)</li>
<li>클릭을 통한 업데이트로 컴포넌트가 재실행 된다. 그리고 그 재실행에서 발생하는 추가적인 <code class="language-text">setState()</code>는 1번처럼 묶어서 한 번만 실행한다.<br>
여기서 업데이트가 발생하지 않을 때까지 계속해서 함수를 재실행한다. 결국, 최소 2번 최대 25번(<down>RE<em>RENDER</em>LIMIT = 25</down>) 컴포넌트가 재 실행될 수 있다. 그리고 화면은 1번과 마찬가지로 한 번만 그려진다.<br>
이 사이클은 render phase임을 유의해라. commit phase가 아니면 단지 in-memory 객체만 끄적인 것이지 아무 변화도 일어나지 않는다.</li>
</ol>
<p>여기까지 이해가 가시나요? 그러면 다행이지만 그렇지 않다면 가장 이해하기 쉬운 방법은 위 내용을 토대로 직접 코드를 작성해서 디버깅을 해보는 것입니다.</p>
<p>다음은 <code class="language-text">setState()</code>를 통해 <code class="language-text">queue</code>에 저장해두었던 update을 훅이 어떻게 소비하는지 알아보도록 하겠습니다.</p>
<h2 id="번외"><a href="#%EB%B2%88%EC%99%B8" aria-label="번외 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>번외</h2>
<h3 id="4-code-classlanguage-textexpirationtimecode"><a href="#4-code-classlanguage-textexpirationtimecode" aria-label="4 code classlanguage textexpirationtimecode permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. <code class="language-text">expirationTime</code></h3>
<p>생략된 <code class="language-text">expirationTime</code>에 대해 조금만 알아보겠습니다.<br>
<code class="language-text">expirationTime</code>에 대해서는 깊이 들어가지는 않지만 reconciler에서 전반적으로 사용되므로 아주 기본만 알고 넘어가겠습니다.</p>
<p><code class="language-text">expirationTime</code>는 scheduler와 reconciler에서 사용하는데 살짝 다른 뜻으로 쓰이지 않으며 구현도 다릅니다. scheduler에서는 이름 그대로 Task의 만료시간만을 나타내는 데 비해 reconciler에서는 이벤트를 구분하는 기준으로도 쓰입니다. 같은 <code class="language-text">expirationTime</code>에서 발생한 연속적인 이벤트는 하나의 이벤트로 간주하기 위함입니다. <code class="language-text">expirationTime</code>이 달라야 개별 이벤트로 판단합니다.</p>
<p><code class="language-text">expirationTime</code>의 가장 큰 수는 32-bit 시스템인 v8에서 처리할 수 있는 부호 있는 31bit 값입니다. 이 값을 Sync로 다룹니다.
이렇게 다룰 수 있는 이유는 위에서 설명한 것처럼 개별 업데이트를 구분하는 기준으로 사용하기 때문입니다.
그리고 <code class="language-text">legacy mode</code>에서는 모든 게 <code class="language-text">Sync</code>로 처리된다고 생각하시면 됩니다. 여기서 나오는 대부분은 <code class="language-text">concurrent mode</code>에서 사용됩니다.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberExpirationTime.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoWork <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Never <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Idle <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Sync <span class="token operator">=</span> <span class="token constant">MAX_SIGNED_31_BIT_INT</span> <span class="token comment">// 1073741823</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Batched <span class="token operator">=</span> Sync <span class="token operator">-</span> <span class="token number">1</span>

<span class="token keyword">const</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">=</span> Batched <span class="token operator">-</span> <span class="token number">1</span></code></pre></div>
<p>현재 시간을 구할 때 형식은 <code class="language-text">Date.now()</code>가 아닌 <code class="language-text">performance.now()</code> 입니다.</p>
<blockquote>
<p>performance.now는 브라우저가 시작되고 현재까지의 경과시간을 나타냅니다.</p>
</blockquote>
<p>이걸 바로 <code class="language-text">expirationTime</code>로 사용하지 않고 다음의 계산식을 이용합니다.<br>
<code class="language-text">() =&gt; MAX_SIGNED_31_BIT_INT - now()</code></p>
<p><code class="language-text">now()</code>가 오른쪽 피연산자에 있다는 건 나중에 발생한 작업일수록 더 작은 <code class="language-text">expirationTime</code> 값을 가지게 된다는 뜻입니다.
이 부분은 나중에 코드에서 fiber에 새겨진 <code class="language-text">expirationTime</code>를 가지고 대소비교를 할 때 헷갈릴 수 있으므로 기억해두시길 바랍니다.</p>
<p>근데 <code class="language-text">performance.now()</code>로(<down>브라우저 경과시간</down>) 현재 시간을 표현하기 때문에 그럴 일은 없겠지만 이론상으로는 발생 시간이 0이 나올 수도 있습니다. 이렇게 되면 <code class="language-text">Sync</code>나 <code class="language-text">Batched</code>와 시간이 겹칠 수 있어서 기존 상수들과 겹치지 않기 위해 offset 값이 필요한데 그게 바로 <code class="language-text">MAGIC_NUMBER_OFFSET</code>입니다.</p>
<p>이 이유 때문에 계산식을 다시 작성하자면 <code class="language-text">() =&gt; MAGIC_NUMBER_OFFSET - now()</code>가 됩니다. 이제 브라우저가 뜨자마자 바로 이벤트가 발생해도 <code class="language-text">Sync</code>와 <code class="language-text">Batched</code>와 겹칠일은 없습니다.</p>
<p>다음 코드가 발생시간에서 <code class="language-text">expirationTime</code>을 <code class="language-text">expirationTime</code>에서 다시 발생시간을 구하는 계산식입니다.</p>
<anchor id="currentTime">
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reconciler > ReactFiberExpirationTime.js</span>
<span class="token comment">// 생략..</span>
<span class="token comment">// const MAGIC_NUMBER_OFFSET = Batched - 1</span>

<span class="token keyword">const</span> <span class="token constant">UNIT_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment">// 1 unit of expiration time represents 10ms.</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">msToExpirationTime</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> ExpirationTime <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token parameter">expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">-</span> expirationTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">UNIT_SIZE</span>
<span class="token punctuation">}</span></code></pre></div>
<p>다시 간략하게 정리하자면 fiber의 <code class="language-text">expirationTime</code>이 <code class="language-text">NoWork</code>이면 작업 중인게 없다는 뜻이고 <code class="language-text">Sync</code>는 동기적으로 작업이 처리될 것이며 <code class="language-text">expirationTime</code>을 대소로 비교하는 조건문이 있을 때는 큰 숫자가 더 옛날에 먼저 발생한 작업이다. 라고만 생각하고 넘어가시면 분석할 때 큰 무리 없이 이해할 수 있을 것입니다.<br>
시간과 관련된 부분은 <code class="language-text">concurrent mode</code>가 일반적으로 사용이 되면 그때 깊이 있게 알아보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th align="center">목록</th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">1</td>
<td align="center"><a href="/react/in-depth-react-intro/">React 톺아보기- 02. Intro</a></td>
</tr>
<tr>
<td align="center">3</td>
<td align="center"><a href="/react/in-depth-react-hooks_2/">React 톺아보기- 03. Hooks_2</a></td>
</tr>
</tbody>
</table></div><hr class="custom-hr"/><div class="bio"><div class="author"><div class="author-description"><a class="link" href="/"><img class="author-image" src="/static/felog-f24356c48475809626ea0c2ac67855c6.png" alt="Goidle" style="width:72px;height:79px"/></a><div class="author-name"><div><a href="https://github.com/goidle" class="author-name-content"><div><svg class="bio_fontaswesome" width="1em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> <!-- -->Goidle<!-- --> <svg class="bio_fontaswesome" width="1.25em" display="inline-block" font-size="inherit" height="1em" overflow="visible" viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"></path></svg> TMON</div></a></div><div class="author-introduction">오픈소스를 톺아보며 매직 코드라 생각했던 부분들의 동작 원리와 의미, 의도를 파악해보고 서로의 생각을 나누기 위한 블로그</div></div></div></div></div><ul class="navigator"><li><a rel="prev" href="/react/in-depth-react-intro/">← <!-- -->React 톺아보기- 02. Intro</a></li><li><a rel="next" href="/react/in-depth-react-hooks_2/">React 톺아보기- 03. Hooks_2<!-- --> →</a></li></ul><div class="utterences"></div><footer class="footer">©<a href="https://github.com/JaeYeopHan">Goidle</a>, Built with<!-- --> <a href="https://github.com/JaeYeopHan/gatsby-starter-bee">Gatsby-starter-bee</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-154981109-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react/in-depth-react-hooks_1/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-69573b14c89d32433a71.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5efb7b8fb8a6286e0a5c.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-ef229068f1a7461d6597.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6bdb37d3a7ac9f5a4c88.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c9089e990f73b65ff865.js"]};/*]]>*/</script><script src="/webpack-runtime-e1056f6722281b635472.js" async=""></script><script src="/commons-fbb6f814cffdadebdb5b.js" async=""></script><script src="/styles-f42f8789f3cee93e7f05.js" async=""></script><script src="/component---src-templates-blog-post-js-ef229068f1a7461d6597.js" async=""></script><script src="/app-69573b14c89d32433a71.js" async=""></script></body></html>