{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/in-depth-react-reconciler_3/","result":{"data":{"site":{"siteMetadata":{"title":"Deep Dive Magic Code","author":"Goidle","comment":{"utterances":"goidle/goidle.github.io"}}},"markdownRemark":{"id":"8d8d2a46-ab7e-5e46-b7d3-ea4140e31311","excerpt":"모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다. 6 - 6 reconcileChildren() 재조정 작업의 목적은 VDOM…","html":"<blockquote>\n<p>모든 설명은 v16.12.0 버전 함수형 컴포넌트와 브라우저 환경을 기준으로 합니다. 버전에 따라 코드는 변경될 수 있으며 클래스 컴포넌트는 설명에서 제외됨을 알려 드립니다.</p>\n</blockquote>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 46.96969696969697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVQoz51Sy07DQAzs//8RvRGJXqjyB0gIIdFC2iTNo3nYHsZOWiJUBOIwWu/aOzv27MrMYMAEj80joKpr3K3XSJIEj9st7rmmaYqHzQbvWRY1urw7318FyTAQvZ9gubdxhKlC+w7adTCRWLWpYedz7O3cTrUek3XlzFpX0FMJYZF64bz3i9I0sKoiThi95pBBCcnzyOnxAC3LSQQwK3R2qhF//aJMxlAzFMWUJ3rGo5O3LcnqqI+ck6ksWp5ngOU8HGxX2NLyXAsqe36C7t4mkpsz/AksEqqJ9kmkZQEhhuyDyvOI/cxzofJXwqtJHAONCciXKs2PkNcX6H4H8/avM7wFN8iV0QxzV92ci0H8Uvb9y/yp5X/gE8YJwM2ieUG3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"render phase flow\" title=\"render phase flow\" src=\"/static/ea0101d7212866b4c6776ee262f8160e/2e237/render_phase_flow.png\" srcset=\"/static/ea0101d7212866b4c6776ee262f8160e/18f77/render_phase_flow.png 198w,\n/static/ea0101d7212866b4c6776ee262f8160e/2cb6c/render_phase_flow.png 395w,\n/static/ea0101d7212866b4c6776ee262f8160e/2e237/render_phase_flow.png 790w,\n/static/ea0101d7212866b4c6776ee262f8160e/471ef/render_phase_flow.png 1185w,\n/static/ea0101d7212866b4c6776ee262f8160e/f705a/render_phase_flow.png 1493w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<h2 id=\"6---6-reconcilechildren\" style=\"position:relative;\"><a href=\"#6---6-reconcilechildren\" aria-label=\"6   6 reconcilechildren permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 - 6 reconcileChildren()</h2>\n<p>재조정 작업의 목적은 VDOM 트리에서 변경이 발생한 부분을 효과적으로 비교하여 새로운 트리를 만들어내는 것입니다. 이때 효과적이란 최소한의 연산을 뜻하는데 리액트는 이 부분을 어떻게 처리하였는지 <a href=\"https://ko.reactjs.org/docs/reconciliation.html\" target=\"_blank\">공식홈페이지</a>에 자세히 기술하고 있습니다. 한번 읽어 보시고 오세요. 진행하는 데 많은 도움이 됩니다.</p>\n<p>아래는 그 일부분을 발췌한 내용입니다.</p>\n<blockquote>\n<p>두 가지 가정에 기반을 두어 O(n) 복잡도의 <u>휴리스틱</u> 알고리즘을 구현했습니다.</p>\n<ol>\n<li>서로 다른 type의 두 엘리먼트는 서로 다른 트리를 만들어낸다.</li>\n<li>개발자는 key prop을 통해, 여러 렌더링 사이에서 어떤 자식 엘리먼트가 변경되지 않아야 할지 표시해 줄 수 있다.</li>\n</ol>\n</blockquote>\n<p>핵심은 React element를 fiber로 확장할 때 <em>current를 재사용할 수 있는지</em> 또는 <em>새로운 fiber를 만들어 내어야 하는지</em> 이 두 가지의 선택지에서 어떠한 근거를 가지고 선택하느냐입니다. 만약 새로운 fiber로 생성한다면 <strong><u>하위 서브트리는 자연스레 완전히 새로운 서브트리로 재구축</u></strong>됩니다.</p>\n<p>이번 포스트의 목적은 이것을 어떻게 코드로 작성하였는지 분석하는 것입니다.</p>\n<h3 id=\"1-childreconciler\" style=\"position:relative;\"><a href=\"#1-childreconciler\" aria-label=\"1 childreconciler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) ChildReconciler()</h3>\n<p>재조정 작업과 관련된 일련의(<down>추가, 삭제..</down>) 함수들이 존재합니다. 이 함수들은 fiber의 마운트 여부에 따라 로직의 경로가 조금씩 다르며 매우 빈번하게 호출되므로 리액트는 컴파일러의 최적화에 도움을 주기 위해 경로가 다른 함수들을 다음과 같이 미리 분리하여 사용되도록 하였습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L258\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">shouldTrackSideEffects</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 삭제</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 마운트</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 추가, 위치 이동</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 마운트</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/*...*/</span>\n\n  <span class=\"token comment\">// 재조정 작업 진행</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> reconcileChildFibers<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// flag를 통해 마운트, 업데이트용 함수를 미리 나눠둠.</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> reconcileChildFibers <span class=\"token operator\">=</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> mountChildFibers <span class=\"token operator\">=</span> <span class=\"token function\">ChildReconciler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<ul>\n<li>마운트의 경우 <code class=\"language-text\">shouldTrackSideEffects</code>는 false이며 업데이트는 true입니다.</li>\n</ul>\n<p>위 함수들은 reconcileChildren()에서 아래와 같이 사용됩니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberBeginWork.js#L210\" target=\"_blank\">reconciler > ReactFiberBeginWork.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">current</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">workInProgress</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">nextChildren</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">renderExpirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">mountChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    workInProgress<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span>\n      workInProgress<span class=\"token punctuation\">,</span>\n      current<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">,</span>\n      nextChildren<span class=\"token punctuation\">,</span>\n      renderExpirationTime\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"2-재조정-작업의-시작\" style=\"position:relative;\"><a href=\"#2-%EC%9E%AC%EC%A1%B0%EC%A0%95-%EC%9E%91%EC%97%85%EC%9D%98-%EC%8B%9C%EC%9E%91\" aria-label=\"2 재조정 작업의 시작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) 재조정 작업의 시작</h3>\n<p>ChildReconciler()가 반환하는 reconcileChildFibers()는 자식 React element의 형식에 맞는 재조정 함수로 라우팅하는 역할을 합니다. 형식이란 단일 React element, Text, 복수의 자식을 담은 배열을 말합니다.\n<anchor id=\"reconcileChildFibers\" /></p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L1246\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildFibers</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span>\n  currentFirstChild<span class=\"token punctuation\">,</span>\n  newChild<span class=\"token punctuation\">,</span>\n  expirationTime</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// key가 없는 Fragment</span>\n  <span class=\"token keyword\">const</span> isUnkeyedTopLevelFragment <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span> <span class=\"token operator\">&amp;&amp;</span>\n    newChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isUnkeyedTopLevelFragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newChild <span class=\"token operator\">=</span> newChild<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> isObject <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token comment\">// React element</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span>\n          <span class=\"token function\">reconcileSingleElement</span><span class=\"token punctuation\">(</span>\n            returnFiber<span class=\"token punctuation\">,</span>\n            currentFirstChild<span class=\"token punctuation\">,</span>\n            newChild<span class=\"token punctuation\">,</span>\n            expirationTime\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">/*...*/</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Text</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">reconcileSingleTextNode</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        currentFirstChild<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">''</span> <span class=\"token operator\">+</span> newChild<span class=\"token punctuation\">,</span>\n        expirationTime\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 복수개의 자식을 담고 있는 배열</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n      returnFiber<span class=\"token punctuation\">,</span>\n      currentFirstChild<span class=\"token punctuation\">,</span>\n      newChild<span class=\"token punctuation\">,</span>\n      expirationTime\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Remaining cases are all treated as empty.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>5 ~ 12: key가 없는 Fragment는 하위 컴포넌트를 묶어주는 용도로만 사용되므로 굳이 fiber로 만들 필요가 없습니다. 자식을 props에서 꺼내<up>11</up> 재조정을 진행하므로 Fragment는 VDOM에 존재하지 않게 됩니다.</li>\n<li>33: 컴포넌트 호출로 반환된 Text는 호스트 컴포넌트 하위에 있는 Text와는 다르게 fiber로 만들어 줍니다.</li>\n<li>20, 34: 재조정을 통해 반환된 fiber를 <code class=\"language-text\">placeSingleChild()</code>가 받아 Placement side-effect tag를 달아 주어야 하는지 판단합니다.</li>\n</ul>\n<blockquote>\n<h3 id=\"side-effect\" style=\"position:relative;\"><a href=\"#side-effect\" aria-label=\"side effect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>side-effect</h3>\n<p>VDOM 입장에서는 트리에 변경점을 불러오는 모든 행위가 side-effect입니다. 그러므로 재조정 작업은 side-effect를 낳는다고 생각할 수 있습니다.\n커스텀 컴포넌트 호출 또한 side-effect에 해당하므로 다음과 같이 tag를 설정해주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> nextChildren <span class=\"token operator\">=</span> <span class=\"token function\">renderWithHooks</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nworkInProgress<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">|=</span> PerformedWork<span class=\"token punctuation\">;</span></code></pre></div>\n<p>fiber에 새겨진 effectTag는 Commit phase에서 fiber에 어떤 작업들이 행해졌는지 확인하는데 쓰이며 해당 tag를 기반으로 최종 마무리(DOM 조작, 라이프 사이클)를 합니다.</p>\n</blockquote>\n<h4 id=\"placesinglechild\" style=\"position:relative;\"><a href=\"#placesinglechild\" aria-label=\"placesinglechild permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>placeSingleChild()</h4>\n<p>단일 자식에 대한 재조정이 진행되고 난 후에 DOM 삽입 여부를 판단합니다.</p>\n<anchor id=\"placeSingleChild\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L361\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">placeSingleChild</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">newFiber</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects <span class=\"token operator\">&amp;&amp;</span> newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> newFiber\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>current가 존재하는 상황<up>4</up>에서 newFiber의 alternate가 null<up>5</up>이라는 것은 호출로 반환된 컴포넌트가 이전 컴포넌트와 <u>type 또는 key가 달라</u> fiber를 새로 생성하였음을 뜻합니다. 그래서 새로 만들어진 newFiber를 삽입하기 위해 Placement tag를 달아줍니다.</li>\n</ul>\n<p>본격적으로 React element, Text, array가 어떻게 재조정을 거치는지 확인해봅시다.</p>\n<h3 id=\"3-reconcilesingleelement\" style=\"position:relative;\"><a href=\"#3-reconcilesingleelement\" aria-label=\"3 reconcilesingleelement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3) reconcileSingleElement()</h3>\n<p>fiber를 만들어낼 때 가장 먼저 해야 할 일은 기존 fiber를 재사용할 수 있느냐를 판단하는 겁니다. 이는 매우 중요합니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L1132\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileSingleElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">returnFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">currentFirstChild</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>key\n  <span class=\"token keyword\">let</span> child <span class=\"token operator\">=</span> currentFirstChild\n\n  <span class=\"token comment\">// newChild와 매칭되는 current를 찾는다.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>child <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        child<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> Fragment\n          <span class=\"token operator\">?</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span>\n          <span class=\"token operator\">:</span> child<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// current 재사용</span>\n        <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>\n          child<span class=\"token punctuation\">,</span>\n          element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span>\n            <span class=\"token operator\">?</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n            <span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n          expirationTime\n        <span class=\"token punctuation\">)</span>\n        existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n        <span class=\"token keyword\">return</span> existing\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    child <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 새 fiber 생성..</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>12, 37: current를 재사용하기 위해서는 현재 재조정 대상인 React element와 매칭되는 current가 필요합니다. while 문을 보면 형제<up>37</up>를 순회하고 있습니다. 그 이유는 현재 단일 자식에 대한 재조정 작업을 진행하고 있기는 하지만, 같은 위치의 current 트리에는 여러 형제가 존재하고 있을 수도 있습니다. 그러므로 이 복수의 current 중에서 현재 React element와 매칭되는 fiber를 찾고 있는 것입니다.</li>\n<li>\n<p>13, 35: key가 다르다면 우리가 찾는 current가 아니며, 해당 current는 삭제되어야 함을 나타내므로 제거<up>35</up>해줍니다.</p>\n<blockquote>\n<p>다시 말씀드리지만 reconcileSingleElement()는 해당 깊이에 단일 자식만 위치할 것임을 나타냅니다. 그러므로 지금 처리되고 있는 element와 매칭되지 않는 current들은 삭제된 것입니다.</p>\n</blockquote>\n</li>\n<li>16 ~ 17, 31: key가 같아도 type이 다르다면 current를 버리고 다시 만들어야 합니다. 이때 해당 current만 제거하면 안 되고 형제들도 다 같이 제거<up>31</up>해야 합니다. 해당 깊이에는 단일 fiber만 위치할 것이고 type이 달라 재사용하지는 못하지만 이미 매칭되는 current를 찾았으므로<up>13</up> 더 이상 while 문을 진행할 필요가 없습니다<up>32</up>.</li>\n<li>\n<p>19: 우리가 원하던 current를 찾았다면 해당 current를 제외한 나머지 형제들은 모두 제거해줍니다.</p>\n<blockquote>\n<p>deleteRemainingChildren()<up>19</up>의 두번 째 인자로 ‘current의 형제’를 넘겨주고 31 라인에서는 ‘current’임을 인지하시길 바랍니다.</p>\n</blockquote>\n</li>\n<li>21 ~ 27: key, type이 모두 같다면 해당 current를 재사용할 수 있습니다. 이때 딱 한 가지 current의 데이터가 아닌 반드시 반환된 element의 데이터를 사용해서 workInProgress를 만들어야 하는 것이 있습니다. 바로 <strong><u>부모로부터 전달받은 props</u></strong>입니다. 자식이 재조정 작업 중이라는 건 부모가 업데이트되어 재호출되었다는 뜻으로 부모가 넘겨주는 props 또한 변경될 수도 있음을 나타냅니다.</li>\n<li>28: current를 재사용 했기 때문에 현재 return은 current의 부모를 가리키고 있습니다. workInProgress tree의 부모를 가리키도록 수정해줍니다.</li>\n</ul>\n<p>다음은 current의 삭제입니다.</p>\n<h4 id=\"deleteremainingchildren-deletechild\" style=\"position:relative;\"><a href=\"#deleteremainingchildren-deletechild\" aria-label=\"deleteremainingchildren deletechild permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deleteRemainingChildren(), deleteChild()</h4>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L280\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> currentFirstChild</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 컴포넌트 마운트라면 current가 없으므로 애초에 지울 것도 없다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> childToDelete <span class=\"token operator\">=</span> currentFirstChild\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>childToDelete <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> childToDelete<span class=\"token punctuation\">)</span>\n    childToDelete <span class=\"token operator\">=</span> childToDelete<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>넘겨받은 <code class=\"language-text\">currentFirstChild</code> 부터 시작하여 모든 형제를 삭제해줍니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L259\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> childToDelete</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// deleteRemainingChildren()와 동일</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">.</span>lastEffect\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    last<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> childToDelete\n    returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> childToDelete\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    returnFiber<span class=\"token punctuation\">.</span>firstEffect <span class=\"token operator\">=</span> returnFiber<span class=\"token punctuation\">.</span>lastEffect <span class=\"token operator\">=</span> childToDelete\n  <span class=\"token punctuation\">}</span>\n\n  childToDelete<span class=\"token punctuation\">.</span>nextEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  childToDelete<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Deletion\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<h3 id=\"fiber의-타입\" style=\"position:relative;\"><a href=\"#fiber%EC%9D%98-%ED%83%80%EC%9E%85\" aria-label=\"fiber의 타입 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fiber의 타입</h3>\n<p>deleteChild()의 로직을 설명하기에 앞서 fiber가 어떤 타입으로 취급될 수 있는지 먼고 짚고 넘어가야 할 것 같습니다. 이를 위해서 <a href=\"https://ko.wikipedia.org/wiki/%EB%8D%95_%ED%83%80%EC%9D%B4%ED%95%91\" target=\"_blank\">Duck typing</a>의 개념이 필요합니다.<br>\nfiber를 Duck typing에 빗대어 설명하자면 fiber는 VDOM 노드이면서 Effect입니다. VDOM 노드가 가지고 있어야 할 속성(<down>return, sibling, child, index..</down>)과 side-effect의속성(<down>effectTag, stateNode, updateQueue</down>)들을 모두 가지고 있기 때문입니다. 또한,\nEffect collection(<down>nextEffect, firstEffect, lastEffect</down>)입니다.</p>\n</blockquote>\n<p>Effect는 후반에 <strong>Work</strong>를 마무리하면서 부모로 전달되는데 이 부분은 그때가서 자세히 다루므로 알고만 계세요.</p>\n<p>삭제는 예외적으로 Effect를 위로 올리는 시기가 조금 다릅니다. 부모로 전달하기 위해서는 completeUnitOfWork()까지 Effect가 살아 있어야 하는데 문제는 삭제되는 fiber는 지금 말고는 접근할 수 있는 시점이 없습니다. 그렇기 때문에 여기서 부모로 Deletion tag를 가진<up>17</up> fiber를 연결<up>8 ~ 14<up>하는 겁니다.</p>\n<h4 id=\"usefiber\" style=\"position:relative;\"><a href=\"#usefiber\" aria-label=\"usefiber permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>useFiber()</h4>\n<p>current를 재사용하는 코드는 간단합니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L320\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">pendingProps</span><span class=\"token operator\">:</span> mixed<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> clone <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> pendingProps<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n  clone<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  clone<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">return</span> clone\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>createWorkInProgress()의 설명은 <a href=\"/react/in-depth-react-reconciler_1#createWorkInProgress\" target=\"_blank\">reconciler_1</a>에서 확인하세요.</p>\n</blockquote>\n<ul>\n<li>props를 제외한 current의 속성들을 복사한 workInProgress를 만들어 냅니다. 현재 위치에 존재하는 노드는 자신 하나이므로 위치를 나타내는 index는 0, sibling은 null입니다. index 속성은 복수의 자식이 담겨있는 배열을 재조정할 때 이용됩니다.</li>\n</ul>\n<h3 id=\"4-reconcilesingletextnode\" style=\"position:relative;\"><a href=\"#4-reconcilesingletextnode\" aria-label=\"4 reconcilesingletextnode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4) reconcileSingleTextNode()</h3>\n<p><a class=\"code_link_5\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L1104\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileSingleTextNode</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">returnFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">currentFirstChild</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">textContent</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentFirstChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> currentFirstChild<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">===</span> HostText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>currentFirstChild<span class=\"token punctuation\">,</span> textContent<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n    existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> existing\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> currentFirstChild<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromText</span><span class=\"token punctuation\">(</span>\n    textContent<span class=\"token punctuation\">,</span>\n    returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n    expirationTime\n  <span class=\"token punctuation\">)</span>\n  created<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n  <span class=\"token keyword\">return</span> created\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Text는 key를 가지고 있지 않습니다. 그러므로 첫 번째 current 자식이 Text fiber라면<up>8</up> 재사용<up>10</up>하고 그렇지 않다면 모두 지워<up>14</up>준 후 fiber를 새롭게 만들어 반환합니다.</p>\n<h3 id=\"5-reconcilechildrenarray\" style=\"position:relative;\"><a href=\"#5-reconcilechildrenarray\" aria-label=\"5 reconcilechildrenarray permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5) reconcileChildrenArray()</h3>\n<p>배열에서 발생할 수 있는 변경에는 원소의 추가, 이동, 삭제가 있습니다. reconcileChildrenArray()는 이런 변경을 최소한의 연산으로 탐색하기 위한 노력을 담고있습니다. 이번 섹션의 목적은 코드에서 이 의도와 의미를 알아내는 것입니다.</p>\n<p>reconcileChildrenArray()는 두 개의 자료구조를 넘겨받습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n    returnFiber<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    currentFirstChild<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    newChild<span class=\"token punctuation\">,</span></span>    expirationTime\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>current의 연결 리스트<up>currentFirstChild</up>, 컴포넌트가 반환한 React element를 담고 있는 배열<up>newChild</up>.</p>\n<p>이제 이 두 자료구조를 비교하여 원소들의 추가, 이동, 삭제를 판별하는 로직을 짠다고 합시다.\n어떻게 짜면 효율적일까요? 가장 간단하게는 2 중첩 형태의 완전 탐색을 이용할 수도 있을 것이고 또는 맵으로 변경하여 key와 원소의 위치를 나타내는 index로 판별할 수도 있습니다.</p>\n<blockquote>\n<p>이번 섹션에서는 current와 React element를 타겟으로 통칭하여 설명하도록 하겠습니다.</p>\n</blockquote>\n<p>리액트는 O(n)의 시간복잡도로 판별을 완수합니다. 연결리스트든 배열이든 타겟을 가리키는 커서는 해당 위치를 딱 한 번만 지나가게 된다는 뜻이며 이때 사용되는 알고리즘의 핵심은 key와 type 그리고 원소의 위치입니다.</p>\n<p>양쪽의 타겟들을 비교할 때 최적의 케이스는 컴포넌트에서 반환된 React element 배열에서 current들이 움직이지 않고 그 자리에 계속 위치해 있는 것입니다. 해당 케이스에서 current가 이동하지 않았으니 이동을 제외한 타겟의 추가, 삭제는 시간 복잡도에 별다른 영향을 주지 않습니다. current가 이동하지 않았다고 가정만 할 수 있다면 커서의 전진만으로 타겟의 key와 type을 이용하여 추가, 삭제를 손쉽게 판단할 수 있습니다.</p>\n<p>하지만 current가 원래 위치에 없을 때는 이야기가 다릅니다. 이때는 element 배열을 모두 탐색해보지 않는 한 current의 이동, 삭제를 판단할 수 없습니다. 해당 케이스에서는 판별을 위해 완전 탐색을 사용할 수도 있지만 그렇게 하지는 않고 공간 복잡도를 올리고 시간 복잡도를 내리는 선택을 합니다. current 연결 리스트를 맵으로 변환하여 key 또는 index로 current를 찾아내는 방식으로 말이죠.</p>\n<p>여기서 언급되는 key는 fiber를 식별하는데 사용되므로 매우 중요합니다.<br>\n예를 들어 누가 봐도 고양이 컴포넌트이지만 개발자가 사자라고 주장한다면 리액트는 군말 없이 고양이를 사자로 취급합니다. 문제는 <strong><u>key를 설정하지 않아 값이 null</u></strong>일 때 발생합니다. 이 부분은 후반에 코드와 함께 알아봅니다.</p>\n<p>비교 알고리즘의 대략적인 내용은 위와 같고 이제부터 좀 더 세부적인 내용을 확인해 보겠습니다.</p>\n<anchor id=\"reconcileChildrenArray\" />\n<h4 id=\"1-current가-이동하지-않은-최적의-케이스로-탐색\" style=\"position:relative;\"><a href=\"#1-current%EA%B0%80-%EC%9D%B4%EB%8F%99%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EC%B5%9C%EC%A0%81%EC%9D%98-%EC%BC%80%EC%9D%B4%EC%8A%A4%EB%A1%9C-%ED%83%90%EC%83%89\" aria-label=\"1 current가 이동하지 않은 최적의 케이스로 탐색 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. current가 이동하지 않은 최적의 케이스로 탐색</h4>\n<p>먼저 주석과 함께 다음의 코드를 한번 쭉 훑어보세요. current가 이동하지 않았다고 가정을 하고 진행되는 로직이며 블록별 의미를 본인 나름대로 해석해 보시길 바랍니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">returnFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">currentFirstChild</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">newChildren</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">resultingFirstChild</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">let</span> <span class=\"token literal-property property\">previousNewFiber</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">let</span> oldFiber <span class=\"token operator\">=</span> currentFirstChild <span class=\"token comment\">// current 커서</span>\n  <span class=\"token keyword\">let</span> lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> newIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">// new child 커서</span>\n  <span class=\"token keyword\">let</span> nextOldFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> oldFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber<span class=\"token punctuation\">.</span>index <span class=\"token operator\">></span> newIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      nextOldFiber <span class=\"token operator\">=</span> oldFiber</span><span class=\"gatsby-highlight-code-line\">      oldFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      nextOldFiber <span class=\"token operator\">=</span> oldFiber<span class=\"token punctuation\">.</span>sibling</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    <span class=\"token comment\">// key가 다르다면 null을 같다면 type을 비교하여 생성 혹은 current를 재사용하여 fiber를 반환</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">updateSlot</span><span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">      returnFiber<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      oldFiber<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      expirationTime</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        oldFiber <span class=\"token operator\">=</span> nextOldFiber</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">break</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">&amp;&amp;</span> newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    <span class=\"token comment\">// fiber에 위치 index를 새기며 이동, 추가의 경우 placement effect tag도 달아줌.</span>\n<span class=\"gatsby-highlight-code-line\">    lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      resultingFirstChild <span class=\"token operator\">=</span> newFiber</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>    previousNewFiber <span class=\"token operator\">=</span> newFiber\n    oldFiber <span class=\"token operator\">=</span> nextOldFiber\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>16 ~ 21: 위 코드에서는 안 나와 있지만, element가 null일 경우 fiber로 만들지 않고 생략합니다. 그래서 아래 코드의 경우 oldFiber의 index가 newIdx보다 클 수<up>16</up> 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> a<span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span><span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>b<span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> b<span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span><span class=\"token number\">0</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 위치가 null이었다는 걸 VDOM에서는 확인할 수 없으므로 해당 지식을 알고 있는 여기서 추가로 판별하고 처리<up>18</up>하고 있는 것입니다.</p>\n<ul>\n<li>\n<p>23 ~ 39: current의 이동을 판별하고 그에 대한 처리를 합니다.</p>\n<p><code class=\"language-text\">updateSlot()</code>은 current를 재사용할 수 있으면 재사용을 하고 type이 다르면 fiber을 새로 만들어 줍니다.<br>\nfiber 말고도 null을 반환할 수도 있는데, 이는 key가 다르거나 <code class=\"language-text\">newChild</code><up>26</up>가 null일 때 그렇습니다.<br>\n만약 null이 반환된다면<up>29</up> 이번 섹션에서 다루는 케이스에 해당하지 않으므로 더이상 로직을 진행하지 않고 중단<up>33</up> 합니다.</p>\n<p>null일 경우 최적의 케이스에 대한 로직을 중단하는데 아래의 경우에는 어떨까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>current는 이동하지 않았습니다. 하지만 첫 번째 element가 null이기 때문에 위 로직은 중단될 것입니다.<br>\nnull은 아무런 기준이 되는 정보를 가지고 있지 않으므로 이는 어쩔 수 없는 부분입니다.</p>\n<p>다음의 경우에 대해서</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>개발자는 1번을 지우기 위해 null를 반환했습니다. 하지만 리액트 입장에서는 첫 번째 element가 null이라고 1번이 삭제되었다는 판단을 내릴 수 있을까요? 이것은 배열을 모두 탐색해보기 전까지는 알 수 없습니다. key가 변경되었든 newChild가 null이든 updateSlot()이 null를 반환하면 로직을 중단시킬 수밖에 없는 것이 이 이유 때문입니다.</p>\n</li>\n<li>35 ~ 39: fiber가 새로 생성되었다면<up>36</up> current는 삭제된 것이므로 제거해준다<up>37</up>.</li>\n<li>41 ~ 46: 마무리 단계입니다. <code class=\"language-text\">placeChild()</code><up>41</up>는 fiber에 현재 위치를 index에 새기고 필요에 따라 Placement tag를 달아줍니다. 그리고 이전 형제와 엮어<up>45</up>줍니다.</li>\n</ul>\n<p>fiber 재사용과 생성을 담당하는 <code class=\"language-text\">updateSlot()</code> 를 먼저 확인하고 <code class=\"language-text\">placeChild()</code>로 넘어가도록하겠습니다.</p>\n<h4 id=\"2-updateslot\" style=\"position:relative;\"><a href=\"#2-updateslot\" aria-label=\"2 updateslot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. updateSlot()</h4>\n<p><a class=\"code_link_5\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L544\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateSlot</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">returnFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">oldFiber</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">newChild</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> oldFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> oldFiber<span class=\"token punctuation\">.</span>key <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">updateTextNode</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token operator\">+</span> newChild<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> newChild <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> newChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>$$<span class=\"token keyword\">typeof</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token constant\">REACT_ELEMENT_TYPE</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">REACT_FRAGMENT_TYPE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">updateFragment</span><span class=\"token punctuation\">(</span>\n              returnFiber<span class=\"token punctuation\">,</span>\n              oldFiber<span class=\"token punctuation\">,</span>\n              newChild<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span>\n              expirationTime<span class=\"token punctuation\">,</span>\n              key\n            <span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">,</span> newChild<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">/*...*/</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>newChild<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token function\">updateFragment</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        oldFiber<span class=\"token punctuation\">,</span>\n        newChild<span class=\"token punctuation\">,</span>\n        expirationTime<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>element의 종류에 맞춰서 적절히 라우팅 해주고 있습니다. 여기서 사용되는 <code class=\"language-text\">update***()</code>는 SQL의 UPSERT와 같이 <em>‘current가 재사용 할 수 있으면 하고 없으면 새롭게 만들어 반환한다.’</em> 의 의미를 담고 있는 함수입니다.</li>\n<li>null을 반환하는 경우는 key가 다르거나<up>32</up> newChild가 fiber로 확장될 수 없을 때 <up>53</up>입니다.</li>\n<li>React element에는 key를 설정할 수 있지만 Text, 배열에는 key를 설정할 수 없습니다. key를 설정할 수 없는 newChild<up>10, 38</up>이지만 current의 key가 존재<up>11, 39</up>한다면 이는 current가 이동, 삭제되었다고 볼 수 있으므로 null을 반환합니다.</li>\n</ul>\n<p>update***()는 로직의 구조가 비슷하므로 일반적인 updateElement() 하나만 확인하고 넘어가겠습니다.</p>\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L393\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">returnFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">current</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> ReactElement<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">expirationTime</span><span class=\"token operator\">:</span> ExpirationTime</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Fiber <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> current<span class=\"token punctuation\">.</span>elementType <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    <span class=\"token keyword\">const</span> existing <span class=\"token operator\">=</span> <span class=\"token function\">useFiber</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n    existing<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> existing\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> created <span class=\"token operator\">=</span> <span class=\"token function\">createFiberFromElement</span><span class=\"token punctuation\">(</span>\n      element<span class=\"token punctuation\">,</span>\n      returnFiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">,</span>\n      expirationTime\n    <span class=\"token punctuation\">)</span>\n    created<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> returnFiber\n    <span class=\"token keyword\">return</span> created\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>current를 재사용하기 위해서는 key와 type이 같아<up>8</up>야 하며 이때 props만은 재사용하지 않는<up>9</up>다고 일전에 설명드렸습니다.</li>\n</ul>\n<p>복수의 자식을 재조정하는 지금까지의 내용으로 <strong><em>배열에서 key를 설정하지 않으면 발생하는 문제점</em></strong>에 대해 유추해 볼 수 있습니다.</p>\n<h3 id=\"️-key의-중요성\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-key%EC%9D%98-%EC%A4%91%EC%9A%94%EC%84%B1\" aria-label=\"️ key의 중요성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>❗️ key의 중요성</h3>\n<p>문제점을 설명하기에 앞서 이것과 관련된 우리가 알고 있는 정보들은 다음과 같습니다.</p>\n<ul>\n<li>key와 type이 같으면 props만 변경된다.</li>\n<li>key를 설정하지 않으면 key는 null이다.</li>\n</ul>\n<p>문제는 배열에서 key를 설정하지 않은(또는 배열의 index를 사용), 같은 type의 fiber가 이동되었을 때 발생합니다.<br>\n다음의 Counter 예제를 통해 어떠한 문제가 발생하는지 눈으로 확인해봅시다.</p>\n<iframe src=\"https://codesandbox.io/embed/5fd73y?view=preview&module=%2Fsrc%2FApp.js\"\n     style=\"width:100%; height: 500px; border:0; border-radius: 4px; overflow:hidden;\"\n     title=\"Array index key\"\n     allow=\"accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking\"\n     sandbox=\"allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts\"\n   ></iframe>\n<p>Shift 버튼을 통해 Counter 컴포넌트를 이동시키길 원합니다. 하지만 바람과 달리 이름만 이동 되고 숫자는 그대로입니다. 이유는 key와 type이 같으니 props만 변경되어 fiber의 hook 객체에 담겨있는 숫자는 이동하지 않아서 입니다. 이처럼 복수의 같은 type의 컴포넌트를 사용할 때는 필수적으로 유니크한 key를 설정해주어야 합니다.</p>\n<blockquote>\n<p>위 내용을 바탕으로 공식홈페이지의 <a href=\"https://ko.reactjs.org/docs/lists-and-keys.html\" target=\"_blank\">리스트와 key</a>를 다시 한번 읽어 보세요. 아마 내용을 받아들이는 깊이가 이전과는 다름을 느끼실겁니다. 암기가 아닌 이해가 중요합니다.</p>\n</blockquote>\n<h4 id=\"3-placechild\" style=\"position:relative;\"><a href=\"#3-placechild\" aria-label=\"3 placechild permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. placeChild()</h4>\n<p>updateSlot()을 통해 fiber를 반환받으면 fiber의 index와 삽입(이동, 추가) 여부를 나타내는 Placement tag를 달아주어야 합니다. 이동 + 추가는 한 묶음으로 HTML 내장 함수인 <a href=\"https://developer.mozilla.org/ko/docs/Web/API/Node/appendChild\" target=\"_blank\">appendChild()</a>를 이용하여 한번에 처리할 수 있습니다.</p>\n<p>우리는 실질적으로 이동시킬 element 선택에도 조금의 생각이 필요합니다.<br>\n다음의 경우에 어떤 element에 Placement tag를 달아주어야 할까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span>div key<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>1이 맨뒤로 이동하면서 2와 3의 위치가 한칸씩 앞으로 이동하게 되었습니다.<br>\n이때 placement tag를 모든 컴포넌트에 달아 주어 각각 DOM 조작을 해야 할까요?</p>\n<p>일반적으로 배열에서의 이동이란 ‘현재 위치’를 기준으로 앞과 뒤로 움직이는걸 뜻하지만 리액트는 이동을 상대적인 것으로 ‘인접한 원소’를 기준으로 그보다 앞 혹은 뒤로 움직이는걸 이동이라고 정의했습니다.</p>\n<p>이렇게 정의한 덕분에 위 배열 예제에서 한가지에 대한 처리로 문제를 해결 할 수 있게 되었습니다.</p>\n<ol>\n<li>1이 뒤로 이동했다고 판단할 경우 2, 3을 그대로 두고 1만 조작하던지</li>\n<li>1은 가만히 있었는데 2, 3이 앞으로 이동했다고 판단하여 2, 3을 조작하던지</li>\n</ol>\n<p>이동의 정의를 인접한 원소를 기준으로 뒤로 이동한 경우 1, 앞으로 이동한 경우를 나타낸 것이 2입니다. 그리고 전자로 로직을 작성한 함수가 placeChild()입니다.</p>\n<anchor id=\"placeChild\" />\n<p><a class=\"code_link_2\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L333\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">newFiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">lastPlacedIndex</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">newIndex</span><span class=\"token operator\">:</span> number</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> number <span class=\"token punctuation\">{</span>\n  newFiber<span class=\"token punctuation\">.</span>index <span class=\"token operator\">=</span> newIndex\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 마운트의 경우 index 설정만 필요함.</span>\n    <span class=\"token keyword\">return</span> lastPlacedIndex\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">.</span>alternate\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> oldIndex <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>index\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldIndex <span class=\"token operator\">&lt;</span> lastPlacedIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 이동</span>\n      newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n      <span class=\"token keyword\">return</span> lastPlacedIndex\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 이동하지 않음</span>\n      <span class=\"token keyword\">return</span> oldIndex\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 추가</span>\n    newFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> Placement\n    <span class=\"token keyword\">return</span> lastPlacedIndex\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>첫 <code class=\"language-text\">lastPlacedIndex</code>는 0입니다. 그리고 cucrnet가 없다면<up>13</up> 이는 새롭게 만들어진 fiber임으로 DOM에 삽입하기 위해 tag를 달아<up>25</up>줍니다.</li>\n</ul>\n<p>이제 원소의 이동을 판단할 차례인데 이동의 기준은 현재 삽입할 위치의 이전 원소가 되겠습니다. 이전 원소의 index보다 current의 index가 작다는 것은 current가 오른쪽으로 이동했음을 뜻합니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 773px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 31.818181818181817%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+ElEQVQY06VRXU/CMBTd//8vEBZQHwwfJgbiizExxhbIJoYBS1xrtzLKvg6321QM8cmbnDa3Pffce1qnqir8Qlk2yPMfFMVl3vJKQkFndrf1Dv4ZGYlLpb5zR6cpVpwhffOh5hw6DLFPEixuruAPXLDrPrTWWD3M4PV74L0Odr6HaL3G0u3CdztgoyGC7bYRNMYgpEsd7hBvAhyom6EmfDbF8/AW70+PMMcjAsbq3JveI5ECcfSBl8kY/G6CDXuFkLIR/MtKRTBk5zzUPsWBBijovWzYNSY3ecur3/DiU85Qk9riLMsghYCIInzSNKUVIU5MjhThq+YERNfMBJ2OTFwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"placeChild  \" title=\"placeChild  \" src=\"/static/21a832466a953523abcf49974706ba80/612f7/placeChild().png\" srcset=\"/static/21a832466a953523abcf49974706ba80/18f77/placeChild().png 198w,\n/static/21a832466a953523abcf49974706ba80/2cb6c/placeChild().png 395w,\n/static/21a832466a953523abcf49974706ba80/612f7/placeChild().png 773w\" sizes=\"(max-width: 773px) 100vw, 773px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>위 내용을 토대로 가장 최악의 시나리오는 무엇일까요? 바로 맨 뒤 원소가 맨 앞으로 이동했을 경우 입니다. 이때는 첫 번째 원소를 제외한 나머지 fiber들에 placement tag가 달릴 것 입니다.</p>\n<p>이 부분을 확인하기 위해 Todo 예제를 다음과 같이 수정하겠습니다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Todo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">,</span> push<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>todos<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>todos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>pull<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span></span>      <span class=\"token operator\">&lt;</span>Input submit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">todo</span> <span class=\"token operator\">=></span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todos</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>OrderList list<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>todos<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">OrderList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> list <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ol<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">&lt;</span>li key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></span>      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ol<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// placement tag를 처리하는 Commit phase 함수.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitPlacement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">finishedWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">key: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>finishedWork<span class=\"token punctuation\">.</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> tag: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>finishedWork<span class=\"token punctuation\">.</span>effectTag<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>맨 뒤에 있는 todo item을 앞으로 당겨오는 pull 버튼을 추가했습니다. item의 key는 입력 값 그대로 사용합니다.</p>\n<img src=\"/path/to/dir/d6d8a683c537f6028c749aa45b13b5fa/placement_when_pull_tail.gif\" height=\"300px\" width=\"100%\">\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 568px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 34.84848484848485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABEklEQVQoz32RCW+DMAyF+/9/2qR1FHoNaAtt2Uq4AoT7eHMyQTc07UlPsWP4DPaqaRpwnkKeXdehbdvZMi/LkuocWZZBkAuRo60qlEKgotowDBjHcfZK0AO3m6eAP2ETME1TOK4D72zjffMG/fUFd8uCbRhg1ytGPKWAMmga6liU+E8Nj2GfTrAIHIQhPO8DRRgBfYcsSdSdlAKGlOR5PndZWioPGPSNBo2+0r1ccNjvwB8PVRv6Hj15BkYRAcVv4DL+ZD50bU3QNc62icNuC8e7q1+uaVx1XT+BMpk6TIAl0AsZjqYJY7+FS7M70hwdxlDTe2Ecw/f9b+AS8BdUqqCmjLYdpBwxjYfxBBltG4ulfAGCwRwNxy0QXgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"placement when pull tail\" title=\"placement when pull tail\" src=\"/static/687c4ac201b8dcac0bbcae3e30c166e1/10e91/placement_when_pull_tail.png\" srcset=\"/static/687c4ac201b8dcac0bbcae3e30c166e1/18f77/placement_when_pull_tail.png 198w,\n/static/687c4ac201b8dcac0bbcae3e30c166e1/2cb6c/placement_when_pull_tail.png 395w,\n/static/687c4ac201b8dcac0bbcae3e30c166e1/10e91/placement_when_pull_tail.png 568w\" sizes=\"(max-width: 568px) 100vw, 568px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>tag: 2는 placement tag를 나타냅니다.</p>\n<h4 id=\"4-삭제할-current만-있거나-추가할-newchild만-있거나\" style=\"position:relative;\"><a href=\"#4-%EC%82%AD%EC%A0%9C%ED%95%A0-current%EB%A7%8C-%EC%9E%88%EA%B1%B0%EB%82%98-%EC%B6%94%EA%B0%80%ED%95%A0-newchild%EB%A7%8C-%EC%9E%88%EA%B1%B0%EB%82%98\" aria-label=\"4 삭제할 current만 있거나 추가할 newchild만 있거나 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 삭제할 current만 있거나 추가할 newChild만 있거나</h4>\n<p>최적의 케이스에서 current 리스트와 newChildren의 길이가 같다면 current 삭제와 element 추가를 모두 쉽게 판별할 수 있습니다. 하지만 길이가 다를 경우도 많겠죠. current 리스트가 더 길거나 그 반대로 newChildren이 긴 경우처럼요.</p>\n<p>다행히도 이때의 삭제, 추가 판별은 오히려 쉽습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// for (; oldFiber !== null &amp;&amp; newIdx &lt; newChildren.length; newIdx++) { ... }</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// current 리스트가 더 긴 경우</span></span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newIdx <span class=\"token operator\">===</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">deleteRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>current 리스트가 더 길다는 건 나머지들은 모두 삭제되었다는 뜻으로 삭제만 하면 끝입니다.</li>\n</ul>\n<p><a class=\"code_link_4\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// if (newIdx === newChildren.length) {...}</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// newChildren 배열이 더 긴 경우</span></span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">createChild</span><span class=\"token punctuation\">(</span>\n        returnFiber<span class=\"token punctuation\">,</span>\n        newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        expirationTime<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        resultingFirstChild <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      previousNewFiber <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/*...*/</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>반대로 newChildren이 길 경우는 추가되었다는 뜻이겠죠. 코드의 의미는 명확합니다.</li>\n</ul>\n<blockquote>\n<p><a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L480\" target=\"_blank\">createChild()</a>는 이제까지 많이 봐왔던 형식으로 React element type에 맞는 fiber로 확장하는 코드만 존재하므로 생략합니다.</p>\n</blockquote>\n<p>이 이후에는 current가 이동했다고 판단하고 코드를 작성하였습니다. current가 이동하게 되면 더 이상 커서의 전진만으로 판별할 수 없으므로 current 리스트를 맵으로 변환하여 진행합니다.</p>\n<h4 id=\"5-current가-이동한-경우\" style=\"position:relative;\"><a href=\"#5-current%EA%B0%80-%EC%9D%B4%EB%8F%99%ED%95%9C-%EA%B2%BD%EC%9A%B0\" aria-label=\"5 current가 이동한 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. current가 이동한 경우</h4>\n<p>로직의 흐름은</p>\n<ol>\n<li>먼저 current 리스트를 맵으로 변환하고</li>\n<li>아직 커서가 지나가지 않은 newChildren 배열의 원소들을 마저 지나가며 맵에서 current를 찾아옵니다.</li>\n<li>찾았다면 current가 이동한 것이고 못찾았다면 삭제된 것이다.</li>\n</ol>\n<p><a class=\"code_link_5\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L756\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber 0\" class=\"language-js line-numbers\"><code class=\"language-js\">‎\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*...*/</span>\n  <span class=\"token comment\">// if (oldFiber === null) {...}</span>\n\n  <span class=\"token keyword\">const</span> existingChildren <span class=\"token operator\">=</span> <span class=\"token function\">mapRemainingChildren</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> oldFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> newIdx <span class=\"token operator\">&lt;</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> newIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token function\">updateFromMap</span><span class=\"token punctuation\">(</span>\n      existingChildren<span class=\"token punctuation\">,</span>\n      returnFiber<span class=\"token punctuation\">,</span>\n      newIdx<span class=\"token punctuation\">,</span>\n      newChildren<span class=\"token punctuation\">[</span>newIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      expirationTime<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 재활용된 fiber의 경우 맵에서 제거해준다</span>\n          existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>\n            newFiber<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> newIdx <span class=\"token operator\">:</span> newFiber<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n\n      lastPlacedIndex <span class=\"token operator\">=</span> <span class=\"token function\">placeChild</span><span class=\"token punctuation\">(</span>newFiber<span class=\"token punctuation\">,</span> lastPlacedIndex<span class=\"token punctuation\">,</span> newIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousNewFiber <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        resultingFirstChild <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        previousNewFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      previousNewFiber <span class=\"token operator\">=</span> newFiber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldTrackSideEffects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> <span class=\"token function\">deleteChild</span><span class=\"token punctuation\">(</span>returnFiber<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> resultingFirstChild<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>6: current 연결 리스트를 맵으로 변환합니다.</li>\n<li>9: updateSlot()과 동일합니다. 다만 current를 참조하는 방식이 map을 통한 참조라는 것만 다릅니다.</li>\n<li>39: newChildren을 모두 탐색한 후에도 currrent가 맵에 남아 있다면 모두 제거된 것이므로 삭제해주면 됩니다.</li>\n<li>42: 부모는 child 속성으로 첫 번째 자식만 참조하므로 resultingFirstChild만 반환합니다.</li>\n</ul>\n<p>mapRemainingChildren()에서는 맵의 key를 설정하는 부분 정도만 주의깊게 보시면 될 것 같습니다.</p>\n<p><a class=\"code_link\" href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactChildFiber.js#L299\" target=\"_blank\">reconciler > ReactChildFiber.js</a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">‎\n<span class=\"token keyword\">function</span> <span class=\"token function\">mapRemainingChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">returnFiber<span class=\"token punctuation\">,</span> currentFirstChild</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> existingChildren <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> existingChild <span class=\"token operator\">=</span> currentFirstChild\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>existingChild <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>key <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">,</span> existingChild<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      existingChildren<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>existingChild<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">,</span> existingChild<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span>\n    existingChild <span class=\"token operator\">=</span> existingChild<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> existingChildren\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이전에 Todo 예제에서 Input컴포넌트의 상태가 업데이트 된 후의 VDOM 형태를 표현한 <a href=\"/react/in-depth-react-reconciler_2/#input_update\" target=\"_blank\">이미지</a>를 기억하시나요?\nInput 컴포넌트는 상태가 업데이트 되었으니 5.update***에서 컴포넌트가 호출될 것입니다. 그리고 반환하는 자식 React element는 6.reconcileChildren에서 재조정 작업을 거친 후 fiber로 확장되어 VDOM에 반영됩니다.<br>\n이 과정을 모두 거친 후의 VDOM 형태는 다음과 같습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 790px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.505050505050505%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB20lEQVQoz21S72/SUBTd///RD34wOmPMphJd4mJQyIYzmTpZhWGhguNnC7S08ErbQUvfK8f7WsARd5OT+37d8+695x6s12tsIS1JEpiMYeA4YEGQnmU3/7xgLsJuD6HvI46i7G7DcbBHSOCc4/3VNzz+eIrLhgruMiwdGyFB+ojN4NVVaG9zqOSOYbdvM0JKZJ9QZid/TwQ0fYDLmgJ9YkFQBvFyucECfLXCstNF/eQdfhY+gJnmA4TygDIDlSA3F40b5JQfKLc0IJhD+F6K2KP1XYA7XUe3dIbO5wKYoT9MKPwAhXwez86LOFO+IxiNoGl1KDcKKmoNt60mZsMhZvYEk2oV1TevUD55DZ3K3/Z+R7i13sSAOuhDH/cRzhnc+Rz6yMDYGsOZTuEOBvCp3JltwWo3YF8r8Jq1XXxKKBdfKINH+VMUq2UwUvioVMTT80+47rRx3+JeH7+Pj3D18jkahTwspYLKi0N8PXwC7aKUapASmqScSsEd6seUxqVJ/tefFobmGJxEWZEgSRynI+IODTh051kmFtRPZhhgVNXCdf8vORsyscOaiCISQyIkQVY0lzwKt/VlQt43SSibKSiYC04jk6Tg6V6k64Qe7WHzJtlAxgoZS17u/wL3V/CaZ9AtuQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"reconcile children\" title=\"reconcile children\" src=\"/static/8add8101dc88320afdd3537f1f4d6b98/2e237/reconcile_children.png\" srcset=\"/static/8add8101dc88320afdd3537f1f4d6b98/18f77/reconcile_children.png 198w,\n/static/8add8101dc88320afdd3537f1f4d6b98/2cb6c/reconcile_children.png 395w,\n/static/8add8101dc88320afdd3537f1f4d6b98/2e237/reconcile_children.png 790w,\n/static/8add8101dc88320afdd3537f1f4d6b98/98b29/reconcile_children.png 937w\" sizes=\"(max-width: 790px) 100vw, 790px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>다음 포스트에서는 지금까지 진행했던 <strong>Work</strong>의 작업물을 마무리하는 방법을 알아 볼 것입니다.</p>","frontmatter":{"title":"React 톺아보기 - 05. Reconciler_3","date":"2020-10-15","keywords":["리액트","react","fiber","VDOM","reconciler"]}}},"pageContext":{"slug":"/react/in-depth-react-reconciler_3/","previous":{"fields":{"slug":"/react/in-depth-react-reconciler_2/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_2","category":"react"}},"next":{"fields":{"slug":"/react/in-depth-react-reconciler_4/"},"frontmatter":{"title":"React 톺아보기 - 05. Reconciler_4","category":"react"}}}},"staticQueryHashes":["2277278352","536400264"]}